;/*FB_PKG_DELIM*/

__d("CoalescingLoader",[],(function(t,n,r,o,a,i){"use strict";function e(){return new Promise(function(e){return globalThis.setTimeout(e,0)})}var l=(function(){function t(t,n){n===void 0&&(n=e),this.$1=t,this.$2=[],this.$3=null,this.$4=n}var n=t.prototype;return n.gen=async function(t){this.$2.push(t);var e=this.$2.length-1,n=await this.$5();return n[e]},n.$5=function(){return this.$3!=null?this.$3:(this.$3=this.$6(),this.$3)},n.$6=async function(){await this.$4();var e=this.$2;return this.$2=[],this.$3=null,this.$1([].concat(e))},t})();i.CoalescingLoader=l}),66);
__d("EBAPI",["MAWEBCombinedSwitch","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(e=r("requireDeferred"))("EBAPIMinosVerifySingleEpoch").__setRef("EBAPI"),u=e("EBAPIWriteMinosPublicKeysForRecipient").__setRef("EBAPI"),c=e("EBGetContactEpochHead").__setRef("EBAPI"),d=e("EBGetMessageKeys").__setRef("EBAPI"),m=e("EBIsEbEnabled").__setRef("EBAPI"),p=e("EBMinosWriteKeyChangeAdminMessage").__setRef("EBAPI"),_=e("EBMinosWriteSecureStorageAlert").__setRef("EBAPI"),f={getContactEpochHead:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return c.load().then(function(e){return e.getContactEpochHead.apply(e,t)})},getMessageKeys:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return d.load().then(function(e){return e.getMessageKeys.apply(e,t)})},isEBEnabled:function(){return o("MAWEBCombinedSwitch").MAWEBCombinedSwitch.isEnabled()},isEbEnabledEbSwitch:function(){return m.load().then(function(e){return e.isEbEnabledEbSwitch()})},minosVerifySingleEpoch:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return s.load().then(function(e){return e.minosVerifySingleEpoch.apply(e,t)})},writeMinosKeyChangeAdminMessage:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return p.load().then(function(e){return e.writeMinosKeyChangeAdminMessage.apply(e,t)})},writeMinosMailboxKeysForRecipientAPI:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return u.load().then(function(e){return e.writeMinosMailboxKeysForRecipientAPI.apply(e,t)})},writeMinosSecureStorageAlert:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return _.load().then(function(e){return e.writeMinosSecureStorageAlert.apply(e,t)})}},g=f;l.default=g}),98);
__d("EchoCommonUtils",[],(function(t,n,r,o,a,i){"use strict";var e="Echo-Doc-Version";function l(e,t){var n=e.localKey,r=e.transportKey;return n+"@"+r+"-"+t}function s(e,t,n){return e==null?{localKey:t,transportKey:n}:{displayName:e,localKey:t,transportKey:n}}i.ECHO_COMMON_FIELD_DOCUMENT_VERSION=e,i.getEchoAddressFieldNameWithSuffix=l,i.craftEchoAddress=s}),66);
__d("EchoConstants",[],(function(t,n,r,o,a,i){"use strict";var e=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"'," ","(",")",",",":",";","<",">","@","[","]","\\"]);i.ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE=e}),66);
__d("EchoDecodingUtils",["invariant","EchoConstants","WALogger"],(function(t,n,r,o,a,i,l,s){"use strict";var e,u,c,d,m,p,_,f,g,h,y,C,b,v=new Set([]);function S(t,n){if(t.length!==0){var r=t.indexOf(":");if(r===-1){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] This is a raw line and we cannot decode its field name and value."])));return}var a=t.substring(0,r).trim(),i=t.substring(r+1).trim();if(a.length===0){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Field name is blank"])));return}if(i.length===0){n.has(a)&&n.delete(a);return}n.set(a,i)}}function R(e,t,n,r){n===void 0&&(n=new Set);for(var a=!1,i=t==="conditional"&&e[0]==='"',l="",s=i?1:0;s<e.length;){var u=e[s];if(t==="conditional"&&!i&&u==='"'||!i&&n.has(u))break;if(i&&!a&&u==='"'){i=!1,s++;break}if(i&&!a&&u==="\\"){if(s===e.length-1)break;a=!0}else a&&u==="r"?l+="\r":a&&u==="n"?l+="\n":l+=u,a=!1;s++}if(i||l.length===0){var d=r!=null?r:"unknown";return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail decoding because we didn't have a closing quote. Error Field: ",""])),d),{remainder:e,result:null,success:!1}}return{remainder:e.substring(s),result:l,success:!0}}function L(e,t){if(e.length===0)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddress"]))),{remainder:e,result:null,success:!1};var n=e.trimLeft(),r=R(n,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,t);if(!r.success)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] conditional quote mode decode failed"]))),{remainder:e,result:null,success:!1};if(r.result!=null||s(0,47923),r.remainder[0]==="@"){var a=E(r.remainder,r.result,t);return{remainder:a.remainder,result:a.result,success:a.success}}var i=r.result,l=r.remainder.trimLeft();if(l.startsWith("<")){var u=E(l.substring(1),void 0,t),c=u.result,_=u.remainder;if(u.success&&c!=null&&_.startsWith(">"))return i.length===0?{remainder:_.substring(1),result:c,success:!0}:{remainder:_.substring(1),result:babelHelpers.extends({},c,{displayName:i}),success:!0}}return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echoDecodeAddress failed"]))),{remainder:e,result:null,success:!1}}function E(e,t,n){var r=t==null?e.trimLeft():e,a=t;if(a==null){var i=R(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n);if(!i.success)return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] parse localKey in address failed"]))),{remainder:e,result:null,success:!1};a=i.result,r=i.remainder}if(a==null||a.length===0||r[0]!=="@")return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid localKey in address detected"]))),{remainder:e,result:null,success:!1};var l=R(r.substring(1),"never",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE,n),s=l.result;return l.success&&s!=null&&s.length>0?{remainder:l.remainder,result:{localKey:a,transportKey:s},success:!0}:(o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid transportKey in address detected"]))),{remainder:e,result:null,success:!1})}function k(e,t){if(e.length===0)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid input to echoDecodeAddressList detected"]))),{result:null,success:!1};var n=L(e,t);if(!n.success)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Address  decode failed with value: ",""])),e),{result:null,success:!1};n.result!=null||s(0,47927);for(var r=[n.result],a=n.remainder;a.startsWith(",");){var i=L(a.substring(1).trimLeft(),t);if(i.success)i.result!=null&&r.push(i.result),a=i.remainder;else break}return{result:r,success:!0}}function I(e){var t=new Map,n=e.split("\r\n");return n.length===1&&n[0]===e?(o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Fail to decode if the input string does not have CRLF"]))),t):(n.forEach(function(e){return S(e,t)}),t)}function T(e,t){var n=e.get(t);if(n==null||n.length===0||n==='""')return{result:null,success:!1};var r=R(n,"conditional",v,t),o=r.result,a=r.success;return{result:o,success:a}}function D(e,t){var n,r=x(e,t);return{result:(n=r.result)!=null?n:0,success:r.success}}function x(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=parseInt(n,10);return isNaN(r)?(o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] "," not a valid number in echo message"])),t),{result:null,success:!1}):Number.isSafeInteger(r)?{result:r,success:!0}:{result:r>Number.MAX_SAFE_INTEGER?Number.MAX_SAFE_INTEGER:Number.MIN_SAFE_INTEGER,success:!0}}function $(e,t){var n,r=P(e,t);return{result:(n=r.result)!=null?n:!1,success:r.success}}function P(e,t){var n=x(e,t);return!n.success||n.result!==0&&n.result!==1?{result:null,success:!1}:{result:n.result===1,success:!0}}function N(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=L(n,t),o=r.result,a=r.success;return{result:o,success:a}}function M(e,t){var n=e.get(t);return n==null||n.length===0?{result:null,success:!1}:k(n,t)}function w(e,t){var n=e.get(t);if(n==null||n.length===0)return{result:null,success:!1};var r=n.split(",").map(function(e){return e.trim()}).filter(Boolean);return r.length===0?{result:null,success:!1}:{result:r,success:!0}}l.echoDecodeFields=I,l.echoDecodeStringField=T,l.echoDecodeIntField=D,l.echoDecodeNullableIntField=x,l.echoDecodeBooleanField=$,l.echoDecodeNullableBooleanField=P,l.echoDecodeAddressField=N,l.echoDecodeAddressListField=M,l.echoDecodeObjectIdListField=w}),98);
__d("EchoEncodingUtils",["EchoConstants","EchoMessage","FBLogger","MAWMsgType","WABase64"],(function(t,n,r,o,a,i,l){"use strict";var e=new Set(['"',"\\","\n","\r","\0"]),s=new Set(["\0","","","","","","","\x07","\b","	","\n","\v","\f","\r","","","","","","","","","","","","","","\x1B","","","","",'"',"\\"]);function u(e,t){for(var n of t)if(e.indexOf(n)>=0)return!0;return!1}function c(t,n,o){if(o===void 0&&(o=new Set),t.length<=0)throw r("FBLogger")("wmi_eb").mustfixThrow("The input string must be non-empty");var a=n;if(n==="conditional"&&(u(t,o)?a="always":a="never"),a==="never")return t;for(var i='"',l=0;l<t.length;l++){var s=t[l];e.has(s)?(i+="\\",s==="\r"?i+="r":s==="\n"?i+="n":i+=s):i+=s}return i+'"'}function d(e){if(!Number.isSafeInteger(e))throw r("FBLogger")("wmi_eb").mustfixThrow("The input value must be a safe integer");return e.toString()}function m(e){var t="",n=e.displayName,r=e.localKey,a=e.transportKey;return n!=null&&n.length>0&&(t+=c(n,"always")+" <"),t+=c(r,"conditional",o("EchoConstants").ADDRESS_LOCAL_KEY_CHARS_NEED_QUOTE)+"@"+a,n!=null&&n.length>0&&(t+=">"),t}function p(e,t,n){n!=null&&n.length!==0&&e.set(t,c(n,"conditional",s))}function _(e,t,n){if(n!=null){var r=d(n);p(e,t,r)}}function f(e,t,n){if(n!=null){var r=d(n?1:0);p(e,t,r)}}function g(e,t,n){n!=null&&e.set(t,m(n))}function h(e,t,n){if(n!=null){var r="";n.forEach(function(e,t){r+=m(e),t<n.length-1&&(r+=", ")}),e.set(t,r)}}function y(e){var t="";return e.forEach(function(e,n){t=t+n+": "+e+"\r\n"}),t}function C(e){return o("WABase64").encodeB64UrlSafe(e)}function b(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("EchoMessage").EchoXMessageContentType.TEXT;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("EchoMessage").EchoXMessageContentType.IMAGE;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("EchoMessage").EchoXMessageContentType.VIDEO;case o("MAWMsgType").MSG_TYPE.PTT:return o("EchoMessage").EchoXMessageContentType.AUDIO;case o("MAWMsgType").MSG_TYPE.STICKER:return o("EchoMessage").EchoXMessageContentType.STICKER;case o("MAWMsgType").MSG_TYPE.GIF:return o("EchoMessage").EchoXMessageContentType.GIF;case o("MAWMsgType").MSG_TYPE.XMA:return o("EchoMessage").EchoXMessageContentType.XMA;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("EchoMessage").EchoXMessageContentType.DOCUMENT;case o("MAWMsgType").MSG_TYPE.REACTION:return o("EchoMessage").EchoXMessageContentType.REACTION;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SETTINGS;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("EchoMessage").EchoXMessageContentType.EPHEMERAL_SYNC_RESPONSE;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("EchoMessage").EchoXMessageContentType.MESSAGE_DELETE_FOR_ME;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("EchoMessage").EchoXMessageContentType.UNSEND;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("EchoMessage").EchoXMessageContentType.GROUP_INVITES;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("EchoMessage").EchoXMessageContentType.BUMP;default:return o("EchoMessage").EchoXMessageContentType.UNKNOWN}}l.echoSetStringField=p,l.echoSetIntField=_,l.echoSetBooleanField=f,l.echoSetAddressField=g,l.echoSetAddressListField=h,l.echoEncodeFields=y,l.convertMediaKeyToString=C,l.convertDbMsgTypeToXMessageContentType=b}),98);
__d("EchoMessage",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","EchoMessageMediaFieldUtils","EchoMessageMediaGroupFieldUtil","EchoMessageQuoteFieldUtils","EchoMessageReceiptStatusFieldUtils","EchoMessageXMAFieldUtils","FBLogger","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f="Message-ID",g="Thread-ID",h="Sort-Order",y="Display-Timestamp",C="Authoritative-Timestamp",b="From",v="Text",S="Text-Size",R="Send-Error",L="Is-Tombstoned",E="Expire-Timestamp",k="Delete-Timestamp",I="Ephemeral-Duration",T="Message-Content-Type",D="X-Message-Content-Type",x="Message-Content-Subtype",$="Is-Forwarded",P="X-Offline-Threading-ID",N="X-Thread-ID",M="X-Message-Placeholder-Type",w="Reactions",A="Reaction-Authoritative-Timestamps",F="X-Reaction-Offline-Threading-IDs",O="Echo-Serialization-Origin",B="Revoke-Sent-Timestamp",W="Revoke-Unsent-Timestamp",q="Edit-Count",U="Edit-Contents-",V="Edit-Timestamps-",H="Group-ID",G="Group-Index",z="Group-Size",j="Receiver-Fetch-Id",K="Message-Ephemerality-Type",Q=1,X=(_=n("$InternalEnum"))({NONE:"none",SMALL:"small",MEDIUM:"medium",LARGE:"large"}),Y=_({NONE:"none",UNSEND:"unsend"}),J=_({DECRYPTION_FAILURE:"decryption_failure",UNSUPPORTED_NEEDS_UPDATE:"unsupported_needs_update",TEXT:"text",ADMIN_MESSAGE:"admin_message",MEDIA:"media",XMA:"xma",NULL_STATE:"null_state",PLACEHOLDER:"placeholder"}),Z=_({UNKNOWN:"unknown",TEXT:"text",IMAGE:"image",VIDEO:"video",AUDIO:"audio",STICKER:"sticker",GIF:"gif",URL:"url",EPHEMERAL_SETTINGS:"ephemeral_settings",LOCATION:"location",DOCUMENT:"document",UNSEND:"unsend",SCREENSHOT_ACTION:"screenshot_action",REACTION:"reaction",XMA:"xma",VISUAL_MESSAGE_VIDEO:"visual_message_video",VISUAL_MESSAGE_IMAGE:"visual_message_image",VISUAL_MESSAGE_ACTION:"visual_message_action",SCREEN_RECORDING_ACTION:"screen_recording_action",MESSAGE_DELETE_FOR_ME:"message_delete_for_me",ENCRYPTED_BACKUP_NEW_DEVICE_ENROLLMENT:"encrypted_backup_new_device_enrollment",SENDER_KEY:"sender_key",DELETE_THREAD:"delete_thread",READ_THREAD:"read_thread",UNREAD_THREAD:"unread_thread",REACTION_UNSEND:"reaction_unsend",GROUP_INVITES:"group_invites",EPHEMERAL_SYNC_RESPONSE:"ephemeral_sync_response",BUMP:"bump"}),ee=_({NO_PLACEHOLDER:"0",DECRYPTION_FAILURE:"-1",CLIENT_NOT_SUPPORTED_NEED_UPDATE:"-2",UNAVIALABLE_DEVICE:"-3"}),te=_({UNKNOWN:"Unknown",WEB:"Web",MOBILE:"Mobile"});function ne(e){var t=new Map;return de(t,e),"mediaData"in e&&e.mediaData&&o("EchoMessageMediaFieldUtils").echoMessageSetMediaMetadataFields(t,e.mediaData),o("EchoEncodingUtils").echoEncodeFields(t)}function re(e,t){var n,r=[],a=0,i=new Set;return t.forEach(function(n,a,l){var s=a.startsWith(U),u=a.startsWith(V);if(s||u){var c=a.slice(s?U.length:V.length);if(!i.has(c)){var d,m;i.add(c);var p=(d=o("EchoDecodingUtils").echoDecodeStringField(t,""+U+c).result)!=null?d:"",_=((m=o("EchoDecodingUtils").echoDecodeIntField(t,""+V+c).result)!=null?m:0)/1e3;r.push({messageId:c,originalMessageId:e,text:p,timestamp:_})}}}),a=(n=o("EchoDecodingUtils").echoDecodeIntField(t,q).result)!=null?n:0,{editCount:a,editHistory:r}}function oe(t){var n=o("EchoDecodingUtils").echoDecodeFields(t);if(n.size===0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fieldsMap is empty for the echo message"]))),null;var a=o("EchoDecodingUtils").echoDecodeStringField(n,f),i=o("EchoDecodingUtils").echoDecodeStringField(n,g),l=o("EchoDecodingUtils").echoDecodeIntField(n,h),_=o("EchoDecodingUtils").echoDecodeIntField(n,y),q=o("EchoDecodingUtils").echoDecodeStringField(n,T),U=o("EchoDecodingUtils").echoDecodeStringField(n,D),V=o("EchoDecodingUtils").echoDecodeStringField(n,x);if(a.success&&i.success&&l.success){var H=a.result;if(H==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded messageId cannot be null");var G=i.result;if(G==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded threadId cannot be null");var z=q==null?void 0:q.result;if(z==null)throw r("FBLogger")("messenger_web").mustfixThrow("The decoded contentTypeString cannot be null");var X=re(H,n),Z=X.editCount,ee=X.editHistory,te={contentSubtype:se(V.result),contentType:ie(z),displayTimestampMs:_.success?_.result:l.result,editCount:Z,editHistory:ee,messageId:H,sortOrderMs:l.result,threadId:G},ne=le(U.result);ne!=null&&(te.xContentType=ne);var oe=o("EchoDecodingUtils").echoDecodeAddressField(n,b);oe.success&&oe.result!=null&&(te.from=oe.result);var de=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,L);de.success&&de.result!=null&&(te.isTombstoned=de.result);var me=o("EchoDecodingUtils").echoDecodeStringField(n,v);me.success&&me.result!=null&&(te.text=me.result);var pe=o("EchoDecodingUtils").echoDecodeStringField(n,S);if(pe.success&&pe.result!=null){var _e=ae(pe.result);te.textSize=_e}var fe=o("EchoDecodingUtils").echoDecodeStringField(n,M);if(fe.success&&fe.result!=null){var ge=ue(fe.result);te.xMessagePlaceholderType=ge}var he=o("EchoDecodingUtils").echoDecodeStringField(n,R);he.success&&he.result!=null&&(te.sendError=he.result);var ye=o("EchoDecodingUtils").echoDecodeNullableIntField(n,E);ye.success&&ye.result!=null&&(te.expireTimestampMs=ye.result);var Ce=o("EchoDecodingUtils").echoDecodeNullableIntField(n,k);Ce.success&&Ce.result!=null&&(te.deleteTimestampMs=Ce.result);var be=o("EchoDecodingUtils").echoDecodeNullableIntField(n,I);be.success&&be.result!=null&&(te.ephemeralDurationInSec=be.result);var ve=o("EchoDecodingUtils").echoDecodeStringField(n,K);ve.success&&ve.result!=null&&ve.result==="view_once"&&(te.viewOnce=!0);var Se=o("EchoDecodingUtils").echoDecodeNullableIntField(n,C);Se.success&&Se.result!=null&&(te.authoritativeTimestampMs=Se.result);var Re=o("EchoMessageReceiptStatusFieldUtils").echoMessageDecodeReceiptStatusDataFields(n);Re.length>0&&(te.receiptStatusList=Re);var Le=o("EchoDecodingUtils").echoDecodeNullableBooleanField(n,$);Le.success&&Le.result!=null&&(te.isForwarded=Le.result),o("EchoMessageMediaGroupFieldUtil").decodeMessageMediaGroupFields(n,te);var Ee=o("EchoDecodingUtils").echoDecodeStringField(n,P);Ee.success&&Ee.result!=null&&(te.xOfflineThreadingId=Ee.result);var ke=o("EchoDecodingUtils").echoDecodeStringField(n,N);ke.success&&ke.result!=null&&(te.xThreadId=ke.result);var Ie=o("EchoDecodingUtils").echoDecodeStringField(n,O);Ie.success&&Ie.result!=null&&(te.serializationOrigin=ce(Ie.result));var Te=o("EchoDecodingUtils").echoDecodeNullableIntField(n,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION);te.version=Te.success&&Te.result!=null?Te.result:Q;var De=o("EchoDecodingUtils").echoDecodeAddressListField(n,w);De.success&&De.result!=null&&(te.reactions=De.result);var xe=o("EchoDecodingUtils").echoDecodeAddressListField(n,A);xe.success&&xe.result!=null&&(te.reactionAuthoritativeTimestampMs=xe.result);var $e=o("EchoDecodingUtils").echoDecodeAddressListField(n,F);$e.success&&$e.result!=null&&(te.reactionXOfflineThreadingIds=$e.result);var Pe=o("EchoMessageQuoteFieldUtils").echoMessageDecodeQuoteFields(n);Pe!=null&&(te.quoteData=Pe);var Ne=(te==null?void 0:te.contentType)===J.XMA&&n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE)&&(n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID)||n.has(o("EchoMessageMediaFieldUtils").ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS)),Me=n.has(j);if(n.has(j)){var we=o("EchoMessageMediaFieldUtils").decodeReceiverFetchData(n),Ae=o("EchoDecodingUtils").echoDecodeStringField(n,j),Fe=Ae.result,Oe=Ae.success;we==null||!Oe||Fe==null?o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode media data for Receiver Fetch, Message origin: ",""])),te.serializationOrigin):(te.receiverFetchData=we,te.receiverFetchId=Fe)}if(((te==null?void 0:te.contentType)===J.MEDIA||Ne)&&!Me){var Be=o("EchoMessageMediaFieldUtils").echoMessageDecodeMediaDataFields(n,te==null?void 0:te.contentType,te==null?void 0:te.xContentType),We="[labyrinth_web] mandatory media data is missing from media message, msgId: "+te.messageId+".";Be!=null?(Be.length!==1&&Be.length!==2&&((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin)),te.mediaData=Be[0],Be.length===2&&(te.previewMediaData=Be[1])):((te==null?void 0:te.contentType)===J.MEDIA&&o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin),(te==null?void 0:te.contentType)===J.XMA&&o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," Message origin: ",""])),We,te.serializationOrigin))}if(te.contentType===J.PLACEHOLDER&&te.contentSubtype===Y.UNSEND){var qe=o("EchoDecodingUtils").echoDecodeNullableIntField(n,B);qe.success&&qe.result!=null&&(te.revokeSentTimestampMs=qe.result);var Ue=o("EchoDecodingUtils").echoDecodeNullableIntField(n,W);Ue.success&&Ue.result!=null&&(te.revokeUnsentTimestampMS=Ue.result)}if(te.contentType===J.XMA){var Ve=o("EchoMessageXMAFieldUtils").decodeXMAFields(n);if(Ve!=null)te.xmaData=Ve;else return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mandatory xma data is missing from xma message, msgId: ",""])),te.messageId),null}return te}else return null}function ae(e){var t;return(t=X.cast(e))!=null?t:X.NONE}function ie(e){var t;return(t=J.cast(e))!=null?t:J.TEXT}function le(e){return Z.cast(e)}function se(e){var t;return(t=Y.cast(e))!=null?t:Y.NONE}function ue(e){var t;return(t=ee.cast(e))!=null?t:ee.NO_PLACEHOLDER}function ce(e){var t;return(t=te.cast(e))!=null?t:te.UNKNOWN}function de(e,t){var n,r;(r=o("EchoEncodingUtils")).echoSetStringField(e,f,t.messageId),r.echoSetStringField(e,g,t.threadId),r.echoSetIntField(e,h,t.sortOrderMs),r.echoSetIntField(e,y,t.displayTimestampMs),r.echoSetIntField(e,C,t.authoritativeTimestampMs),r.echoSetAddressField(e,b,t.from),r.echoSetStringField(e,v,t.text),t.textSize!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.textSize),t.xMessagePlaceholderType!=null&&o("EchoEncodingUtils").echoSetStringField(e,M,t.xMessagePlaceholderType),o("EchoEncodingUtils").echoSetStringField(e,R,t.sendError),o("EchoEncodingUtils").echoSetBooleanField(e,L,t.isTombstoned),o("EchoEncodingUtils").echoSetIntField(e,E,t.expireTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,k,t.deleteTimestampMs),o("EchoEncodingUtils").echoSetIntField(e,I,t.ephemeralDurationInSec),t.contentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.contentType),t.xContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,D,t.xContentType),o("EchoMessageReceiptStatusFieldUtils").echoMessageSetReceiptStatusDataFields(e,t.receiptStatusList),o("EchoEncodingUtils").echoSetBooleanField(e,$,t.isForwarded),o("EchoEncodingUtils").echoSetStringField(e,P,t.xOfflineThreadingId),o("EchoEncodingUtils").echoSetStringField(e,N,t.xThreadId),o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").ECHO_COMMON_FIELD_DOCUMENT_VERSION,t.version),t.contentSubtype!=null&&o("EchoEncodingUtils").echoSetStringField(e,x,t.contentSubtype),o("EchoEncodingUtils").echoSetAddressListField(e,w,t.reactions),o("EchoEncodingUtils").echoSetAddressListField(e,A,t.reactionAuthoritativeTimestampMs),o("EchoEncodingUtils").echoSetAddressListField(e,F,t.reactionXOfflineThreadingIds),o("EchoMessageQuoteFieldUtils").echoMessageSetQuoteFields(e,t),t.serializationOrigin!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.serializationOrigin),t.revokeSentTimestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,B,t.revokeSentTimestampMs),t.revokeUnsentTimestampMS!=null&&o("EchoEncodingUtils").echoSetIntField(e,W,t.revokeUnsentTimestampMS),o("EchoMessageMediaGroupFieldUtil").echoMessageSetMediaGroupFields(e,t);var a=t.xmaData;a!=null&&o("EchoMessageXMAFieldUtils").echoMessageSetXMAFields(e,a),((n=t.editHistory)==null?void 0:n.length)>0&&(o("EchoEncodingUtils").echoSetIntField(e,q,t.editCount),t.editHistory.forEach(function(t){var n=t.messageId;n!=null&&(o("EchoEncodingUtils").echoSetStringField(e,U+n,t.text),o("EchoEncodingUtils").echoSetIntField(e,V+n,t.timestamp*1e3))})),t.receiverFetchId!=null&&o("EchoEncodingUtils").echoSetStringField(e,j,t.receiverFetchId)}l.ECHO_SERIALIZATION_ORIGIN=O,l.ECHO_MESSAGE_FIELD_NAME_EDIT_COUNT=q,l.ECHO_MESSAGE_FIELD_NAME_EDIT_CONTENT_PREFIX=U,l.ECHO_MESSAGE_FIELD_NAME_EDIT_TS_PREFIX=V,l.ECHO_MESSAGE_FIELD_GROUP_ID=H,l.ECHO_MESSAGE_FIELD_GROUP_INDEX=G,l.ECHO_MESSAGE_FIELD_GROUP_SIZE=z,l.ECHO_MESSAGE_FIELD_RECEIVER_FETCH_ID=j,l.ECHO_MESSAGE_FIELD_NAME_EPHEMERALITY_TYPE=K,l.ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION=Q,l.MessageTextSize=X,l.EchoMessageContentSubtype=Y,l.EchoMessageContentType=J,l.EchoXMessageContentType=Z,l.EchoMessagePlaceholderType=ee,l.EchoSerializationOriginType=te,l.encodeEchoMessage=ne,l.decodeEchoMessage=oe}),98);
__d("EchoMessageMediaFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","EchoMessage","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R="X-Object-Id",L="X-Attachment-Object-Ids",E="Attachment-Type",k="Content-Type",I="X-Encrypted-Hash",T="X-Attachment-Type",D="X-Backup-Ent-Fbid",x="X-Backup-Status",$="X-Content-Type",P="X-Direct-Path",N="Height",M="X-Media-Key",w="X-Media-Key-Timestamp",A="Playable-Duration",F="Preview-Height",O="Preview-Content-Type",B="Preview-Width",W="Size",q="Width",U="X-Plaintext-Hash",V="File-Name",H="Header-Attribution-Content-Type",G=(S=n("$InternalEnum"))({IMAGE:"image",STICKER:"sticker",VIDEO:"video",GIF:"animated_image",PTT:"audio",XMA:"xma",DOCUMENT:"document"}),z=S({IMAGE_JPEG:"image/jpeg",IMAGE_PNG:"image/png",STICKER:"image/webp",GIF:"image/gif",AUDIO_MP4:"audio/mp4",AUDIO_WAV:"audio/wav",XMA:"xma"}),j=S({INVALID:"-1",IMAGE:"0",PTT:"1",AUDIO:"2",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",PROFILE_PICTURE:"7",APP_STATE:"8",HISTORY_SYNC:"9",THUMBNAIL_IMAGE:"10",THUMBNAIL_VIDEO:"11",THUMBNAIL_GIF:"12",THUMBNAIL_DOCUMENT:"13",THUMBNAIL_LINK:"14",NOVI_IMAGE:"15",NOVI_VIDEO:"16",KYCID:"17",WAFFLE_IMAGE:"18",WAFFLE_VIDEO:"19",WAFFLE_GIF:"20",PAYMENT_BG_IMAGE:"21",XMA_IMAGE:"22",PAYMENT_BR_DOCUMENT:"23",BIZ_COVER_PHOTO:"24",MESSENGER_PREVIEW:"25"}),K=S({FULL:"full",PREVIEW:"preview"});function Q(t,n){var r=t.attachmentObjectId,a=t.attachmentType,i=t.backupEntFbid,l=t.directPath,p=t.filename,_=t.encryptedHash,f=t.height,g=t.mediaBackupStatus,h=t.mediaContentType,y=t.mediaKey,C=t.mediaKeyTimestamp,b=t.mediaPlayableDuration,v=t.plaintextHash,S=t.previewContentHeight,R=t.previewContentType,L=t.previewContentWidth,E=t.size,k=t.width,I=t.xAttachmentType,T=t.xContentType,D=t.xmaData,x=t.mediaEntryData;if(r==null)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment object id from required media metadata fields, msgId: ",""])),n);else if(a==null)o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing attachment type from required media metadata fields, msgId: ",""])),n);else if(l==null)o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing direct path field from required media metadata fields, msgId: ",""])),n);else if(v==null)o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing plaintextHash field from required media metadata fields, msgId: ",""])),n);else if(T==null)o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xContentType field from required media metadata fields, msgId: ",""])),n);else if(I==null)o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xAttachmentType field from required media metadata fields, msgId: ",""])),n);else return{attachmentObjectId:r,attachmentType:a,backupEntFbid:i,directPath:l,encryptedHash:_,filename:p,height:f,mediaBackupStatus:g,mediaContentType:h,mediaEntryData:x,mediaKey:y,mediaKeyTimestamp:C,mediaPlayableDuration:b,plaintextHash:v,previewContentHeight:S,previewContentType:R,previewContentWidth:L,size:E,width:k,xAttachmentType:I,xContentType:T,xmaData:D}}function X(e,t){var n;(n=o("EchoEncodingUtils")).echoSetStringField(e,R,t.attachmentObjectId),n.echoSetStringField(e,E,t.attachmentType),n.echoSetStringField(e,U,t.plaintextHash),n.echoSetStringField(e,I,t.encryptedHash),n.echoSetIntField(e,W,t.size),n.echoSetStringField(e,M,t.mediaKey),n.echoSetIntField(e,w,t.mediaKeyTimestamp),n.echoSetStringField(e,P,t.directPath),t.mediaContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.mediaContentType),o("EchoEncodingUtils").echoSetIntField(e,q,t.width),o("EchoEncodingUtils").echoSetIntField(e,N,t.height),t.previewContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,O,t.previewContentType),t.headerAttributionContentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,H,t.headerAttributionContentType),o("EchoEncodingUtils").echoSetIntField(e,B,t.previewContentWidth),o("EchoEncodingUtils").echoSetIntField(e,F,t.previewContentHeight),o("EchoEncodingUtils").echoSetIntField(e,A,t.mediaPlayableDuration),t.xAttachmentType!=null&&o("EchoEncodingUtils").echoSetStringField(e,T,t.xAttachmentType),o("EchoEncodingUtils").echoSetStringField(e,$,t.xContentType),o("EchoEncodingUtils").echoSetStringField(e,D,t.backupEntFbid),o("EchoEncodingUtils").echoSetStringField(e,x,t.mediaBackupStatus),o("EchoEncodingUtils").echoSetStringField(e,V,t.filename)}function Y(e,t,n){var r={},a=!1,i=!1,l=!1;if(ne(e)){var s=re(e,t,n);if(s==null)return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: primary attachment object id is null. msgType: "," mediaType: ",""])),t,n),null;s.length!==2&&o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to get primary and secondary attachment object ids"])));var u=!1,c=!1,d=!1,m=s[0],f=s[1],g={};if(a=ee(e,r,m),u=ee(e,g,f),i=Z(e,r,t,m,m),c=Z(e,g,t,f,m),l=J(e,r,m),d=J(e,g,f),!a||!i||!l||!u||!c||!d)return null;var h=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,y=Q(r,h),C=Q(g,h);if(y!=null&&C!=null)return[y,C]}else{if(a=ee(e,r),i=Z(e,r,t),l=J(e,r),!a||!i||!l)return null;var b=Q(r);if(b!=null)return[b]}return null}function J(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=[{fieldName:"height",id:N},{fieldName:"width",id:q},{fieldName:"size",id:W},{fieldName:"previewContentHeight",id:F},{fieldName:"previewContentWidth",id:B},{fieldName:"mediaKeyTimestamp",id:n!=null?n+"-"+w:w}],s=[{attachmentTypes:[j.VIDEO,j.AUDIO],fieldName:"mediaPlayableDuration",id:A}];for(var u of s){var c=u.attachmentTypes,d=u.fieldName,m=u.id,p=o("EchoDecodingUtils").echoDecodeIntField(e,m),_=p.result,g=p.success;if(g&&_!=null)t[d]=_;else if(!(t.xAttachmentType!=null&&!te(c,t.xAttachmentType)||t.attachmentType===G.XMA))return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. xAttachmentType: ",", AttachmentType: ",". EchoOrigin: "," xOfflineThreadingId: ",""])),d,t.xAttachmentType,t.attachmentType,i,a),!1}return l.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeIntField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function Z(e,t,n,r,a){var i,l=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,s,u,c,d=(i=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?i:"",m=[{fieldName:"filename",id:V}];r!=null&&a!=null?(t.attachmentObjectId=r,s=[{fieldName:"plaintextHash",id:r+"-"+U},{fieldName:"directPath",id:r+"-"+P},{fieldName:"xContentType",id:r+"-"+$}],m.push({fieldName:"mediaKey",id:r+"-"+M}),u=a+"-"+D,c=r+"-"+I):(s=[{fieldName:"attachmentObjectId",id:R},{fieldName:"plaintextHash",id:U},{fieldName:"directPath",id:P},{fieldName:"xContentType",id:$}],m.push({fieldName:"mediaKey",id:M}),u=D,c=I),m.push({fieldName:"backupEntFbid",id:u}),m.push({fieldName:"mediaContentType",id:k}),m.push({fieldName:"encryptedHash",id:c});var p=a!=null?a+"-"+x:x;m.push({fieldName:"mediaBackupStatus",id:p});var _=[];for(var f of s){var y=f.fieldName,C=f.id,b=o("EchoDecodingUtils").echoDecodeStringField(e,C),v=b.result,S=b.success;S&&v!=null?t[y]=v:_.push(y)}if(_.length>0){var L=_.join(", ");return n===o("EchoMessage").EchoMessageContentType.XMA?o("WALogger").WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: ",""])),L,t.attachmentType,d):o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields. AttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),L,t.attachmentType,d,l),!1}return m.map(function(n){var r=n.fieldName,a=n.id,i=o("EchoDecodingUtils").echoDecodeStringField(e,a),l=i.result,s=i.success;s&&l!=null&&(t[r]=l)}),!0}function ee(e,t,n){var r,a=o("EchoDecodingUtils").echoDecodeStringField(e,"X-Offline-Threading-ID").result,i=(r=e.get(o("EchoMessage").ECHO_SERIALIZATION_ORIGIN))!=null?r:"",l=o("EchoDecodingUtils").echoDecodeStringField(e,E),s=l.result==="file"?G.DOCUMENT:G.cast(l.result);s!=null&&(t.attachmentType=s);var u=o("EchoDecodingUtils").echoDecodeStringField(e,O),c=z.cast(u.result);c!=null&&(t.previewContentType=c);var d=o("EchoDecodingUtils").echoDecodeStringField(e,H),m=d.result;m!=null&&(t.headerAttributionContentType=m);var p=o("EchoDecodingUtils").echoDecodeStringField(e,n!=null?n+"-"+T:T),_=null;return p.success&&p.result!=null&&(_=oe(p.result),_!=null&&(t.xAttachmentType=_)),s!=null&&(c!=null||s===G.DOCUMENT||s===G.PTT)?!0:(o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing enum fields from media fields: attachmentType: "," mediaPreviewContentType: "," mediaAttachmentType: "," EchoOrigin: "," xOfflineThreadingId: ",""])),s,c,p,i,a),!1)}function te(e,t){return e.reduce(function(e,n){return e||n===t},!1)}function ne(e){return e.has(L)}function re(e,t,n){var r=o("EchoDecodingUtils").echoDecodeObjectIdListField(e,L),a=r.result,i=r.success;if(!i||a==null||a.length!==2)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] multi blob media message: can not parse objects ids. "," msgType: "," mediaType: ",""])),a,t,n),null;var l=a.find(function(t){var n=t+"-"+x,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null)return!0});if(l!=null){var s=l===a[0]?a[1]:a[0];return[l,s]}if(l=a.find(function(t){var n=t+"-"+$,r=o("EchoDecodingUtils").echoDecodeStringField(e,n),a=r.result,i=r.success;if(i&&a!=null&&K.cast(a)===K.FULL)return!0}),l!=null){var u=l===a[0]?a[1]:a[0];return[l,u]}return a}function oe(e){var t=j.cast(e);return t==null&&o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Invalid media attachment type: ",""])),e),t!=null?t:j.INVALID}function ae(e){var t={},n=ee(e,t);if(!n)return null;var r=o("EchoDecodingUtils").echoDecodeStringField(e,k),a=o("EchoDecodingUtils").echoDecodeIntField(e,N),i=o("EchoDecodingUtils").echoDecodeIntField(e,q),l=o("EchoDecodingUtils").echoDecodeStringField(e,E);return!r.success||!a.success||!i.success||!l.success||r.result==null||a.result==null||i.result==null||l.result==null?(o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing media fields for receiver fetch"]))),null):{mimetype:r.result,previewHeight:a.result,previewWidth:i.result,type:l.result}}l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_ID=R,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_OBJECT_IDS=L,l.ECHO_MESSAGE_FIELD_NAME_ATTACHMENT_TYPE=E,l.AttachmentType=G,l.EchoMessageMediaPreviewType=z,l.EchoMessageActMediaAttachmentType=j,l.convertMediaMetadataDetailsToMediaMetadata=Q,l.echoMessageSetMediaMetadataFields=X,l.echoMessageDecodeMediaDataFields=Y,l.setMediaIntFields=J,l.setMediaEnumFields=ee,l.getAttachmentObjectIdsFromMultiBlobMediaMsg=re,l.decodeReceiverFetchData=ae}),98);
__d("EchoMessageMediaGroupFieldUtil",["EchoDecodingUtils","EchoEncodingUtils","EchoMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){t.groupId!=null&&o("EchoEncodingUtils").echoSetStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID,t.groupId),t.groupIndex!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX,t.groupIndex),t.groupSize!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE,t.groupSize)}function s(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_ID);n.success&&n.result!=null&&(t.groupId=n.result);var r=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_INDEX);r.success&&r.result!=null&&(t.groupIndex=r.result);var a=o("EchoDecodingUtils").echoDecodeIntField(e,o("EchoMessage").ECHO_MESSAGE_FIELD_GROUP_SIZE);a.success&&a.result!=null&&(t.groupSize=a.result)}l.echoMessageSetMediaGroupFields=e,l.decodeMessageMediaGroupFields=s}),98);
__d("EchoMessageQuoteFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils"],(function(t,n,r,o,a,i,l){"use strict";var e="Reply-Message-Id",s="Reply-Message-Sender",u="Reply-Sort-Order",c="Reply-Type",d="Reply-Status",m=n("$InternalEnum").Mirrored(["BUMP"]),p=n("$InternalEnum")({VALID:"valid"});function _(e){var t={quoteMessageId:"<not set>",quoteMessageSender:{localKey:"<not set>",transportKey:"<not set>"},quoteSortOrderInMs:0},n=g(e,t),r=h(e,t),o=y(e,t),a=C(e,t);return!n||!r||!o||!a?null:t}function f(t,n){var r=n.quoteData;r!=null&&(o("EchoEncodingUtils").echoSetStringField(t,e,r.quoteMessageId),o("EchoEncodingUtils").echoSetAddressField(t,s,r.quoteMessageSender),o("EchoEncodingUtils").echoSetIntField(t,u,r.quoteSortOrderInMs),r.status!=null&&o("EchoEncodingUtils").echoSetStringField(t,d,r.status),r.replyType!=null&&o("EchoEncodingUtils").echoSetStringField(t,c,r.replyType))}function g(e,t){var n=[{fieldName:"quoteMessageSender",id:s}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeAddressField(e,i),u=l.result,c=l.success;if(c&&u!=null)t[a]=u;else return!1}return!0}function h(t,n){var r=[{fieldName:"quoteMessageId",id:e}];for(var a of r){var i=a.fieldName,l=a.id,s=o("EchoDecodingUtils").echoDecodeStringField(t,l),u=s.result,c=s.success;if(c&&u!=null)n[i]=u;else return!1}return!0}function y(e,t){var n=[{fieldName:"quoteSortOrderInMs",id:u}];for(var r of n){var a=r.fieldName,i=r.id,l=o("EchoDecodingUtils").echoDecodeIntField(e,i),s=l.result,c=l.success;if(c&&s!=null)t[a]=s;else return!1}return!0}function C(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,c),r=m.cast(n.result);r!=null&&(t.replyType=r);var a=o("EchoDecodingUtils").echoDecodeStringField(e,d),i=p.cast(a.result);return i!=null&&(t.status=i),!0}l.EchoMessageQuoteReplyType=m,l.EchoMessageQuoteStatus=p,l.echoMessageDecodeQuoteFields=_,l.echoMessageSetQuoteFields=f}),98);
__d("EchoMessageReceiptStatusFieldUtils",["$InternalEnum","EchoCommonUtils","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s="Receipt-Status",u="Receipt-Timestamp",c=n("$InternalEnum")({UNKNOWN:"unknown",SENDING:"sending",SERVER_RECEIVED:"server_received",DELIVERED:"delivered",READ:"read",ERROR:"error",NON_RETRYABLE_ERROR:"non_retryable_error"});function d(e,t){t==null||t.length===0||t.forEach(function(t){o("EchoEncodingUtils").echoSetStringField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,s),t.status),t.timestampMs!=null&&o("EchoEncodingUtils").echoSetIntField(e,o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(t.address,u),t.timestampMs)})}function m(e){var t=[];return p(e).forEach(function(n){var r=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,s),a=o("EchoDecodingUtils").echoDecodeStringField(e,r);if(a.success){var i,l=(i=c.cast(a.result))!=null?i:c.UNKNOWN,d=o("EchoCommonUtils").getEchoAddressFieldNameWithSuffix(n,u),m=o("EchoDecodingUtils").echoDecodeNullableIntField(e,d);m.result!=null?t.push({address:n,status:l,timestampMs:m.result}):t.push({address:n,status:l})}}),t}function p(t){var n=new Set;for(var r of t.keys())if(r.includes(s))try{var a=r.split("@"),i=a[0],l=_(a[1]);n.add({localKey:i,transportKey:l})}catch(t){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error occurred while decoding participants from echo doc, error: ",""])),t)}return Array.from(n)}function _(e){var t=e.split(s);return t[0].split("-")[0]}l.MessageReceiptStatus=c,l.echoMessageSetReceiptStatusDataFields=d,l.echoMessageDecodeReceiptStatusDataFields=m}),98);
__d("EchoMessageXMAFieldUtils",["$InternalEnum","EchoDecodingUtils","EchoEncodingUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="XMA-Default-CTA",m="XMA-Gating-Type",p="XMA-Header-Subtitle",_="XMA-Header-Title",f="XMA-Is-Tombstoned",g="XMA-Layout-Type",h="XMA-Max-Subtitle-Num-Lines",y="XMA-Max-Title-Num-Lines",C="XMA-Subtitle-Text",b="XMA-Target-Expiry",v="XMA-Target-ID",S="XMA-Target-Type",R="XMA-Target-Username",L="XMA-Title-Text",E="XMA-Content-Ref",k="XMA-Dataclass",I=n("$InternalEnum").Mirrored(["SINGLE","HSCROLL","VSTACK","PORTRAIT","STANDARD_DXMA","LIST_DXMA","GRID"]),T=n("$InternalEnum").Mirrored(["NONE","IG_STORY_PHOTO_MENTION","IG_SINGLE_IMAGE_POST_SHARE","IG_MULTIPOST_SHARE","IG_SINGLE_VIDEO_POST_SHARE","IG_STORY_PHOTO_SHARE","IG_STORY_VIDEO_SHARE","IG_CLIPS_SHARE","IG_IGTV_SHARE","IG_SHOP_SHARE","IG_PROFILE_SHARE","IG_STORY_PHOTO_HIGHLIGHT_SHARE","IG_STORY_VIDEO_HIGHLIGHT_SHARE","IG_STORY_REPLY","IG_STORY_REACTION","FB_FEED_SHARE","FB_STORY_REPLY","FB_STORY_SHARE","FB_STORY_MENTION","FB_FEED_VIDEO_SHARE","FB_GAMING_CUSTOM_UPDATE","FB_PRODUCER_STORY_REPLY","FB_PROFILE_DIRECTORY_ITEM","FB_FEED_POST_REACTION_REPLY","MSG_EXTERNAL_LINK_SHARE","MSG_RECEIVER_FETCH","RTC_AUDIO_CALL","RTC_VIDEO_CALL","RTC_MISSED_AUDIO_CALL","RTC_MISSED_VIDEO_CALL","RTC_GROUP_AUDIO_CALL","RTC_GROUP_VIDEO_CALL","FB_EVENT","FB_SHORT","MSG_LOCATION_SHARING","MSG_LOCATION_SHARING_V2","MSG_MEMORIES_SHARE"]),D=n("$InternalEnum").Mirrored(["NONE","PRIVATE","SENSITIVE","MISINFORMATION","MEDIA_LABEL","POST_COVER","POST_LABEL","WARNING_SCREENS","INFO","EYE_OFF","NEWS_OFF","WARNING"]);function x(e,t){t.xmaLayoutType!=null&&o("EchoEncodingUtils").echoSetStringField(e,g,t.xmaLayoutType),t.xmaTargetType!=null&&o("EchoEncodingUtils").echoSetStringField(e,S,t.xmaTargetType),o("EchoEncodingUtils").echoSetStringField(e,R,t.xmaTargetUsername),o("EchoEncodingUtils").echoSetStringField(e,v,t.xmaTargetId),t.xmaTargetExpiry!=null&&o("EchoEncodingUtils").echoSetIntField(e,b,t.xmaTargetExpiry),o("EchoEncodingUtils").echoSetStringField(e,d,t.xmaDefaultCTA),o("EchoEncodingUtils").echoSetStringField(e,_,t.xmaHeaderTitle),o("EchoEncodingUtils").echoSetStringField(e,p,t.xmaHeaderSubtitle),o("EchoEncodingUtils").echoSetStringField(e,L,t.xmaTitleText),o("EchoEncodingUtils").echoSetStringField(e,C,t.xmaSubtitleText),t.xmaMaxTitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,y,t.xmaMaxTitleNumLines),t.xmaMaxSubtitleNumLines!=null&&o("EchoEncodingUtils").echoSetIntField(e,h,t.xmaMaxSubtitleNumLines),t.xmaGatingType!=null&&o("EchoEncodingUtils").echoSetStringField(e,m,t.xmaGatingType),t.xmaDataclass!=null&&o("EchoEncodingUtils").echoSetStringField(e,k,t.xmaDataclass),o("EchoEncodingUtils").echoSetBooleanField(e,f,t.xmaIsTombstoned),t.xmaContentRef!=null&&o("EchoEncodingUtils").echoSetStringField(e,E,t.xmaContentRef)}function $(t){var n=M(t,f);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing xmaIsTombstoned from xma fields"]))),null;var r=D.cast(o("EchoDecodingUtils").echoDecodeStringField(t,m).result),a=I.cast(o("EchoDecodingUtils").echoDecodeStringField(t,g).result),i=T.cast(o("EchoDecodingUtils").echoDecodeStringField(t,S).result);return{xmaContentRef:P(t,E),xmaDataclass:P(t,k),xmaDefaultCTA:P(t,d),xmaGatingType:r,xmaHeaderSubtitle:P(t,p),xmaHeaderTitle:P(t,_),xmaIsTombstoned:n,xmaLayoutType:a,xmaMaxSubtitleNumLines:N(t,h),xmaMaxTitleNumLines:N(t,y),xmaSubtitleText:P(t,C),xmaTargetExpiry:N(t,b),xmaTargetId:P(t,v),xmaTargetType:i,xmaTargetUsername:P(t,R),xmaTitleText:P(t,L)}}function P(e,t){var n=o("EchoDecodingUtils").echoDecodeStringField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from media fields"])),t)}function N(e,t){var n=o("EchoDecodingUtils").echoDecodeIntField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}function M(e,t){var n=o("EchoDecodingUtils").echoDecodeBooleanField(e,t),r=n.result,a=n.success;if(a&&r!=null)return r;o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Missing "," from xma fields"])),t)}l.XMALayoutType=I,l.XMAContentType=T,l.XMAGatingType=D,l.echoMessageSetXMAFields=x,l.decodeXMAFields=$}),98);
__d("EncryptedBackupsAttachmentProductType",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum")({MSGR:"msgr",IGD:"igd"}),l=e;i.default=l}),66);
__d("IGDWEBUploadMessageUtils",["I64","MAWExtractMsFromExternalId","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){var r=o("MAWExtractMsFromExternalId").extractMsFromExternalId((s||(s=o("I64"))).of_string(t));return r==null&&o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[sortOrder] Could not extract ms from externalId: ",""])),t),o("WATimeUtils").castToMillisTime(Number(n)*1e3+(r!=null?r:0))}l.generateProtobufServerTs=u}),98);
__d("EncryptedBackupsUploadEntity",["$InternalEnum","EncryptedBackupsUtils","IGDWEBUploadMessageUtils","WAArmadilloBackupMessage.pb","WAByteArray","WAGlobals","WAJids","WATimeUtils","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e instanceof ArrayBuffer?new Uint8Array(e):e}var s=n("$InternalEnum").Mirrored(["NEEDS_BACKUP","COMPLETED","NEEDS_BACKUP_RETRY","PERMANENT_FAILURE","EXPIRED","THREAD_DELETED","DELETION_PURGED","MESSAGE_DELETED","UPLOADING"]),u=n("$InternalEnum")({INVALID:"-1",IMAGE:"0",PTT:"1",DOCUMENT:"3",VIDEO:"4",GIF:"5",STICKER:"6",XMA:"22",MESSENGER_PREVIEW:"25"});function c(e){return e}function d(e){var t=e.messageApplication,n=e.msgId,r=e.reportingMeta,a=e.sortOrderMs,i=o("WAJids").authorToUserId(n.author,o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()));return o("encodeProtobuf").encodeProtobuf(o("WAArmadilloBackupMessage.pb").BackupMessageSpec,o("EncryptedBackupsUtils").asBackupMessage(i,n.externalId,a,r!=null?r:{frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},t)).readByteArrayView()}function m(e){return o("WAByteArray").uint8ArrayToBuffer(e)}function p(e){var t=e.attachmentContext,n=e.backupDirective,r=e.dbMsgType,a=e.instanceKey,i=e.isOpenEB,l=e.isRetroactiveUpload,u=e.legacyAttachmentContext,c=e.messageApplication,m=e.msgId,p=e.originalMsgProtocolId,_=e.reportingMeta,f=e.retryCount,g=e.senderId,h=e.serverTs,y=e.sortOrderMs,C=e.tags,b=e.triggerSource,v=d({messageApplication:c,msgId:m,reportingMeta:_,sortOrderMs:n.actionType===4?o("IGDWEBUploadMessageUtils").generateProtobufServerTs(m.externalId,h):y}),S={backupActionType:n.actionType,backupDirective:n,dbMsgType:r,failTsMs:o("WATimeUtils").castToMillisTime(0),instanceKey:a,isOpenEB:i,isRetroactiveUpload:l,msgId:m,msgIdKey:o("EncryptedBackupsUtils").convertWAMsgIdToStringId(m),msgType:"text",originalMsgProtocolId:p,protobuf:v,retryCount:f,senderId:g,serverTs:h,sortOrderMs:y,supplementalKey:n.supplementalKey,tags:C,triggerSource:b,uploadStatus:s.NEEDS_BACKUP,uploadTsSec:o("WATimeUtils").unixTime()};return t!=null&&(S=babelHelpers.extends({},S,{attachmentContext:t,legacyAttachmentContext:u,msgType:"media"})),S}l.toEbBackupMessageBytes=e,l.EbUploadStatus=s,l.AttachmentContextMediaType=u,l.castToEBQueueId=c,l.encodeBackupMessage=d,l.getEbBackupMessageBytesBuffer=m,l.asEBUploadEntity=p}),98);
__d("MAWBridgeThread",["MAWTimeUtils","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return!0},user:function(t){return!1}});return{authoritativeThreadKey:n,cannotReplyReason:e.cannotReplyReason,clientThreadKey:t,description:r,folder:e.folder,instanceKey:a,isGroup:i,jid:e.jid,lastReadTs:o("MAWTimeUtils").ensureValidMillisTime(e.lastReadMsgTs)||o("WATimeUtils").castToMillisTime(0)}}l.createBridgeThread=e}),98);
__d("MAWGetOrCreateThreadTxns",["MAWAdminMsgTxns","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThread","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWQplProxy","MAWThreadMappingQPL","MAWWriteBulkWriteIncomingAdminMsgTxns","WATimeUtils","getErrorSafe","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e!=null&&t!=null){var n=o("WATimeUtils").fromMillisTime(e),r=o("WATimeUtils").fromMillisTime(t);return o("WATimeUtils").castToMillisTime(Math.max(n,r))}return e!=null?e:t}function s(e,t){return e.threads.get({jid:t})}function u(e,t){return(r("gkx")("10029")?o("MAWDexieTable").dexieAll(t.map(function(t){return e.threads.get({jid:t})})).then(function(e){return e.filter(Boolean)}):e.threads.where("jid").anyOf(t).toArray()).then(function(e){var n=new Map;for(var r of e)n.set(r.jid,r);return t.map(function(e){return n.get(e)})})}function c(e,t,n){var a=t.instanceKey,i=t.jid;return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_start",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_start",{instanceKey:n}),s(e,i).then(function(a){return a==null?(n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"create-1-1-thread-start",{instanceKey:n}),p(e,t,n).then(function(e){return{created:!0,thread:e}})):g(e,t,a).then(function(e){return{created:!1,thread:e}})}).then(function(e){return o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"get_or_create_thread_end",{instanceKey:a}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"thread_mapping_get_or_create_thread_end",{instanceKey:n}),e})}function d(e,t,n){var r=n===void 0?{}:n,a=r.logState;return u(e,t.map(function(e){var t=e.jid;return t})).then(function(n){a==null||a("threadMapping2FetchedThreads");var r={},i=[],l=[];for(var s of n.entries()){var u=s[0],c=s[1];c==null?i.push(t[u]):l.push({params:t[u],thread:c})}return o("MAWDexieTable").dexieAll([i.length?_(e,i):o("MAWDexieTable").dexieResolve([]),l.length?h(e,l):o("MAWDexieTable").dexieResolve([])]).then(function(e){var n=e[0],o=e[1];a==null||a("threadMapping3ThreadsUpdated");for(var i of n){var l=i.adminMsgParams,s=i.thread;r[s.jid]={adminMsgParams:l,created:!0,thread:s}}for(var u of o)r[u.jid]={adminMsgParams:null,created:!1,thread:u};return t.map(function(e){var t=e.jid;return r[t]})})})}function m(e){var t,n=e.authoritativeThreadKey,r=e.clientThreadKey,a=e.createTs,i=e.deduplicationKey,l=e.folder,s=e.jid,u=e.lastActivityTimestamp,c=o("WATimeUtils").millisTime(),d=(t=u!=null?u:a)!=null?t:c,m={authoritativeThreadKey:n!=null?n:void 0,deduplicationKey:i,folder:l!=null?l:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:s,lastReadMsg:null,lastReadMsgReceiptSent:null,newestMsgTs:d,oldestMsg:null,optimisticThreadKey:r!=null?r:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(d,s)};return m}function p(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread,u=m(t);return e.threads.add(u).then(function(t){var c=babelHelpers.extends({},u,{chatId:t});return s!==!0&&o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)}),n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-e2ee-admin-msg-in-new-thread",{instanceKey:n}),o("MAWAdminMsgTxns").writeE2EEThreadDescriptionMsg(e,c,n)}).catch(function(e){var t=r("getErrorSafe")(e);throw l!=null&&o("MAWThreadMappingQPL").endFailureInWorker("create_thread_failed",l,{string:{createThreadFailureReason:t.message}}),t.message="Error creating thread: "+t.message,t})}function _(e,t){var n=t.map(m);return e.threads.bulkAdd(n,{allKeys:!0}).then(function(r){var a=r.map(function(e,r){return{data:babelHelpers.extends({},n[r],{chatId:e}),params:t[r]}});for(var i of a)i.params.skipVerifyThread!==!0&&o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(i.data,i.data.optimisticThreadKey,i.params.authoritativeThreadKey,i.params.description,i.params.instanceKey)});return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns(e,a.map(function(e){return e.data}))}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk creating threads: "+t.message,t})}function f(t,n,r){var o=n.authoritativeThreadKey,a=n.clientThreadKey,i=n.deduplicationKey,l=n.folder,s=n.lastActivityTimestamp,u={authoritativeThreadKey:o!=null?o:t.authoritativeThreadKey,cannotReplyReason:l!=null||a!=null?null:t.cannotReplyReason,deduplicationKey:l!=null||a!=null?i:t.deduplicationKey,folder:l!=null?l:t.folder,newestMsgTs:e(r,s),optimisticThreadKey:a!=null?a:t.optimisticThreadKey};return babelHelpers.extends({},t,u)}function g(e,t,n){var a=t.authoritativeThreadKey,i=t.description,l=t.instanceKey,s=t.skipVerifyThread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,n.jid).then(function(u){var c=f(n,t,u);return e.threads.update(n.chatId,c).then(function(){var e;return s!==!0&&o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(c,c.optimisticThreadKey,a,i,l)}),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:(e=c==null?void 0:c.folder)!=null?e:o("MAWFolderTypes").FOLDER_ID.INBOX,threadJid:c.jid})}),c}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error updating thread: "+t.message,t})})}function h(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.params,r=t.thread;return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,r.jid).then(function(e){var t=f(r,n,e);return{params:n,thread:t}})})).then(function(t){return e.threads.bulkUpdate(t.map(function(e){var t=e.thread;return{changes:t,key:t.chatId}})).then(function(){for(var e of t){var n=e.params,r=n.authoritativeThreadKey,a=n.description,i=n.instanceKey,l=n.skipVerifyThread,s=e.thread;l!==!0&&o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(s,s.optimisticThreadKey,r,a,i)})}return t.map(function(e){var t=e.thread;return t})})}).catch(function(e){var t=r("getErrorSafe")(e);throw t.message="Error bulk updating threads: "+t.message,t})}l.getExistingThread=s,l.bulkGetExistingThread=u,l.getOrCreateThread=c,l.bulkGetOrCreateThread=d,l.createThread=p,l.prepareUpdatedThreadData=f}),98);
__d("MAWAdminMsgTxns",["MAWDbMsg","MAWDbThread","MAWDbThreadTxns","MAWExternalId","MAWLocalizationType","MAWLocalizationUtils","MAWTimeUtils","MAWWriteBulkWriteIncomingAdminMsgTxns","MAWWriteMsgTxns","WALogger","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=e.ts,a=o("WATimeUtils").castUnixTimeToMillisTime(r),i=o("MAWTimeUtils").ensureValidMillisTime(n)||o("WATimeUtils").castToMillisTime(0),l=a>i?a:i;return babelHelpers.extends({},t,{newestMsgTs:l,oldestMsg:e.msgId,snippetMsg:e.msgId,snippetMsgTs:o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(e)),threadOrder:o("MAWDbThread").craftThreadOrder(l,t.jid)})}function u(t,n){return o("MAWDbThreadTxns").getThread(t,n).then(function(n){if(!n.success){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeReachabilityErrorAdminMsg failed to create or get 1:1 thread"])));return}var a=n.value,i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.REACHABILITY_ERROR,version:0},a.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(t,i,a).then(r("emptyFunction"))})}function c(e,t,n){return o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(e,[t],n).then(function(e){var t=e[0];return t})}function d(e){var t=o("MAWDbMsg").craftE2eeAdminMsgAltIndex(e.chatId),n=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.E2EE_THREAD_DESCRIPTION,version:0},e.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castToUnixTime(0),t);return babelHelpers.extends({},n,{msgId:o("MAWDbMsg").craftMsgIdV2(e.chatId,1,n),sortOrderMs:0})}l.getUpdatedThreadForAdminMsg=s,l.writeReachabilityErrorAdminMsg=u,l.writeE2EEThreadDescriptionMsg=c,l.buildE2EEThreadDescriptionMsg=d}),98);
__d("MAWBridgeTrace",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i,l,s){var u=e.ack,c=e.externalId,d=e.ts,m=e.type,p=o("WAJids").switchOnMsgrChatJidType(t,{group:function(t){return"Group"},user:function(t){return"User"}});return{ack:u,externalId:c,isFirstMsg:!!a,openMessageOtid:r,openMessageParticipantCount:i,participantCount:l,threadJid:t,threadKey:s,threadType:p,traceType:n,ts:d,type_:m}}function s(e,t,n){return{traceContext:n,traceId:t,traceType:e}}function u(e,t,n,r){return{errorMessage:r,event:t,externalIds:e,traceType:n}}function c(e,t,n,r,o,a){return{checkPointId:e,dataTraceId:t,errorMessage:n,shouldFlush:r,syncChannel:o,tags:a}}l.createBridgeStartTraceData=e,l.createBridgeStartTraceWithTraceIdData=s,l.createBridgeUpdateTraceData=u,l.createBridgeTraceRecordCheckpointData=c}),98);
__d("MAWAfterWriteMsgUtil",["$InternalEnum","ArmadilloDataTraceType","MAWBridgeMsg","MAWBridgeTrace","MAWDbMsg","MAWIndexedDb","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum").Mirrored(["DO_NOT_BUMP_THREAD","BUMP_LOCAL_ONLY","BUMP_LOCAL_AND_SERVER"]);function s(e){var t=e.dbMsg,n=e.isFirstMsg,r=e.openMessageOtid,a=e.openMessageParticipantCount,i=e.participantCount,l=e.quotedReplyAttachmentMeta,s=e.updatedThread,u=s.authoritativeThreadKey,c=s.jid;t.altIndex===o("MAWDbMsg").SPAM_ALT_INDEX||t.altIndex===o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX||(o("MAWIndexedDb").afterTransaction({tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(t,c,o("ArmadilloDataTraceType").armadilloMessageSend,r,n,a,i,u)}),o("MAWXMAUtils").isXMAStoryReply(t.xmaMessageType)||o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t,l)}))}l.WriteMsgAfterTxnBumpThreadOption=e,l.writeMsgAfterTransaction=s}),98);
__d("MAWWriteBulkWriteIncomingAdminMsgTxns",["MAWAdminMsgTxns","MAWAfterWriteMsgUtil","MAWDbMsgTxns","MAWDexieTable","MAWQplProxy","WALogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n){var r=[],a=[],i=[],l=new Map,s=new Map,u=n.map(function(e){return o("MAWDbMsgTxns").getThreadOldestMessageId(t,e.jid).then(function(t){return l.set(e.jid,t)})}),c=n.map(function(e){return o("MAWDbMsgTxns").getThreadNewestMessageMs(t,e.jid).then(function(t){return s.set(e.jid,t)})});return o("MAWDexieTable").dexieAll([u,c]).then(function(){return n.forEach(function(t){t==null&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["OfflineBulkWriteAdminmsg - Missing thread when write e2ee thread description"])));var n=o("MAWAdminMsgTxns").buildE2EEThreadDescriptionMsg(t),l=o("MAWAdminMsgTxns").getUpdatedThreadForAdminMsg(n,t,s.get(t.jid));r.push(n),i.push(l),a.push({dbMsg:n,isFirstMsg:!1,updatedThread:l})}),{afterTransactionSyncMsgsData:a,e2eeThreadAdminMsgs:r,threadsToUpdate:i}})}function u(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate,r=new Map;return t.forEach(function(e){var t=e.updatedThread.jid;r.set(t,{externalId:e.dbMsg.externalId,msgId:e.dbMsg.msgId})}),n.map(function(e){return{adminMsgParams:r.get(e.jid),thread:e}})})}function c(e,t,n){return d(e,t,n).then(function(e){var t=e.afterTransactionSyncMsgsData,n=e.threadsToUpdate;return t.forEach(function(e){return o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction(e)}),n})}function d(e,t,n){return s(e,t).then(function(t){var a=t.afterTransactionSyncMsgsData,i=t.e2eeThreadAdminMsgs,l=t.threadsToUpdate;return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-start",{instanceKey:n}),o("MAWDexieTable").dexieAll([e.messages.bulkAdd(i),e.threads.bulkPut(l)]).then(function(){return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"write-bulk-admin-msgs-end",{instanceKey:n}),{afterTransactionSyncMsgsData:a,threadsToUpdate:l}})})}l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithoutAfterTxns=u,l.writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns=c}),98);
__d("MAWBuildIncomingMsgs",["MAWAckLevel","MAWDbMsg","MAWMsgType","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS;function s(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}}function u(e,t){var n=e.author,r=e.externalId;return{ack:o("MAWAckLevel").ACK.failed,altIndex:void 0,author:n,externalId:r,serverTs:t,ts:t,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE}}function c(t,n){var r;return{ack:t.ack,author:t.author,externalId:t.externalId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(r=o("MAWDbMsg").getMsgContent(t))==null?void 0:r.content,threadJid:n.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME}}function d(t,n,r){return{ack:t.ack,altIndex:void 0,author:t.author,externalId:r.externalId,msgContent:o("MAWDbMsg").getMsgContent(t),originalTs:t.ts,revokedExternalId:r.revokedExternalId,threadJid:n.jid,ts:r.ts,type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)}}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.buildUnstoredCiphertextMsg=s,l.buildUnstoredUnavailableMsg=u,l.buildUnstoredDeleteForMeMsg=c,l.buildUnstoredRevokedMsg=d}),98);
__d("MAWDbEditMsgHistoryTxns",["MAWAckLevel","MAWDbEditMsgHistory","MAWDexieTable","MAWVault","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["maw_db","txn","MAWDbEditMsgHistoryTxns"]);function m(t,n){var r=[];if(n.length===0)return o("MAWDexieTable").dexieResolve(r);var a=n.filter(function(e){return e.editCount!=null&&e.editCount>0}),i=a.map(function(e){return[e.externalId,e.threadJid]});if(i.length===0)return o("MAWDexieTable").dexieResolve([]);var l=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t.msgId),e},new Map),u=a.reduce(function(e,t){return t.msgId!=null&&e.set(t.externalId,t),e},new Map);return p(t,i).then(function(t){if(t.length===0)return d.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No edit history found for the messages despite there being an editCount greater than 0"]))),[];for(var n of t){var a=l.get(n.originalMsgExternalId);a!=null&&r.push(babelHelpers.extends({},n,{editMsgHistoryId:o("MAWDbEditMsgHistory").convertToEditMsgHistoryId64(n.editMsgHistoryId),originalMsgId:a}));var i=u.get(n.originalMsgExternalId);i!=null&&n.threadJid!==i.threadJid&&d.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Edit history threadJid does not match original message threadJid"])))}return r})}function p(e,t){return e.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(t).toArray()}function _(e,t){return t==null?o("MAWDexieTable").dexieResolve():e.editMsgHistory.get({editMsgHistoryId:t})}function f(e,t,n){return e.editMsgHistory.where("originalMsgExternalId").equals(n).filter(function(e){return e.editExternalId===t.externalId&&e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){if(e.length>1){var t=e.map(function(e){return""+e.editTs.toString()}),n=new Set(t).size===1;n?d.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Suspected multiple instances of same message!"]))):d.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[getEditHistoryMsgByEditedProtocolMsgId] Can't have "," messages with the same editExternalId!"])),e.length)}return e[0]})}function g(e,t){return t==null?o("MAWDexieTable").dexieResolve([]):e.editMsgHistory.where("originalMsgExternalId").equals(t.externalId).filter(function(e){return e.author===t.author&&e.threadJid===t.chat}).toArray().then(function(e){var t=[];return e.forEach(function(e){e!=null&&t.push(e)}),t})}function h(e,t){return e.editMsgHistory.bulkGet(t)}function y(e,t){return e.editMsgHistory.bulkAdd(t,{allKeys:!0}).then(function(e){return o("MAWDexieTable").dexieResolve(e)})}function C(e,t,n,r){return r.then(function(r){return b(e,t,n,r)})}function b(e,t,n,r){var a=[];return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===r&&e.author===n&&(e.sendStatus==null||e.sendStatus>=o("MAWAckLevel").ACK.sent)}).toArray().then(function(e){return e.forEach(function(e){a.push({messageId:e.editExternalId,originalMessageId:e.originalMsgExternalId,text:o("MAWVault").unvault(e.msgContent.content),timestamp:e.editTs})}),a})}function v(e,t,n,o){return e.editMsgHistory.where("originalMsgExternalId").equals(t).filter(function(e){return e.threadJid===o&&e.author===n}).delete().then(r("emptyFunction"))}var S=function(t,n){return t.editMsgHistory.where(["originalMsgExternalId","threadJid"]).anyOf(n).delete().then(function(){return o("MAWDexieTable").dexieResolve(n.length)})};function R(e,t,n){return e.editMsgHistory.put(babelHelpers.extends({},t,{msgContent:n.msgContent})).then(function(){})}l.loadEditMsgHistory=m,l.getEditHistoryByOriginalMsgExternalIdAndThreadJid=p,l.maybeGetEditMsgHistoryFromEditMsgHistoryId=_,l.getEditHistoryMsgByEditedProtocolMsgId=f,l.maybeGetEditMsgHistoryFromProtocolMsgId=g,l.bulkGetEditMsgHistorys=h,l.bulkAddEditMsgHistory=y,l.getEditHistoryAsEchoWithJidPromise=C,l.getEditHistoryAsEcho=b,l.bulkRemoveEditHistory=v,l.deleteExpiredEditMsgHistory=S,l.updateEditMsgHistoryWithNewIncomingMsg=R}),98);
__d("MAWDbPendingStanza",["WAAssertUnreachable"],(function(t,n,r,o,a,i,l){"use strict";var e="revoked",s="deleteForMe",u="deleteThread",c="Revoked",d="DeleteForMe",m="DeleteThread",p={DELETE_FOR_ME:d,DELETE_THREAD:m,REVOKED:c};function _(t){switch(t){case"Revoked":return e;case"DeleteForMe":return s;case"DeleteThread":return u;default:return r("WAAssertUnreachable")(t)}}l.PENDING_REVOKED=e,l.PENDING_DELETE_FOR_ME=s,l.REVOKED=c,l.DELETE_FOR_ME=d,l.PENDING_TYPE=p,l.getPendingSuffix=_}),98);
__d("MAWDeleteThreadUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];if(e.forEach(function(e){if(e.pendingContent.type==="DeleteThread"){var n=e.pendingContent.content.metaSyncMessageRange.lastMessageTimestamp;n!=null&&t.push(n)}}),t.length===0)return null;t.sort(function(e,t){return t-e});var n=t[0];return{lastMessageTimestamp:n}}function l(e,t){return t!=null&&t.lastMessageTimestamp>=e}i.getLatestDeleteThreadInfo=e,i.isMsgDeletedViaDeleteThread=l}),66);
__d("MAWMsgCleaner",["MAWLoggerUtils","MWFBLogger","Promise","WAAssertUnreachable","WAShiftTimer","WATimeUtils","WorkerScheduler","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d="Unsend",m="Ephemeral",p="DeleteForMe",_="PendingStanza",f="Xma",g="IGDDM",h="Quote",y=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerUpdate]),C={DELETE_FOR_ME:p,EPHEMERAL:m,IGDDM:g,PENDING_STANZA:_,QUOTE:h,UNSEND:d,XMA:f},b;function v(){return b==null&&(b=o("WorkerScheduler").makeScheduler("cleaner",{concurrency:1,maxTaskLimit:1,maxThrottleMs:8e3})),b}var S=(function(){function t(e,t){var n=this;this.$1=new(o("WAShiftTimer")).ShiftTimer(function(){r("promiseDone")(n.$2())}),this.getNextTs=e.getNextTs,this.removeExpired=e.removeExpired,this.cleanerType=t,this.purgeEnabled=e.purgeEnabled,this.$1.forceRunNow()}var a=t.prototype;return a.update=function(n){var t=R(this.cleanerType);y.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["","::update ",""])),t,n),this.$1.onOrBefore(o("WATimeUtils").cappedMillisecondsUntil(n))},a.$2=function(){var e=this,t=function(){if(!e.purgeEnabled())return(c||(c=n("Promise"))).resolve();var t=R(e.cleanerType);return y.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow"])),t),e.removeExpired().then(function(n){return n>0&&y.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["","::_purgeNow "," msgs' content cleaned"])),t,n),e.getNextTs()}).then(function(t){t!=null&&e.update(t)})};return this.$3!=null?(c||(c=n("Promise"))).resolve():(this.$3=v().task({fn:t,name:this.cleanerType,priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().finally(function(){e.$3=null}))},t})();function R(e){switch(e){case"Unsend":return"UnsendMsgCleaner";case"Ephemeral":return"EphemeralCleaner";case"DeleteForMe":return"DeleteForMeCleaner";case"PendingStanza":return"PendingStanzaCleaner";case"Xma":return"XmaCleaner";case"IGDDM":return"IGDDisappearingMsgCleaner";case"Quote":return"QuoteCleaner";default:return r("WAAssertUnreachable")(e)}}var L=S;l.CLEANER_TYPE=C,l.MsgCleaner=S,l.MSG_CLEANER_FOR_TESTING_ONLY=L}),98);
__d("MAWPendingStanzaCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.PENDING_STANZA))}function d(t){if(u==null){var n="Trying to add new PendingStanzaCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["PendingStanzaCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startPendingStanzaCleaner=c,l.addNewPendingStanzaCleanerTimestamp=d,l.getPendingStanzaCleaner_FOR_TESTING_ONLY=m,l.resetPendingStanzaCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWDbPendingStanzaTxns",["MAWDbPendingStanza","MAWDeleteThreadUtil","MAWPendingStanzaCleaner","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+i).filter(function(e){var t=e.pendingContent;return t.type===a&&t.content.author===n&&t.content.threadJid===r}).first()}function s(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.REVOKED)}function u(t,n,r,a){return e(t,n,r,a,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME)}function c(e,t){var n=t.map(function(e){var t=e.expirationInSeconds;return o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+t)}),a=t.map(function(e,t){var r=e.content,a=e.externalId,i=e.pendingStanzaType;return{deleteTs:n[t],externalIdWithType:a+"_"+o("MAWDbPendingStanza").getPendingSuffix(i),pendingContent:r}});return e.pendingStanzas.bulkAdd(a).then(function(){return n.forEach(o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp)}).then(r("emptyFunction"))}function d(e,t,n,r,a){var i=o("MAWDbPendingStanza").getPendingSuffix(a),l=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+n),s={deleteTs:l,externalIdWithType:r+"_"+i,pendingContent:t};return e.pendingStanzas.add(s).then(function(){o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(l)})}function m(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD);return e.pendingStanzas.where("externalIdWithType").equals(t+"_"+n).toArray().then(function(e){return o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e)})}function p(e){return e.pendingStanzas.toArray()}function _(e,t){var n=t.map(function(e){return e.rowId});return e.pendingStanzas.bulkDelete(n)}function f(e){var t,n;return(e==null||(t=e.pendingContent)==null?void 0:t.type)===o("MAWDbPendingStanza").PENDING_TYPE.REVOKED?e==null||(n=e.pendingContent)==null?void 0:n.content:null}function g(e,t){var n=o("MAWDbPendingStanza").getPendingSuffix(o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD),r=t.map(function(e){return e+"_"+n});return e.pendingStanzas.where("externalIdWithType").anyOf(r).toArray().then(function(e){var t=e.reduce(function(e,t){var n=e.get(t.externalIdWithType);return n==null?e.set(t.externalIdWithType,[t]):n.push(t),e},new Map),n=new Map;return t.forEach(function(e,t){var r=o("WAJids").unsafeCoerceToChatJid(t.split("_")[0]),a=o("MAWDeleteThreadUtil").getLatestDeleteThreadInfo(e);a!=null&&n.set(r,a)}),n})}l.maybeGetPendingStanzaByExternalId=e,l.maybeGetPendingRevokedStanza=s,l.maybeGetPendingDeletedStanza=u,l.bulkPutPendingStanzas=c,l.putPendingStanza=d,l.maybeGetDeleteThreadFromPendingStanza=m,l.getAllPendingStanzas=p,l.deletePendingStanzas=_,l.getRevokedContent=f,l.bulkGetDeleteThreadPendingStanzas=g}),98);
__d("MAWDeleteForMeMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.DELETE_FOR_ME))}function d(t){if(u==null){var n="Trying to add new DeleteForMeContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["DeleteForMeMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startDeleteForMeMsgContentCleaner=c,l.addNewDeleteForMeMsgContentCleanerTimestamp=d,l.getDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetDeleteForMeMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWBridgeMsgCountdown",["MAWDbMsg","MAWLoggerUtils","MWFBLogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MWFBLogger").MWLogger().tags(["bridge",o("MAWLoggerUtils").Tag.Countdown]);function c(t){return{msgs:t.map(function(t){var n,r=t.messageExpirationTs,a=(n=t.ephemeralSetting)==null?void 0:n.ephemeralExpirationInSec;if(!(r==null||a==null)){var i=o("WATimeUtils").cappedMillisecondsUntil(r);if(i<=0){u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Calling the messages starting countdown bridge event with remaning time less or equal to 0 (expired message)"])));return}var l=a*1e3;return i>l&&(i=l),u.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["createBridgeMsgsStartCountdown: msg ",", expiration ",", ms until countdown ",", duration ",""])),t.msgId,r,i,a),{countdownTs:r,millisecondsUntilCountdownTs:i,msgId:t.msgId,threadJid:t.threadJid,ts:o("MAWDbMsg").getCanonicalTsFromMsg(t)}}}).filter(Boolean)}}function d(e,t){return{countdownTs:t,msgId:e}}l.createBridgeMsgsStartCountdown=c,l.createBridgeMsgClearCountdown=d}),98);
__d("MAWEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"backend"]);function c(e){var t=e.expiryFns,n=e.purgeDeletionsFns;if(s==null){var r;s={expiry:new(r=o("MAWMsgCleaner")).MsgCleaner(t,r.CLEANER_TYPE.EPHEMERAL),purgeDeletions:new r.MsgCleaner(n,r.CLEANER_TYPE.EPHEMERAL)}}}function d(t,n){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");var r=s,o=r.expiry,a=r.purgeDeletions;u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",") and deletion(",")"])),t,n),o.update(t),a.update(n)}function m(){return s}function p(){s=null}l.startEphemeralCleaner=c,l.addNewEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWEphemeralSettingsCache",["MAWBridge","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t,n){e.set(t,n)}function u(t){var n,r={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};return(n=e.get(t))!=null?n:r}async function c(t){var n={ephemeralExpirationInSec:0,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").castToUnixTime(0)};if(!e.has(t)){var r=await o("MAWBridge").getBridge().sendAndReceive("event","getLSDBEphemeralSetting",{chatJid:t});s(t,r!=null?r:n)}}l.setEphemeralSettingCache=s,l.getEphemeralSettingCache=u,l.requestLSDBCacheForJid=c}),98);
__d("MAWEphemeralUtil",["FBLogger","MAWAckLevel","MAWBridgeMsgCountdown","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWMsgType","WAArmadilloApplication.pb","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){var n=t.ephemeralExpirationInSec!==e.ephemeralExpirationInSec&&t.ephemeralLastUpdatedOrSetTimestamp===e.ephemeralLastUpdatedOrSetTimestamp;return n||e.ephemeralLastUpdatedOrSetTimestamp>t.ephemeralLastUpdatedOrSetTimestamp}function c(t,n,r){if(t==null)return!0;var a=t.ephemeralSetting;return a!=null&&a.ephemeralExpirationInSec===n?(o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["New ephemeral duration should be different from the existing duration"]))),!1):a!=null&&a.ephemeralLastUpdatedOrSetTimestamp>r?(o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["The new ephemeral setting timestamp should be greater than the existing timestamp"]))),!1):!0}function d(e){var t={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_SETTING_CHANGE_MINUTES},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN};return{unstoredDbMedia:null,unstoredDbMsg:t,unstoredDbReaction:null}}function m(e,t){var n;switch(t){case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREENSHOT_IMAGE;break;case o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING:n=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_SCREENSHOT_ACTION_SCREENSHOT_TYPE.SCREEN_RECORDING;break;default:throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected screenshot action type")}var a={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:o("MAWExternalId").generateExternalId(),msgContent:{adminMsgContent:[],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.YOU_EPHEMERAL_TAKE_SCREENSHOT,screenshotActionType:n},ts:e,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return{unstoredDbMedia:null,unstoredDbMsg:a,unstoredDbReaction:void 0}}function p(e){return o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){throw r("FBLogger")("messenger_web").mustfixThrow("Received invalid chatJid. We only support ephemeral messaging in 1:1 threads.")},user:function(t){return t}})}function _(e){e!=null&&e.messageExpirationTs!=null&&e.ephemeralCounterStarted===!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgClearCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgClearCountdown(e.msgId,e.messageExpirationTs)})}l.isLocalSettingOutdated=u,l.shouldUpdateForOutgoingUserEphemeralSettingChange=c,l.buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder=d,l.buildUnstoredDbEphemeralScreenshotActionMsgWithoutContentPlaceholder=m,l.getUserJidForEphemeralSetting=p,l.maybeClearEphemeralMsgCountdown=_}),98);
__d("MAWEphemeralSettingsTxns",["DateConsts","MAWDbThreadTxns","MAWDexieTable","MAWEphemeralSettingsCache","MAWEphemeralUtil","MAWIndexedDb","MAWLoggerUtils","MAWUserJidWrapper","MWFBLogger","WAJids","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MWFBLogger").MWLogger().tags(["maw_db","txn",(_=o("MAWLoggerUtils")).Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Incoming]),g=o("MWFBLogger").MWLogger().tags(["maw_db","txn",_.Tag.Ephemeral,_.Tag.SettingChange,_.Tag.Outgoing]),h=null,y=90*o("DateConsts").SEC_PER_DAY;function C(t,n,r,a,i,l,d,m,p){if(r<0||r>y){var _=o("WAJids").interpretAndValidateJid(l.jid).toString();throw f.mustfixThrow("EphemeralSetting duration is invalid "+r+", jidType: "+_)}var g={ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:a};f.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle Incoming Ephemeral Setting duration: ",", lastUpdated: ",". Thread: ",", Author: ",""])),r,a,String(l),n);var C=o("WAJids").interpretAsUserJid(l.jid);if(C==null)return f.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Received invalid chat jid for incoming ephemeral settings"]))),o("MAWDexieTable").dexieResolve(h);var b=o("WAJids").isAuthorMe(n)?o("MAWUserJidWrapper").getMyUserJid():n,v=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(l.jid),S=v==null?void 0:v.ephemeralExpirationInSec,R=v==null?void 0:v.ephemeralLastUpdatedOrSetTimestamp;if(p)return v!=null&&!o("MAWEphemeralUtil").isLocalSettingOutdated(g,v)?a!==R?(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending Sync Response with duration ",", timestamp ",""])),S,R),o("MAWDexieTable").dexieResolve({outOfSyncEphemeralSetting:{chatJid:l.jid,correctEphemeralExpirationInSec:v.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:v.ephemeralLastUpdatedOrSetTimestamp}})):(f.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Ephemeral setting in sync"]))),o("MAWDexieTable").dexieResolve(h)):(o("MAWIndexedDb").afterTransaction({tag:"EphemeralSettingsUpdatedForUI",value:{author:o("WAJids").userIdFromJid(b),chatJid:l.jid,ephemeralSettingArgs:g,isEphemeralSettingReset:i}}),o("MAWDexieTable").dexieResolve(h));var L={ephemeralSetting:g,ephemeralSyncResponseBackoffInfo:void 0,userJid:C};return t.ephemeralSettings.put(L).then(function(){return h})}function b(e,t,n,r,a){var i=n;if(i<0)throw g.mustfixThrow("Ephemeral duration should be 0 or more");var l=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return o("MAWDbThreadTxns").getThread(e,t).then(function(t){return t.success?e.ephemeralSettings.get({userJid:l}).then(function(t){if(!o("MAWEphemeralUtil").shouldUpdateForOutgoingUserEphemeralSettingChange(t,i,r))return o("WAResultOrError").makeResult({shouldUpdateSetting:!1});var n=t==null?{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r},userJid:l}:babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:i,ephemeralLastUpdatedOrSetTimestamp:r}});return e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult({shouldUpdateSetting:!0})})}):o("WAResultOrError").makeResult({shouldUpdateSetting:!1})})}function v(e,t,n){var a=o("MAWEphemeralUtil").getUserJidForEphemeralSetting(t);return e.ephemeralSettings.get({userJid:a}).then(function(t){if(t==null||t.ephemeralSetting==null)throw g.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Contact "," "," and ephemeral setting "," should not be null when receiving the server ack for outgoing ephemeral setting change"])),a,String(t),String(t==null?void 0:t.ephemeralSetting)),g.mustfixThrow("Contact and ephemeral setting should not be null when receiving the server ack for outgoing ephemeral setting change");var o=babelHelpers.extends({},t,{ephemeralSetting:{ephemeralExpirationInSec:t.ephemeralSetting.ephemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:n}});return e.ephemeralSettings.put(o).then(r("emptyFunction"))})}function S(e,t){var n=o("WAJids").interpretAsUserJid(t);n==null&&g.mustfixThrow("Unexpected chatJid input to isEphemeralMessagesEnabledForContact");var r=o("MAWEphemeralSettingsCache").getEphemeralSettingCache(t);return r.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").castToUnixTime(0)?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting")):r!=null&&r.ephemeralExpirationInSec>0?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({outOfSyncEphemeralSetting:{chatJid:t,correctEphemeralExpirationInSec:r.ephemeralExpirationInSec,correctEphemeralLastUpdatedOrSetTimestamp:r.ephemeralLastUpdatedOrSetTimestamp}})):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("no_ephemeral_setting"))}function R(e,t){return e.ephemeralSettings.get({userJid:t}).then(function(n){return(n==null?void 0:n.ephemeralSyncResponseBackoffInfo)==null?(f.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo no op for ",""])),t),o("WAResultOrError").makeResult()):(n.ephemeralSyncResponseBackoffInfo=void 0,f.DEBUG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["maybeResetEphemeralSyncResponseBackoffInfo reset for ",""])),t),e.ephemeralSettings.put(n).then(function(){return o("WAResultOrError").makeResult()}))})}l.handleAndWriteIncomingEphemeralSetting=C,l.handleAndWriteOutgoingUserEphemeralSettingChange=b,l.updateContactWhenEphemeralSettingChangeMarkedSent=v,l.getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg=S,l.maybeResetEphemeralSyncResponseBackoffInfo=R}),98);
__d("MAWEphemeralMsgTxns",["EBLogger","MAWBridgeMsgCountdown","MAWDbMsg","MAWDbMsgTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDexieTable","MAWEphemeralCleaner","MAWEphemeralConsts","MAWEphemeralMsgUtils","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWLoggerUtils","MAWODSProxy","MAWThreadSnippetUtils","MWFBLogger","WAJids","WAOdsEnums","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=o("MWFBLogger").MWLogger().tags([(p=o("MAWLoggerUtils")).Tag.Ephemeral,p.Tag.SettingSync,p.Tag.Incoming]),f=o("MWFBLogger").MWLogger().tags([p.Tag.Ephemeral,p.Tag.OnRead,p.Tag.Countdown]);function g(e,t,n){return n===void 0&&(n=function(){return!0}),o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,t,!1,!0).filter(n).limit(1).toArray().then(function(e){var t;return{needsUpdate:!0,value:(t=e[0])!=null?t:null}})}function h(e,t,n){return n.size===0?o("MAWDexieTable").dexieResolve():o("MAWDbThreadTxns").getThread(e,t).then(function(t){if(t.success){var r=t.value;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getThreadOldestMessageId(e,r.jid),o("MAWDbMsgTxns").getThreadNewestMessageId(e,r.jid)]).then(function(t){var a=t[0],i=t[1];if(!(a==null||i==null)){var l=o("MAWEphemeralMsgUtils").filterNonExpiredMsg(n),s=n.has(a)?g(e,r.jid,l):o("MAWDexieTable").dexieResolve({needsUpdate:!1}),u=n.has(i)?o("MAWDbMsgTxns").getThreadMessagesBySortOrder(e,r.jid,!0,!1).filter(l).reverse().limit(1).toArray().then(function(t){var a=t[0];return a!=null&&o("MAWThreadSnippetUtils").isDbMsgDisabledForThreadSnippet(a)?o("MAWThreadSnippetUtils").recalculateSnippetFromScratch_EXPENSIVE(e,r,n).then(function(e){return{needsUpdate:!0,value:e!=null?e:null}}):{needsUpdate:!0,value:a!=null?a:null}}):o("MAWDexieTable").dexieResolve({needsUpdate:!1});return o("MAWDexieTable").dexieAll([s,u]).then(function(t){var n,l,s,u,c=t[0],d=t[1];if(!(!c.needsUpdate&&!d.needsUpdate)){var m=d.needsUpdate?(n=(l=d.value)==null?void 0:l.msgId)!=null?n:void 0:i,p=d.needsUpdate?d.value!=null?o("WATimeUtils").castUnixTimeToMillisTime(o("MAWDbMsg").getCanonicalTsFromMsg(d.value)):void 0:r.snippetMsgTs,_=babelHelpers.extends({},r,{oldestMsg:c.needsUpdate?(s=(u=c.value)==null?void 0:u.msgId)!=null?s:null:a,snippetMsg:m,snippetMsgTs:p});e.threads.put(_)}})}})}})}function y(t,n,r){if(r===void 0&&(r=!0),n==null||n.ephemeralSetting==null||n.ephemeralSetting.ephemeralExpirationInSec===0)return o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").castToUnixTime(n.ts+n.ephemeralSetting.ephemeralExpirationInSec),i=o("WATimeUtils").castToUnixTime(a+o("MAWEphemeralConsts").ephemeralReportingWindowInSeconds);return n.ebTimestampMs!=null&&(o("EBLogger").EBLogger().tags(["eb_restore"]).WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Delete DM backup - S472027 follow up"]))),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"restore_dm_s472027"})),C(t,[{messageDeleteTs:i,messageExpirationTs:a,msgId:n.msgId,readTsForLogging:n.ts}]).then(function(e){var t=e[0],n=e[1],a=e[2];return a.length>0&&(f.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["markEphemeralMessageAsSent EphemeralCounter: Showing UI counter for ",""])),String(a.map(function(e){return e.msgId}))),r&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(a)})),t!=null&&n!=null&&o("MAWEphemeralCleaner").addNewEphemeralTimestamp(t,n),a[0]})}function C(e,t){var n=t.map(function(e){return e.msgId});return o("MAWDbXMATxns").getXMAMsgIdsFromAssociatedMsgIds(e,n).then(function(r){var o=new Map;t.forEach(function(e){o.set(e.msgId,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging});var t=r.get(e.msgId);t!=null&&o.set(t,{messageDeleteTs:e.messageDeleteTs,messageExpirationTs:e.messageExpirationTs,readTsForLogging:e.readTsForLogging})});var a=null,i=null,l=[],s=Array.from(new Set(n.concat(Array.from(r.values()))));return e.messages.where("msgId").anyOf(s).toArray().then(function(t){if(t.length!==0)return t.forEach(function(e){var t=e.messageExpirationTs,n=e.messageDeleteTs,r=o.get(e.msgId),s=r==null?void 0:r.messageExpirationTs,c=r==null?void 0:r.messageDeleteTs;if(f.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["updating ephemeral timestamp msg ",", existing expiration ",", existing deletion ",", updated expiration ",", updated deletion ",""])),e.msgId,t,n,s,c),!(s==null||c==null)&&e.ephemeralCounterStarted!==!0){(a==null||s<a)&&(a=s),(i==null||c<i)&&(i=c);var d=babelHelpers.extends({},e,{ephemeralCounterStarted:!0,messageDeleteTs:c,messageExpirationTs:s});l.push(d)}}),e.messages.bulkPut(l)}).then(function(){return[a,i,l]})})}function b(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=[];return t.forEach(function(t,r){n.push(h(e,r,t))}),o("MAWDexieTable").dexieAll(n).then(r("emptyFunction"))}function v(e,t,n,a,i){if(t==null)return o("MAWDexieTable").dexieResolve();_.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["maybeUpdateEphemeralSettingOrCheckOutOfSyncAfterWritingIncomingMsg: Message from ",", chat ",", type ",""])),n,a.jid,t.type);var l=o("MAWDexieTable").dexieResolve();if(t.ephemeralSetting==null)o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(){return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))},user:function(){o("MAWDbMsg").isMsgEligibleForTriggeringEphemeralSyncResponse(t)&&(l=o("MAWEphemeralSettingsTxns").getOutOfSyncEphemeralSettingForIncomingNonEphemeralMsg(e,a.jid).then(function(e){var t;return e==null||(t=e.value)==null?void 0:t.outOfSyncEphemeralSetting}))}});else if(t.messageExpirationTs!=null&&t.messageDeleteTs!=null){var s=t.ephemeralSetting,u=t.messageDeleteTs,p=t.messageExpirationTs;_.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is ephemeral: duration ",", timestamp ",""])),s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp),o("MAWEphemeralCleaner").addNewEphemeralTimestamp(p,u),l=o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(e,n,s.ephemeralExpirationInSec,s.ephemeralLastUpdatedOrSetTimestamp,!1,a,i,null,!0).then(function(e){return e==null?void 0:e.outOfSyncEphemeralSetting})}return l.then(function(t){if(t!=null)_.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["incoming msg is out of sync: correct duration ",", correct timestamp ",""])),t.correctEphemeralExpirationInSec,t.correctEphemeralLastUpdatedOrSetTimestamp);else return o("MAWEphemeralSettingsTxns").maybeResetEphemeralSyncResponseBackoffInfo(e,n).then(r("emptyFunction"))})}l.markEphemeralMessageAsSent=y,l.bulkUpdateEphemeralMessageTimestamps=C,l.updateThreadsOnMessagesExpiredFromUi=b,l.syncEphemeralSettingOnIncomingMsg=v}),98);
__d("MAWExpiredQuoteCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.QUOTE))}function d(t){if(u==null){var n="Trying to add new addNewExpiredQuoteCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredQuoteCleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredQuoteCleaner=c,l.addNewExpiredQuoteCleanerTimestamp=d,l.getExpiredQuoteCleaner_FOR_TESTING_ONLY=m,l.resetExpiredQuoteCleaner_FOR_TESTING_ONLY=p}),98);
__d("isWAFTSContentSearchEnabled",["isE2EEConversationSearchEnabled","isMAWUniversalSearchEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("isE2EEConversationSearchEnabled")()||r("isMAWUniversalSearchEnabled")()}l.default=e}),98);
__d("MAWFTSTxns",["MAWDexieTable","isWAFTSContentSearchEnabled","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=r("justknobx")._("1146");function s(e,t){return r("isWAFTSContentSearchEnabled")()?e.ftsPurgeBacklog.put({externalId:t}):o("MAWDexieTable").dexieResolve(null)}function u(t,n){return!r("isWAFTSContentSearchEnabled")()||!e?o("MAWDexieTable").dexieResolve(null):t.ftsBackloggedMessages.put({rowId:n})}function c(t,n){return!r("isWAFTSContentSearchEnabled")()||!e?o("MAWDexieTable").dexieResolve(null):t.ftsBackloggedMessages.bulkPut(n.map(function(e){return{rowId:e}}))}function d(e,t){return r("isWAFTSContentSearchEnabled")()?e.ftsPurgeThreadBacklog.put({chatJid:t}):o("MAWDexieTable").dexieResolve(null)}l.maybePutMessageToPurgeBacklog=s,l.maybePutMessageToBacklog=u,l.maybePutMessagesToBacklog=c,l.maybePutThreadToPurgeBacklog=d}),98);
__d("MAWBridgeUpload",["MAWMainTraceUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.actionType,n=e.attachmentContext,r=e.attachmentContextArray,o=e.authTs,a=e.echoDocument,i=e.echoEncodingLatencyNs,l=e.errorCode,s=e.errorMessage,u=e.messageId,d=e.messageType,m=e.productType,p=e.protoMsg,_=e.sortOrderMs,f=e.threadId,g=e.traceId,h=e.uploadTrackingInstanceKey,y=c(n,m!=null?m:"msgr",r);return{actionType:t,attachmentBackupContext:y,authTs:o,echoDocument:a,echoEncodingLatencyNs:i,errorCode:l,errorMessage:s,messageId:u,messageType:d,protoMsg:p,sortOrderMs:_,threadId:f,traceId:g,uploadTrackingInstanceKey:h}}function s(e,t,n,r,o,a){return{actionType:a,echoDocument:o,folderType:t,threadId:e,transportKey:n,ts:r}}function u(e,t,n,r,o,a,i,l){return{deliveryObjectId:e,mediaType:t,messageId:n,productType:r,threadId:o,threadJid:a,traceId:l,ts:i}}function c(e,t,n){if(n!=null){var r=n.map(function(e){return{attachmentTraceId:o("MAWMainTraceUtils").createTraceId(),mediaType:e.mediaType,zippyObjectId:e.mediaObjectId}}),a={attachmentInfos:r,productType:t};return a}}l.createBridgeUploadMessage=e,l.createBridgeDeleteMessagesOfThread=s,l.createBridgeUploadAttachment=u,l.createBridgeUploadAttachmentBackupContext=c}),98);
__d("MAWUploadThreadTxns",["$InternalEnum","MAWFolderTypes"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({INBOX:0,PENDING:1,OTHER:2,SPAM:3,ARCHIVED:4,HIDDEN:5});function s(t){switch(t){case o("MAWFolderTypes").FOLDER_ID.INBOX:return e.INBOX;case o("MAWFolderTypes").FOLDER_ID.PENDING:return e.PENDING;case o("MAWFolderTypes").FOLDER_ID.ARCHIVED:return e.ARCHIVED;default:return e.INBOX}}function u(e){return s(e).toString()}l.FolderType=e,l.getFolderTypeAsText=u}),98);
__d("MpsDeletedCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new MpsDeletedTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MpsDeletedCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startMpsDeletedCleaner=c,l.addNewMpsDeletedTimestamp=d,l.getMpsDeletedCleaner_FOR_TESTING_ONLY=m,l.resetMpsDeletedCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsEphemeralCleaner",["MAWLoggerUtils","MAWMsgCleaner","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=null,u=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.MsgCleaner,o("MAWLoggerUtils").Tag.CleanerTimestamp,"purgeDeletions"]);function c(e){s==null&&(s=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.EPHEMERAL))}function d(t){if(s==null)throw u.mustfixThrow("Trying to add new ephemeral timestamp before the cleaner is initialized!");u.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCleaner: Adding timestamps for expiry(",")"])),t),s.update(t)}function m(){return s}function p(){s=null}l.startMpsEphemeralCleaner=c,l.addNewMpsEphemeralTimestamp=d,l.getEphemeralCleaner_FOR_TESTING_ONLY=m,l.resetEphemeralCleaner_FOR_TESTING_ONLY=p}),98);
__d("MpsReverbDbDump",["WebReverbDB","WormDump"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t=o("WebReverbDB").getWebReverbDB();return t.dump({dbMetadata:{customFields:{mawDBMigrationCurrentMessageId:(e=o("WormDump")).wormNonSensitiveField,mawDBMigrationCurrentThread:e.wormNonSensitiveField,mawDBMigrationStartMs:e.wormNonSensitiveField,mawDBMigrationState:e.wormNonSensitiveField,pk:e.wormNonSensitiveField}},deleted:{customFields:{deletedMessageId:e.wormNonSensitiveField,deletionMessageId:e.wormNonSensitiveField,deletionTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},message:{customFields:{debugFlags:e.wormNonSensitiveField,expiryTimestampMs:e.wormNonSensitiveField,isLocalOnlyMessage:e.wormNonSensitiveField,isTransportErrorPlaceholder:e.wormNonSensitiveField,messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,senderId:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:2500},supplemental:{customFields:{messageId:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,supplementalKey:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField,topLevelMessageId:e.wormNonSensitiveField},limit:1e3},tags:{customFields:{messageId:e.wormNonSensitiveField,messagePk:e.wormNonSensitiveField,pk:e.wormNonSensitiveField,threadId:e.wormNonSensitiveField,timestampMs:e.wormNonSensitiveField},limit:1e3}})}l.debugGetReverbDbDump=e}),98);
__d("QPLMultiplexedFlow",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=Array.from(new Set(e));return{addAnnotations:function(n){t.forEach(function(e){return e.addAnnotations(n)})},addPoint:function(n,r){t.forEach(function(e){return e.addPoint(n,r)})},endCancel:function(n,r){t.forEach(function(e){return e.endCancel(n,r)})},endFail:function(n,r){t.forEach(function(e){return e.endFail(n,r)})},endSuccess:function(n){t.forEach(function(e){return e.endSuccess(n)})},getQPLAttrs:function(){return t.map(function(e){return e.getQPLAttrs()})[0]},isActive:function(){return t.some(function(e){return e.isActive()})},start:function(){}}}i.makeQplMultiplexedFlow=e}),66);
__d("WebMpsGetDistinctSupplementals",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=new Map(e),r=new Map;return t.forEach(function(e,t){var o=n.get(t);if(o==null)n.set(t,e),r.set(t,e);else{var a=o.timestampMs,i=e.timestampMs;i>a&&(n.set(t,e),r.set(t,e))}}),{supplementals:n,supplementalsToWriteToReverb:r}}i.getDistinctSupplementals=e}),66);
__d("WebMpsGetDistinctMessages",["WebMpsGetDistinctSupplementals"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"],s=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function u(t,n){var r=new Map,a=new Map;t.forEach(function(t){var n=t.reverbTopLevel,o=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=babelHelpers.objectWithoutPropertiesLoose(n,e);a.set(t.reverbTopLevel.messageId,t),r.set(t.reverbTopLevel.messageId,{expiryTimestampMs:i,supplementalProtobufs:t.supplementalProtobufs,tags:t.tags,toplevelProtobuf:c})});var i=new Map,l=new Map,u=new Map;return n.forEach(function(e){var t=e.supplementalProtobufs,n=e.tags,c=e.toplevelProtobuf,d=c.messageId,m=a.get(d);if(m==null||m.reverbTopLevel.isTransportErrorPlaceholder===!0)r.set(d,e),i.set(d,c),l.set(d,new Map(t)),u.set(d,n);else{var p=m.supplementalProtobufs,_=o("WebMpsGetDistinctSupplementals").getDistinctSupplementals(p,t),f=_.supplementals,g=_.supplementalsToWriteToReverb,h=m.reverbTopLevel,y=h.debugFlags,C=h.expiryTimestampMs,b=h.isLocalOnlyMessage,v=h.isTransportErrorPlaceholder,S=h.pk,R=babelHelpers.objectWithoutPropertiesLoose(h,s);r.set(d,{expiryTimestampMs:C,supplementalProtobufs:f,tags:m.tags,toplevelProtobuf:R}),g.size>0&&l.set(d,new Map(g))}}),{messages:Array.from(r.values()),supplementalMessagesToWriteToReverb:l,tagsToWriteToReverb:u,topLevelMessagesToWriteToReverb:i}}l.getDistinctMessages=u}),98);
__d("WebMpsGetIsMessageExpired",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e!=null&&o("WATimeUtils").cappedMillisecondsUntil(o("WATimeUtils").castMilliSecondsToUnixTime(e))<=0}l.getIsMessageExpired=e}),98);
__d("WebMpsPersistMessagesFromEb",["FBLogger","MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;async function s(t){if(!(t.length===0||t.every(function(e){return e.topLevelProtobufs.size===0&&e.supplementalProtobufs.size===0&&e.tags.size===0})))try{await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(n){var o=t.map(function(t){var o=t.supplementalProtobufs,a=t.tags,i=t.threadId,l=t.topLevelProtobufs;return r("FBLogger")("mps").INFO(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Persisting EB messages thread: "," topLevelProtobufs: "," supplementalProtobufs: ",""])),i,Array.from(l.keys()).join(","),Array.from(o.keys()).join(",")),u(l,o,a,i,function(e){return e(n)})}).flat();return Promise.all(o)},"mps-persist-messages-from-eb")}catch(e){var n=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(n).mustfix("Runtime error performing persistMessagesFromEB"),n}}function u(e,t,n,r,a){var i=[];return e.forEach(function(e,t){var r;i.push(o("WebMpsReverbWrites").upsertTopLevelToReverb(e,{actionType:o("MpsTypes").ActionType.UpsertTopLevel,debugFlags:["EB"],isLocalOnly:!1,isTransportErrorPlaceholder:!1,tags:(r=n.get(t))!=null?r:[],targetMessageId:t},a))}),t.forEach(function(e,t){e.forEach(function(e,n){i.push(o("WebMpsReverbWrites").upsertSupplementalToReverb(e.messageId,e.payload,n,t,r,e.timestampMs,a))})}),i}l.persistMessagesFromEB=s}),98);
__d("WebMpsBatchLoadMessage",["CoalescingLoader","MpsLogger","QPLMultiplexedFlow","WebMpsGetDistinctMessages","WebMpsGetIsMessageExpired","WebMpsPersistMessagesFromEb","WebReverbDB","getErrorSafe","getSafeQplErrorMessage","groupBy"],(function(t,n,r,o,a,i,l){"use strict";var e=["messageId"],s=["config","ctx","messageId","threadId"],u=["pk","supplementalKey","threadId","topLevelMessageId"],c=(function(){function t(t){var n=this;this.$3=async function(t){var a=r("groupBy")(t,function(e){return n.$4(e)}),i=new Map;return await Promise.all(Object.entries(a).map(async function(t){var r=t[0],a=t[1],l=a.map(function(e){return e.ctx.metric}),s=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(l);s.addAnnotations({int:{coalesced_batch_size:a.length}});var u=a[0],c=u.messageId,d=babelHelpers.objectWithoutPropertiesLoose(u,e),m=babelHelpers.extends({},d,{ctx:{metric:s},messageIds:a.map(function(e){return e.messageId})}),p=await n.batchLoad(m);i.set(r,p)})),t.map(function(e){var t=i.get(n.$4(e));return t==null?void 0:t.find(function(t){return(t==null?void 0:t.toplevelProtobuf.messageId)===e.messageId})})},this.$1=t,this.$2=new(o("CoalescingLoader")).CoalescingLoader(this.$3)}var n=t.prototype;return n.$4=function(t){var e=t.config,n=t.ctx,r=t.messageId,o=t.threadId,a=babelHelpers.objectWithoutPropertiesLoose(t,s);return JSON.stringify({config:e,threadId:o})},n.$5=async function(t,n,a,i){try{i.metric.addPoint("load-message-from-reverb_start");var e=o("WebReverbDB").getWebReverbDB(),l=await e.runInTransaction(["message","supplemental","tags"],"readonly",function(e){return Promise.all(n.map(function(n){var r=e.stores.message.readIndex("[threadId+messageId]",[t,n],{limit:1}),o=a.shouldFetchTags?e.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[t,n]}):[],i=a.shouldFetchSupplementals?e.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t,n]}):[];return Promise.all([n,r,i,o])}))},"mps-load-message");i.metric.addPoint("load-message-from-reverb_end");var s=new Map;return l.forEach(function(e){var t=e[0],n=e[1],r=n[0],a=e[2],i=e[3];if(r==null||o("WebMpsGetIsMessageExpired").getIsMessageExpired(r.expiryTimestampMs))return null;var l=new Map;a.forEach(function(e){var t=e.pk,n=e.supplementalKey,r=e.threadId,o=e.topLevelMessageId,a=babelHelpers.objectWithoutPropertiesLoose(e,u);l.set(n,a)});var c=i.map(function(e){var t=e.tag;return t});s.set(t,{reverbTopLevel:r,supplementalProtobufs:l,tags:c})}),s}catch(e){return i.metric.addPoint("load-message-from-reverb_fail"),o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Runtime error performing loadMessageFromReverb"),new Map}},n.$6=async function(t,n,a){try{var e=this.$1,i=e.decryptedProtobufToFullMessage,l=e.eb,s=l.isEbEnabled(),u=s===!0?"true":s===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:u}}),s!==!0)return new Map;a.metric.addPoint("load-message-from-eb_start");var c=l.messagePointQuery,d=await c({ctx:a,messageIds:n,threadId:t});if(d.success===!1)return new Map;var m=i(d.value,t);return a.metric.addPoint("load-message-from-eb_end"),new Map(m.map(function(e){return[e.toplevelProtobuf.messageId,e]}))}catch(e){a.metric.addPoint("load-message-from-eb_fail");var p=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(p).mustfix("Runtime error performing loadFromEB"),new Map}},n.batchLoad=async function(t){var e=this,n=t.config,a=t.ctx,i=t.messageIds,l=t.threadId;try{a.metric.addPoint("load-message_start");var s=function(){return e.$5(l,i,n,a)},u=function(){return e.$6(l,i,a)},c=n.strategy==="local-first"?async function(){var e=await s(),t=e.size===i.length;return t?[e,new Map]:[e,await u()]}:n.strategy==="full-fetch"?function(){return Promise.all([s(),u()])}:n.strategy==="local-only"?async function(){return[await s(),new Map]}:n.strategy==="remote-only"?async function(){return[new Map,await u()]}:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+n.strategy)})(),d=await c(),m=d[0],p=d[1],_=i.map(function(e){var t=m.get(e),n=p.get(e);return o("WebMpsGetDistinctMessages").getDistinctMessages([t].filter(Boolean),[n].filter(Boolean))});return n.persistToReverb==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(_.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:l,topLevelProtobufs:r}})),a.metric.addPoint("load-message_end"),_.map(function(e){return e.messages[0]})}catch(e){var f=r("getErrorSafe")(e);throw a.metric.addPoint("load-message_fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(f)}}),o("MpsLogger").MpsLogger().catching(f).mustfix("Runtime error performing loadMessage"),f}},n.load=function(t){return this.$2.gen(t)},t})();l.WebMpsPointQueryApi=c}),98);
__d("PackedMpsRange",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.packMpsRange=e}),66);
__d("WebMpsBatchLoadFromReverb",["MpsLogger","WebMpsGetIsMessageExpired","WebReverbDB","WormRangeIterator","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"],s=["pk","supplementalKey","threadId","topLevelMessageId"];async function u(t,n,r,a,i,l,u,c,d,m,p,_){var f=r[0],g=r[1],h=c?function(e){return e.isLocalOnlyMessage===!1}:function(e){return!0},y=function(t){return!o("WebMpsGetIsMessageExpired").getIsMessageExpired(t.expiryTimestampMs)},C=function(t){return h(t)&&y(t)};function b(){var e=t.stores.message.getIndexRangeIterator("[threadId+timestampMs+messageId]",a,{greaterThanOrEqual:[n],lessThanOrEqual:[n]},C),r=g==null?[n,f]:[n,f,g];return e.read(r,i)}async function v(e){var r="[threadId+tag+timestampMs]",l=await Promise.all(Array.from(e).map(function(e){return t.stores.tags.getIndexRangeIterator(r,a,{greaterThanOrEqual:[n,e],lessThanOrEqual:[n,e]}).read([n,e,f],i)})),s=o("WormRangeIterator").mergeRanges(l,["timestampMs","messageId"],a,i),u=await Promise.all(s.data.map(function(e){return t.stores.message.getByIndex("[threadId+messageId]",[e.threadId,e.messageId],{filter:C})})).then(function(e){return e.filter(Boolean)}),c=o("WormRangeIterator").makeCursorInfoFromList(u,["threadId","timestampMs","messageId"],s.cursorInfo.hasNext,s.cursorInfo.hasPrevious);return{cursorInfo:c,data:u}}var S;d!=="all"?(p.metric.addPoint("load_messages_with_tags_"+_+"_start"),S=await v(d),p.metric.addPoint("load_messages_with_tags_"+_+"_end")):(p.metric.addPoint("load_messages_canoincal_"+_+"_start"),S=await b(),p.metric.addPoint("load_messages_canonical_"+_+"_end"));var R=S,L=R.cursorInfo,E=R.data;p.metric.addPoint("load_message_results_"+_+"_start"),p.metric.addAnnotations({bool:{shouldFetchTags:u}});var k=async function(){var r=E.length>0?a==="asc"?E[0].messageId:E[E.length-1].messageId:null,o=l?r!=null?await t.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{greaterThanOrEqual:[n,r]}):[]:[],i=new Map;return o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,a=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e),s=i.get(a);s==null&&(s=new Map,i.set(a,s)),s.set(r,l)}),Promise.all(E.map(async function(e){var r,o=(r=i.get(e.messageId))!=null?r:new Map,a=u?await t.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[n,e.messageId]}):[],l=a.map(function(e){var t=e.tag;return t});return{reverbTopLevel:e,supplementalProtobufs:o,tags:l}}))},I=function(){return Promise.all(E.map(async function(e){var r=l?await t.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n,e.messageId]}):[],o=new Map;r.forEach(function(e){var t=e.pk,n=e.supplementalKey,r=e.threadId,a=e.topLevelMessageId,i=babelHelpers.objectWithoutPropertiesLoose(e,s);o.set(n,i)});var a=u?await t.stores.tags.readIndexRange("[threadId+messageId+tag]",{only:[n,e.messageId]}):[],i=a.map(function(e){var t=e.tag;return t});return{reverbTopLevel:e,supplementalProtobufs:o,tags:i}}))},T=m?await k():await I();return p.metric.addPoint("load_message_results_"+_+"_end"),{cursorInfo:{endCursor:L.endCursor!=null?[L.endCursor[1],L.endCursor[2]]:null,hasNext:L.hasNext,hasPrevious:L.hasPrevious,startCursor:L.startCursor!=null?[L.startCursor[1],L.startCursor[2]]:null},messages:T,threadId:n}}async function c(e,t,n,a,i,l,s){try{i.metric.addPoint("reverb_fetch_start");var c=o("WebReverbDB").getWebReverbDB(),d=new Map(await c.runInTransaction(["message","supplemental","tags"],"readonly",function(r){return Promise.all(e.map(function(e,o){return u(r,e.threadId,e.from,e.direction,e.numMessages,t,n,a,l,s,i,o).then(function(t){return[e,t]})}))},"mps-load-messages"));return i.metric.addPoint("reverb_fetch_end"),d}catch(e){var m=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(m).mustfix("Runtime error performing WebMpsBatchLoadFromReverb"),i.metric.addPoint("reverb_fetch_end",{bool:{reverbFail:!0}}),new Map}}l.batchLoadMessagesFromReverb=c}),98);
__d("WebMpsLoadMessagesFromEb",["MpsLogger","WAPromiseDelays","WAResultOrError","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e={endCursor:null,hasNext:!1,hasPrevious:!1,startCursor:null};async function s(e,t,n,a,i){function l(){throw a.metric.addPoint("eb_fetch_timeout"),o("MpsLogger").MpsLogger().mustfixThrow("Timed out waiting for EB Fetch")}var s=e.reduce(function(e,t){return e+t.numMessages},0),u=Math.min(Math.max((s-20)/180,0),1),c=r("justknobx")._("3429")*(1+u*2),d=await o("WAPromiseDelays").withTimeout(t.messageRangeQuery({ctx:a,ranges:e,tagsFilter:i}),c,l),m=d.map(function(t,r){var a=e[r],i=a.threadId;if(t.success===!1)return t;var l=t.value,s=l.cursorInfo,u=l.messages,c=n(u,i);return o("WAResultOrError").makeResult({cursorInfo:s,messages:c,threadId:i})});return a.metric.addPoint("eb_fetch_end"),m}async function u(t,n,a,i){var l=n.decryptedProtobufToFullMessage,u=n.eb;try{var c=u.isEbEnabled(),d=c===!0?"true":c===!1?"false":"unset";if(a.metric.addAnnotations({string:{ebEnabled:d}}),c!==!0)return new Map(t.map(function(t){return[t,o("WAResultOrError").makeResult({cursorInfo:e,messages:[],threadId:t.threadId})]}));var m=!1;a.metric.addPoint("load-messages-from-eb_start");var p=await s(t,u,l,a,i),_=new Map(t.map(function(e,t){var n=p[t];return n.success===!1&&(m=!0),[e,n]}));return m&&a.metric.addAnnotations({bool:{ebFetchFailed:!0}}),a.metric.addPoint("load-messages-from-eb_end"),_}catch(e){var f=r("getErrorSafe")(e);return a.metric.addPoint("load-messages-from-eb_fail",{string:{ebFetchFailReason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}}),o("MpsLogger").MpsLogger().catching(f).mustfix("Error fetching from EB"),new Map}}l.loadMessagesFromEb=u}),98);
__d("WebMpsMergeMessageRangesFromDifferentSources",["WebMpsGetDistinctMessages","err","first","last"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk"];function s(t,n,a,i,l){var s,u,c=o("WebMpsGetDistinctMessages").getDistinctMessages((s=n==null?void 0:n.messages)!=null?s:[],(u=t==null?void 0:t.messages)!=null?u:[]),d=c.messages,m=c.supplementalMessagesToWriteToReverb,p=c.tagsToWriteToReverb,_=c.topLevelMessagesToWriteToReverb;if(n==null||t==null){var f=n!=null?babelHelpers.extends({},n,{messages:n.messages.map(function(t){var n=t.reverbTopLevel,r=t.supplementalProtobufs,o=n.debugFlags,a=n.expiryTimestampMs,i=n.isLocalOnlyMessage,l=n.isTransportErrorPlaceholder,s=n.pk,u=babelHelpers.objectWithoutPropertiesLoose(n,e);return{expiryTimestampMs:a,supplementalProtobufs:r,tags:[],toplevelProtobuf:u}})}):t;if(f==null)throw r("err")("data-fetching-error");return{range:f,supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}var g=t,h=[].concat(d).sort(function(e,t){return a==="asc"?e.toplevelProtobuf.timestampMs-t.toplevelProtobuf.timestampMs:t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}),y=h.slice(0,i),C=r("first")(y),b=r("last")(y),v=C!=null?[C.toplevelProtobuf.timestampMs,C.toplevelProtobuf.messageId]:void 0,S=b!=null?[b.toplevelProtobuf.timestampMs,b.toplevelProtobuf.messageId]:void 0,R=S!=null?g.cursorInfo.hasNext||n.cursorInfo.hasNext:!1,L=v!=null?g.cursorInfo.hasPrevious||n.cursorInfo.hasPrevious:!1;return{range:{cursorInfo:{endCursor:S,hasNext:R,hasPrevious:L,startCursor:v},messages:y,threadId:l},supplementalMessagesToWriteToReverb:m,tagsToWriteToReverb:p,topLevelMessagesToWriteToReverb:_}}l.mergeMessageRangesFromDifferentSources=s}),98);
__d("WebMpsEbCache",["MpsTypes","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=o("WAJids").validateChatJid(t);if(l==null)return[];var s=e.getMetadataFromCache({chatJid:l,direction:n,numberOfMessages:r,referenceMessage:i,referenceTimestamp:a==null?null:o("WATimeUtils").castToMillisTime(a)});return s.success===!1?[]:s.value.map(function(e){var t=e.offlineThreadingId,n=e.sortOrderMs;return{offlineThreadingId:t,sortOrderMs:o("MpsTypes").toTimestamp(n)}})}function s(e,t){if(e==null||t.length===0)return"no-match";if(e.cursorInfo.hasNext!==!0)return"reverb-cursor-ended";var n=new Set(e.messages.map(function(e){return e.reverbTopLevel.messageId})),r=new Set(t.map(function(e){return e.offlineThreadingId}));if(n.size!==r.size)return"no-match";if(Array.from(n).every(function(e){return r.has(e)}))return"match";for(var o=e.messages.map(function(e){return e.reverbTopLevel.timestampMs}).sort(function(e,t){return t-e}),a=t.map(function(e){return e.sortOrderMs}).sort(function(e,t){return t-e}),i=0,l=0;l<o.length;l++){var s=o[l],u=a[i];if(s<u)return"no-match";s>u||i++}return"reverb-newer"}l.loadEBMetadataCache=e,l.compareReverbVsMetadataCache=s}),98);
__d("WebMpsValidateReverbViaCacheAndFetchFromEb",["MpsLogger","WebMpsEbCache","WebMpsLoadMessagesFromEb"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,r,a){var i=await t;if(a!=="all")return r.metric.addAnnotations({string:{ebMetadataCache:"skip"}}),{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(e,n,r,a),reverb:i};var l=e.filter(function(e){var t=e.direction,a=e.from,l=e.numMessages,s=e.threadId,u=o("WebMpsEbCache").loadEBMetadataCache(n.eb,s,t,l,a[0],a[1]),c=o("WebMpsEbCache").compareReverbVsMetadataCache(i.get(e),u);return r.metric.addAnnotations({string:{ebMetadataCache:c}}),o("MpsLogger").MpsLogger().debug("MPS Range query metadata comparison: ",c),!(c==="match"||t==="desc"&&c==="reverb-newer")});return l.length===0?{eb:new Map,reverb:i}:{eb:await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(l,n,r,a),reverb:i}}l.validateReverbViaCacheAndFetchFromEb=e}),98);
__d("WebMpsBatchLoadMessages",["MpsLogger","PackedMpsRange","WebMpsBatchLoadFromReverb","WebMpsLoadMessagesFromEb","WebMpsMergeMessageRangesFromDifferentSources","WebMpsPersistMessagesFromEb","WebMpsValidateReverbViaCacheAndFetchFromEb","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,a){var i=n.persistToReverb,l=n.shouldFetchSupplementals,s=n.shouldFetchTags,u=n.shouldIgnoreLocalOnly,c=n.shouldUseBatchSupplementalFetch,d=n.strategy,m=n.tagsFilter,p=e.map(function(e){return o("PackedMpsRange").packMpsRange(e)});try{a.metric.addPoint("mps_fetch_start");var _=function(){return o("WebMpsBatchLoadFromReverb").batchLoadMessagesFromReverb(p,l,s,u,a,m,c)},f,g;switch(d){case"full-fetch":{var h=await o("WebMpsValidateReverbViaCacheAndFetchFromEb").validateReverbViaCacheAndFetchFromEb(p,_(),t,a,m);f=h.reverb,g=h.eb;break}case"local-only":f=await _(),g=new Map;break;case"remote-only":g=await o("WebMpsLoadMessagesFromEb").loadMessagesFromEb(p,t,a,m),f=new Map;break;default:throw r("err")("empty strategy")}var y=p.map(function(e){var t,n=e.direction,r=e.numMessages,a=e.threadId,i=f.get(e),l=(t=g.get(e))==null?void 0:t.value;if(!(i==null&&l==null)){var s=o("WebMpsMergeMessageRangesFromDifferentSources").mergeMessageRangesFromDifferentSources(l,i,n,r,a),u=s.range,c=s.supplementalMessagesToWriteToReverb,d=s.tagsToWriteToReverb,m=s.topLevelMessagesToWriteToReverb;return{range:u,supplementalMessagesToWriteToReverb:c,tagsToWriteToReverb:d,threadId:a,topLevelMessagesToWriteToReverb:m}}}).filter(Boolean);return i==="persist"&&o("WebMpsPersistMessagesFromEb").persistMessagesFromEB(y.map(function(e){var t=e.supplementalMessagesToWriteToReverb,n=e.tagsToWriteToReverb,r=e.threadId,o=e.topLevelMessagesToWriteToReverb;return{supplementalProtobufs:t,tags:n,threadId:r,topLevelProtobufs:o}})),y.map(function(e){var t=e.range;return t})}catch(e){var C=r("getErrorSafe")(e);throw o("MpsLogger").MpsLogger().catching(C).mustfix("Runtime error performing loadMessages"),a.metric.addAnnotations({string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(C)}}),C}}l.batchLoadMessages=e}),98);
__d("MAWMpsCleanersContants",["DateConsts"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("DateConsts").MS_PER_DAY,s=6*o("DateConsts").MS_PER_HOUR;l.PURGE_DELETED_MESSAGES_WINDOW_IN_MS=e,l.REPORTING_WINDOW_IN_MS=s}),98);
__d("WebMpsInsertionCleaners",["MAWMpsCleanersContants","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsTypes","WATimeUtils","err","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){try{await Promise.all(e.map(s)),await Promise.all(e.map(c))}catch(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Failed to run side effects")}}function s(e){return e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel||e.directive.actionType===o("MpsTypes").ActionType.DeleteSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteThread?u(e.message.timestampMs):e.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||e.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||e.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder||e.directive.actionType===o("MpsTypes").ActionType.Noop?Promise.resolve():e.directive.actionType===o("MpsTypes").ActionType.Unknown||e.directive.actionType===o("MpsTypes").ActionType.Preprocess?Promise.reject(r("err")("this should not happen")):(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e.directive.actionType)})()}function u(e){var t=o("WATimeUtils").castToUnixTime(Math.ceil((e+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)/1e3));return o("MpsDeletedCleaner").addNewMpsDeletedTimestamp(t),Promise.resolve()}function c(e){var t,n=(t=e.directive)==null?void 0:t.expiryTimestampMs;if(n==null)return Promise.resolve();var r=o("WATimeUtils").castToUnixTime(Math.ceil(n/1e3));return o("MpsEphemeralCleaner").addNewMpsEphemeralTimestamp(r),Promise.resolve()}l.scheduleCleaners=e}),98);
__d("WebMpsInsertionFlow",["MpsLogger","MpsTypes","WebMpsReverbWrites","WebReverbDB","err","getErrorSafe","justknobx","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";async function e(e){if(r("justknobx")._("4336"))try{return await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",async function(t){for(var n of e)await u(n,function(e){return e(t)})},"mps-insertion-flow-shared"),new Map}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("Failed to persist messages")}return s(e)}async function s(e){var t=new Map,n=async function(n){await u(n,function(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["message","supplemental","deleted","tags","dbMetadata"],"readwrite",function(t){return e(t)},"mps-insertion-flow-separate")}).catch(function(e){t.set(n.message.messageId,e)})};for(var r of e)await n(r);return t}function u(e,t){switch(e.directive.actionType){case o("MpsTypes").ActionType.UpsertTopLevel:return c(e,t);case o("MpsTypes").ActionType.UpsertSupplemental:return d(e,t);case o("MpsTypes").ActionType.DeleteTopLevel:return m(e,t);case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return p(e,t);case o("MpsTypes").ActionType.DeleteSupplemental:return _(e,t);case o("MpsTypes").ActionType.DeleteThread:return f(e,t);case o("MpsTypes").ActionType.Noop:return Promise.resolve();case o("MpsTypes").ActionType.Unknown:case o("MpsTypes").ActionType.Preprocess:return Promise.reject(r("err")("this should not happen"))}}async function c(e,t){var n=e.directive,r=e.message;await o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}async function d(e,t){var n=e.directive,a=e.message,i=r("nullthrows")(n.supplementalKey);await o("WebMpsReverbWrites").upsertSupplementalToReverb(a.messageId,a.payload,i,n.targetMessageId,a.threadId,a.timestampMs,t)}function m(e,t){var n=e.message,r=e.directive.targetMessageId,o=[n.threadId,r];return t(async function(e){var t,a=await e.stores.message.getByIndex("[threadId+messageId]",o),i=await e.stores.deleted.getByIndex("[threadId+deletedMessageId]",o);if(!(((t=i==null?void 0:i.deletionTimestampMs)!=null?t:0)>=n.timestampMs)){var l={deletedMessageId:r,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:!1,payload:a==null?void 0:a.payload,threadId:n.threadId,timestampMs:a==null?void 0:a.timestampMs};await e.stores.deleted.bulkUpsert("[threadId+deletedMessageId]",[{item:l,selector:o}]),a&&await e.stores.message.bulkDelete([a.pk])}})}function p(e,t){var n=e.directive,r=e.message;return o("WebMpsReverbWrites").upsertTopLevelToReverb(r,n,t)}function _(e,t){var n=e.message,o=r("nullthrows")(e.directive.supplementalKey),a=e.directive.targetMessageId,i=[n.threadId,a,o];return t(async function(t){var r=await t.stores.supplemental.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i);if(r!=null){var l=await t.stores.deleted.getByIndex("[threadId+topLevelMessageId+supplementalKey]",i,{filter:function(t){return t.deletionTimestampMs>=n.timestampMs}});if(!l){var s={deletedMessageId:r.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.directive.isLocalOnly,payload:r.payload,supplementalKey:o,threadId:n.threadId,timestampMs:r.timestampMs,topLevelMessageId:a};await t.stores.deleted.bulkUpsert("[threadId+topLevelMessageId+supplementalKey]",[{item:s,selector:i}]),await t.stores.supplemental.bulkDelete([r.pk])}}})}function f(e,t){var n=e.message;return t(async function(e){var t=await e.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[n.threadId]});await e.stores.supplemental.bulkDelete(t);var r=await e.stores.message.readIndexRange("[threadId+messageId]",{only:[n.threadId]});await e.stores.message.bulkDelete(r.map(function(e){return e.pk}));var o=await e.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:[n.threadId]});await e.stores.tags.bulkDelete(o);var a=await e.stores.deleted.readKeysByIndexRange("[threadId+deletedMessageId]",{only:[n.threadId]});await e.stores.deleted.bulkDelete(a),await e.stores.deleted.bulkAdd(r.map(function(e){return{deletedMessageId:e.messageId,deletionMessageId:n.messageId,deletionMessagePayload:n.payload,deletionTimestampMs:n.timestampMs,isLocalOnlyMessage:e.isLocalOnlyMessage,payload:e.payload,threadId:e.threadId,timestampMs:e.timestampMs}}))})}l.persistNewMessages=e}),98);
__d("WebMpsLoadDeletedMessages",["MpsTypes","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["pk","supplementalKey","threadId","topLevelMessageId"];async function s(t,n){var r=o("WebReverbDB").getWebReverbDB(),a=await r.runInTransaction(["deleted","supplemental"],"readonly",async function(n){var r=await n.stores.deleted.readIndexRange("[threadId+timestampMs+deletedMessageId]",{lessThanOrEqual:[t.threadId,o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER)]},{limit:t.numMessages});return Promise.all(r.map(async function(r){var o=await n.stores.supplemental.readIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:[t.threadId,r.deletedMessageId]}),a=new Map;return o.forEach(function(t){var n=t.pk,r=t.supplementalKey,o=t.threadId,i=t.topLevelMessageId,l=babelHelpers.objectWithoutPropertiesLoose(t,e);a.set(r,l)}),{deletedEntity:r,supplementalProtobufs:a}}))},"get-deleted-messages-for-spam-report"),i=a.map(function(e){if(e.deletedEntity.payload!=null){var r=e.deletedEntity.payload;if(e.deletedEntity.timestampMs!=null){var o=e.deletedEntity.timestampMs;return n([{otid:e.deletedEntity.deletedMessageId,supplementalProtobufs:new Map(e.supplementalProtobufs.entries().map(function(e){var t=e[0],n=e[1];return[t,{decryptedProtobuf:n.payload,protobufTimestampMS:n.timestampMs}]})),tags:[],toplevelProtobuf:{decryptedProtobuf:r,protobufTimestampMS:o}}],t.threadId)[0]}}}).filter(Boolean);return{messages:i,tombstones:new Set(a.map(function(e){return e.deletedEntity.deletionMessageId}))}}l.loadDeletedMessages=s}),98);
__d("WebMpsPostprocess",["MpsLogger","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n){await Promise.all(t.map(async function(t){var r=t.process(e,n),a=r instanceof Promise?await r.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):r;a!=null&&a.size>0&&a.forEach(function(e,t){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessor fails %s",t)})})).catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("Non-critical postprocessors runtime failure")})}async function s(e,t,n){var r=new Map,a=async function(a){n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_start");var t=a.process(e,n),i=t instanceof Promise?await t.catch(function(e){o("MpsLogger").MpsLogger().catching(e).mustfix("PostProcessor Runtime failure")}):t;i!=null&&i.size>0&&i.forEach(function(e,t){r.set(t,e),o("MpsLogger").MpsLogger().catching(e).mustfix("Critical postprocessor fails %s",t),n.messageToQpl.endFail(t,a.name.toLowerCase()+"-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}),n.messageToQpl.all(e.map(function(e){return e.message.messageId})).addPoint(a.name+"_end")};for(var i of t)await a(i);return r}l.runNonCriticalPostprocessor=e,l.runCriticalPostprocessor=s}),98);
__d("WebMpsPurgeDeletedPayload",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.filter(function(e){return e.payload!=null});return e.metric.addAnnotations({int:{num_deletions:a.length}}),await t.stores.deleted.bulkPut(a.map(function(e){return babelHelpers.extends({},e,{payload:null,timestampMs:null})})),a.length},"web-mps-purge-deletions")}function s(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS),n=await e.stores.deleted.readIndexRange("deletionTimestampMs",{greaterThan:[t]},{order:"asc"}),r=n.filter(function(e){return e.payload!=null});if(!(r.length===0||r[0].deletionTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(r[0].deletionTimestampMs+o("MAWMpsCleanersContants").REPORTING_WINDOW_IN_MS)},"web-mps-next-deletion-timestamp-ms")}catch(e){throw e}}l.purgeDeletedPayload=e,l.getNextDeletionTimestampMs=s}),98);
__d("WebMpsPurgeDeletions",["MAWMpsCleanersContants","MpsTypes","WATimeUtils","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WebReverbDB").getWebReverbDB().runInTransaction(["deleted","supplemental","tags","message"],"readwrite",async function(t){var n=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()-o("MAWMpsCleanersContants").PURGE_DELETED_MESSAGES_WINDOW_IN_MS),r=await t.stores.deleted.readIndexRange("deletionTimestampMs",{lessThanOrEqual:[n]}),a=r.map(function(e){return[e.threadId,e.deletedMessageId]});e.metric.addAnnotations({int:{num_deletions:r.length}});var i=Promise.all(a.map(function(e){return t.stores.supplemental.readKeysByIndexRange("[threadId+topLevelMessageId+supplementalKey]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.supplemental.bulkDelete(e)}),l=Promise.all(a.map(function(e){return t.stores.tags.readKeysByIndexRange("[threadId+messageId+tag]",{only:e})})).then(function(e){return e.flat()}).then(function(e){return t.stores.tags.bulkDelete(e)}),s=t.stores.deleted.bulkDelete(r.map(function(e){return e.pk}));return await Promise.all([i,l,s]),r.length},"web-mps-purge-deletions")}l.purgeDeletions=e}),98);
__d("WebMpsScheduler",["WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){if(e==null){var t;e=o("WorkerScheduler").makeScheduler("MPS",{concurrency:(t=r("justknobx"))._("4338"),defaultSamplingRate:t._("4540"),maxTaskLimit:t._("4338"),maxThrottleMs:t._("4339"),timeoutMs:t._("4337")})}return e}l.mpsScheduler=s}),98);
__d("WmiMultiQplTracker",["QPLMultiplexedFlow"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map,s=(function(){function e(e){var t=this;this.$1=new Map,e.forEach(function(e){t.$1.set(e[0],e[1])})}e.from=function(n){return new e(n)};var t=e.prototype;return t.addAnnotations=function(t,n){var e;(e=this.$1.get(t))==null||e.addAnnotations(n)},t.addPoint=function(t,n,r){var e;(e=this.$1.get(t))==null||e.addPoint(n,r)},t.endSuccess=function(t){var e=this.$1.get(t);e!=null&&(e.endSuccess(),this.$1.delete(t),this.$2=null)},t.endFail=function(t,n,r){var e=this.$1.get(t);e!=null&&(e.endFail(n,{string:{errorDescription:r}}),this.$1.delete(t),this.$2=null)},t.size=function(){return this.$1.size},t.all=function(t){var e=this;if(t!=null){var n=t.map(function(t){return e.$1.get(t)}).filter(Boolean);return o("QPLMultiplexedFlow").makeQplMultiplexedFlow(n)}if(!this.$2){var r=o("QPLMultiplexedFlow").makeQplMultiplexedFlow(Array.from(this.$1.values()));return this.$2=r,r}return this.$2},t.failAllPending=function(t){this.$1.forEach(function(e){return e.endFail(t)}),this.$1.clear(),this.$2=null},e.empty_TEST_ONLY=function(){return new e([])},e})();function u(t,n){e.set(t,n)}function c(t){return e.get(t)}l.WmiMultiQplTracker=s,l.trackQplForSeqId=u,l.getQplForSeqId=c}),98);
__d("schedulePeriodicTask",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=async function(){try{await e()}finally{globalThis.setTimeout(n,t)}};globalThis.setTimeout(n,0)}i.schedulePeriodicTask=e}),66);
__d("WebMps",["DateConsts","MpsDeletedCleaner","MpsEphemeralCleaner","MpsLogger","MpsReverbDbDump","MpsReverbInit","MpsTypes","QPLFlow","WAPromiseQueue","WAResultOrError","WATimeUtils","WAWaitForUserUnblocked","WebMpsBatchLoadMessage","WebMpsBatchLoadMessages","WebMpsInsertionCleaners","WebMpsInsertionFlow","WebMpsLoadDeletedMessages","WebMpsPostprocess","WebMpsPurgeDeletedPayload","WebMpsPurgeDeletions","WebMpsPurgeExpiredMessages","WebMpsScheduler","WmiMultiQplTracker","WorkerScheduler","err","getErrorSafe","getSafeQplErrorMessage","justknobx","memoizeWithArgsLFUCache","mergeMaps","qpl","schedulePeriodicTask"],(function(t,n,r,o,a,i,l){"use strict";var e=["debug"],s=["config"],u=["debug"],c;function d(e){return JSON.stringify(e)}async function m(e){var t=e.db,n=e.dependencies,a=e.getMpsExtensionConfiguration;if(c!=null)throw r("err")("MPS already initialised");await o("MpsReverbInit").initReverb(t);var i=new p(a(),n);return c=i,i}var p=(function(){function t(t,n){var a=this;this.$3=[],this.$6=new(o("WAPromiseQueue")).PromiseQueue,this.batchLoadMessage=function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageIds,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return a.$2.batchLoad({config:m,ctx:t,messageIds:c,threadId:d})},name:"batch-load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY}).then(function(e){return a.$10(e.filter(Boolean),m),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$11=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s=e.config,u=e.debug,c=e.messageId,d=e.threadId,m={persistToReverb:(t=s==null?void 0:s.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=s==null?void 0:s.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=s==null?void 0:s.shouldFetchTags)!=null?i:!0,strategy:(l=s==null?void 0:s.strategy)!=null?l:"full-fetch"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:u.purpose,strategy:m.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4536"),fn:async function(t){var e=await a.$2.load({config:m,ctx:t,messageId:c,threadId:d});return e!=null&&a.$10([e],m),e},name:"load-message",priority:o("WorkerScheduler").BLOCKING_PRIORITY})},function(t){var n=t.debug,r=babelHelpers.objectWithoutPropertiesLoose(t,e);return d(babelHelpers.extends({},r,{ebEnabled:a.$1.eb.isEbEnabled()}))},1,function(e){a.$3.push(e)}),this.loadMessage=function(e){return a.$11(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$12=function(e){var t,n,i=e.config,l=e.debug,s=e.ranges;return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:l.purpose,strategy:(t=i==null?void 0:i.strategy)!=null?t:"full-fetch"}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages(s.map(function(e){var t=e.direction,n=e.from,r=e.numMessages,a=e.threadId;return{direction:t,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(n[0])),n[1]],numMessages:r,threadId:a}}),a.$1,i,t)},name:"batch-load-messages",priority:(n=i.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY})},this.batchLoadMessages=function(e){var t,n,i,l,u,c,d,m,p=e.config,_=babelHelpers.objectWithoutPropertiesLoose(e,s),f={persistToReverb:(t=p==null?void 0:p.persistToReverb)!=null?t:"persist",priority:(n=p==null?void 0:p.priority)!=null?n:o("WorkerScheduler").BLOCKING_PRIORITY,shouldFetchSupplementals:(i=p==null?void 0:p.shouldFetchSupplementals)!=null?i:!0,shouldFetchTags:(l=p==null?void 0:p.shouldFetchTags)!=null?l:!0,shouldIgnoreLocalOnly:(u=p==null?void 0:p.shouldIgnoreLocalOnly)!=null?u:!1,shouldUseBatchSupplementalFetch:(c=p==null?void 0:p.shouldUseBatchSupplementalFetch)!=null?c:!1,strategy:(d=p==null?void 0:p.strategy)!=null?d:"full-fetch",tagsFilter:(m=p==null?void 0:p.tagsFilter)!=null?m:"all"};return a.$12(babelHelpers.extends({},_,{config:f})).then(function(e){var t=e.flatMap(function(e){return e.messages});return a.$10(t,f),o("WAResultOrError").makeResult(e)}).catch(function(e){var t=r("getErrorSafe")(e);return o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.$13=r("memoizeWithArgsLFUCache")(function(e){var t,n,i,l,s,u,c,d,m=e.config,p=e.debug,_=e.direction,f=e.from,g=e.numMessages,h=e.threadId,y={persistToReverb:(t=m==null?void 0:m.persistToReverb)!=null?t:"persist",shouldFetchSupplementals:(n=m==null?void 0:m.shouldFetchSupplementals)!=null?n:!0,shouldFetchTags:(i=m==null?void 0:m.shouldFetchTags)!=null?i:!0,shouldIgnoreLocalOnly:(l=m==null?void 0:m.shouldIgnoreLocalOnly)!=null?l:!1,shouldUseBatchSupplementalFetch:(s=m==null?void 0:m.shouldUseBatchSupplementalFetch)!=null?s:!1,strategy:(u=m==null?void 0:m.strategy)!=null?u:"full-fetch",tagsFilter:(c=m==null?void 0:m.tagsFilter)!=null?c:"all"};return o("WebMpsScheduler").mpsScheduler().runTask({annotations:{string:{purpose:p.purpose,strategy:y.strategy}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4538"),fn:function(t){return o("WebMpsBatchLoadMessages").batchLoadMessages([{direction:_,from:[o("MpsTypes").toTimestamp(o("WATimeUtils").miAdjustTimestamp(f[0])),f[1]],numMessages:g,threadId:h}],a.$1,y,t).then(function(e){e.length>1&&o("MpsLogger").MpsLogger().mustfix("loadMessages returned more than one range");var t=e.at(0);if(t==null)throw r("err")("loadMessages returned no result. Likely this is the result of both reverb and EB queries failing");return a.$10(t.messages,y),t})},name:"load-messages",priority:(d=m==null?void 0:m.priority)!=null?d:o("WorkerScheduler").BLOCKING_PRIORITY})},function(e){var t,n=e.debug,r=babelHelpers.objectWithoutPropertiesLoose(e,u);return d(babelHelpers.extends({},r,{config:babelHelpers.extends({},r.config,{tagsFilter:(function(e){if(e==="all"||e===void 0)return"all";{var t=e;return Array.from(t.values())}})((t=r.config)==null?void 0:t.tagsFilter)}),ebEnabled:a.$1.eb.isEbEnabled()}))},10/60,function(e){a.$3.push(e)}),this.loadMessages=function(e){return a.$13(e).then(function(e){return o("WAResultOrError").makeResult(e)}).catch(function(e){a.$7();var t=r("getErrorSafe")(e);return o("WAResultOrError").DEPRECATED_makeError("runtime-error",t)})},this.extensionConfiguration=t,this.$1=n,this.$2=new(o("WebMpsBatchLoadMessage")).WebMpsPointQueryApi(n),this.$4(function(e){return n.generateDeletionMessage(e)}),this.$5(function(e){return n.generateDeletionMessage(e)})}var n=t.prototype;return n.saveNewMessages=function(t,n){var e=this,a=o("WebMpsScheduler").mpsScheduler().task({annotations:{string:{source:n.source}},customFlags:{runtimeReliability:!0},eventSamplingRate:r("justknobx")._("4535"),fn:async function(){e.$7();var n={messageToQpl:o("WmiMultiQplTracker").WmiMultiQplTracker.from(t.map(function(e){return[e.message.messageId,o("QPLFlow").startQPLFlow(r("qpl")._(1056834650,"494"),{annotations:{string:{messageId:e.message.messageId,senderId:e.message.senderId,threadId:e.message.threadId}}})]}))};n.messageToQpl.all(t.map(function(e){return e.message.messageId})).addPoint("preprocess_start");var a=await e.extensionConfiguration.preprocessors.run({ctx:n,payloadList:t}),i=a.errors,l=a.payloadList;n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("preprocess_end"),i.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"preprocess-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),r("justknobx")._("4033")&&(n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_start"),await o("WebMpsInsertionCleaners").scheduleCleaners(l),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("schedule_cleaners_end")),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_start");var s=await o("WebMpsInsertionFlow").persistNewMessages(l);n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persist_end"),s.entries().forEach(function(e){var t=e[0],r=e[1];n.messageToQpl.endFail(t,"persist-error",o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r))}),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("persisted"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_start");var u=await e.$8(l,n);return n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("critical_postprocess_end"),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_start"),e.$9(l,n),n.messageToQpl.all(l.map(function(e){return e.message.messageId})).addPoint("non_critical_postprocess_end"),l.forEach(function(e){n.messageToQpl.endSuccess(e.message.messageId)}),r("mergeMaps")(i,s,u)},name:"save-new-messages",priority:o("WorkerScheduler").BLOCKING_PRIORITY});return this.$6.enqueue(function(){return a.run()})},n.$9=function(t,n){o("WebMpsPostprocess").runNonCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.nonCritical,n).catch(function(e){var t=r("getErrorSafe")(e);o("MpsLogger").MpsLogger().catching(t).mustfix("Non-critical postprocessor failed with runtime error")})},n.$8=function(t,n){return o("WebMpsPostprocess").runCriticalPostprocessor(t,this.extensionConfiguration.postProcessors.critical,n).catch(function(e){var t=r("getErrorSafe")(e);return o("MpsLogger").MpsLogger().catching(t).mustfix("Critical postprocessor failed with runtime error"),new Map})},n.purgeDeletions=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletions").purgeDeletions,name:"purge-deletions",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletions"),0}},n.purgeDeletedPayload=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").purgeDeletedPayload,name:"purge-deleted-payload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeDeletedPayload"),0}},n.getNextDeletionTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({fn:o("WebMpsPurgeDeletedPayload").getNextDeletionTimestampMs,name:"get-next-deletion-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextDeletionTimestampMs")}},n.purgeExpiredMessages=async function(t){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:function(n){return o("WebMpsPurgeExpiredMessages").purgeExpiredMessages(t,n)},name:"purge-expired-messages",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){return o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running purgeExpiredMessages"),0}},n.getNextExpiryTimestampMs=async function(){try{return await o("WAWaitForUserUnblocked").waitForUserUnblocked(),o("WebMpsScheduler").mpsScheduler().runTask({eventSamplingRate:r("justknobx")._("4539"),fn:o("WebMpsPurgeExpiredMessages").getNextExpiryTimestampMs,name:"get-next-expire-timestamp-ms",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("failed running getNextExpiryTimestampMs")}},n.debugDbDump=function(){return o("MpsReverbDbDump").debugGetReverbDbDump()},n.spamReportLoadMessages=function(t){var e=this;return o("WebMpsScheduler").mpsScheduler().runTask({fn:async function(){var n=await Promise.all([e.$13({config:{persistToReverb:"no-persist",shouldFetchSupplementals:!0,shouldFetchTags:!1,shouldIgnoreLocalOnly:!1,strategy:"local-only",tagsFilter:"all"},debug:{purpose:"get-latest-msgs-for-spam-report"},direction:"desc",from:[o("MpsTypes").toTimestamp(Number.MAX_SAFE_INTEGER),null],numMessages:t.numMessages,threadId:t.threadId}),o("WebMpsLoadDeletedMessages").loadDeletedMessages(t,e.$1.decryptedProtobufToFullMessage)]),r=n[0],a=n[1],i=r.messages.filter(function(e){return!a.tombstones.has(e.toplevelProtobuf.messageId)});return[].concat(i,a.messages).toSorted(function(e,t){return t.toplevelProtobuf.timestampMs-e.toplevelProtobuf.timestampMs}).slice(0,t.numMessages)},name:"get-latest-msgs-for-spam-report"})},n.$7=function(){this.$3.forEach(function(e){return e()})},n.$10=function(t,n){var e=this.extensionConfiguration.readSideEffects;if(!(e==null||t.length===0))try{e(t,n)}catch(e){o("MpsLogger").MpsLogger().catching(r("getErrorSafe")(e)).mustfix("readSideEffects failed")}},n.$4=function(t){var e=this;o("schedulePeriodicTask").schedulePeriodicTask(function(){return e.purgeDeletions()},o("DateConsts").MS_PER_MIN*20),r("justknobx")._("4033")||o("schedulePeriodicTask").schedulePeriodicTask(function(){return e.purgeExpiredMessages(t)},o("DateConsts").MS_PER_MIN*10)},n.$5=function(t){var e=this;r("justknobx")._("4033")&&(o("MpsEphemeralCleaner").startMpsEphemeralCleaner({getNextTs:function(){return e.getNextExpiryTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeExpiredMessages(t)}}),o("MpsDeletedCleaner").startMpsDeletedCleaner({getNextTs:function(){return e.getNextDeletionTimestampMs()},purgeEnabled:function(){return!0},removeExpired:function(){return e.purgeDeletedPayload()}}))},t})();function _(){if(c==null)throw r("err")("MPS not initialised");return c}function f(){c=void 0}l.makeMps=m,l.mps=_,l.resetMps_TEST_ONLY=f}),98);
__d("WebMpsPurgeExpiredMessages",["MpsTypes","WATimeUtils","WebMps","WebReverbDB"],(function(t,n,r,o,a,i,l){"use strict";var e=["debugFlags","expiryTimestampMs","isLocalOnlyMessage","isTransportErrorPlaceholder","pk","timestampMs"];async function s(t,n){var r=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),a=await o("WebReverbDB").getWebReverbDB().runInTransaction(["message","deleted"],"readonly",async function(e){var t=await e.stores.message.readIndexRange("expiryTimestampMs",{lessThanOrEqual:[r]});return n.metric.addAnnotations({int:{num_expired_messages:t.length}}),t},"web-mps-purge-deletions");if(a.length===0)return 0;var i=a.map(function(n){var a=n.debugFlags,i=n.expiryTimestampMs,l=n.isLocalOnlyMessage,s=n.isTransportErrorPlaceholder,u=n.pk,c=n.timestampMs,d=babelHelpers.objectWithoutPropertiesLoose(n,e);return{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:t(babelHelpers.extends({},d,{timestampMs:r}))}});return await o("WebMps").mps().saveNewMessages(i,{source:"purge-expired-messages"}),a.length}function u(){try{return o("WebReverbDB").getWebReverbDB().runInTransaction(["message"],"readonly",async function(e){var t=o("MpsTypes").toTimestamp(o("WATimeUtils").unixTimeMs()),n=await e.stores.message.readIndexRange("expiryTimestampMs",{greaterThan:[t]},{limit:1,order:"asc"});if(!(n.length===0||n[0].expiryTimestampMs==null))return o("WATimeUtils").castMilliSecondsToUnixTime(n[0].expiryTimestampMs)},"web-mps-next-expiry-timestamp-ms")}catch(e){throw e}}l.purgeExpiredMessages=s,l.getNextExpiryTimestampMs=u}),98);
__d("MAWBridgeEventTransmitter",["EBAPI","EBLogger","LSIntEnum","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTrace","MAWBridgeTypesCreators","MAWBridgeUpload","MAWIndexedDb","MAWJobDefinitions","MAWUploadThreadTxns","MpsTypes","WAJids","WALogger","WATimeUtils","WebMps"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Issuing point query for message: ",""])),t),r("EBAPI").isEBEnabled()!==!1&&o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,shouldFetchTags:!1,strategy:"full-fetch"},debug:{purpose:"issuePointQueryOutsideTxn"},messageId:o("MpsTypes").toMessageId(t),threadId:o("MpsTypes").toThreadId(a)}).then(function(e){var t=e.value;t!=null&&o("MAWBridge").getBridge().sendAndReceive("event","uiUpdate",{events:[{tag:"RestoreNativeOp",value:{chatJid:a,decryptedMessagesProtobufs:[o("MAWJobDefinitions").mpsMessageToEncryptedBackupsMessage(t)],isPointQuery:!0,taskSource:(s||(s=o("LSIntEnum"))).ofNumber(n!=null?n:r("LSMEBTaskCreationSource").UNKNOWN)}}]}).catch(function(e){return o("EBLogger").EBLogger().tags(["eventTransmitter","mps"]).catching(e).warn("failure while executing UI update")})})}function c(e,t){o("MAWIndexedDb").afterTransaction({tag:"DeleteMessagesOfThread",value:o("MAWBridgeUpload").createBridgeDeleteMessagesOfThread(o("WAJids").threadIdForChatJid(e.jid),o("MAWUploadThreadTxns").getFolderTypeAsText(e.folder),"AdvancedCrypto",t!=null?t:o("WATimeUtils").castToMillisTime(1),null,2)})}function d(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"StartTrace",value:o("MAWBridgeTrace").createBridgeStartTraceData(e,t,n)}]})}function m(e,t,n){o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({cannotReplyReason:e,folder:t,threadJid:n})}]})}l.issuePointQueryOutsideTxn=u,l.deleteMessagesOfThreadAfterTxn=c,l.startTraceOutsideTxn=d,l.updateThreadOutsideTxn=m}),98);
__d("MAWQuotedMsgUtils",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.content.type==="NoteReply"?e.content.msgContent==null?e:babelHelpers.extends({},e,{content:babelHelpers.extends({},e.content,{msgContent:void 0})}):e}function s(t){return t.content.expirationTs==null||t.content.expirationTs>o("WATimeUtils").unixTime()?t:e(t)}l.dbQuotedMsgWithoutExpirableContent=e,l.dbQuotedMsgWithoutExpiredContent=s}),98);
__d("MAWGetMsgQuoteTxn",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWQuotedMsgUtils","MAWTransactionMode","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return t==null||t===o("WAJids").AUTHOR_SYSTEM?null:o("WAJids").authorAsUserJid(t)};function s(t,n,a,i){var l=n.quote,s=(l==null?void 0:l.content)||{},u=s.author,c=s.externalId;if(u==null)return o("MAWDexieTable").dexieResolve(null);var d=o("WAJids").isAuthorMe(u)?o("WAJids").AUTHOR_ME:e(u);if(l==null||d==null||c==null)return o("MAWDexieTable").dexieResolve(null);var m={author:d,chat:a,externalId:c};if(l.content.type==="NoteReply")return o("MAWDexieTable").dexieResolve({quote:o("MAWQuotedMsgUtils").dbQuotedMsgWithoutExpiredContent(l),quoteExternalId:l.content.externalId});var p=i!=null&&i==="ebrestore"?r("LSMEBTaskCreationSource").EB_POINT_QUERY_RESTORE_PROTOBUF:r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT;return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,m).then(function(e){if(o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(m.externalId,p,m.chat),e==null||!o("MAWMsgType").isQuotedMsgType(e.type))return{quote:l,quoteExternalId:l.content.externalId};o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(e,null,!0)});var t=e.author,n=e.externalId,r=e.mediaId,a=e.msgContent,i=e.msgId,s=e.plaintextHash,u=e.specialTextSize,c=e.ts,d=e.type,_=e.xmaMessageType,f={author:t,externalId:n,mediaId:r,msgContent:a,msgId:i,plaintextHash:s,specialTextSize:u,ts:c,type:d,xmaMessageType:_};return e.messageExpirationTs!=null&&e.messageExpirationTs<o("WATimeUtils").unixTime()&&(f=babelHelpers.extends({},f,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})),{quote:babelHelpers.extends({},l,{content:f}),quoteExternalId:e.externalId}})}function u(e,t,n){return s(e,t,n).then(function(e){return babelHelpers.extends({},t,{quote:e==null?void 0:e.quote,quoteExpirationTs:e==null?void 0:e.quote.content.expirationTs,quoteExternalId:e==null?void 0:e.quoteExternalId})})}function c(e,t){return e.messages.where("quoteExternalId").anyOf(t).toArray()}var d=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"maybeBatchGetMsgsByQuoteExternalId",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return c.apply(void 0,[e].concat(n))})});l.getMsgQuoteInfo=s,l.enhanceMsgWithQuoteInfo=u,l.maybeBatchGetMsgsByQuoteExternalId=c,l.maybeBatchGetMsgsByQuoteExternalIdWithTransaction=d}),98);
__d("MAWThreadEventConst",[],(function(t,n,r,o,a,i){"use strict";var e="placeholderConvertSubscription";i.PLACEHOLDER_CONVERT_SUBSCRIPTION=e}),66);
__d("MAWUpdateQuotedMsgTxns",["MAWAuthor","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,n,r,a,i,l,s){var e=o("MAWAuthor").getAuthorUserJid(a);return t.messages.where("quoteExternalId").equals(r).toArray().then(function(r){if(r.length!==0){var a=r;(s==null||!s)&&(a=r.filter(function(t){var r=t.quote,a=t.threadJid;return o("MAWAuthor").getAuthorUserJid(r==null?void 0:r.content.author)===e&&a===n}));var u=a.map(function(e){var t,n=Object.assign({},(t=e.quote)==null?void 0:t.content,i.content),r=babelHelpers.extends({},e.quote,i,{content:n});return r.content.msgId==null&&l!=null&&(r.content.msgId=l),babelHelpers.extends({},e,{quote:r})});return t.messages.bulkPut(u).then(function(){return u})}})},s=function(n,r,a,i,l){l===void 0&&(l=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var t={content:{mediaId:void 0,msgContent:void 0,type:l}};return e(n,r,a,i,t).then(function(e){e!=null&&e.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})},u=function(t,n,r){r===void 0&&(r=o("MAWMsgType").MSG_TYPE.UNAVAILABLE);var e=n.author,a=n.chat,i=n.externalId;return t.threads.get({jid:a}).then(function(n){if(n!=null)return s(t,n.jid,i,e,r)})},c=function(n,r,a,i){var t=a.author,l=a.externalId,s=a.mediaId,u=a.msgContent,c=a.msgId,d=a.plaintextHash,m=a.ts,p=a.type;if(o("WAJids").isAuthorSystem(t))return o("MAWDexieTable").dexieResolve();var _={author:t,chat:r,externalId:l};if(!o("MAWMsgType").isQuotedMsgType(p))return o("MAWDexieTable").dexieResolve();var f=o("MAWDexieTable").dexieResolve(null);return a.type===o("MAWMsgType").MSG_TYPE.XMA&&(f=o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(n,_).then(function(e){return e.success===!1?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve(e.value)})),f.then(function(o){var a,_,f,g,h,y={author:t,externalId:l,mediaId:(a=o==null||(_=o.defaultPreview)==null?void 0:_.mediaId)!=null?a:s,msgContent:u,plaintextHash:(f=o==null||(g=o.defaultPreview)==null?void 0:g.plaintextHash)!=null?f:d,ts:m,type:p,xmaMessageType:o==null||(h=o.xma)==null?void 0:h.targetType};return e(n,r,l,t,{content:y},c,i)})};function d(e,t,n){return o("MAWDexieTable").dexieAll([c(e,n,t),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)]).then(function(n){var r=n[0],a=n[1];return r!=null?o("MAWDexieTable").dexieResolve(m(t,a)).then(function(){o("MAWDexieTable").dexieAll(r.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){return m(t,e),t})}))}):o("MAWDexieTable").dexieResolve([])})}function m(e,t){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,t)})}l.disassociateQuotedMsg=s,l.disassociateQuotedMessageByProtocolMsgId=u,l.associateQuotedMessage=c,l.associateAllReplies=d,l.issueReplyMsgUpdate=m}),98);
__d("MAWUseProtocolMsgIdForMsgId",[],(function(t,n,r,o,a,i){"use strict";function e(){return!0}i.shouldUseProtocolMsgIdForMsgId=e}),66);
__d("MAWBridgeParticipants",["MAWBridgeParticipantsUpdatedHandler","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.deliveredWatermarkTs,n=e.threadJid,r=e.type,a=e.userJid;return babelHelpers.extends({deliveredWatermarkTs:t||o("WATimeUtils").castToUnixTime(0),fbid:o("WAJids").extractUserId(a)},o("MAWBridgeParticipantsUpdatedHandler").mawToLsParticipantTypeConversion(r),{lastReadActionTs:o("WATimeUtils").castToUnixTime(0),readWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n})}function s(t){return{participants:t.map(function(t){return e(t)})}}l.createBridgeParticipant=e,l.createBridgeParticipants=s}),98);
__d("MAWDbParticipantTxns",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWCurrentUser","MAWDbParticipant","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWUserJidWrapper","MWFBLogger","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t,n,r){return r===void 0&&(r=!0),p(e,n.map(function(e){return babelHelpers.extends({},e,{chatJid:t})}),r)}function d(e,t){o("WAJids").switchOnMsgrChatJidType(e.threadJid,{group:r("emptyFunction"),user:function(r){e.userJid!==r&&e.userJid!==o("MAWUserJidWrapper").getMyUserJid()&&o("MWFBLogger").MWLogger().tags(["db","txn"]).mustfix("Attempting to insert participant to a mismatched one-on-one thread at %s",t)}})}function m(e){var t=e.addressable,n=e.chatJid,r=e.type,a=e.userJid;return{addressable:t,deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),id:o("MAWDbParticipant").craftParticipantId(n,a),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0),threadJid:n,type:r!=null?r:"participant",userJid:a}}function p(e,t,n){if(n===void 0&&(n=!0),t.length===0)return o("MAWDexieTable").dexieResolve([]);var r=t.map(function(e){return m(e)});return r.forEach(function(e){return d(e,"bulkAddParticipantsInThreads")}),e.participants.bulkPut(r).then(function(){return n&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(r)}),r})}function _(e,t,n,r){r===void 0&&(r=!0);var a=new Set([t,o("MAWUserJidWrapper").getMyUserJid()]),i=n.filter(function(e){var t=e.userJid;return!a.has(t)}).map(function(e){var t=e.threadJid,n=e.userJid;return[t,n]});return i.length>0&&o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_ONE_TO_ONE_THREAD_PARTICIPANT_CLEANUP,key:o("MAWCurrentUser").isEmployee()?"employee":"public"}),b(e,i,r)}function f(e,t,n,r){r===void 0&&(r=!0);var a=Array.from(new Set([t,o("MAWUserJidWrapper").getMyUserJid()])),i=new Set(n.map(function(e){return e.userJid})),l=a.filter(function(e){return!i.has(e)}),s=l.map(function(e){return{type:"participant",userJid:e}});return c(e,t,s,r).then(function(e){var t=a.reduce(function(t,r){var o=e.find(function(e){return e.userJid===r}),a=n.find(function(e){return e.userJid===r});return o!=null&&a==null?t.push(o):a!=null&&t.push(a),t},[]);return t})}function g(e,t,n){return n===void 0&&(n=!0),L(e,t).then(function(r){return _(e,t,r,n).then(function(o){return f(e,t,r,n)})})}function h(e,t){return t.forEach(function(e){return d(e,"bulkUpdateParticipants")}),e.participants.bulkPut(t).then(function(){return t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(t)}),t})}function y(e,t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=n.map(function(e){return[t,e]});return b(e,r)}function C(e,t,n){if(t.length===0)return o("MAWDexieTable").dexieResolve();var r=t.map(function(e){return[e,n]});return b(e,r)}function b(e,t,n){return n===void 0&&(n=!0),e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(t){return e.participants.bulkDelete(t.map(function(e){return e.id})).then(function(){n&&t.forEach(function(e){var t=e.threadJid,n=e.userJid;return o("MAWIndexedDb").afterTransaction({tag:"ParticipantRemoved",value:{threadJid:t,userId:o("WAJids").extractUserId(n)}})})})})}function v(e,t){return e.participants.where("threadJid").equals(t).delete()}function S(e,t,n,r,o){return R(e,[{deliveredWatermarkTs:n,lastReadActionTs:o,lastReadWatermarkTs:r,participantKey:t}]).then(function(e){return e[0]})}function R(t,n,r){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var a=new Map,i=[];return n.forEach(function(e){i.push(e.participantKey),a.set(JSON.stringify(e.participantKey),e)}),t.participants.where(["threadJid","userJid"]).anyOf(i).toArray().then(function(n){n.length!==i.length&&r!=null&&r.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing participants "," vs ",""])),n.length,i.length);var l=[],c=[];return n.forEach(function(e){var t=a.get(JSON.stringify([e.threadJid,e.userJid]));if(t==null){r!=null&&r.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: missing tsData for participant ",", ",""])),e.threadJid,e.userJid);return}var n=t.deliveredWatermarkTs,o=t.lastReadActionTs,i=t.lastReadWatermarkTs,d=e.deliveredWatermarkTs,m=e.lastReadWatermarkTs,p=e.lastReadActionTs,_=n>d,f=i>m,g=p==null||o>p;if(r!=null&&r.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["bulkUpdateParticipantTimestamps: participant ",", "," deliveredWatermarkTs: ",", lastReadWatermarkTs: ",", lastReadActionTs: ",""])),e.threadJid,e.userJid,n,i,o),!_&&!f&&!g){c.push(e);return}l.push(babelHelpers.extends({},e,{deliveredWatermarkTs:_?n:d,lastReadActionTs:g?o:p,lastReadWatermarkTs:f?i:m}))}),l.forEach(function(e){return d(e,"bulkUpdateParticipantTimestamps")}),t.participants.bulkPut(l).then(function(){return l.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"ReceivedReceipt",value:o("MAWBridgeTypesCreators").createBridgeReceivedReceipt(e.threadJid,o("WAJids").extractUserId(e.userJid),e.deliveredWatermarkTs)})}),[].concat(l,c)})})}function L(e,t){return e.participants.where("threadJid").equals(t).toArray()}function E(e,t){return e.participants.where("threadJid").anyOf(t).toArray()}function k(e,t){return L(e,t).then(function(e){return e.filter(function(e){return e.type==="invitedParticipant"})})}function I(e,t,n){return e.participants.where(["threadJid","userJid"]).equals([t,n]).first().then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function T(e,t){return e.participants.where(["threadJid","userJid"]).anyOf(t).toArray().then(function(e){var n=new Map(e.map(function(e){return[JSON.stringify([e.threadJid,e.userJid]),e]}));return t.map(function(e){return n.get(JSON.stringify(e))})})}l.bulkAddParticipants=c,l.logIfIllegalParticipant=d,l.bulkAddParticipantsInThreads=p,l.deleteIncorrectParticipantsInOneToOneThread=_,l.addMissingParticipantsInOneToOneThread=f,l.bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread=g,l.bulkUpdateParticipants=h,l.bulkDeleteParticipantsInThread=y,l.bulkDeleteParticipantAcrossThreads=C,l.bulkDeleteParticipants=b,l.deleteAllParticipantsForThread=v,l.updateParticipantTimestamps=S,l.bulkUpdateParticipantTimestamps=R,l.getParticipantsInThread=L,l.getParticipantsInThreads=E,l.getInvitedParticipantsInThread=k,l.getParticipant=I,l.bulkGetParticipants=T}),98);
__d("MAWWriteMsgSideEffectTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDexieTable"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWDbMsg").getCanonicalTsFromMsg(t),r=t.author;return r!=="@me"&&r!=="@system"?o("MAWDbParticipantTxns").updateParticipantTimestamps(e,[t.threadJid,r],n,n,n):o("MAWDexieTable").dexieResolve()}l.updateParticipantTimestampsForMsg=e}),98);
__d("MAWWriteMsgTxns",["FBLogger","MAWAfterWriteMsgUtil","MAWBridgeMsg","MAWBuildIncomingMsgs","MAWDbEditMsgHistoryTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbReactionsTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDeleteForMeMsgContentCleaner","MAWDeleteThreadUtil","MAWDexieTable","MAWEphemeralMsgTxns","MAWExpiredQuoteCleaner","MAWFTSTxns","MAWFolderTypes","MAWGetMsgQuoteTxn","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWLocalizationType","MAWLocalizationUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWThreadEventConst","MAWTimeUtils","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteMsgSideEffectTxns","MAWWriteRevokeMessageTxns","ODS","WAJids","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=["rowId"],s,u,c;function d(e,t,n,a){var i=n.ts,l=[o("WATimeUtils").castUnixTimeToMillisTime(i),n.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN],s=l[0],u=l[1];return o("MAWGetOrCreateThreadTxns").getExistingThread(e,t.jid).then(function(t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");var i=o("MAWDbMsgTxns").getThreadOldestMessageBySortOrder(e,t.jid),l=o("MAWDbMsgTxns").getThreadNewestMessageBySortOrder(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(e){var r,i,l,c=e[0],d=e[1],m=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?null:d==null?1:o("MAWDbMsg").getInChatMsgIdFromMsgId(d.msgId)+1,p=o("WATimeUtils").castToMillisTime((r=d==null?void 0:d.sortOrderMs)!=null?r:0),_=s>p&&!u?s:p,f=(i=o("MAWTimeUtils").ensureValidMillisTime(t.lastReadMsgTs))!=null?i:0,g=o("WATimeUtils").castToMillisTime((l=d==null?void 0:d.sortOrderMs)!=null?l:0),h=f<g,y=n.author===o("WAJids").AUTHOR_ME||n.type===o("MAWMsgType").MSG_TYPE.ADMIN&&o("MAWLocalizationUtils").isParticipantChangeAdminMsg(n.msgContent.adminType)&&!h,C=babelHelpers.extends({},n,{msgId:m!=null?o("MAWDbMsg").craftMsgIdV2(t.chatId,m,n):o("MAWJidUtils").formatProtocolMsgIdFromMsg(n)}),b=o("MAWDbMsgTxns").calculateOldestMsg(c,d,C,a),v=b.oldestMsg;return{isOldestMsgUpdated:c!=null&&v!==c.msgId,msgId:C.msgId,prevOldestMsg:c,updatedSnippet:void 0,updatedThread:babelHelpers.extends({},t,{lastReadMsg:y?C.msgId:t.lastReadMsg,lastReadMsgTs:y?_:t.lastReadMsgTs,newestMsgTs:_,oldestMsg:v,snippetMsg:t.snippetMsg,snippetMsgTs:t.snippetMsgTs,threadOrder:o("MAWDbThread").craftThreadOrder(_,t.jid)})}})})}function m(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN&&e.type!==o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION?!1:e.type===t.type&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?r:g(e,t,n)})}function p(e,t,n,r){return e.messages.where(["threadJid","sortOrderMs"]).equals([n.jid,r]).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&e.msgContent.adminType===t.msgContent.adminType}).first().then(function(r){return r!=null?((c||(c=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):g(e,t,n)})}function _(e,t,n){return e.messages.where("threadJid").equals(n.jid).filter(function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN&&(e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED||e.msgContent.adminType===o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT)}).first().then(function(r){return r!=null?((c||(c=o("ODS"))).bumpEntityKey(600,"maw_write_msg_txns_deduped_admin_message",t.msgContent.adminType),r):g(e,t,n)})}function f(e,t){return e.messages.add(t).then(function(e){return babelHelpers.extends({},t,{rowId:e})})}function g(e,t,n,r){r===void 0&&(r={});var a=r,i=a.isFirstMsg,l=i===void 0?!1:i,u=a.isOutgoing,c=u===void 0?!1:u,m=a.openMessageOtid,p=a.openMessageParticipantCount,_=a.optimisticMsg,g=a.participantCount,h=a.quotedReplyAttachmentMeta,y=a.shouldUpdateUi,C=y===void 0?!0:y,b=a.sortOrderMs;return d(e,n,t,b).then(function(n){var r=n.isOldestMsgUpdated,a=n.msgId,i=n.prevOldestMsg,u=n.updatedThread,d=babelHelpers.extends({},t,{msgId:a,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t)});return o("MAWDexieTable").dexieAll([f(e,d),e.threads.put(u),o("MAWFTSTxns").maybePutMessageToBacklog(e,d.externalId)]).then(function(e){var t=e[0],n=e[1];return c&&o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeMsgAfterTransaction - sortOrderMs: ",""])),t.sortOrderMs),C&&o("MAWAfterWriteMsgUtil").writeMsgAfterTransaction({dbMsg:t,isFirstMsg:l,openMessageOtid:m,openMessageParticipantCount:p,optimisticMsg:_,participantCount:g,quotedReplyAttachmentMeta:h,updatedThread:u}),t})})}function h(e,t,n){return o("MAWGetOrCreateThreadTxns").getExistingThread(e,n.jid).then(function(a){if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("at this point there's always a thread - checking for updates");return(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()?o("MAWDexieTable").dexieResolve(null):o("MAWDbUnrenderedMsgTxns").getNextUnrenderedMsgIdNumberForThread(e,a)).then(function(r){var i=babelHelpers.extends({},t,{msgId:r!=null?o("MAWDbMsg").craftUnrenderedMsgId(a.chatId,r):o("MAWJidUtils").formatProtocolMsgIdFromExternalId(n.jid,t.externalId)});return o("MAWDexieTable").dexieAll([e.unrenderedMessages.add(i),e.threads.put(a)]).then(function(e){var t=e[0],n=e[1];return babelHelpers.extends({},i,{rowId:t})})})})}function y(e,t,n){return o("MAWDexieTable").dexieAll([C(e,t,n),o("MAWDbEditMsgHistoryTxns").getEditHistoryByOriginalMsgExternalIdAndThreadJid(e,[[t.externalId,n.jid]]).then(function(e){return{editMsgHistories:e,originalEditMsgHistory:e.find(function(e){return e.editExternalId===t.externalId})}})]).then(function(e){var t=e[0],n=e[1],r=n.editMsgHistories,o=n.originalEditMsgHistory;return babelHelpers.extends({},t,{editMsgHistories:r,existingEditMsgHistory:o!=null?o:null})})}function C(e,t,n){var r=[t.externalId,n.jid,t.author],a=r[0],i=r[1],l=r[2];return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,a,l,i),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,a,l,i),o("MAWDbMsgTxns").checkIfMsgIsDeletedForMeOrRevoked(e,a,i,l),o("MAWDbPendingStanzaTxns").maybeGetDeleteThreadFromPendingStanza(e,i).then(function(e){return o("MAWDeleteThreadUtil").isMsgDeletedViaDeleteThread(t.ts,e)})]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4];return{existingMsg:t!=null?t:null,isDeletedWithThread:a,isDeleteForMeOrRevoked:o,pendingDeleteForMeStanza:r!=null?r:null,pendingRevokedStanza:n!=null?n:null}})}function b(e,t,n,r,a){return r===void 0&&(r=!0),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,t.externalId,t.author,n.jid).then(function(i){if(i!=null)return R(e,t,n,i,!0);var l=t.author;o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handle"," Msg: Message from ",", chat ",""])),t.type,l,n.jid);var s=babelHelpers.extends({},babelHelpers.extends({},t,{threadJid:n.jid}));return n.folder===o("MAWFolderTypes").FOLDER_ID.OTHER&&(s.altIndex=s.altIndex===o("MAWDbMsg").FUTUREPROOF_ALT_INDEX?o("MAWDbMsg").FUTUREPROOF_SPAM_ALT_INDEX:o("MAWDbMsg").SPAM_ALT_INDEX),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(e,s,n.jid,a).then(function(t){t!=null&&(s=babelHelpers.extends({},s,{quote:t==null?void 0:t.quote,quoteExpirationTs:t==null?void 0:t.quote.content.expirationTs,quoteExternalId:t==null?void 0:t.quoteExternalId}));var a=s.quoteExpirationTs;return a!=null&&a>o("WATimeUtils").unixTime()&&o("MAWExpiredQuoteCleaner").addNewExpiredQuoteCleanerTimestamp(a),o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,n.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(e,s)]).then(function(t){var a=t[0],i=t[1],l=t[2];return g(e,s,n,{quotedReplyAttachmentMeta:i,shouldUpdateUi:r}).then(function(t){return o("MAWDexieTable").dexieAll([o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(e,s),o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(e,t,r)]).then(function(e){var n=e[1];return a!=null&&r&&a.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,l)})}),n||t})})})})})}function v(t,n,r,a,i,l){var s=babelHelpers.extends({},babelHelpers.extends({},n,{msgId:r.msgId,protocolMsgId:r.protocolMsgId,rowId:r.rowId,serverTs:r.serverTs,sortOrderMs:r.sortOrderMs,threadJid:a.jid,ts:r.ts}));return o("MAWDexieTable").dexieAll([o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(t,a.jid,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,s),o("MAWLoadReplyMediaTxns").getReplyMediaForMsg(t,s),o("MAWGetMsgQuoteTxn").getMsgQuoteInfo(t,s,a.jid,l),o("MAWDbMsgTxns").getThreadNewestMessageId(t,a.jid)]).then(function(l){var u,c=l[0],d=l[1],m=l[2],p=l[3],_=l[4];return s=babelHelpers.extends({},s,{quote:p==null?void 0:p.quote,quoteExternalId:p==null?void 0:p.quoteExternalId}),((u=r.editCount)!=null?u:0)>0&&i!=null&&n.type===o("MAWMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").updateEditMsgHistoryWithNewIncomingMsg(t,i,n).then(function(){return r}):t.messages.put(s).then(function(){return o("MAWDbThreadTxns").needsRetroactiveReadReceiptInThread(t,s)}).then(function(e){if(e)return s.altIndex=o("MAWDbMsg").craftToBeReadAltIndex(a.chatId),t.messages.put(s)}).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,m)}),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(s,d)}),o("MAWIndexedDb").afterTransactionThreadEvent({chatJid:a.jid,msgId:s.msgId},o("MAWThreadEventConst").PLACEHOLDER_CONVERT_SUBSCRIPTION),c!=null&&c.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e,m)})}),s.msgId===_){var n=s,r=n.rowId,i=babelHelpers.objectWithoutPropertiesLoose(n,e);o("MAWWriteMsgSideEffectTxns").updateParticipantTimestampsForMsg(t,i)}return s})})}function S(e,t,n,r){var a=o("MAWBuildIncomingMsgs").buildUnstoredDeleteForMeMsg(t,n);return o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:a.author,chatJid:a.threadJid,externalId:a.externalId}]),h(e,a,n),e.pendingStanzas.delete(r.rowId),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)]).then(function(e){var t=e[0],n=e[1];return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(a.messageDeleteForMeTs),babelHelpers.extends({},a,{msgId:n.msgId,rowId:n.rowId})})}function R(e,t,n,a,i){i===void 0&&(i=!1);var l=o("MAWDbPendingStanzaTxns").getRevokedContent(a);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing revoked content");var s=o("MAWBuildIncomingMsgs").buildUnstoredRevokedMsg(t,n,l);return o("MAWDexieTable").dexieAll([g(e,s,n),e.pendingStanzas.delete(a.rowId)]).then(function(t){var r=t[0];return o("MAWWriteRevokeMessageTxns").markIncomingMessageRevoked(e,r,n).then(function(){return r})})}l.writeDedupedEphemeralSettingAdminMessage=m,l.writeDedupedAdminMessage=p,l.writeDedupedUsersConnectedAdminMessage=_,l.writeMsg=g,l.writeUnrenderedMsg=h,l.prepareTextMsgWriteData=y,l.prepareMsgWriteData=C,l.writeNewIncomingMsg=b,l.writeCiphertextUpdate=v,l.handleDeleteForMeMessage=S,l.handleOutOfOrderRevokedMessage=R}),98);
__d("MAWDbDeletedMessages",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({ChatDelete:"chat_delete",Revoke:"revoke"});i.DbDeletedMsgReasonEnum=e}),66);
__d("MAWMediaManagerDeferred",["promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("MAWMediaManager").__setRef("MAWMediaManagerDeferred");function s(t){r("promiseDone")(e.load().then(function(e){e.getMawMediaManager().dequeueDownload(t)}))}l.dequeueDownload=s}),98);
__d("MAWUnsendMsgContentCleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.UNSEND))}function d(t){if(u==null){var n="Trying to add new UnsendMsgContentCleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["UnsendMsgContentCleaner: Adding timestamps (",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startUnsendMsgContentCleaner=c,l.addNewUnsendMsgContentCleanerTimestamp=d,l.getUnsendMsgContentCleaner_FOR_TESTING_ONLY=m,l.resetUnsendMsgContentCleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWWriteDeleteMessageTxns",["MAWAckLevel","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDbXMATxns","MAWDeleteForMeMsgContentCleaner","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUpdateQuotedMsgTxns","MAWXMAUtils","WAResultOrError","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=30*o("WATimeUtils").DAY_SECONDS;function u(e,t){var n=t.protocolMsgId,r=n.author,a=n.chat,i=n.externalId;return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(e,a),e.unrenderedMessages.get({externalId:i}),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,i)]).then(function(t){var a=t[0],l=t[1];return a.success?l!=null&&l.threadJid===a.value.jid&&l.author===r?o("WAResultOrError").makeError("duplicate_delete_for_me"):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,n).then(function(t){if(t==null){var l={ack:o("MAWAckLevel").ACK.received,author:r,externalId:i,threadJid:a.value.jid,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME},u=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),d={deleteTs:u,externalIdWithType:i+"_"+o("MAWDbPendingStanza").PENDING_DELETE_FOR_ME,pendingContent:{content:l,type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_FOR_ME}};return e.pendingStanzas.add(d).then(function(){return o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(u),o("WAResultOrError").makeResult()})}return o("MAWDexieTable").dexieResolve(c(e,t,r,n.chat,a.value)).then(function(){return o("WAResultOrError").makeResult()})}):o("WAResultOrError").makeError("missing_thread")})}function c(t,n,a,i,l){var s,u,c=o("MAWDexieTable").dexieResolve();o("MAWXMAUtils").isXMAStoryReply((s=n.quote)==null?void 0:s.content.xmaMessageType)&&(c=d(t,n));var p={ack:n.ack,author:a,externalId:n.externalId,mediaId:n.mediaId,messageDeleteForMeTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e),msgContent:(u=o("MAWDbMsg").getMsgContent(n))==null?void 0:u.content,msgId:n.msgId,quote:n.quote,reportingMeta:n.reportingMeta,serverTs:void 0,threadJid:i,ts:n.ts,type:o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME,xmaMessageType:n.xmaMessageType},_=o("MAWDexieTable").dexieAll([m(t,n.author,n.externalId,n.threadJid),o("MAWDbMsgTxns").deleteDbMsg(t,n.rowId),c]).then(function(){if(o("MAWDbMsg").isMediaMsg(n)){var e=n.mediaId,a=n.plaintextHash;e!=null&&(a!=null?(o("MAWMediaManagerDeferred").dequeueDownload(a),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:n.msgId,plaintextHash:a,threadJid:n.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:e,msgId:n.msgId,threadJid:n.threadJid}}))}return o("MAWDexieTable").dexieAll([o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(t,l)]).then(r("emptyFunction"))});return _.then(function(){return o("MAWDexieTable").dexieAll([t.unrenderedMessages.add(p),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(t,[{author:a,chatJid:n.threadJid,externalId:n.externalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(t,n.threadJid,n.externalId,n.author,o("MAWMsgType").MSG_TYPE.REVOKED)]).then(function(){return o("MAWDbMsgTxns").maybeUpdateThreadMsgsForDeleteForMe(t,l.jid,n.msgId,n.sortOrderMs).then(function(){return o("MAWDeleteForMeMsgContentCleaner").addNewDeleteForMeMsgContentCleanerTimestamp(p.messageDeleteForMeTs),o("WAResultOrError").makeResult()})})})}function d(e,t){return o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(t){return o("MAWDbMsgTxns").maybeGetMsg(e,t==null?void 0:t.msgId).then(function(t){if(t!=null)return o("MAWDbMsgTxns").deleteDbMsg(e,t.rowId)})})}function m(e,t,n,r){return e.messages.where("quoteExternalId").equals(n).filter(function(e){var n;return e.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE&&((n=e.quote)==null?void 0:n.content.author)===t&&e.threadJid===r}).toArray().then(function(t){if(t.length===0)return o("MAWDexieTable").dexieResolve([]);var n=t.map(function(e){return e.rowId});return o("MAWDbMsgTxns").bulkDeleteDbMsg(e,n).then(function(){return t})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.handleDeleteForMe=u,l.deleteXMAStoryReplyMsg=d,l.deleteBumpMsgs=m}),98);
__d("MAWWriteRevokeMessageTxns",["FBLogger","LSMEBTaskCreationSource","MAWAckLevel","MAWBridgeEventTransmitter","MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbDeletedMessages","MAWDbMsg","MAWDbMsgTxns","MAWDbPendingStanza","MAWDbProtocolMsgIdMiddleware","MAWDbReactionsTxns","MAWDexieTable","MAWEphemeralUtil","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWMediaManagerDeferred","MAWMsgType","MAWPendingStanzaCleaner","MAWThreadSnippetBuildTxns","MAWUnsendMsgContentCleaner","MAWUpdateQuotedMsgTxns","MAWWriteDeleteMessageTxns","MAWWriteMsgTxns","MAWXMAUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=30*o("WATimeUtils").DAY_SECONDS;function u(e,t,n,a,i,l){if(l!=null&&a==null){var u,d=babelHelpers.extends({},t,{originalTs:o("WATimeUtils").castMilliSecondsToUnixTime(l),threadJid:n.jid,unsendMsgContentDeleteTs:(u=t.serverTs)!=null?u:t.ts});return o("MAWWriteMsgTxns").writeMsg(e,d,n).then(function(e){return e.type==="Revoked"?e:null})}var m=o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+s),_=t.author,f=t.externalId,g=t.revokedExternalId,h=i!=null?p(e,i):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([a==null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,t.revokedExternalId,n.jid,t.author):o("MAWDexieTable").dexieResolve(a),o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,f)]).then(function(i){var l=i[0];if((a==null||l!=null)&&r("FBLogger")("messenger_web").warn("Revoked message missing originalMsg incorrectly"),l==null){var s={deleteTs:m,externalIdWithType:g+"_"+o("MAWDbPendingStanza").PENDING_REVOKED,pendingContent:{content:{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:_,externalId:f,revokedExternalId:g,threadJid:n.jid,ts:t.ts,type:"Revoked"},type:o("MAWDbPendingStanza").PENDING_TYPE.REVOKED}};return o("MAWDexieTable").dexieAll([e.pendingStanzas.add(s),h]).then(function(t){var a=t[0],i=t[1];o("MAWPendingStanzaCleaner").addNewPendingStanzaCleanerTimestamp(m),o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(g,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,n.jid),i===!0&&o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n)})}return h.then(function(){return c(e,l,n,t.externalId,t.revokedExternalId,t.serverTs,t.ts,!1)})})}function c(t,n,r,a,i,l,s,u){var c,m=babelHelpers.extends({},n,{altIndex:void 0,externalId:a,msgContent:o("MAWDbMsg").getMsgContent(n),originalTs:(c=n.serverTs)!=null?c:n.ts,revokedExternalId:i,serverTs:l,threadJid:r.jid,ts:s,type:"Revoked",unsendMsgContentDeleteTs:o("WATimeUtils").castToUnixTime(o("WATimeUtils").unixTime()+e)});return o("MAWDbProtocolMsgIdMiddleware").appendProtocolMsgId(m),u?o("MAWDexieTable").dexieResolve(m):d(t,n,m,r).then(function(){return m})}function d(e,t,n,r){var a,i=o("MAWXMAUtils").isXMAStoryReply((a=t.quote)==null?void 0:a.content.xmaMessageType)?o("MAWWriteDeleteMessageTxns").deleteXMAStoryReplyMsg(e,t):o("MAWDexieTable").dexieResolve(),l=o("MAWJidUtils").toProtocolMsgId(t),s=l!=null?e.deletedMessages.add(babelHelpers.extends({},l,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.externalId,t.threadJid).then(function(){return o("MAWDexieTable").dexieAll([e.messages.put(n),o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:n.author,chatJid:n.threadJid,externalId:n.revokedExternalId}]),o("MAWUpdateQuotedMsgTxns").disassociateQuotedMsg(e,n.threadJid,n.revokedExternalId,n.author,o("MAWMsgType").MSG_TYPE.REVOKED),i,s,o("MAWFTSTxns").maybePutMessageToPurgeBacklog(e,t.externalId)]).then(function(){if(o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(n)}),t!=null&&o("MAWDbMsg").isMediaMsg(t)){var a=t.mediaId,i=t.plaintextHash;a!=null&&(i!=null?(o("MAWMediaManagerDeferred").dequeueDownload(i),o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:t.msgId,plaintextHash:i,threadJid:t.threadJid}})):o("MAWIndexedDb").afterTransaction({tag:"MediaExpired",value:{mediaId:a,msgId:t.msgId,threadJid:t.threadJid}}))}return o("MAWEphemeralUtil").maybeClearEphemeralMsgCountdown(t),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,r)})})}function m(e,t,n){if(t.type!==o("MAWMsgType").MSG_TYPE.REVOKED)throw r("FBLogger")("messenger_web").mustfixThrow("Cant mark unrevoked message revoked");var a=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.revokedExternalId),i=a!=null?e.deletedMessages.add(babelHelpers.extends({},a,{reason:o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke})):o("MAWDexieTable").dexieResolve();return o("MAWWriteDeleteMessageTxns").deleteBumpMsgs(e,t.author,t.revokedExternalId,t.threadJid).then(function(r){return r.length>0&&o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,r)}),o("MAWDexieTable").dexieAll([o("MAWDbReactionsTxns").deleteReactionsByUniqueMsgIdentifiers(e,[{author:t.author,chatJid:t.threadJid,externalId:t.revokedExternalId}]),o("MAWThreadSnippetBuildTxns").refreshThreadSnippet(e,n),i]).then(function(){o("MAWUnsendMsgContentCleaner").addNewUnsendMsgContentCleanerTimestamp(t.unsendMsgContentDeleteTs),o("MAWIndexedDb").afterTransaction({tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(t)})})})}function p(e,t){return t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?e.messages.delete(t.rowId).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"DeleteMessages",value:o("MAWBridgeTypesCreators").createBridgeDeleteMessages(t.threadJid,[t])}),!0}):o("MAWDexieTable").dexieResolve(!1)}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.writeIncomingRevokeMsg=u,l.revokeUnstoredMsg=c,l.markExistingMsgRevoked=d,l.markIncomingMessageRevoked=m}),98);
__d("validateMAWMediaAndComposeEntryForProtoMsg",["FBLogger","WAMediaUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbMedia is null in validateMediaAndComposeEntryForProtoMsg");var n=null;if(e!=null&&t.mediaId!=null){if(!t.msgIds.includes(e))throw r("FBLogger")("messenger_web").mustfixThrow("the media ("+t.mediaId+") is not linked to the msg ("+e+")");n=t.mediaEntries.get(e)}else n=t.mediaEntry;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media entry not found in validateMediaAndComposeEntryForProtoMsg");var o=t.plaintextHash,a=s(o,n);return[t,a]}function s(e,t){var n=o("WAMediaUtils").mediaEntryDataToRawData(e,t);if(n.fileSha256==null||n.mediaKey==null||n.fileEncSha256==null||n.directPath==null||n.mediaKeyTimestamp==null)throw r("FBLogger")("messenger_web").mustfixThrow("missing fields in mediaEntryData");return babelHelpers.extends({},n,{directPath:n.directPath,fileEncSha256:n.fileEncSha256,fileSha256:n.fileSha256,mediaKey:n.mediaKey,mediaKeyTimestamp:n.mediaKeyTimestamp})}l.validateMAWMediaAndComposeEntryForProtoMsg=e,l.validateMediaEntry=s}),98);
__d("MAWAsArmadilloApplication",["FBLogger","MAWEncodeMediaTransportProtocol","MAWMsg","MAWMsgType","MAWVault","MAWXMAEncodeUtils","WAArmadilloApplication.pb","WAGlobals","WAJids","WATimeUtils","getErrorSafe","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.XMA:{if((t==null?void 0:t.xma)==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA content should have XMA payload");var i=o("MAWXMAEncodeUtils").encodeXMA(e,t);return i}case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return u(e,n);case o("MAWMsgType").MSG_TYPE.RAVEN:return p(e,a);case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return d(e);default:throw r("FBLogger")("messenger_web").mustfixThrow(e.type+" should not be handled as ArmadilloApplication")}}function u(e,t){var n;if(e.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE||((n=e.quote)==null?void 0:n.content)==null||t==null)return null;var r=e.quote.content,a=o("WAJids").interpretAndValidateJid(t),i=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author,l=o("WAJids").isAuthorMe(r.author)?o("WAGlobals").getMyUserJid():r.author;function s(){return a.jidType==="msgrUser"?l:a.jidType==="group"?a.groupJid:null}function u(){return i===l?null:a.jidType==="group"?l:null}var c=s(),d=u();if(c==null)return null;if(e)return{payload:{content:{bumpExistingMessage:{key:{fromMe:i===l,id:r.externalId,participant:d,remoteJid:c}}}}}}function c(e){var t,n,r,a=(t=e.quote)==null?void 0:t.content,i=a==null||(n=a.msgContent)==null?void 0:n.content,l=a==null?void 0:a.expirationTs,s=e==null||(r=e.msgContent)==null?void 0:r.content;if(a==null||i==null||s==null)return null;var u=l!=null?o("WATimeUtils").castUnixTimeToMillisTime(l):void 0;return{payload:{content:{noteReplyMessage:{noteText:{text:o("MAWVault").unvault(i)},noteTimestampMs:u,textContent:{text:o("MAWVault").unvault(s)}}}}}}function d(e){var t=e.ravenActionToMsgExternalId;if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg ravenActionToMsgExternalId is null in encodeRavenActionMessage");var n=Number(e.actionType),a;if(n===0)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.PLAYED;else if(n===1)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.SCREENSHOT;else if(n===2)a=o("WAArmadilloApplication.pb").ARMADILLO_CONTENT_RAVEN_ACTION_NOTIF_MESSAGE_ACTION_TYPE.FORCE_DISABLE;else throw r("FBLogger")("messenger_web").mustfixThrow("msg actionType is not in enum in encodeRavenActionMessage");var i=e.actionTimestamp==null?Date.now():o("WATimeUtils").castUnixTimeToMillisTime(e.actionTimestamp),l={actionTimestamp:i,actionType:a,key:{id:t}};return{payload:{content:{ravenActionNotifMessage:l}}}}function m(e){return e===o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE?0:e===o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY?1:e===o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT?2:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}function p(t,n){if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("media is null in encodeRavenMessage");var a,i;try{var l=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(t.msgId,n);a=l[0],i=l[1]}catch(t){var s=r("getErrorSafe")(t);r("FBLogger")("messenger_web").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media entry is invalid, fallback to the placeholder: ",""])),s.message),a=void 0,i=void 0}if(a==null||i==null)return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType)}}}};switch(t.ravenMediaType){case o("MAWMsg").MAWRavenMsgMediaType.IMAGE:{var u=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),imageMessage:{payload:u,version:1}}}}}}case o("MAWMsg").MAWRavenMsgMediaType.VIDEO:{var c=o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToVideoTransport(a,i);return{payload:{content:{ravenMessageMsgr:{ephemeralType:m(t.ravenEphemeralType),videoMessage:{payload:c,version:1}}}}}}}}l.asArmadilloApplication=s,l.encodeNoteReplyMessage=c}),98);
__d("MAWAsConsumerApplication",["FBLogger","I64","LSIntEnum","MAWDbMedia","MAWEncodeMediaTransportProtocol","MAWJids","MAWMsgType","MAWVault","WAAssertUnreachable","WAConsumerApplication.pb","WAGlobals","WAJids","WAMediaTransport.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){switch(e.type){case o("MAWMsgType").MSG_TYPE.TEXT:return p(e);case o("MAWMsgType").MSG_TYPE.IMAGE:return _(e,t);case o("MAWMsgType").MSG_TYPE.VIDEO:return C(e,t);case o("MAWMsgType").MSG_TYPE.PTT:return v(e,t);case o("MAWMsgType").MSG_TYPE.REVOKED:return R(e.revokedExternalId);case o("MAWMsgType").MSG_TYPE.GIF:return C(e,t);case o("MAWMsgType").MSG_TYPE.STICKER:return h(e,t);case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return x(e,t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return null;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:throw r("FBLogger")("messenger_web").mustfixThrow("Implemented ephemeral setting message in MAWAsConsumerApplication");case o("MAWMsgType").MSG_TYPE.XMA:throw r("FBLogger")("messenger_web").mustfixThrow("XMA content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support converting to protoMsg with "+e.type+" type","maw_db");case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("Raven content message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support editing messages right now since the sending flow is not implemented yet. ");case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return E(e,n);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:throw r("FBLogger")("messenger_web").mustfixThrow("Bump message is not consumer application. It should be addressed as ArmadilloApplication");case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return T(e,a);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll creation messages yet as the sending flow is not implemented.");case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw r("FBLogger")("messenger_web").mustfixThrow("We do not support group poll update messages yet as the sending flow is not implemented.");default:return r("WAAssertUnreachable")(e.type)}}function c(e,t){if(t==null)return d(e);switch(t.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:return f(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.VIDEO:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.PTT:return S(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.GIF:return b(e.msgId,t);case o("MAWDbMedia").MEDIA_TYPE.STICKER:return y(e.msgId,t);default:return null}}function d(e){var t=null;if(e.type===o("MAWMsgType").MSG_TYPE.REVOKED&&e.msgContent!=null&&e.msgContent.content!=null)t=e.msgContent.content;else if(e.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME&&e.msgContent!=null)t=e.msgContent;else return null;return{payload:{content:{messageText:{mentionedJid:[],text:o("MAWVault").unvault(t)}}}}}function m(e){if(e!=null){var t=e===1?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.SMALL:e===2?o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.MEDIUM:o("WAConsumerApplication.pb").CONSUMER_APPLICATION_METADATA_SPECIAL_TEXT_SIZE.LARGE;return{specialTextSize:t}}}function p(e){var t={payload:{content:{messageText:{commands:e.msgContent.commands,mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)}}}},n=m(e.specialTextSize);return n!=null&&(t.metadata=n),t}function _(e,t){return f(e.msgId,t,e)}function f(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedImageMessage(a,i,n)}function g(e){function t(){var t=o("WAJids").validateGroupJid(e.threadJid);return t!=null?t:o("WAJids").isAuthorMe(e.author)?e.threadJid:o("WAGlobals").getMyUserJid()}var n=t();return{payload:{content:{editMessage:{key:{fromMe:!0,id:e.originalMsgExternalId,remoteJid:n},message:{mentionedJid:e.msgContent.mentionedJids,text:o("MAWVault").unvault(e.msgContent.content)},timestampMs:e.editTs*1e3}}}}}function h(e,t){return y(e.msgId,t)}function y(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedStickerMessage(r,a)}function C(e,t){return b(e.msgId,t)}function b(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedVideoMessage(r,a)}function v(e,t){return S(e.msgId,t)}function S(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedAudioMessage(r,a)}function R(e){return{payload:{applicationData:{revoke:{key:{fromMe:!0,id:e}}}}}}function L(e){var t=o("WAJids").isAuthorMe(e.reactToAuthor)?o("WAGlobals").getMyUserJid():e.reactToAuthor;function n(){var n=o("WAJids").isAuthorMe(e.author)?o("WAGlobals").getMyUserJid():e.author;return n===t}var r=n(),a=o("WAJids").interpretAsGroupJid(e.threadJid)!=null,i={groupingKey:e.groupingKey==null?void 0:e.groupingKey,key:{fromMe:r,id:e.reactToExternalId,participant:a&&!r?t:void 0,remoteJid:e.threadJid},senderTimestampMs:e.senderTimestampMs,text:e.reaction==null?void 0:e.reaction};return{payload:{content:{reactionMessage:i}}}}function E(e,t){if(e.threadJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("msg threadJid is null in encodeGroupInviteMessage");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("DbGroupInvite is null in encodeGroupInviteMessage");var n=o("WAJids").interpretAsGroupJid(e.threadJid);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("groupJid is null in encodeGroupInviteMessage");return{payload:{content:{groupInviteMessage:{groupJid:n,groupName:e.groupName,inviteCode:t.inviteCode,inviteExpiration:t.inviteExpirationTs}}}}}function k(t){return(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(1))||(e||(e=o("I64"))).equal(t.displayedContentTypes,(s||(s=o("LSIntEnum"))).ofNumber(256))||t.textHasLinks||t.isUnsent?I(t):null}function I(e){var t,n=(t=e.mentionIds)==null||(t=t.split(","))==null?void 0:t.map(o("MAWJids").toUserJid);return{payload:{content:{messageText:{mentionedJid:n!=null?n:[],text:e.text}}}}}function T(e,t){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch id");if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch message without receiver fetch info");switch(t.type){case"sticker":return D(t);default:throw r("FBLogger")("messenger_web").mustfixThrow("Unsupported receiver fetch type: "+t.type)}}function D(e){if(e.receiverFetchId==null)throw r("FBLogger")("messenger_web").mustfixThrow("Cannot generate receiver fetch sticker message without receiver fetch id");var t={ancillary:{accessibilityLabel:e.accessibilitySummaryText,height:e.previewHeight,isThirdParty:!1,receiverFetchId:e.receiverFetchId,width:e.previewWidth},integral:{receiverFetchId:e.receiverFetchId,transport:{ancillary:{mimetype:o("MAWEncodeMediaTransportProtocol").STICKER_MIME_TYPE,thumbnail:{thumbnailHeight:e.previewHeight,thumbnailWidth:e.previewWidth}},integral:{}}}},n=o("encodeProtobuf").encodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,t);return{payload:{content:{stickerMessage:{sticker:{payload:n.readBuffer(),version:1}}}}}}function x(e,t){return $(e.msgId,t)}function $(e,t){var n=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),r=n[0],a=n[1];return o("MAWEncodeMediaTransportProtocol").encodeValidatedFileMessage(r,a)}l.asConsumerApplication=u,l.deletedMsgAsConsumerApplicationForSpamReporting=c,l.encodeConsumerApplicationMetadata=m,l.encodeEditMessage=g,l.encodeReactionMessage=L,l.asConsumerApplicationLSDb=k,l.encodeReceiverFetchStickerMessage=D,l.encodeFileMessage=x}),98);
__d("WAFranking",["$InternalEnum","WACryptoDependencies","WACryptoHmac","WACryptoUtils","WAFrankingTypes","WAGlobals","WAPREList","WAPREMetrics"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=0,u=n("$InternalEnum").Mirrored(["KEEP","DROP"]);function c(){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WAFrankingTypes").castToFrankingKey(t)}function d(e){return e!=null?e:s}function m(e,t){return o("WACryptoHmac").hmacSha256(e,t).then(function(e){return o("WAFrankingTypes").castToFrankingTag(new Uint8Array(e))})}async function p(e,t,n,r){switch(r){case void 0:case 0:{var a=await o("WACryptoHmac").hmacSha256(t,e);return o("WACryptoUtils").uint8ArraysEqual(new Uint8Array(a),n)}default:return!0}}async function _(e,t){var n,r,a,i=o("WAGlobals").getConfig().isFrankingDropOnInvalid(),l=o("WAPREMetrics").startMetric(o("WAPREList").PRE_METRIC.FRANKING_VALIDATION);if((t==null?void 0:t.frankingTag)!=null&&((n=e.metadata)==null?void 0:n.frankingKey)==null){var s;return t.frankingTag=null,t.reportingTag=null,l.endFail("missingFrankingKey",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((s=e.metadata)==null?void 0:s.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),{decision:u.KEEP,updatedReportingMeta:t}}if((t==null?void 0:t.frankingTag)!=null&&e.version==="v3"&&e.type==="subprotocol"&&((r=e.metadata)==null?void 0:r.frankingKey)!=null&&e.frankingContent!=null){var c=t.frankingTag,d=e.frankingContent,m=e.metadata.frankingVersion,_=o("WAFrankingTypes").castToFrankingKey(new Uint8Array(e.metadata.frankingKey));return _==null?(l.endFail("tagButNoKey"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}):await p(new Uint8Array(d),_,c,m)?(t.frankingKey=_,t.reportingContent=d,l.endSuccess(),{decision:u.KEEP,updatedReportingMeta:t}):(l.endFail("tagMismatch"),i?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t})}return l.endFail("potentialDropCandidate",{bool:{doesFrankingTagExist:(t==null?void 0:t.frankingTag)!=null,doesFrankingKeyExist:((a=e.metadata)==null?void 0:a.frankingKey)!=null,doesFrankingContentExist:e.frankingContent!=null}}),o("WAGlobals").getConfig().isFrankingDropOnMissing()?{decision:u.DROP,updatedReportingMeta:t}:{decision:u.KEEP,updatedReportingMeta:t}}l.FrankingDecision=u,l.createFrankingKey=c,l.getFrankingVersion=d,l.genFrankingTag=m,l.validateFrankingTag=p,l.handleAndValidateFrankingFromIncomingMsg=_}),98);
__d("WAAsMessageApplication",["WAAsConsumerApplication","WAConsumerApplication.pb","WAFranking","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;switch(e.type){default:t=o("WAAsConsumerApplication").asConsumerApplication(e)}var n=e.forwardingScore!=null?e.forwardingScore:0,r=e.isForwarded!=null?e.isForwarded:!1,a={metadata:{chatEphemeralSetting:null,forwardingScore:n,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),isForwarded:r,quotedMessage:null}};if(t!=null){var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);a.payload={subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}return o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,a).readByteArrayView()}function s(e){return e}function u(e){return e.buffer}l.asMessageApplication=e,l.castToMessageApplicationBytes=s,l.castMessageApplicationBytesToBytes=u}),98);
__d("MAWAsMessageApplication",["I64","LSIntEnum","LSMessageReplySourceTypeV2","MAWAsArmadilloApplication","MAWAsConsumerApplication","MAWJids","MAWMsgType","WAArmadilloApplication.pb","WAAsMessageApplication","WAConsumerApplication.pb","WAFranking","WAGlobals","WAJids","WAMsgApplication.pb","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,a,i){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,c(e,t,n,r,a,i)).readByteArrayView())}function c(e,t,n,r,a,i){var l,s;switch(e.type){case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,void 0,t);break;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,void 0,a);break;case o("MAWMsgType").MSG_TYPE.XMA:l=o("MAWAsArmadilloApplication").asArmadilloApplication(e,r);break;default:s=o("MAWAsConsumerApplication").asConsumerApplication(e,t,n,i)}var u,c,d=e.forwardingScore!=null?e.forwardingScore:0,m=e.isForwarded!=null?e.isForwarded:!1;if(e.quote!=null){var p=e.quote;u={participant:p.content.author===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():p.content.author,stanzaId:p.content.externalId}}if(e.ephemeralSetting){var _=e.ephemeralSetting;e.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?c={ephemeralExpiration:_.ephemeralExpirationInSec,isEphemeralSettingReset:e.isEphemeralSettingReset}:c={ephemeralExpiration:_.ephemeralExpirationInSec,ephemeralSettingTimestamp:_.ephemeralLastUpdatedOrSetTimestamp*1e3}}var f={metadata:{chatEphemeralSetting:c,forwardingScore:d,frankingKey:y(e.reportingMeta),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:m,quotedMessage:u}};if(s!=null){var g=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,s);f.payload={subProtocol:{consumerMessage:{payload:g.readBuffer(),version:1}}}}else if(l!=null){var h=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,l);f.payload={subProtocol:{armadillo:{payload:h.readBuffer(),version:1}}}}return f}function d(t){var n,a=o("MAWAsConsumerApplication").asConsumerApplicationLSDb(t),i,l,u=t.isForwarded!=null?t.isForwarded:!1,c=u?1:0;t.replySourceTypeV2&&!(e||(e=o("I64"))).equal(t.replySourceTypeV2,(s||(s=o("LSIntEnum"))).ofNumber(r("LSMessageReplySourceTypeV2").NONE))&&t.replyToUserId!=null&&(i={participant:t.replyToUserId===o("WAJids").AUTHOR_ME?o("WAGlobals").getMyDeviceJid():o("MAWJids").toUserJid((e||(e=o("I64"))).to_string(t.replyToUserId)),stanzaId:t.messageId});var d={metadata:{chatEphemeralSetting:l,forwardingScore:c,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion(),groupId:(n=t==null?void 0:t.groupId)!=null?n:void 0,groupIndex:t.groupIndex!=null?(e||(e=o("I64"))).to_float(t.groupIndex):void 0,groupSize:t.groupSize!=null?(e||(e=o("I64"))).to_float(t.groupSize):void 0,isForwarded:u,quotedMessage:i}};if(a!=null){var m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);d.payload={subProtocol:{consumerMessage:{payload:m.readBuffer(),version:1}}}}return d}function m(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p(e)).readByteArrayView())}function p(e){var t=o("MAWAsConsumerApplication").encodeReactionMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function _(e){var t=o("MAWAsArmadilloApplication").encodeNoteReplyMessage(e);if(t==null)return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()}};var n=e.ephemeralSetting,r=n?{ephemeralExpiration:n.ephemeralExpirationInSec,ephemeralSettingTimestamp:n.ephemeralLastUpdatedOrSetTimestamp*1e3}:void 0,a=o("encodeProtobuf").encodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,t);return{metadata:{chatEphemeralSetting:r,frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{armadillo:{payload:a.readBuffer(),version:1}}}}}function f(e){return o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,g(e)).readByteArrayView())}function g(e){var t=o("MAWAsConsumerApplication").encodeEditMessage(e),n=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,t);return{metadata:{frankingKey:o("WAFranking").createFrankingKey(),frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:n.readBuffer(),version:1}}}}}function h(e,t){var n,r,a=o("MAWAsConsumerApplication").deletedMsgAsConsumerApplicationForSpamReporting(e,t);if(a==null)return null;var i=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,a);return{metadata:{frankingKey:y(e.reportingMeta),frankingVersion:((n=e.reportingMeta)==null?void 0:n.frankingVersion)!=null?(r=e.reportingMeta)==null?void 0:r.frankingVersion:o("WAFranking").getFrankingVersion()},payload:{subProtocol:{consumerMessage:{payload:i.readBuffer(),version:1}}}}}function y(e){return(e==null?void 0:e.frankingKey)!=null?e.frankingKey:o("WAFranking").createFrankingKey()}l.encodeMessageApplication=u,l.asMessageApplication=c,l.asMessageApplicationLSDb=d,l.encodeReactionMessageApplication=m,l.asReactionMessageApplication=p,l.asNoteReplyMessageApplication=_,l.encodeEditMessageApplication=f,l.asEditMessageApplication=g,l.deletedMsgAsMessageApplicationForSpamReporting=h}),98);
__d("MAWXMAEncodeUtils",["MAWAsMessageApplication","MAWEncodeMediaTransportProtocol","MAWMsgType","MAWParseSubprotocolVersionConsts","MAWVault","WALogger","WAMsgApplication.pb","encodeProtobuf","validateMAWMediaAndComposeEntryForProtoMsg"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){var r=o("validateMAWMediaAndComposeEntryForProtoMsg").validateMAWMediaAndComposeEntryForProtoMsg(e,t),a=r[0],i=r[1];return{payload:o("MAWEncodeMediaTransportProtocol").encodeValidatedMediaToImageTransport(a,i),version:n}}function u(t,n){var r=t.msgContent,a=t.msgId,i=r||{},l=i.commands,u=i.content,c=i.mentionedJids,d=n.associatedMessage,m=n.favicon,p=n.header,_=n.previews,f=n.xma,g=null;if(d!=null)if(d.type!==o("MAWMsgType").MSG_TYPE.TEXT)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Non-text associated message for the XMA content is not supported"])));else{var h=o("MAWAsMessageApplication").asMessageApplication(d),y=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,h);g={payload:y.readBuffer(),version:o("MAWParseSubprotocolVersionConsts").ASSOCIATED_MESSAGE_SUBPROTOCOL_VERSION}}var C=p!=null&&a!=null?s(a,p,o("MAWParseSubprotocolVersionConsts").XMA_HEADER_SUBPROTOCOL_VERSION):null,b=m!=null&&a!=null?s(a,m,o("MAWParseSubprotocolVersionConsts").XMA_FAVICON_SUBPROTOCOL_VERSION):null,v=_!=null&&a!=null?_.map(function(e){return s(a,e,o("MAWParseSubprotocolVersionConsts").XMA_PREVIEW_SUBPROTOCOL_VERSION)}):null,S=f.defaultCTA==null?void 0:[f.defaultCTA].concat(f.ctas).filter(Boolean);return{payload:{content:{extendedContentMessage:{associatedMessage:g!=null?g:void 0,commands:l,contentRef:f.contentRef,ctas:S,favicon:b!=null?b:void 0,headerImage:C!=null?C:void 0,headerTitle:f.headerTitle,maxSubtitleNumOfLines:f.maxSubtitleNumOfLines,maxTitleNumOfLines:f.maxTitleNumOfLines,mentionedJid:c,messageText:u==null?void 0:o("MAWVault").unvault(u),overlayDescription:f.overlayDescription,overlayIconGlyph:f.overlayIconGlyph,overlayTitle:f.overlayTitle,previews:v!=null?v:[],sentWithMessageId:g?f.externalId:void 0,subtitleText:f.subtitleText,targetExpiringAtSec:f.targetExpiringAtSec,targetId:f.targetId,targetType:f.targetType,targetUsername:f.targetUsername,titleText:f.titleText,xmaDataclass:f.xmaDataclass,xmaLayoutType:f.xmaLayoutType}}}}}l.encodeXMA=u}),98);
__d("MAWUnsafeCoerce",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCoerce=e}),66);
__d("MAWBulkEditMsgsTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","WAJids","WAMsgMap","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=new Set,r=[];return t.forEach(function(e){var t=e.chatJid,o=e.msg;n.add(t),r.push(o.originalMsgExternalId)}),o("MAWDexieTable").dexieAll([e.messages.where("externalId").anyOf(r).toArray(),e.messages.where("quoteExternalId").anyOf(r).toArray(),e.editMsgHistory.where("originalMsgExternalId").anyOf(r).toArray()]).then(function(e){var t=e[0],n=e[1],r=e[2];return{editMsgHistory:r,originalMsgs:t,quoteMessages:n}})}function s(e,t,n){var a=n.editMsgHistory,i=n.originalMsgs,l=n.quoteMessages,s=i.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),u=a.reduce(function(e,t){var n=o("MAWJidUtils").toProtocolMsgId(t);return n==null?e:e.set(n,t)},new(o("WAMsgMap")).MsgMap),d=c(t,{messageHistoriesToEdit:u,messagesToEdit:s}),m=d[0],p=d[1],_=d[2];return o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,m).then(function(){var t=new(o("WAMsgMap")).MsgMap;p.entries().forEach(function(e){var n,a,i=e[0],l=e[1],u=s.get(i);if(u==null){r("FBLogger")("messenger_web").warn("Cannot find the original msg for the edit action.");return}if(u.type!==o("WAMsgType").MSG_TYPE.TEXT&&u.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",u.type);var c=babelHelpers.extends({},u,{editCount:((n=u.editCount)!=null?n:0)+((a=_.get(i))!=null?a:0),msgContent:l.editMsgContent,type:o("WAMsgType").MSG_TYPE.TEXT});t.set(i,c)});var n=l.map(function(e){var n=e.quote,a=e.quoteExternalId,i=e.threadJid;if(n==null){r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",e.externalId);return}var l=n.content.author,s=o("MAWJidUtils").maybeToProtocolMsgId(l==="@me"?o("MAWUserJidWrapper").getMyUserJid():l,i,a);if(s!=null){var u=t.get(s);if(u!=null)return babelHelpers.extends({},e,{quote:babelHelpers.extends({},n,{content:babelHelpers.extends({},n.content,{msgContent:babelHelpers.extends({},u.msgContent)})})})}}).filter(Boolean);return e.messages.bulkPut(t.values().concat(n)).then(function(){t.values().forEach(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(){n.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})})})})}function u(e,t){var n,a,i,l;switch(e.type){case o("WAMsgType").MSG_TYPE.TEXT:case o("WAMsgType").MSG_TYPE.EDIT_ACTION:return{author:e.author,editExternalId:e.externalId,editTs:(n=e.serverTs)!=null?n:e.ts,msgContent:(a=e.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:(i=e.originalMsgExternalId)!=null?i:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};case o("WAMsgType").MSG_TYPE.CIPHERTEXT:return{author:e.author,editExternalId:e.externalId,editTs:(l=e.serverTs)!=null?l:e.ts,msgContent:{content:""},originalMsgExternalId:e.externalId,sendStatus:o("MAWAckLevel").ACK.sent,specialTextSize:e.specialTextSize,threadJid:t};default:throw e.type,r("FBLogger")("messenger_web").mustfixThrow("MAWBulkEditMsgsTxns::getMessageHistory: Unexpected msg type")}}function c(e,t){var n=t.messageHistoriesToEdit,a=t.messagesToEdit,i=[],l=new(o("WAMsgMap")).MsgMap,s=new(o("WAMsgMap")).MsgMap;return e.forEach(function(e){var t=e.chatJid,c=e.msg,d=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.originalMsgExternalId);if(d==null)throw r("FBLogger")("messenger_web").mustfixThrow("[protocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.originalMsgExternalId);var m=o("MAWJidUtils").maybeToProtocolMsgId(c.author,t,c.externalId);if(m==null)throw r("FBLogger")("messenger_web").mustfixThrow("[editMsgProtocolMsgId] Cannot get the protocol id for the edit action. isAuthorSystem = %s; chatJid = %s; externalId = %s",o("WAJids").isAuthorSystem(c.author),!!t,!!c.externalId);if(n.get(m)==null){var p;i.push(u(c,t));var _=(p=s.get(d))!=null?p:0,f=a.get(d);if(s.set(d,_+1),n.get(d)==null&&_===0&&f!=null){if(f.type!==o("WAMsgType").MSG_TYPE.TEXT&&f.type!==o("WAMsgType").MSG_TYPE.CIPHERTEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",f.type);i.push(u(f,t))}}var g=l.get(d),h=g==null?void 0:g.serverTs,y=c==null?void 0:c.serverTs;(h==null||y==null||h<y)&&l.set(d,c)}),[i,l,s]}l.prepareDataForMessageEdit=e,l.bulkEditMsgs=s,l.getMessageHistory=u}),98);
__d("MAWBulkPutReactionsWithThreadUpdateTxn",["FBLogger","MAWDbReaction","MAWDbReactionsTxns","MAWDexieTable","MAWJidUtils","MAWThreadSnippetBuildTxns","WAArrayGroupBy","WAJids","WAMsgMap","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n=o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.reactToExternalId);return n==null||e.set(n,o("MAWDbReactionsTxns").coerceToReaction(t)),e},new(o("WAMsgMap")).MsgMap).values()}function s(t,n,a){if(n.length===0)return o("MAWDexieTable").dexieResolve();var i=e(n),l=i.map(function(e){var t=a.get(e.threadJid);if(t==null)throw r("FBLogger")("messenger_web").mustfixThrow("Should not have got here - expect thread to exist for flow");return e}),s=o("WAArrayGroupBy").groupBy(l,function(e){var t=e.threadJid;return t}),u=s.map(function(e){var n=e[0],r=e[1],i=a.get(n);if(i==null||r.length===0)return null;for(var l=null,s=r.length-1;s>=0&&(l=o("MAWDbReaction").maybeCastToIncomingDbReaction(r[s]),l==null);s--);var u=r.filter(function(e){return e.reaction==null}),c=o("WAJids").interpretAsGroupJid(i.jid)!=null;return o("MAWThreadSnippetBuildTxns").getThreadChangesetForReactionChanges(t,i,{newestReaction:l,reactionsToClear:u},c)}).filter(Boolean);return o("MAWDexieTable").dexieAll(u).then(function(e){return o("MAWDexieTable").dexieAll([t.threads.bulkPut(e.map(function(e){var t=e.thread;return t})),t.reactions.bulkPut(l)]).then(r("emptyFunction"))})}l.bulkPutReactionsWithThreadUpdates=s}),98);
__d("MAWDeletedReactionsCache",["WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAMsgMap")).MsgMap;l.DeletedReactionsCache=e}),98);
__d("MAWBulkWriteReactionsTxns",["FBLogger","LSMEBTaskCreationSource","MAWAuthor","MAWBridgeEventTransmitter","MAWBulkPutReactionsWithThreadUpdateTxn","MAWDbMsg","MAWDbReaction","MAWDbReactionsTxns","MAWDeletedReactionsCache","MAWDexieTable","MAWJidUtils","MAWODSProxy","MAWUseProtocolMsgIdForMsgId","WAArrayGroupBy","WAJids","WAOdsEnums","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=[];return t.forEach(function(e){var t=e.chatJid,r=e.unstoredReaction,o=r.reactToExternalId;n.push(t),a.push(o)}),o("MAWDexieTable").dexieAll([e.threads.where("jid").anyOf(n).toArray(),e.messages.where("externalId").anyOf(a).toArray(),e.reactions.where("reactToExternalId").anyOf(a).toArray()]).then(function(n){var a=n[0],i=n[1],l=n[2],u=new Map(a.map(function(e){return[e.jid,e]})),c=new Map(o("WAArrayGroupBy").groupBy(i,function(e){return e.externalId})),d=new Map(o("WAArrayGroupBy").groupBy(l,function(e){return e.reactToExternalId})),m=[],p=o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId(),_=function(n){return t.forEach(function(e){var t=e.chatJid,a=e.unstoredReaction,i=a.author,l=a.externalId,_=a.groupingKey,f=a.reaction,g=a.reactToAuthor,h=a.reactToExternalId,y=a.senderTimestampMs,C=a.ts,b=u.get(t);if(b==null)return"missing_thread";var v=null;if(!p&&n!=null){var S=new Map(n),R=S.get(b.jid);if(R==null)throw r("FBLogger")("messenger_web").mustfixThrow("nextInChatReactionId should not be null");S.set(b.jid,R+1),v=o("MAWDbMsg").craftReactionId(b.chatId,R)}else v=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,l);var L=d.get(a.reactToExternalId)||[],E=o("MAWDbReaction").findMatchingReaction(L,b.jid,i);if(E!=null&&o("MAWDbReaction").getReactionTimeMs(E)>o("MAWDbReaction").getReactionTimeMs(a))return"newer_reaction_exists";if(E!=null&&a.reaction==null){var k={author:a.author,chat:a.threadJid,externalId:a.externalId};o("MAWDeletedReactionsCache").DeletedReactionsCache.set(k,E)}var I=o("MAWAuthor").getAuthorUserJid(g),T=c.get(a.reactToExternalId);T==null&&(a.reactToExternalId===a.externalId?r("FBLogger")("messenger_web").warn("reactToExternalId is same as externalId"):r("gkx")("16596")||o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(a.reactToExternalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_IN_ACT_REACTIONS,b.jid));var D=s(b,I,T),x=o("MAWDbReaction").formatReactionForDb(b.jid,l,v,h,f,_,g,D==null&&p?o("MAWJidUtils").formatProtocolMsgIdFromExternalId(b.jid,h):D==null?void 0:D.msgId,C,i!=null?i:o("WAJids").AUTHOR_ME,E==null?void 0:E.rowId,void 0,y);m.push(x)}),{chatJidToDbThread:u,unstoredDbReactionsForInsertion:m}};if(!p){var f=a.map(function(t){return o("MAWDbReactionsTxns").getNextReactionIdNumberForThread(e,t).then(function(e){return[t.jid,e]})});return o("MAWDexieTable").dexieAll(f).then(_)}return _(null)})}function s(e,t,n){var a,i=(a=n==null?void 0:n.filter(function(n){return n.threadJid===e.jid&&t===o("MAWAuthor").getAuthorUserJid(n.author)}))!=null?a:[];return i.length>1&&(r("FBLogger")("maw_mutation_validator").warn("%s matching duplicate messages found for a reaction",i.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_MUTATION_VALIDATOR,key:"match_reaction_to_message.invalid"})),i[0]}function u(e,t){var n=t.chatJidToDbThread,r=t.unstoredDbReactionsForInsertion;return o("MAWBulkPutReactionsWithThreadUpdateTxn").bulkPutReactionsWithThreadUpdates(e,r,n)}l.prepareReactionsData=e,l.bulkWriteReactions=u}),98);
__d("MAWCastToMsgrServerMediaType",["EncryptedBackupsUploadEntity","MAWDbMedia","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n){if(n===void 0&&(n=!1),n&&t==="image")return"xma";switch(t){case"image":case"video":case"gif":case"sticker":return t;case"document":return"file";case"ptt":return"audio";case"xma-image":return"xma";case"preview":return"preview";default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["invalid mediaType: "," for castToMsgrServerMediaType method"])),t),null}}function d(e,t){if(t===void 0&&(t=!1),t&&e===o("MAWDbMedia").MEDIA_TYPE.IMAGE)return"xma";switch(e){case"Image":return"image";case"Video":return"video";case"Gif":return"gif";case"Sticker":return"sticker";case"DocumentFile":return"file";case"Ptt":return"audio";default:return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["invalid client mediaType: "," for castClientMediaTypeToServerMediaType method"])),e),null}}function m(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return"image";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return"video";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return"gif";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER:return"sticker";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return"file";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return"audio";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA:return"xma";case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW:return"preview";default:return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["invalid attachment mediaType: "," for castMediaAttachmentTypeToServerMediaType method"])),e),null}}l.castToMsgrServerMediaType=c,l.castClientMediaTypeToServerMediaType=d,l.castMediaAttachmentTypeToServerMediaType=m}),98);
__d("WADbDeviceRegistration",["gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=25,s=6,u=s,c="https://reg-e2ee.facebook.com",d=r("gkx")("13108")?"https://reg-e2ee.messenger.com":c,m="https://v.whatsapp.net",p="https://reg-e2ee.instagram.com",_="/v2/fb_icdc_fetch",f="/v2/fb_register_v2",g="Device has already been registered to WA servers",h="Device registration finished successfully",y="Device registration retries failed "+s+" times. No longer attempting registration.",C="Device registration response was null",b="Current user id is zero",v="CryptoAuthToken is empty",S="CryptoAuthToken is expired",R={failed:"failed",finished:"finished"};l.MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE=e,l.MAX_DEVICE_REGISTRATION_RETRIES=s,l.MAX_ROTATE_CRYPTO_AUTH_TOKEN_RETRIES=u,l.REG_FB_DOMAIN=c,l.REG_MSGR_DOMAIN=d,l.REG_WA_DOMAIN=m,l.REG_IGD_DOMAIN=p,l.ICDC_ENDPOINT=_,l.REGISTRATION_ENDPOINT=f,l.DEVICE_ALREADY_REGISTERED=g,l.DEVICE_SUCCESSFULLY_REGISTERED=h,l.FAILED_REGISTRATION_RETRIES=y,l.NULL_RESPONSE_FROM_SERVER=C,l.DEVICE_REGISTER_ERROR_ZERO_AS_USER_ID=b,l.DEVICE_REGISTER_ERROR_EMPTY_CAT_TOKEN=v,l.DEVICE_REGISTER_ERROR_EXPIRED_CAT_TOKEN=S,l.RegistrationStatesEnum=R}),98);
__d("WorkerUtils",[],(function(t,n,r,o,a,i){"use strict";function e(){try{return"WorkerGlobalScope"in t&&t instanceof t.WorkerGlobalScope}catch(e){return!1}}function l(){try{return"SharedWorkerGlobalScope"in t&&t instanceof t.SharedWorkerGlobalScope}catch(e){return!1}}i.isWorkerContext=e,i.isSharedWorkerContext=l}),66);
__d("getOrchestratorVersion",["qex"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e;return(e=r("qex")._("263"))!=null?e:"default"}l.default=e}),98);
__d("MAWMainWebWorkerConfig",["MAWGK","MAWParseXMAFBConfig","WADbDeviceRegistration","WorkerUtils","getOrchestratorVersion","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=1,u={S508658PreventOldSessionLookupAndPromote:function(){return!0},armadilloWebProcessFutureproof:function(){return r("MAWGK").armadillo_web_process_futureproof},getSignalFutureMessagesMax:function(){return r("justknobx")._("847")},icdcAlertTriggerFailureCounter:function(){return r("justknobx")._("1970")},icdcCooldownIntervalInMinutes:function(){return r("justknobx")._("1971")},icdcIntervalInMinutes:function(){return r("justknobx")._("1972")},isDocumentReceiveEnabled:function(){return!r("gkx")("23924")},isFrankingDropOnInvalid:function(){return r("gkx")("23973")},isFrankingDropOnMissing:function(){return r("gkx")("23974")},isICDCErrorEnabled:function(){return r("gkx")("23975")},isMetaAiInvocationMessageRenderEnabled:function(){return r("gkx")("12661")},isPollsEnabled:function(){return!1},isProgressiveJpegSendEnabled:function(){return!0},isSharedWorkerContext:function(){return(e||(e=o("WorkerUtils"))).isSharedWorkerContext()},jpegThumbnailTargetByteSizeKB:function(){return r("justknobx")._("2338")},maxPrekeysToUpload:function(){return 200},maxUsersForNotifyDeviceChange:function(){return o("WADbDeviceRegistration").MAX_USERS_FOR_NOTIFY_DEVICE_CHANGE},newClockSkewCalculation:function(){return r("gkx")("18494")},offlineQueueStuckTimeoutMs:function(){return r("justknobx")._("3264")},orchestratorVersion:function(){return r("getOrchestratorVersion")()},pjpegPreviewAvoidLastScan:function(){return!0},sessionDropIfTooOld:function(){return r("justknobx")._("2240")},skipProcessingGroupInvite:function(){return r("justknobx")._("3899")},waDanglingQueue:function(){return!0}},c={productTypeForEBAttachments:"msgr",shouldFallbackToPreviewForFailedProgressiveJpeg:function(){return r("gkx")("2909")},supportedTypesVersion:function(){return r("MAWGK").armadillo_web_process_futureproof?s+1:s},supportedXMATargetTypes:function(){return o("MAWParseXMAFBConfig").FB_FULLY_SUPPORTED_TARGET_TYPES}};l.waConfig=u,l.mawConfig=c}),98);
__d("MAWConfig",["MAWMainWebWorkerConfig"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWMainWebWorkerConfig").mawConfig;function s(){return e}function u(t){e=t}l.getConfig=s,l.setConfig=u}),98);
__d("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAGatingType.INFO:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO;case o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF;case o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING;case o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE;case o("EchoMessageXMAFieldUtils").XMAGatingType.NONE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaGatingType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE}}l.convertXMAGatingTypeToExtendedContentOverlayIconGlyph=s}),98);
__d("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;case o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT;case o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL;case o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA;case o("EchoMessageXMAFieldUtils").XMALayoutType.GRID:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaLayoutType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE}}l.convertXMALayoutTypeToExtendedContentXMLLayoutType=s}),98);
__d("MAWConvertXMATargetTypeToExtendedContentTargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2;case o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE;case o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY:return o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid xmaTargetType: ",""])),t),o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE}}l.convertXMATargetTypeToExtendedContentTargetType=s}),98);
__d("MAWJobsIndexedDb",["FBLogger","MAWCurrentUser","MAWErrorObject","MAWIndexedDbMetadata","MAWQplProxy","MAWTransactionMode","Promise","WAExceededStorageQuota","WALogger","WAWorkerGlobalScope","emptyFunction","promiseDone","qex","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null,c=null,d="jobs";function m(){return r("qex")._("940")}function p(){if(u==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return u}function _(){if(c==null)throw r("FBLogger")("messenger_web").mustfixThrow("JobDB IndexDB should've been initialized");return c.then(function(){return p()})}function f(){return u!=null}var g=[function(e){var t=e.target.result,n=t.createObjectStore(d,{autoIncrement:!0,keyPath:"jobId"});n.createIndex("uniqKey","uniqKey")},r("emptyFunction"),r("emptyFunction")];function h(e){return c=null,u=null,y(e).then(function(){return u.version})}function y(t){var a;if(c!=null)return c;if(u!=null)return(s||(s=n("Promise"))).resolve();var i=o("MAWCurrentUser").getID(),l=o("MAWIndexedDbMetadata").jobsDbName(i),d=(a=t!=null?t:m())!=null?a:g.length,p=r("qpl")._(25310776,"6155");return c=new(s||(s=n("Promise")))(function(t,n){var r=indexedDB.open(l,d);r.onupgradeneeded=function(e){for(var t=0;t<g.length;t++){var n=g[t],r=t+1;C(e,r)&&n(e)}},r.onsuccess=function(n){var r=n.target.result;r.onversionchange=function(){var t;o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_versionchange"),o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[JobsDb initialization] upgradeneeded is triggered in another worker. This should not happen."]))),r.close(),(t=o("WAWorkerGlobalScope").workerGlobalScope.location)==null||t.reload==null||t.reload()},u=r,o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_ready"),t()},r.onerror=function(){o("MAWQplProxy").sendQplPointThroughBridge(p,"database_jobs_db_failed"),n(r.error)}}),c}function C(e,t){var n=e.newVersion,r=e.oldVersion;return r<t&&n>=t}function b(e){return e===o("MAWTransactionMode").READWRITE?"readwrite":"readonly"}function v(e,t,n,a){var i=b(t);return function(t){return function(){for(var l=arguments.length,s=new Array(l),d=0;d<l;d++)s[d]=arguments[d];var m=a!=null?o("MAWQplProxy").startQplUserFlow(a):null,p=function(l){return _().then(function(n){var r=function(r){var t=n.transaction(e,r!=null?b(r):i,{durability:"relaxed"});return o("WAExceededStorageQuota").listenToQuotaExceededError(t),t.objectStore(e)};return t.apply(void 0,[r].concat(s))}).then(function(e){return m==null||m.endSuccess(),e}).catch(function(t){m==null||m.endFail("job_transaction_fail");var a=o("MAWErrorObject").getErrorObject(t);if((a==null?void 0:a.name)==="InvalidStateError"&&l===1)return c=null,u=null,r("promiseDone")(y()),p(l-1);throw a instanceof Error?r("FBLogger")("maw_db").catching(a).mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e):r("FBLogger")("maw_db").mustfixThrow("%s:%s - Error performing transaction in jobDB transactor v2",n,e)})};return p(1)}}}l.getJobsDbVersion=m,l.getJobDB=p,l.isJobDBInitted=f,l.dbMigrations=g,l.makeJobsDbIgnoringPreviousCreations=h,l.makeJobsDb=y,l.makeJobsTransactor=v}),98);
__d("MAWJobPersistenceAccessorsApi",["MAWJobActionsV2","MAWJobsIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e,t,n;return{deletePersistedJob:(e=o("MAWJobsIndexedDb")).makeJobsTransactor("jobs",(t=o("MAWTransactionMode")).READWRITE,"deletePersistedJob")((n=o("MAWJobActionsV2")).deletePersistedJob),loadAllJobs:e.makeJobsTransactor("jobs",t.READONLY,"loadAllJobs")(n.readAllPersistedJobs),maybeCreateJob:e.makeJobsTransactor("jobs",t.READWRITE,"maybeCreateJob")(n.maybeCreateJob),readPersistedJob:e.makeJobsTransactor("jobs",t.READONLY,"readPersistedJob")(n.readPersistedJob),updatePersistedJob:e.makeJobsTransactor("jobs",t.READWRITE,"updatePersistedJob")(n.updatePersistedJob)}}l.getJobPersistenceAccessors=e}),98);
__d("WAJobRequirement",["Promise","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t=this;this.$1=(s||(s=n("Promise"))).resolve(),this.$2=!0,this.$3=null,this.$4=function(){var e=t.$3;if(e!=null)return t.$3=null,(s||(s=n("Promise"))).all(e).then(t.$4);t.$2=!0},this.name=e}var r=t.prototype;return r.addBlocker=function(r){var t=this,a=r.catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["JobRequirement[","] blocker errored ",""])),t.name,n).sendLogs("job-blocker-rejected")});if(this.$2)this.$2=!1,this.$1=(s||(s=n("Promise"))).all([this.$1,a]).then(this.$4);else{var i=this.$3;i!=null?i.push(a):this.$3=[a]}},r.waitUntilSatisfied=function(){return this.$1},r.isSatisfied=function(){return this.$2},r.isSatisfiable=function(){return!0},t})(),c=(function(e){function t(t){var r;return r=e.call(this,t)||this,e.prototype.addBlocker.call(r,new(s||(s=n("Promise")))(function(){})),r}babelHelpers.inheritsLoose(t,e);var r=t.prototype;return r.addBlocker=function(){},r.isSatisfiable=function(){return!1},t})(u);function d(e,t){var r=e.filter(function(e){return!e.isSatisfiable()});if(r.length>0){var o=r.map(function(e){return e.name});return function(e){return t==null||t("unsatisfiable",o,e),r[0].waitUntilSatisfied()}}var a=e.map(function(){return(s||(s=n("Promise"))).resolve()}),i=(s||(s=n("Promise"))).resolve(),l=null,u=function(){if(a.every(function(t,n){return t===e[n].waitUntilSatisfied()})){l=null;return}var t=[],r=e.map(function(e){var n=e.waitUntilSatisfied();return e.isSatisfied()||(t.push(e.name),n.then(function(){var n=t.indexOf(e.name);t.splice(n,1)})),n});return a=r,l=t,(s||(s=n("Promise"))).all(r).then(u)};return function(e){if(l==null){var n=u();n!=null&&(i=i.then(function(){return n}))}return t==null||t(l==null?"satisfied":"unsatisfied",l,e),i}}l.JobRequirement=u,l.UnsatisfiableJobRequirement=c,l.joinRequirements=d}),98);
__d("WAJobPriorityBucket",["WAJobOrchestratorTypes","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e){var t;this.tasks=[],this.pendingTasks=[],this.lastJobStartedTimestampMs=null,this.jobMaxConcurrency=(t=e.jobMaxConcurrencyMap)!=null?t:{}}var n=t.prototype;return n.updateConfig=function(t){var e;this.jobMaxConcurrency=(e=t.jobMaxConcurrencyMap)!=null?e:{}},n.getStats=function(){return[].concat(this.tasks,this.pendingTasks).reduce(function(e,t){var n,r=(n=e[t.jobName])!=null?n:0;return e[t.jobName]=r+1,e},{})},n.next=function(){var e=this;if(this.tasks.length===0)return null;var t=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.tasks.filter(function(n){var r,a;return((r=t.get(n.jobName))!=null?r:0)<((a=e.jobMaxConcurrency[n.jobName])!=null?a:o("WAJobOrchestratorTypes").DEFAULT_CONCURRENCY)});return n.length>0?[n[0]]:null},n.add=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.tasks.push(e),e},n.markJobTaskPending=function(n){this.pendingTasks.includes(function(e){return e.jobId===n.jobId})&&o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),n.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.lastJobStartedTimestampMs=Date.now(),this.pendingTasks.push(n),this.tasks=this.tasks.filter(function(e){return e.jobId!==n.jobId})},n.markJobTaskDone=function(t){this.pendingTasks=this.pendingTasks.filter(function(e){return e.jobId!==t}),this.tasks.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.count=function(){return this.tasks.length},n.pendingCount=function(){return this.pendingTasks.length},n.clearWaitingTasks=function(){this.tasks=[]},n.clear=function(){this.tasks=[],this.pendingTasks=[]},n.getLastJobStartedTimestamp=function(){return this.lastJobStartedTimestampMs},t})(),c=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.next=function(){var e=this,t,n;if(this.tasks.length===0)return null;var r=this.pendingTasks.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),o=this.tasks.filter(function(t){var n,o;return((n=r.get(t.jobName))!=null?n:0)<((o=e.jobMaxConcurrency[t.jobName])!=null?o:1)});if(o.length===0)return null;var a=(t=this.jobMaxConcurrency[o[0].jobName])!=null?t:1,i=(n=r.get(o[0].jobName))!=null?n:0;if(a>1&&i<a){var l=o.filter(function(e){return e.jobName===o[0].jobName}),s=Math.min(l.length,a-i);return l.slice(0,s)}return[o[0]]},t})(u);l.BaseJobBucket=u,l.LowJobBucket=c}),98);
__d("WAMetrics",["Promise","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=o("WATimeUtils").performanceAbsoluteNow();return new(e||(e=n("Promise")))(function(e){setTimeout(function(){e(o("WATimeUtils").performanceAbsoluteNow()-t)},0)})}l.getEventLoopDelay=s}),98);
__d("WAConcurrentBucketJobQueue",["WABase64","WACryptoDependencies","WACustomError","WAJobOrchestratorTypes","WAJobPriorityBucket","WALogger","WAMetrics","WANullthrows","WAPromiseTimeout","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=30,c=new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]);function d(e){var t=new Uint8Array(e);return o("WACryptoDependencies").getCrypto().getRandomValues(t),o("WABase64").encodeB64(t)}var m=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4=0,this.$5=new Map,this.$6=new Map,this.$7=new Map,this.$9=0}var n=t.prototype;return n.init=function(t,n){var e,a,i,l,s,c;if(this.$1)throw r("err")("WAConcurrentBucketJobQueue has already initialized");this.$4=(e=t==null?void 0:t.bestEffortWaitTimeoutSec)!=null?e:u,this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$8=n,this.$7=this.$11(t==null?void 0:t.jobPrioritiesQuota),this.$6=new Map(this.$7),this.$5=new Map,this.$9=Date.now();var d=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(a=t.maxConcurrencyPerJob)!=null?a:{}}),m=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(i=t.maxConcurrencyPerJob)!=null?i:{}}),p=new(o("WAJobPriorityBucket")).LowJobBucket({jobMaxConcurrencyMap:(l=t.maxConcurrencyPerJob)!=null?l:{}}),_=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(s=t.maxConcurrencyPerJob)!=null?s:{}}),f=new(o("WAJobPriorityBucket")).BaseJobBucket({jobMaxConcurrencyMap:(c=t.maxConcurrencyPerJob)!=null?c:{}});this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,d),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.OFFLINE,_),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.HISTORY_SYNC,f),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,m),this.$5.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,p),this.$1=!0},n.updateConfig=function(n){this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$5.forEach(function(e){var t;return e.updateConfig({jobMaxConcurrencyMap:(t=n.maxConcurrencyPerJob)!=null?t:{}})}),this.$7=this.$11(n==null?void 0:n.jobPrioritiesQuota),o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated WAConcurrentBucketJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueue=function(){if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");this.$5.forEach(function(e){return e.clear()})},n.clearQueueByPriority=function(t){var e;if(!this.$1)throw r("err")("WAConcurrentBucketJobQueue not initialized");(e=this.$5.get(t))==null||e.clearWaitingTasks()},n.getIntStats=function(){var e=this,t=function(n){var t,r,o=e.$5.get(n);return((t=o==null?void 0:o.count())!=null?t:0)+((r=o==null?void 0:o.pendingCount())!=null?r:0)};return{highPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityBucketSize:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.getStringStats=function(){var e=this,t=function(n){var t,r,o=(t=(r=e.$5.get(n))==null?void 0:r.getStats())!=null?t:{},a=Object.keys(o).reduce(function(e,t){var n=e[0],r=e[1],a=o[t];return a>n?[a,t]:[n,r]},[0,null]),i=a[1];return i};return{highPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH),lowPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW),bestEffortPriorityMaxJob:t(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT)}},n.enqueue=function(t,n,a,i){var e,l,s=this;if(!this.$1)return Promise.reject(r("err")("WAConcurrentBucketJobQueue not initialized"));var u,c,m=new Promise(function(e,t){u=e,c=t}),p=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),_=this.getJobBucketByType(p.priority);if(!_)return Promise.reject(r("err")("WAConcurrentBucketJobQueue no bucket for job with name "+t+" was found."));o("WAMetrics").getEventLoopDelay().then(function(e){i!=null&&i.isActive()&&(i==null||i.addPoint("measure_event_loop_delay",{int:{eventLoopDelay:e}}))}),i==null||i.addPoint("scheduling_job",{string:babelHelpers.extends({},this.getStringStats(),{priority:p.priority}),int:babelHelpers.extends({},this.getIntStats(),{maxTimeoutMs:(e=a==null?void 0:a.maxTimeoutMs)!=null?e:0})});var f=p.priority+"-"+t+"-"+((l=a==null?void 0:a.jobId)!=null?l:d(8)),g=_.add(t,p,f,async function(){try{s.$8.logJobStarted(f);var e=await s.$12(n(),a==null?void 0:a.maxTimeoutMs);s.$8.logJobCompleted(f),u(e)}catch(e){e instanceof o("WACustomError").TimeoutError?s.$8.logJobTimeout(f):s.$8.logJobError(f),c(e)}});return this.$8.logJobCreated({jobId:f,jobName:t,jobPriority:p.priority,pendingJobsCount:_.count()}),a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$13(g),this.$14(),m},n.getAvailableThreadsCount=function(){return this.$3},n.getJobQuotaConfig=function(){return this.$7},n.getRemainingJobCountMap=function(){return this.$6},n.getJobBucketByType=function(t){return this.$5.get(t)},n.getSnapshot=function(t){var e=this.getJobBucketByType(t);return e?e.getStats():null},n.$11=function(t){var e;return t?e=new Map(t):e=new Map(c),e.set(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT,0),e},n.$15=function(t){var e;return(e=this.$6.get(t))!=null?e:0},n.$16=function(){this.$6=new Map(this.$7)},n.$17=function(t){var e=this;t===void 0&&(t=!0);var n=0,r=null,a=0;this.$5.forEach(function(t,o){n+=t==null?void 0:t.count(),a+=e.$15(o),r==null&&t.count()>0&&e.$15(o)>0&&(r=t)});var i=r==null||a===0;return i&&this.$16(),this.$18(n,i)?this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT):r==null&&t?this.$17(!1):r},n.$18=function(t,n){var e,r=this;function a(e,t){var n=Date.now();return e>n?!1:n-e<t*1e3}function i(e,t){var n=Math.ceil(e-Date.now())+t*1e3;return n>0?n:0}var l=this.getJobBucketByType(o("WAJobOrchestratorTypes").JOB_PRIORITY.BEST_EFFORT),s=t-((e=l==null?void 0:l.count())!=null?e:0),u=l==null?void 0:l.getLastJobStartedTimestamp();if((l==null?void 0:l.count())===0)return!1;if(u==null&&a(this.$9,this.$4)){if(this.$10==null){var c=i(this.$9,this.$4);this.$10=setTimeout(function(){r.$14(),r.$10=null},c)}return!1}return s>0&&u!=null&&a(u,this.$4)?!1:n},n.$19=function(t){var e=this.$20(t);return r("WANullthrows")(this.$5.get(e))},n.$20=function(t){var e=t.split("-")[0],n=o("WAJobOrchestratorTypes").JOB_PRIORITY.cast(e);if(!n)throw r("err")("ConcurrentBucketQueue cannot extract known job priority type from id: "+t);return n},n.$21=function(t){var e=this.$20(t);this.$15(e)>0?this.$6.set(e,this.$15(e)-1):this.$6.set(e,0)},n.$14=function(){for(var e=this;this.$3>0;){var t=this.$17(),n=t==null?void 0:t.next();if(n==null)break;n.forEach(function(t){e.$21(t.jobId),e.$13(t)})}},n.$12=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$13=async function(t){var e=this,n=this.$19(t.jobId);this.$3--,n.markJobTaskPending(t);var r=t.run,a=t.jobId,i=t.jobName;try{var l;await this.$12(r(),((l=t.jobInfo)==null?void 0:l.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$8.logJobTimeout(a),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),i);else throw e}finally{this.$3++,n.markJobTaskDone(a),this.$3>0&&setTimeout(function(){return e.$14()},0)}},t})();l.WAConcurrentBucketJobQueue=m}),98);
__d("WAConcurrentPreemptiveJobQueue",["WACustomError","WAJobOrchestratorTypes","WALogger","WAPromiseTimeout","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=(function(){function t(){this.$1=!1,this.$2=0,this.$3=0,this.$4={},this.$5=[],this.$6=[]}var n=t.prototype;return n.init=function(t,n){var e;if(this.$1)throw r("err")("ConcurrentPreemptiveJobQueue has already initialized");this.$2=t.maxConcurrency,this.$3=t.maxConcurrency,this.$4=(e=t.maxConcurrencyPerJob)!=null?e:{},this.$7=n,this.$1=!0},n.updateConfig=function(n){var t;this.$3+=n.maxConcurrency-this.$2,this.$2=n.maxConcurrency,this.$4=(t=n.maxConcurrencyPerJob)!=null?t:{},o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: updated ConcurrentPreemptiveJobQueue config"])))},n.isInitialized=function(){return this.$1},n.clearQueueByPriority=function(t){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=this.$5.filter(function(e){var n;return((n=e.jobInfo)==null?void 0:n.priority)!==t})},n.clearQueue=function(){if(!this.$1)throw r("err")("ConcurrentPreemptiveJobQueue not initialized");this.$5=[],this.$6=[]},n.enqueue=function(t,n,a){var e,i=this;if(!this.$1)return Promise.reject(r("err")("ConcurrentPreemptiveJobQueue not initialized"));var l,s,u=new Promise(function(e,t){l=e,s=t}),c=babelHelpers.extends({priority:o("WAJobOrchestratorTypes").DEFAULT_JOB_PRIORITY},a),d=(e=a==null?void 0:a.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64),m=this.$8(t,c,d,async function(){try{i.$7.logJobStarted(d);var e=await i.$9(n(),a==null?void 0:a.maxTimeoutMs);i.$7.logJobCompleted(d),l(e)}catch(e){e instanceof o("WACustomError").TimeoutError?i.$7.logJobTimeout(d):i.$7.logJobError(d),s(e)}});return a&&a.priority===o("WAJobOrchestratorTypes").JOB_PRIORITY.UI_ACTION&&this.$10(m),this.$11(),u},n.getAvailableThreadsCount=function(){return this.$3},n.getJobMaxConcurrency=function(){return this.$4},n.getSnapshot=function(t){},n.$11=function(){for(;this.$3>0;){var e=this.$12();if(e==null)break;this.$10(e)}},n.$9=function(t,n){return n!==void 0?o("WAPromiseTimeout").promiseTimeout(t,n):t},n.$10=async function(t){var e=this;this.$3--,this.$13(t);var n=t.run,r=t.jobId,a=t.jobName;try{var i;await this.$9(n(),((i=t.jobInfo)==null?void 0:i.maxTimeoutMs)===void 0?o("WAJobOrchestratorTypes").DEFAULT_JOB_TIMEOUT_MS:void 0)}catch(e){if(e instanceof o("WACustomError").TimeoutError)this.$7.logJobTimeout(r),o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[job-orchestator]: "," exceeding the timeout, release the thread."])),a);else throw e}finally{this.$3++,this.$14(r),setTimeout(function(){return e.$11()},0)}},n.$8=function(t,n,r,o){var e={jobId:r,jobInfo:n,jobName:t,run:o};return this.$7.logJobCreated({jobId:r,jobName:t,jobPriority:n.priority,pendingJobsCount:this.$5.length}),this.$5.push(e),e},n.$13=function(t){this.$6.includes(function(e){return e.jobId===t.jobId})&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskPending found jobId: "," in pending tasks"])),t.jobId).sendLogs("JobOrchestrator::markJobTaskPending"),this.$6.push(t),this.$5=this.$5.filter(function(e){return e.jobId!==t.jobId})},n.$14=function(t){this.$6=this.$6.filter(function(e){return e.jobId!==t}),this.$5.includes(function(e){return e.jobId===t})&&o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Assertion failed::markJobTaskDone found jobId: "," in scheduled tasks"])),t).sendLogs("JobOrchestrator::markJobTaskDone")},n.$12=function(){var e=this;if(this.$5.length===0)return null;var t=this.$6.reduce(function(e,t){var n,r=(n=e.get(t.jobName))!=null?n:0;return e.set(t.jobName,r+1),e},new Map),n=this.$5.filter(function(n){var r,o;return((r=t.get(n.jobName))!=null?r:0)<((o=e.$4[n.jobName])!=null?o:1)});return n[0]},t})();l.WAConcurrentPreemptiveJobQueue=d}),98);
__d("WADefaultJobNoQueue",["WAJobOrchestratorTypes","WARandomHex","err"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(){this.$2=!1}var t=e.prototype;return t.init=function(t,n){if(this.$2)throw r("err")("DefaultNoQueue has already initialized");this.$1=n,this.$2=!0},t.updateConfig=function(t){},t.isInitialized=function(){return this.$2},t.clearQueue=function(){},t.clearQueueByPriority=function(t){},t.getSnapshot=function(){throw r("err")("getSnapshot is not implemented for DefaultNoQueue")},t.enqueue=async function(t,n,r){var e,a,i=(e=r==null?void 0:r.jobId)!=null?e:o("WARandomHex").randomHex(8).substr(0,64);this.$1.logJobCreated({jobId:i,jobName:t,jobPriority:(a=r==null?void 0:r.priority)!=null?a:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,pendingJobsCount:0});try{this.$1.logJobStarted(i);var l=await n();return this.$1.logJobCompleted(i),l}catch(e){throw this.$1.logJobError(i),e}},e})();l.WADefaultJobNoQueue=e}),98);
__d("WAOrchestratorJobStatsLogger",["WAGlobals","WAPREList","WAPREMetrics"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n){this.jobName=e,this.pendingJobsCount=n,this.jobPriority=t}var t=e.prototype;return t.logJobAdded=function(){this.webcJobAddedT=Date.now(),this.eventFlow=o("WAPREMetrics").startMetric(o("WAPREList").PRE_METRIC.WA_JOBS_ORCHESTRATOR,{string:{name:this.jobName,jobPriority:this.jobPriority,orchestratorVersion:o("WAGlobals").getConfig().orchestratorVersion()},int:{pendingJobsCount:this.pendingJobsCount,addedAt:this.webcJobAddedT}})},t.logJobStarted=function(){this.webcJobStartedT=Date.now(),this.eventFlow.addPoint("start_job",{int:{startedAt:this.webcJobStartedT}})},t.logJobCompleted=function(t){this.webcJobCompletedT=Date.now(),this.jobResultType=t;var e={int:{pendingJobsCount:this.pendingJobsCount,completedAt:this.webcJobCompletedT}};t==="completed"?this.eventFlow.endSuccess(e):this.eventFlow.endFail(t,e)},e})(),s=(function(){function t(){this.$1=new Map}var n=t.prototype;return n.logJobCreated=function(n){var t=n.jobName,r=n.jobId,o=n.jobPriority,a=n.pendingJobsCount,i=new e(t,o,a);i.logJobAdded(),this.$1.set(r,i)},n.logJobStarted=function(t){var e=this.$1.get(t);e==null||e.logJobStarted()},n.logJobCompleted=function(t){this.$2(t,"completed")},n.logJobError=function(t){this.$2(t,"error")},n.logJobTimeout=function(t){this.$2(t,"timeout")},n.logJobAborted=function(t){this.$2(t,"aborted")},n.$2=function(t,n){var e=this.$1.get(t);e==null||e.logJobCompleted(n),this.$1.delete(t)},t})();l.JobInfoEvent=e,l.JobStatsLogger=s}),98);
__d("WAOrchestrator",["WAConcurrentBucketJobQueue","WAConcurrentPreemptiveJobQueue","WADefaultJobNoQueue","WAGlobals","WAJobOrchestratorTypes","WAOrchestratorJobStatsLogger"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e={maxConcurrency:1},t="default",n={},r=e,a=new(o("WAOrchestratorJobStatsLogger")).JobStatsLogger;return function(i,l){var c,d,m,p,_;i===void 0&&(i=!1);var f=i?t:o("WAGlobals").getConfig().orchestratorVersion(),g=(c=u())!=null?c:e,h;if(l==null||l.addPoint("get_orchestrator",{string:{orchestrator:f},int:{maxConcurrency:g.maxConcurrency,highPriorityQuota:(d=(m=g.jobPrioritiesQuota)==null?void 0:m.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH))!=null?d:0,lowPriorityQuota:(p=(_=g.jobPrioritiesQuota)==null?void 0:_.get(o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW))!=null?p:0}}),n[f])return s(r,g)&&(r=g,n[f].updateConfig(g)),n[f];switch(f){case"preemptive":{h=new(o("WAConcurrentPreemptiveJobQueue")).WAConcurrentPreemptiveJobQueue;break}case"bucket":{h=new(o("WAConcurrentBucketJobQueue")).WAConcurrentBucketJobQueue;break}default:h=new(o("WADefaultJobNoQueue")).WADefaultJobNoQueue;break}return h.init(g,a),n[f]=h,r=g,h}}function s(e,t){var n,r,o,a;return e.maxConcurrency!==t.maxConcurrency||((n=e.jobPrioritiesQuota)==null?void 0:n.size)!==((r=t.jobPrioritiesQuota)==null?void 0:r.size)||Object.keys((o=e.maxConcurrencyPerJob)!=null?o:{}).length!==Object.keys((a=t.maxConcurrencyPerJob)!=null?a:{}).length?!0:JSON.stringify(e)!==JSON.stringify(t)}function u(){var e={jobPrioritiesQuota:new Map([[o("WAJobOrchestratorTypes").JOB_PRIORITY.HIGH,5],[o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW,1]]),maxConcurrency:5,maxConcurrencyPerJob:{}};return e}l.getInstanceDelegate=e}),98);
__d("WAPersistedJobManager",["WAJobRequirement","WALogger","WAPromiseBackoffs","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A=1,F=(function(){function e(e){this.feature=e}var t=e.prototype;return t.toString=function(){return"RequiresPage: "+this.feature},e})(),O=(function(){function e(e){this.backoffOptions=e}var t=e.prototype;return t.toString=function(){return"RetryOnBackoff"},e})(),B=(function(e){function t(){return e.apply(this,arguments)||this}babelHelpers.inheritsLoose(t,e);var n=t.prototype;return n.toString=function(){return"NonRetryableError"},t})(babelHelpers.wrapNativeSuper(Error)),W=function(t){this.result=t},q="$unstarted",U="$finished",V=(function(){function t(t){var n=this,r=t.isRestartAfterCrash,a=t.accessors,i=t.unfinishedJobEntries,l=new Map,u=i.then(function(t){var i=[],u=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?i.push(e):u.push(e)}),Promise.all(i.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),G(t),t.step).devConsole(H(t)).sendLogs("job-stuck-"+t.type),a.deletePersistedJob(t.jobId)})).then(function(){u.forEach(function(e){l.has(e.jobId)||(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": restarting"])),H(e)),l.set(e.jobId,n.$1(e,r)))})})});this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=a,this.activeJobs=l,this.initialJobsPromise=u,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs}var n=t.prototype;return n.loadAndRunJobFromId=function(t){var e=this.activeJobs.get(t);if(e!=null)return e;var n=this.$2(t);return this.activeJobs.set(t,n),n},n.$2=async function(t){var e=this.initialJobsPromise,n=this.accessors;await e;var r=await n.readPersistedJob(t);return r?this.$1(r,!1):(o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["No entry for job ",""])),t),o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))),null)},n.$3=function(t){var e=this.implementations,n=this.implementationLoaders,r=e.get(t);if(r)return r;var o=n.get(t);if(!o)return null;var a=o();return e.set(t,a),a},n.$4=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),j),e.set(n,r)),r(t)},n.$5=function(t,n,r,a){var e=this;r===void 0&&(r=!1);var i=t.step,l=n.findIndex(function(e){return e.stepName===i}),s=n[l].info(t.current,t.original,K(t,r)),u=s.requirements,c=s.code,p=this.$4(t,u);return a&&(p=p.then(a)),p.then(function(){return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),z(t)),c(t.current,t.original,K(t,r))}).then(function(a){if(a instanceof W)return o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),z(t)),a.result;var i=l+1;if(i>=n.length)return a;var s=n[i];return t.step=s.stepName,t.current=a,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,e.accessors.updatePersistedJob(t).then(function(){return e.$5(t,n,r)})})},n.$1=async function(t,n){var e,r=this,a=this.accessors,i=this.activeJobs,l=this.deprecatedJobs,s=this.listeners,u=s.onJobFinished,c=s.onJobStarted,d=await this.$3(t.type),m=l[t.type];if(!d){if(m){if(m==="NOOP")return o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await a.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await a.deletePersistedJob(t.jobId),null;d=await m()}var x=d;m&&o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(e=t.stepFirstStartTime)!=null?e:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===U){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),H(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await this.accessors.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),H(t)),await a.deletePersistedJob(t.jobId)),i.delete(t.jobId),t.current}var M=t.step!==q?d.find(function(e){return e.stepName===t.step}):d[0];if(!M)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await a.deletePersistedJob(t.jobId),null;t.step=M.stepName;var w=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var i=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>i?(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),z(t),e,i),t.waitUntil=i,a=r.accessors.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(i)})):(o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),z(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,r.accessors.updatePersistedJob(t)};return r.$5(t,x,n,e).catch(function(e){if(e instanceof F)return o("WALogger").LOG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": requires page"])),z(t)),t.stepHardStartCountAfterTimeout>0&&(--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t)),new Promise(function(){});if(e instanceof O){o("WALogger").LOG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),z(t));var n=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,r.accessors.updatePersistedJob(t).then(w)}else if(t.stepUnexpectedErrorCount<A)return o("WALogger").WARN(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),z(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(L||(L=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),z(t),e),t.stepUnexpectedErrorCount++,r.accessors.updatePersistedJob(t).then(w);throw e})})},B=w(),W=B.then(async function(e){o("WALogger").LOG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),z(t));var n=null;try{n=u(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}n!=null&&n>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(n/1e3)),t.step=U,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await r.accessors.updatePersistedJob(t)):(await a.deletePersistedJob(t.jobId),i.delete(t.jobId))},async function(e){o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var l=r.info(t.current,t.original,K(t,n));l.stopRetryIf!=null&&await l.stopRetryIf.onStopRetry(t.current,t.original,K(t,n))}await a.deletePersistedJob(t.jobId),i.delete(t.jobId)});try{c(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(D||(D=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return W.then(function(){return B})},n.addPersistedJobImplementation=function(t,n){var e=this.implementationLoaders,r=this.deprecatedJobs;if(e.has(t)){o("WALogger").ERROR(x||(x=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}r&&r[t]&&o("WALogger").DEV($||($=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),t),e.set(t,n)},n.fireAndForget=function(t){var e=this;this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.waitUntilPersisted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;e.loadAndRunJobFromId(n)})},n.waitUntilCompleted=function(t){var e=this;return this.accessors.maybeCreateJob(t).then(function(t){var n=t.id;return e.loadAndRunJobFromId(n)})},n.fireAndForgetNonPersisted=function(t){o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["fireAndForgetNonPersisted not implemented in PersistedJobManager"])))},n.waitUntilCompletedNonPersisted=function(t){return Promise.resolve(function(){return o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["waitUntilCompletedNonPersisted not implemented in PersistedJobManager"])))})},t})();function H(e){return"Job["+e.jobId+"] ("+e.type+")"}function G(e){return"[Job "+e.type+"] "}function z(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function j(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),z(n),t):e==="unsatisfied"&&o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),z(n),t)}function K(e,t){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:Q}}function Q(e){return new W(e)}l.RequiresPage=F,l.RetryOnBackoff=O,l.NonRetryableError=B,l.InterruptJob=W,l.UNSTARTED_JOB=q,l.FINISHED_JOB=U,l.PersistedJobManager=V}),98);
__d("WaJobInMemoryAccessors",["Promise","WARandomHex","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){var t=-1,r=new Map;return{deletePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.delete(o))},loadAllJobs:function(){return(e||(e=n("Promise"))).resolve(Array.from(r.values()))},maybeCreateJob:function(i){var a,l=JSON.stringify([i.type,(a=i.uniqKey)!=null?a:o("WARandomHex").randomHex(32)]),s={backedOffCount:0,current:i.args,original:i.args,startTime:o("WATimeUtils").unixTime(),step:"$unstarted",stepFirstStartTime:null,stepHardStartCountAfterTimeout:0,stepUnexpectedErrorCount:0,type:i.type,uniqKey:l,version:i.version,waitUntil:null,scheduleConfig:i.scheduleConfig},u=function(){var o=t--,a=babelHelpers.extends({},s,{jobId:o});return r.set(o,a),(e||(e=n("Promise"))).resolve({id:o,newlyCreated:!0})};if(i.uniqKey!=null){var c=Array.from(r.values()).filter(function(e){return e.uniqKey===l});if(c.length===0)return u();var d=null;return c.forEach(function(e){e.step!=="$finished"?d=e:r.delete(e.jobId)}),d!=null?(e||(e=n("Promise"))).resolve({id:d.jobId,newlyCreated:!1}):u()}return u()},readPersistedJob:function(o){var t=r.get(o);return(e||(e=n("Promise"))).resolve(t&&babelHelpers.extends({},t))},updatePersistedJob:function(o){return(e||(e=n("Promise"))).resolve(r.set(o.jobId,babelHelpers.extends({},o)))}}}l.getJobInMemoryAccessors=s}),98);
__d("WAPersistedJobManagerV2",["WAGlobals","WAJids","WAJobOrchestratorTypes","WAJobRequirement","WALogger","WAOrchestrator","WAPREList","WAPREMetrics","WAPersistedJobManager","WAPromiseBackoffs","WAResolvable","WATimeUtils","WaJobInMemoryAccessors","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O=1;function B(e){var t=e.code,n=e.annotations,r=n===void 0?{}:n,o=e.eventFlow,a=o===void 0?W(r):o;return t(a).then(function(e){return a.endSuccess(),e}).catch(function(e){throw a.endFail("error",{string:{error:""+e}}),e})}function W(e){var t,n;return e===void 0&&(e={}),o("WAPREMetrics").startMetric(o("WAPREList").PRE_METRIC.WA_JOB_MANAGER,babelHelpers.extends({},e,{string:babelHelpers.extends({},(t=(n=e)==null?void 0:n.string)!=null?t:{},{userHash:o("WAGlobals").getDependencies().isEmployee()&&o("WAGlobals").getDependencies().isUseridAnnotationEnabled()?o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()).slice(-5):null})}))}var q=(function(){function t(t){var n=this;this.$1=[];var r=t.isRestartAfterCrash,a=t.accessors,i=t.unfinishedJobEntries,l=t.ignoreForceNonPersistedJobList;this.getOrchestratorDelegate=o("WAOrchestrator").getInstanceDelegate(),this.activeJobs=new Map,this.implementationLoaders=new Map,this.implementations=new Map,this.stepBlockers=new WeakMap,this.accessors=a,this.isRestartAfterCrash=r||!1,this.listeners=t.listeners,this.deprecatedJobs=t.deprecatedJobs,this.inMemoryAccessors=o("WaJobInMemoryAccessors").getJobInMemoryAccessors(),this.offlineQueueMode=!0,this.$1=l,t.offlineQueueCompletePromise!=null?t.offlineQueueCompletePromise.finally(function(){n.offlineQueueMode=!1}):this.offlineQueueMode=!1,this.initialJobsPromise=i.then(function(t){var r=[],a=[];return t.forEach(function(e){e.stepHardStartCountAfterTimeout>=5?r.push(e):a.push(e)}),Promise.all(r.map(function(t){return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": stuck on the step ",", aborting the job"])),V(t),t.step).devConsole(U(t)).sendLogs("job-stuck-"+t.type),n.accessors.deletePersistedJob(t.jobId)})).then(function(){a.forEach(function(e){var t=n.$2(e.jobId);if(t.alreadyActive===!0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[JOB MANAGER] Restarting job with the same id"])));return}t.deferred.resolve(B({code:function(r){return n.$3(e,n.accessors,{eventFlow:r})},annotations:{string:{name:e.type},bool:{offlineQueueMode:n.offlineQueueMode}}}))})})})}var n=t.prototype;return n.$4=async function(t,n,a){var e;a===void 0&&(a={});var i=this.$2(t);if((e=a.eventFlow)==null||e.addPoint("start_load_and_run",{bool:{skipped:i.alreadyActive}}),i.alreadyActive===!0)return i.deferred;var l=await n.readPersistedJob(t);if(l==null)throw o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Persisted job missing for given ID"]))).sendLogs("missing-job-entry"),r("err")("Persisted job missing for given ID "+t);return i.deferred.resolve(this.$3(l,n,a)),i.deferred.promise},n.$3=function(t,n,r){var e,a;return r===void 0&&(r={}),(e=r.eventFlow)==null||e.addPoint("enqueueing_job",{string:{name:t.type}}),this.getOrchestratorDelegate(((a=t.scheduleConfig)==null?void 0:a.priority)===o("WAJobOrchestratorTypes").JOB_PRIORITY.SKIP,r.eventFlow).enqueue(t.type,this.$5(t,n,r),t.scheduleConfig,r.eventFlow)},n.$6=function(t,n,r){var e=this;return r===void 0&&(r={}),n.maybeCreateJob(t).then(function(t){var o,a=t.id;return(o=r.eventFlow)==null||o.addPoint("job_persisted",{int:{jobId:a},bool:{nonPersisted:n===e.inMemoryAccessors}}),a})},n.$2=function(t){var e=this.activeJobs.get(t);if(e!=null)return{alreadyActive:!0,deferred:e};var n=new(o("WAResolvable")).Resolvable;return this.activeJobs.set(t,n.promise),{alreadyActive:!1,deferred:n}},n.$5=function(t,n,r){var e=this;return function(){return e.$7(t,n,r)}},n.$8=function(t){var e=this.implementations,n=this.implementationLoaders,r=e.get(t);if(r)return r;var o=n.get(t);if(!o)return null;var a=o();return e.set(t,a),a},n.$9=function(t,n){if(n==null||n.length===0)return Promise.resolve();var e=this.stepBlockers,r=e.get(n);return r==null&&(r=o("WAJobRequirement").joinRequirements(n.map(function(e){return e()}),G),e.set(n,r)),r(t)},n.$10=function(t,n,r,a,i){var e,l=this;i===void 0&&(i={});var s=t.step;(e=i.eventFlow)==null||e.addPoint("start_step");var u=n.findIndex(function(e){return e.stepName===s}),m=n[u].info(t.current,t.original,z(t,this.isRestartAfterCrash)),p=m.requirements,_=m.code,f=this.$9(t,p);return a&&(f=f.then(a)),f.then(function(){var e;return o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",": running step"])),H(t)),(e=i.eventFlow)==null||e.addPoint("run_step"),_(t.current,t.original,z(t,l.isRestartAfterCrash,i.eventFlow))}).then(function(e){var a;if((a=i.eventFlow)==null||a.addPoint("step_is_complete"),e instanceof o("WAPersistedJobManager").InterruptJob)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["",": InterruptJob"])),H(t)),e.result;var s=u+1;if(s>=n.length)return e;var c=n[s];return t.step=c.stepName,t.current=e,t.stepHardStartCountAfterTimeout=0,t.stepFirstStartTime=o("WATimeUtils").unixTime(),t.stepUnexpectedErrorCount=0,t.waitUntil=null,t.backedOffCount=0,r.updatePersistedJob(t).then(function(){return l.$10(t,n,r,void 0,i)})})},n.$7=async function(t,n,r){var e,a,i=this;r===void 0&&(r={});var l=this.activeJobs,s=this.deprecatedJobs,u=this.listeners,c=u.onJobFinished,d=u.onJobStarted;(e=r.eventFlow)==null||e.addPoint("run_job");var T=await this.$8(t.type),D=s[t.type];if(!T){if(D){if(D==="NOOP")return o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["No implementation for deprecated ",", job deleted"])),t.type),await n.deletePersistedJob(t.jobId),null}else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",". Maybe it should have been put to the deprecated list?"])),t.type).sendLogs("missing-job-implementation"),await n.deletePersistedJob(t.jobId),null;T=await D()}var x=T;D&&o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Running deprecated job ",""])),t.type);var $=(a=t.stepFirstStartTime)!=null?a:o("WATimeUtils").unixTime();if(t.stepFirstStartTime=$,t.stepUnexpectedErrorCount=t.stepUnexpectedErrorCount||0,t.backedOffCount=t.backedOffCount||0,t.step===o("WAPersistedJobManager").FINISHED_JOB){var P=t.waitUntil,N=o("WATimeUtils").secondsUntil($);return P!=null&&o("WATimeUtils").isInFuture(P)&&N>0&&(o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["",": skew detected, adjusting accordingly"])),U(t)),P=o("WATimeUtils").castToUnixTime(P-N),o("WATimeUtils").isInFuture(P)&&(t.stepFirstStartTime=o("WATimeUtils").castToUnixTime($-N),t.waitUntil=P,await n.updatePersistedJob(t))),(P==null||!o("WATimeUtils").isInFuture(P))&&(o("WALogger").LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose(["",": removing completed, expired job from db"])),U(t)),await n.deletePersistedJob(t.jobId)),l.delete(t.jobId),t.current}var M=t.step!==o("WAPersistedJobManager").UNSTARTED_JOB?T.find(function(e){return e.stepName===t.step}):T[0];if(!M)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["No implementation for ",".",""])),t.type,t.step).sendLogs("missing-job-step"),await n.deletePersistedJob(t.jobId),null;t.step=M.stepName;var w=function(){var e=t.waitUntil,a=Promise.resolve();if(e!=null){var l=o("WATimeUtils").futureUnixTime(o("WATimeUtils").DAY_SECONDS);e>l?(o("WALogger").LOG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["",": trim wait from "," to ",""])),H(t),e,l),t.waitUntil=l,a=n.updatePersistedJob(t).then(function(){return o("WATimeUtils").delayUntil(l)})):(o("WALogger").LOG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["",": delaying until ",""])),H(t),e),a=o("WATimeUtils").delayUntil(e))}return a.then(function(){var e=function(){return t.waitUntil=null,o("WATimeUtils").happenedWithin($,o("WATimeUtils").DAY_SECONDS)||t.stepHardStartCountAfterTimeout++,n.updatePersistedJob(t)};return i.$10(t,x,n,e,r).catch(function(e){if(e instanceof o("WAPersistedJobManager").RetryOnBackoff){var a;o("WALogger").LOG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["",": RetryOnBackoff"])),H(t)),(a=r.eventFlow)==null||a.addPoint("retry_on_backoff");var i=o("WAPromiseBackoffs").getDelay(++t.backedOffCount,e.backoffOptions);return t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(i/1e3)),t.stepHardStartCountAfterTimeout>0&&--t.stepHardStartCountAfterTimeout,n.updatePersistedJob(t).then(w)}else{if(!(e instanceof o("WAPersistedJobManager").NonRetryableError)&&t.stepUnexpectedErrorCount<O){var l;return(l=r.eventFlow)==null||l.addPoint("retry_on_unexpected_error"),o("WALogger").WARN(v||(v=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception. Tried "," times"])),H(t),t.stepUnexpectedErrorCount),o("WALogger").WARN(S||(S=babelHelpers.taggedTemplateLiteralLoose(["",": Unhandled exception: ",""])),H(t),e),t.stepUnexpectedErrorCount++,n.updatePersistedJob(t).then(w)}throw e}})})},A=w(),F=A.then(async function(e){o("WALogger").LOG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["",": finished job"])),H(t));var r=null;try{r=c(t.jobId,t.type,t.original,e)}catch(e){o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["onJobFinished for "," threw exception ",""])),t.type,e).sendLogs("onJobFinished-threw")}r!=null&&r>0?(t.waitUntil=o("WATimeUtils").futureUnixTime(Math.ceil(r/1e3)),t.step=o("WAPersistedJobManager").FINISHED_JOB,t.current=e,t.stepFirstStartTime=o("WATimeUtils").unixTime(),await n.updatePersistedJob(t)):(await n.deletePersistedJob(t.jobId),l.delete(t.jobId))},async function(e){o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose([""," failed with error ",""])),t.type,e).sendLogs("job-threw-exception-"+t.type);var r=x.find(function(e){return e.stepName===t.step});if(!r)o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["",": "," step not found"])),t.type,t.step);else{var a=r.info(t.current,t.original,z(t,i.isRestartAfterCrash));a.stopRetryIf!=null&&await a.stopRetryIf.onStopRetry(t.current,t.original,z(t,i.isRestartAfterCrash))}await n.deletePersistedJob(t.jobId),l.delete(t.jobId)});try{d(t.jobId,t.type,t.original)}catch(e){o("WALogger").ERROR(I||(I=babelHelpers.taggedTemplateLiteralLoose(["onJobStarted for "," threw exception ",""])),t.type,e).sendLogs("onJobStarted-threw")}return F.then(function(){return A})},n.addPersistedJobImplementation=function(t,n){var e=this.implementationLoaders,r=this.deprecatedJobs;if(e.has(t)){o("WALogger").ERROR(T||(T=babelHelpers.taggedTemplateLiteralLoose(["addPersistedJobImplementation called twice for ",""])),t).sendLogs("repeat-job-loader");return}r&&r[t]&&o("WALogger").DEV(D||(D=babelHelpers.taggedTemplateLiteralLoose([""," has been loaded and is marked as deprecated"])),t),e.set(t,n)},n.fireAndForget=function(t){var e=this;if(this.$1.indexOf(t.type)===-1){o("WALogger").LOG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t);return}o("WALogger").LOG($||($=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),B({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilPersisted=async function(t){var e=this;if(this.$1.indexOf(t.type)===-1)return o("WALogger").LOG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.fireAndForgetNonPersisted(t),Promise.resolve();o("WALogger").LOG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type);var n=W({string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}});return await this.initialJobsPromise,n.addPoint("initial_jobs_promise_fulfilled"),this.$6(t,this.accessors,{eventFlow:n}).then(function(t){B({code:function(r){var n={eventFlow:r};return e.$4(t,e.accessors,n)},eventFlow:n})}).catch(function(e){throw n.endFail("error",{string:{error:""+e}}),e})},n.waitUntilCompleted=function(t){var e=this;return this.$1.indexOf(t.type)===-1?(o("WALogger").LOG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["",": running in forced non-persisted mode"])),t.type),this.waitUntilCompletedNonPersisted(t)):(o("WALogger").LOG(w||(w=babelHelpers.taggedTemplateLiteralLoose(["",": running in persisted mode"])),t.type),B({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.accessors,n).then(function(t){return e.$4(t,e.accessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}}))},n.fireAndForgetNonPersisted=function(t){var e=this;B({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},n.waitUntilCompletedNonPersisted=function(t){var e=this;return B({code:async function(r){var n={eventFlow:r};return await e.initialJobsPromise,r.addPoint("initial_jobs_promise_fulfilled"),e.$6(t,e.inMemoryAccessors,n).then(function(t){return e.$4(t,e.inMemoryAccessors,n)})},annotations:{string:{name:t.type},bool:{offlineQueueMode:this.offlineQueueMode}}})},t})();function U(e){return"Job["+e.jobId+"] ("+e.type+")"}function V(e){return"[Job "+e.type+"] "}function H(e){return"Job["+e.jobId+"] ("+e.type+"."+e.step+")"}function G(e,t,n){e==="unsatisfiable"?o("WALogger").LOG(A||(A=babelHelpers.taggedTemplateLiteralLoose([""," halting because of ",""])),H(n),t):e==="unsatisfied"&&o("WALogger").LOG(F||(F=babelHelpers.taggedTemplateLiteralLoose([""," waiting on ",""])),H(n),t)}function z(e,t,n){return t===void 0&&(t=!1),{jobStartTime:e.startTime,afterCrash:t,interruptJob:j,eventFlow:n}}function j(e){return new(o("WAPersistedJobManager")).InterruptJob(e)}l.PersistedJobManager=q}),98);
__d("MAWJobManager",["MAWBridge","MAWDefinePersistedJob","MAWJobPersistenceAccessorsApi","WAPersistedJobManagerV2","WAWaitForComms","WAWaitForUserUnblocked","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("WAPersistedJobManagerV2")).PersistedJobManager({accessors:o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors(),deprecatedJobs:{removeCurrentDevice:"NOOP"},ignoreForceNonPersistedJobList:["sendMsg","sendBumpMsg","sendReactionMsg","sendMediaMsg","sendWrittenMsg","downloadAndHandleMedia"],isRestartAfterCrash:!1,listeners:{onJobFinished:function(t,n,r,a){return o("MAWBridge").getBridge().fireAndForget("event","onJobFinished",{id:t,originalArgs:r,result:a,type:n},!0),null},onJobStarted:r("emptyFunction")},offlineQueueCompletePromise:o("WAWaitForUserUnblocked").waitForUserUnblocked(),unfinishedJobEntries:o("WAWaitForComms").waitForComms().then(function(){return o("MAWJobPersistenceAccessorsApi").getJobPersistenceAccessors().loadAllJobs()})});function s(){return o("MAWDefinePersistedJob").persistedJobsApi}function u(){return e}l.getPersistedJobsApi=s,l.getJobManager=u}),98);
__d("WAJobBuilder",["Promise","WAPersistedJobManager","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function e(e){this.steps=e}var t=e.prototype;return t.step=function(t,n){return this.$1(t,typeof n=="function"?{code:n}:n)},t.$1=function(n,r){var t=r.stopRetryIf,a=r.requirements,i=r.code,l=d(a,i,t);if(t){var s=t.timePassedSeconds,u=t.appCrashed,p=t.onStopRetry,_=d(null,m(p),t);s!=null&&(l=c(function(e,t,n){var r=n.jobStartTime;return o("WATimeUtils").happenedWithin(r,s)},l,_)),u&&(l=c(function(e,t,n){var r=n.afterCrash;return!r},l,_))}return new e([].concat(this.steps,[{stepName:n,info:l}]))},t.finalStep=function(t,n){var e=this.step(t,n);return{end:function(){return e.steps}}},e})();function u(){return new s([])}function c(e,t,n){return function(r,o,a){return e(r,o,a)?t(r,o,a):n(r,o,a)}}function d(e,t,n){var r={requirements:e,code:t,stopRetryIf:n};return function(){return r}}function m(t){return function(r,a,i){return(e||(e=n("Promise"))).resolve(t(r,a,i)).then(function(e){return e instanceof o("WAPersistedJobManager").InterruptJob?e:new(o("WAPersistedJobManager")).InterruptJob(e)})}}l.JobBuilder=s,l.definePersistedJob=u}),98);
__d("MAWDefinePersistedJob",["MAWJobManager","Promise","WAJobBuilder"],(function(t,n,r,o,a,i,l){"use strict";var e,s={definePersistedJob:function(){return o("WAJobBuilder").definePersistedJob()}};function u(t){var r=o("MAWJobManager").getJobManager();Object.keys(t).forEach(function(o){var a=t[o];r.addPersistedJobImplementation(o,function(){return(e||(e=n("Promise"))).resolve(a)})})}function c(e){var t=o("MAWJobManager").getJobManager();Object.keys(e).forEach(function(n){var r=e[n];t.addPersistedJobImplementation(n,r)})}l.persistedJobsApi=s,l.setMsgrJobImplementations=u,l.setMsgrDeferredJobImplementations=c}),98);
__d("MAWDexieCastToPromise",["Promise","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return(e||(e=n("Promise"))).resolve(t)}function u(e){return r("vulture")("Fs7u2qpGsgGUHBjaeXKvgOwLL5I="),e}l.dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING=s,l.promiseCastToDexiePromise_I_KNOW_WHAT_I_AM_DOING=u}),98);
__d("MAWEchoToProtobufConversionLoggingUtils",["QPLUserFlow","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){r("QPLUserFlow").start(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function s(e,t,n){r("QPLUserFlow").endFailure(r("qpl")._(521484676,"2684"),t,{annotations:n,instanceKey:e})}function u(e,t){r("QPLUserFlow").endSuccess(r("qpl")._(521484676,"2684"),{annotations:t,instanceKey:e})}function c(e,t,n){n&&r("QPLUserFlow").addAnnotations(r("qpl")._(521484676,"2684"),n,{instanceKey:e}),r("QPLUserFlow").addPoint(r("qpl")._(521484676,"2684"),t,{instanceKey:e})}l.startQplUserFlow=e,l.endFailure=s,l.endSuccess=u,l.addPoint=c}),98);
__d("MAWGetMsgForProtocolMsgIdTxn",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getMsgForProtocolMsgIdTxn",function(e){return function(t){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e!=null?o("WAResultOrError").makeResult(e):o("WAResultOrError").makeError("message-not-found")})}});l.getMsgForProtocolMsgIdTxn=e}),98);
__d("WACryptoAesGcm",["WABinary","WACryptoDependencies"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n,r,a){a===void 0&&(a=16);var i={name:"AES-GCM",iv:c(t),tagLength:a*8};return r!=null&&(i.additionalData=c(r)),o("WACryptoDependencies").getCrypto().subtle.encrypt(i,await u(e),n)}async function s(e,t,n,r,a){a===void 0&&(a=16);var i={name:"AES-GCM",iv:c(t),tagLength:a*8};return r!=null&&(i.additionalData=c(r)),o("WACryptoDependencies").getCrypto().subtle.decrypt(i,await u(e),n)}function u(e){return o("WACryptoDependencies").getCrypto().subtle.importKey("raw",e,"AES-GCM",!1,["encrypt","decrypt"])}function c(e){if(e instanceof Uint8Array)return e;if(typeof e=="string"){var t=new(o("WABinary")).Binary;return t.writeString(e),t.readByteArrayView()}return new Uint8Array(e)}l.gcmEncrypt=e,l.gcmDecrypt=s}),98);
__d("WAUseCaseSecret",["$InternalEnum","WABinary","WACryptoHkdf"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({POLL_VOTE:"Poll Vote",ENC_REACTION:"Enc Reaction",ENC_COMMENT:"Enc Comment",REPORT_TOKEN:"Report Token",EVENT_RESPONSE:"Event Response",EVENT_EDIT_ENCRYPTED:"Event Edit",MESSAGE_EDIT:"Message Edit"}),s=32;function u(e){var t=e.messageSecret,n=e.stanzaId,r=e.parentMsgOriginalSender,a=e.modificationSender,i=e.modificationType,l=o("WABinary").Binary.build(n,r,a,i).readBuffer();return o("WACryptoHkdf").extractAndExpand(t instanceof ArrayBuffer?new Uint8Array(t):t,l,s)}l.UseCaseSecretModificationType=e,l.createUseCaseSecret=u}),98);
__d("MAWGroupPollsDualEncryptionUtils",["MAWDbPoll","WABase64","WAConsumerApplication.pb","WACryptoAesGcm","WACryptoSha256","WAResultOrError","WAUseCaseSecret","decodeProtobuf","encodeProtobuf","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t,n){if(e.encIv==null||e.encPayload==null)return o("WAResultOrError").makeError("invalid_poll_enc_value");var a=e.encIv,i=e.encPayload;try{var l=await o("WACryptoAesGcm").gcmDecrypt(t,a,i,n);return o("WAResultOrError").makeResult(l)}catch(e){return o("WAResultOrError").DEPRECATED_makeError("decryption_error",r("getErrorSafe")(e))}}async function s(e,t,n){try{var a=self.crypto.getRandomValues(new Uint8Array(12)),i=await o("WACryptoAesGcm").gcmEncrypt(t,a,e,n);return o("WAResultOrError").makeResult({encIv:a.buffer,encPayload:i})}catch(e){return o("WAResultOrError").DEPRECATED_makeError("encryption_error",r("getErrorSafe")(e))}}function u(e,t){var n=e+"\0"+t;return new TextEncoder().encode(n).buffer}async function c(e,t){var n=t.pollCreationMessageKey,r=t.pollCreationSenderJid,a=t.pollCreationStanzaId,i=t.pollUpdateSenderJid,l=t.pollUpdateStanzaId,c=await o("WAUseCaseSecret").createUseCaseSecret({messageSecret:n,modificationSender:i,modificationType:o("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:r,stanzaId:a}),d=u(l,i),m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplication$PollVoteMessageSpec,e).readBuffer();return s(m,c,d)}async function d(t,n){var a=n.pollCreationMessageKey,i=n.pollCreationSenderJid,l=n.pollCreationStanzaId,s=n.pollUpdateSenderJid,c=n.pollUpdateStanzaId,d=await o("WAUseCaseSecret").createUseCaseSecret({messageSecret:a,modificationSender:s,modificationType:o("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:i,stanzaId:l}),m=u(c,s),p=await e(t,d,m);if(!p.success)return p;try{return o("WAResultOrError").makeResult(o("decodeProtobuf").decodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplication$PollVoteMessageSpec,p.value))}catch(e){return o("WAResultOrError").DEPRECATED_makeError("protobuf_decode_error",r("getErrorSafe")(e))}}async function m(e,t){var n=t.pollCreationMessageKey,r=t.pollCreationSenderJid,a=t.pollCreationStanzaId,i=t.pollUpdateSenderJid,l=t.pollUpdateStanzaId,c=await o("WAUseCaseSecret").createUseCaseSecret({messageSecret:n,modificationSender:i,modificationType:o("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:r,stanzaId:a}),d=u(l,i),m=o("encodeProtobuf").encodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplication$PollAddOptionMessageSpec,e).readBuffer();return s(m,c,d)}async function p(t,n){var a=n.pollCreationMessageKey,i=n.pollCreationSenderJid,l=n.pollCreationStanzaId,s=n.pollUpdateSenderJid,c=n.pollUpdateStanzaId,d=await o("WAUseCaseSecret").createUseCaseSecret({messageSecret:a,modificationSender:s,modificationType:o("WAUseCaseSecret").UseCaseSecretModificationType.POLL_VOTE,parentMsgOriginalSender:i,stanzaId:l}),m=u(c,s),p=await e(t,d,m);if(!p.success)return p;try{return o("WAResultOrError").makeResult(o("decodeProtobuf").decodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplication$PollAddOptionMessageSpec,p.value))}catch(e){return o("WAResultOrError").DEPRECATED_makeError("protobuf_decode_error",r("getErrorSafe")(e))}}async function _(e){var t=await o("WACryptoSha256").sha256(new TextEncoder("utf8").encode(e));return f(t)}function f(e){return o("MAWDbPoll").convertStringToOptionHash(o("WABase64").encodeB64(e))}l.encryptGroupPollVote=c,l.decryptGroupPollVote=d,l.encryptGroupPollAddOption=m,l.decryptGroupPollAddOption=p,l.getHashForOptionName=_,l.getBase64EncodedHash=f}),98);
__d("MAWHandleXmaTransactionUtil",["MAWBridgeXMA","MAWDbChunkTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";async function e(e,t){var n=!1;return e!=null&&t.defaultPreviewMediaId===e.mediaId&&(n=await _(e)),o("MAWBridgeXMA").createBridgeXMA(e,t,{hasMedia:n,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function s(e,t,n){return u(e,t,n).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function u(e,t,n){var r=n==null?o("MAWDexieTable").dexieResolve(!1):o("MAWDbChunkTxns").hasMediaChunk(e,n.hashedPlaintextHash);return r.then(function(e){return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:e,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})}function c(e,t,n,r,a){return d(e,t,n,r,a).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})})}function d(e,t,n,r,a){var i=m(n,r,a,e);return i.then(function(e){var r=e.hasMedia,a=e.hasXmaFaviconMedia,i=e.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})})}function m(e,t,n,r){if(e!=null||t!=null||n!=null){var a=[e,t,n].filter(Boolean).map(function(e){return e.hashedPlaintextHash});return o("MAWDbChunkTxns").hasMediaChunks(r,a).then(function(r){return{hasMedia:e!=null&&r.get(e.hashedPlaintextHash)===!0,hasXmaFaviconMedia:t!=null&&r.get(t.hashedPlaintextHash)===!0,hasXmaHeaderMedia:n!=null&&r.get(n.hashedPlaintextHash)===!0}})}else return o("MAWDexieTable").dexieResolve({hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})}function p(e,t,n,r,a){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(m(e,t,n,a).then(function(t){var n=t.hasMedia,a=t.hasXmaFaviconMedia,i=t.hasXmaHeaderMedia;return o("MAWBridgeXMA").createBridgeXMA(e,r,{hasMedia:n,hasXmaFaviconMedia:a,hasXmaHeaderMedia:i})}))}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:o("MAWTransactionMode").READONLY},"MAWHandleXmaTransactionUtil.hasMediaChunkTransaction",function(e){return(function(t){return o("MAWDbChunkTxns").hasMediaChunk(e,t.hashedPlaintextHash)})});l.checkMediaChunkTransactionAndCreatedBridgeXma=e,l.checkMediaChunkAndHandleXmaAfterTransaction=s,l.checkMediaChunkAndCreatedBridgeXma=u,l.checkAllMediaChunksAndHandleXmaAfterTransaction=c,l.checkAllMediaChunksAndCreateBridgeXma=d,l.verifyAllMediaChunksForXMA=m,l.checkAllMediaChunksAndCreateBridgeXma_DEPRECATED=p}),98);
__d("MAWLegacyDownloadManager",[],(function(t,n,r,o,a,i){"use strict";var e=1e4,l=(function(){function t(){this.$1=[],this.$2=new Map}var n=t.prototype;return n.setToDownloadManager=function(t,n){this.$3(),this.$2.set(t,n),this.$1.push(t)},n.getFromDownloadManager=function(t){return this.$2.get(t)},n.removeFromMediaDownloadManager=function(t){this.$2.delete(t);var e=this.$1.filter(function(e){return e!==t});this.setDownloadManagerQueue(e)},n.setDownloadManagerQueue=function(t){this.$1=t},n.$3=function(){if(this.$1.length>=e){var t=this.$1.shift();this.$2.delete(t)}},t})();i.LegacyDownloadManager=l}),66);
__d("MAWLegacyMediaDownloadManager",["MAWLegacyDownloadManager"],(function(t,n,r,o,a,i,l){"use strict";var e=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager,s=new(o("MAWLegacyDownloadManager")).LegacyDownloadManager;function u(t,n){e.setToDownloadManager(t,n)}function c(t){return e.getFromDownloadManager(t)}function d(t){e.removeFromMediaDownloadManager(t)}function m(e,t){s.setToDownloadManager(e,t)}function p(e){return s.getFromDownloadManager(e)}function _(e){s.removeFromMediaDownloadManager(e)}l.setToMediaDownloadManager=u,l.getFromMediaDownloadManager=c,l.removeFromMediaDownloadManager=d,l.setToMediaPlaintextDownloadManager=m,l.getFromMediaPlaintextDownloadManager=p,l.removeFromMediaPlaintextDownloadManager=_}),98);
__d("MAWMediaType",["WAServerMediaType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"XMA":return"xma-image";case"EphemeralScreenshotAction":case"Raven":case"RavenAction":case"EditAction":case"NoteReply":case"BumpExistingMessage":return null;default:return o("WAServerMediaType").getMediaType(e)}}l.getMediaType=e}),98);
__d("MAWRavenUtils",["EphemeralMediaViewMode","MAWMsg","RavenMessagingState"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){switch(t){case o("MAWMsg").MAWRavenMsgEphemeralMediaState.PERMANENT:return r("RavenMessagingState").PERMANENT;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN:return r("RavenMessagingState").UNSEEN;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN:return r("RavenMessagingState").SEEN;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.REPLAYED:return r("RavenMessagingState").REPLAYED;case o("MAWMsg").MAWRavenMsgEphemeralMediaState.EXPIRED:return r("RavenMessagingState").EXPIRED}},s=function(t){switch(t){case o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return r("EphemeralMediaViewMode").PERMANENT;case o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return r("EphemeralMediaViewMode").REPLAYABLE;case o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return r("EphemeralMediaViewMode").READ_ONCE}},u=function(t,n){return{ephemeralMediaState:n,ephemeralMediaViewMode:s(t)}};function c(t,n){switch(n){case o("MAWMsg").MAWRavenMsgEphemeralType.VIEW_ONCE:return t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN?r("RavenMessagingState").SEEN:e(t);case o("MAWMsg").MAWRavenMsgEphemeralType.ALLOW_REPLAY:return t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.UNSEEN?r("RavenMessagingState").SEEN:t===o("MAWMsg").MAWRavenMsgEphemeralMediaState.SEEN?r("RavenMessagingState").REPLAYED:e(t);case o("MAWMsg").MAWRavenMsgEphemeralType.KEEP_IN_CHAT:return e(t)}}l.getEphemeralMediaState=e,l.getEphemeralMediaViewMode=s,l.deriveRavenSettings=u,l.getNextRavenMessageEphemeralState=c}),98);
__d("MpsMediaEntryCache",["FBLogger","MpsMessageToBridgeWrapper","WADirectPath","WAHashUtils","WALongInt","WAMediaUtils","WAProgressiveJpegGetScanLengths","WATimeUtils","getErrorSafe","getMediaTypeFromConsumerMessage","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e=new Map;function s(t){var n,r,o=e.get(t.plaintextHash);if(((n=t.mediaKeyTimestamp)!=null?n:0)>=((r=o==null?void 0:o.mediaKeyTimestamp)!=null?r:0))return e.set(t.plaintextHash,t),t}function u(e){try{var t=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(e);return[c(t),p(t)].concat(m(t)).filter(Boolean)}catch(e){var n=r("getErrorSafe")(e);if(e.message.includes("FormatError"))return r("FBLogger")("mps").catching(n).mustfix("Error in hydrateCache"),[];throw r("FBLogger")("mps").catching(n).mustfixThrow("Error in hydrateCache")}}function c(e){var t,n=e.deserialize(),r=(t=n.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(r!=null)return d(e,r)}function d(e,t){var n,r,a,i,l,s,u,c,d,m=(n=(r=(a=(i=(l=t.audioMessage())==null?void 0:l.payload)!=null?i:(s=t.documentMessage())==null?void 0:s.payload)!=null?a:(u=t.imageMessage())==null?void 0:u.payload)!=null?r:(c=t.stickerMessage())==null?void 0:c.payload)!=null?n:(d=t.videoMessage())==null?void 0:d.payload;if(m!=null){var p=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(t.proto);return _(m,p,e)}}function m(e){var t,n,r=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),o=r==null?void 0:r.extendedContentMessage();if(o==null||r==null)return[];var a="xma-image",i=o.previews().map(function(t){return _(t,a,e)}),l=o.headerImage();l!=null&&i.push(_(l,a,e));var s=o.favicon();s!=null&&i.push(_(s,a,e));var u=(n=o.associatedMessage())==null?void 0:n.consumerMessage();return u!=null&&i.push(d(e,u)),i.filter(Boolean)}function p(e){var t,n=(t=e.deserialize().encryptedTransportMessage())==null?void 0:t.armadillo(),a=n==null?void 0:n.noteReply(),i=a==null?void 0:a.stickerContent(),l=a==null?void 0:a.videoContent(),s=i!=null?i:l;if(s!=null){var u=l!=null?o("getMediaTypeFromConsumerMessage").getMediaTypeForVideo(l):void 0,c=i!=null?"sticker":void 0,d=r("nullthrows")(u!=null?u:c);return _(s,d,e)}}function _(e,t,n){var a,i,l,u,c,d,m,p,_,f,g,h,y,C=e.ancillary,b=e.integral;if(C==null||b==null){var v=Object.entries({ancillary:C,integral:b}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("invalid media entry, missing %s. type %s",v,t);return}var S=o("WADirectPath").validateDirectPath((a=b.transport)==null||(a=a.integral)==null?void 0:a.directPath).value,R=(i=b.transport)==null||(i=i.integral)==null?void 0:i.mediaKeyTimestamp,L=R!=null?o("WATimeUtils").castLongIntToUnixTime(R):void 0,E=(l=b.transport)==null||(l=l.integral)==null?void 0:l.fileSha256,k=E!=null?o("WAHashUtils").toPlaintextHash(E):void 0;if(S==null||E==null||k==null||t==null){var I=Object.entries({directPath:S,fileSha256:E,mediaType:t,plaintextHash:k}).filter(function(e){var t=e[0],n=e[1];return n==null}).map(function(e){var t=e[0];return t}).join(", ");r("FBLogger")("mps").warn("Missing media entry fields: %s. type :%s",I,t);return}var T=null,D=C.scanLengths,x=C.scansSidecar;x!=null&&D!=null&&(T={scanLengths:D.map(o("WAProgressiveJpegGetScanLengths").asProgressiveJpegScanLength),sidecar:x});var $=void 0,P=(u=b.transport)==null||(u=u.ancillary)==null||(u=u.thumbnail)==null?void 0:u.downloadableThumbnail;if(P!=null){var N;$={directPath:o("WADirectPath").validateDirectPath(P.directPath).value,fileEncSha256:P.fileEncSha256,fileSha256:P.fileSha256,mediaKey:P.mediaKey==null?void 0:o("WAMediaUtils").castToMediaKey(P.mediaKey),mediaKeyTimestamp:o("WATimeUtils").castLongIntToUnixTime((N=P.mediaKeyTimestamp)!=null?N:0),objectId:P.objectId==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(P.objectId)}}var M={directPath:S,downloadableThumbnail:$,fileEncSha256:(c=b.transport)==null||(c=c.integral)==null?void 0:c.fileEncSha256,filename:null,fileSha256:E,mediaKey:((d=b.transport)==null||(d=d.integral)==null?void 0:d.mediaKey)==null?void 0:o("WAMediaUtils").castToMediaKey((m=b.transport)==null||(m=m.integral)==null?void 0:m.mediaKey),mediaKeyTimestamp:L,objectId:(b==null||(p=b.transport)==null||(p=p.ancillary)==null?void 0:p.objectId)==null?void 0:o("WAMediaUtils").stringToDeliveryObjectId(b==null||(_=b.transport)==null||(_=_.ancillary)==null?void 0:_.objectId),progressiveJpegDetails:T,serverMediaType:t,size:o("WALongInt").numberOrThrowIfTooLarge((f=b==null||(g=b.transport)==null||(g=g.ancillary)==null?void 0:g.fileLength)!=null?f:0),uploadToken:void 0},w=o("WAMediaUtils").encodeMediaEntryWithUpdatedPath(M,S);return s({decodedMediaEntry:M,mediaEntry:w,mediaKeyTimestamp:L,message:{messageId:n.message.messageId,threadId:n.message.threadId},plaintextHash:k,serverMediaType:t,thumbnailHash:((h=$)==null?void 0:h.fileSha256)!=null?o("WAHashUtils").toPlaintextHash((y=$)==null?void 0:y.fileSha256):void 0})}function f(t){return e.get(t)}function g(){e.clear()}l.storeEntry=s,l.hydrateCache=u,l.getEntry=f,l.clear__TEST_ONLY=g}),98);
__d("MAWMediaAfterTxns",["MAWBridgeTypesCreators","MAWDbMedia","MAWDexieTable","MAWIndexedDb","MAWMediaType","MAWMediaUtils","MAWMpsGating","MAWRavenUtils","MpsMediaEntryCache","MpsTypes","WAHashUtils","WAMediaUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,u){return a.messages.where("msgId").anyOf(t.msgIds).toArray().then(function(c){var d=e.threadJid,m=o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(c,d),p=o("MAWMediaUtils").createHdTypesForBridgeMedia(c),_=e.ravenEphemeralType!=null&&e.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(e.ravenEphemeralType,e.ravenEphemeralMediaState),sortOrderMs:e.sortOrderMs,transportKey:l}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:d,filteredMsgIds:m,hasMediaForUI:n,hdTypes:p,media:t,sortOrderMs:e.sortOrderMs,transportKey:l});if(o("MAWMpsGating").isMpsMessageRendering()&&u===!0){var f,g,h,y=r("nullthrows")(t.mediaEntries.get(e.msgId)),C=o("WAMediaUtils").decodeMediaEntryData(y),b=(f=(g=t.validatedImageInfo)==null?void 0:g.thumbnailPlaintextHash)!=null?f:(h=t.validatedVideoInfo)==null?void 0:h.thumbnailPlaintextHash;if(b==null){var v=C.downloadableThumbnail;(v==null?void 0:v.fileSha256)!=null&&(b=o("WAHashUtils").toPlaintextHash(v.fileSha256))}o("MpsMediaEntryCache").storeEntry({decodedMediaEntry:C,mediaEntry:y,mediaKeyTimestamp:t.ts,message:{messageId:o("MpsTypes").toMessageId(e.externalId),threadId:o("MpsTypes").toThreadId(e.threadJid)},plaintextHash:t.plaintextHash,serverMediaType:r("nullthrows")(o("MAWMediaType").getMediaType(t.mediaType)),thumbnailHash:b})}return s(a,babelHelpers.extends({},_,{skipShouldUpdateHasMore:i}),void 0,u)})}function s(e,t,n,r){return u(t)?o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,t,n).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e},r)}):(o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:t},r),o("MAWDexieTable").dexieResolve())}function u(e){if(e.ephemeralMediaState!=null||e.ephemeralMediaViewMode!=null)return!1;switch(e.mediaType){case o("MAWDbMedia").MEDIA_TYPE.IMAGE:case o("MAWDbMedia").MEDIA_TYPE.VIDEO:case o("MAWDbMedia").MEDIA_TYPE.GIF:case o("MAWDbMedia").MEDIA_TYPE.DOCUMENT_FILE:return!0;default:return!1}}l.handleNewMediaAfterTxn=e,l.handleNewMediaAfterTxnWithBridgeMedia=s}),98);
__d("MAWVideoAudioValidationUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return{audioAvgBitsPerSecond:e.audioAvgBitsPerSecond!=null?Math.round(e.audioAvgBitsPerSecond):null,audioNumberOfChannels:e.audioNumberOfChannels!=null?Math.round(e.audioNumberOfChannels):null,audioSamplingRate:e.audioSamplingRate!=null?Math.round(e.audioSamplingRate):null,audioStreamType:e.audioStreamType,validatedMimeType:e.validatedMimeType,videoAvgBitsPerSecond:e.videoAvgBitsPerSecond!=null?Math.round(e.videoAvgBitsPerSecond):null,videoCalculatedFps:e.videoCalculatedFps!=null?Math.round(e.videoCalculatedFps):null,videoDuration:e.videoDuration!=null?Math.round(e.videoDuration):null,videoHeight:e.videoHeight!=null?Math.round(e.videoHeight):null,videoNominalFps:e.videoNominalFps!=null?Math.round(e.videoNominalFps):null,videoStreamType:e.videoStreamType,videoWidth:e.videoWidth!=null?Math.round(e.videoWidth):null}}i.normalizeValidationResult=e}),66);
__d("MAWHandleMediaDownloadApi",["MAWBridgeMsg","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMedia","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWLegacyMediaDownloadManager","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaAfterTxns","MAWMediaUtils","MAWMpsGating","MAWMsgType","MAWTransactionMode","MAWVideoAudioValidationUtils","MAWXMAUtils","MWFBLogger","Promise","WAArmadilloXMA.pb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function p(t,r,a,i,l,c){m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start persisting media blob"])));var p=t.db,_=o("MAWMediaUtils").genHMACPlaintextHash(r),f=t.persistChunk?o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(t.db,r,i,a):null;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(p,l),p.media.where("hashedPlaintextHash").equals(_).first(),f]).then(function(e){var t=e[0],l=e[1],_=e[2];if(l==null)return m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media is null when storing downloaded blob"]))),o("WAResultOrError").makeError("missing-media-on-save");var f,g=!1;return f=o("MAWLegacyMediaDownloadManager").getFromMediaPlaintextDownloadManager(r),f==null&&(f=o("MAWLegacyMediaDownloadManager").getFromMediaDownloadManager(l.mediaId),g=!0),f!=null&&(m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["resolve MediaPlaintextDownloadManager promise"]))),f((d||(d=n("Promise"))).resolve(new Blob([i],{type:a}))),o("MAWLegacyMediaDownloadManager").removeFromMediaPlaintextDownloadManager(r),g&&o("MAWLegacyMediaDownloadManager").removeFromMediaDownloadManager(l.mediaId)),h(p,t).then(function(e){return e?p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return o("MAWDbXMATxns").getXMAFromMsgs(p,e).then(function(e){return o("MAWDexieTable").dexieAll(e.map(function(e){if(!o("MAWXMAUtils").isXMAStoryReply(e.targetType)&&e.defaultPreviewMediaId===l.mediaId)return o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(p,e,l)}))}).then(function(){return e})}).then(function(e){return y(p,e)}):p.messages.where("msgId").anyOf(l.msgIds).toArray().then(function(e){return p.threads.where("jid").anyOf(e.map(function(e){return e.threadJid})).toArray().then(function(n){return o("MAWDexieTable").dexieAll(n.map(function(n){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(e),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.jid,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(e,n.jid),hasMediaForUI:!0,hdTypes:r,media:l,sortOrderMs:t==null?void 0:t.sortOrderMs});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(p,a,e)}))}).then(function(){return e})}).then(function(e){return y(p,e)})}).then(function(){var e,t,n,r,a,s,u,d,m,_,f,g=l.mediaType===o("MAWDbMedia").MEDIA_TYPE.VIDEO?o("MAWVideoAudioValidationUtils").normalizeValidationResult({audioAvgBitsPerSecond:c==null||(e=c.audioStreamReport)==null?void 0:e.avgBitsPerSecond,audioNumberOfChannels:c==null||(t=c.audioStreamReport)==null?void 0:t.numberOfChannels,audioSamplingRate:c==null||(n=c.audioStreamReport)==null?void 0:n.samplingRate,audioStreamType:c==null||(r=c.audioStreamReport)==null?void 0:r.streamType,validatedMimeType:c==null?void 0:c.mimeType,videoAvgBitsPerSecond:c==null||(a=c.videoStreamReport)==null?void 0:a.avgBitsPerSecond,videoCalculatedFps:c==null||(s=c.videoStreamReport)==null?void 0:s.calculatedFps,videoDuration:c==null||(u=c.videoStreamReport)==null?void 0:u.duration,videoHeight:c==null||(d=c.videoStreamReport)==null?void 0:d.videoHeight,videoNominalFps:c==null||(m=c.videoStreamReport)==null?void 0:m.nominalFps,videoStreamType:c==null||(_=c.videoStreamReport)==null?void 0:_.streamType,videoWidth:c==null||(f=c.videoStreamReport)==null?void 0:f.videoWidth}):void 0,h=o("MAWDbMediaTxns").updateMedia(p,l,{size:i.byteLength,validatedResult:g});return h}).then(function(){return o("WAResultOrError").makeResult()})})}var _=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READWRITE,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownload",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!0},t,n,r,o,a)})}),f=o("MAWIndexedDb").makeMsgrTransactor({chunk:c.READONLY,media:c.READWRITE,messages:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READONLY,xma:c.READONLY},"handleMediaDownloadWithoutPersistChunk",function(e){return(function(t,n,r,o,a){return p({db:e,persistChunk:!1},t,n,r,o,a)})}),g=function(){return o("MAWMpsGating").isMpsMessageRendering()?f.apply(void 0,arguments):_.apply(void 0,arguments)};function h(e,t){var n;return t==null?o("MAWDexieTable").dexieResolve(!1):t.type===o("MAWMsgType").MSG_TYPE.XMA?o("MAWDexieTable").dexieResolve(!0):((n=t.quote)==null?void 0:n.content.xmaMessageType)===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY?o("MAWDexieTable").dexieResolve(t.type===o("MAWMsgType").MSG_TYPE.TEXT):o("MAWDbXMATxns").maybeGetXMAFromAssociatedMsgId(e,t.msgId).then(function(e){return e!=null})}function y(e,t){return o("MAWGetMsgQuoteTxn").maybeBatchGetMsgsByQuoteExternalId(e,t.map(function(e){return e.externalId})).then(function(t){return t.map(function(t){return t.source="eb_restore",o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})})}l.handleMediaDownload=g}),98);
__d("MAWMediaDownloadStatusForUI",["MAWBridge","MAWLoggerUtils","MAWMediaDownloadStatus","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWMediaLogger().tags([o("MAWLoggerUtils").Tag.MediaDownload,o("MAWLoggerUtils").Tag.MessageReceive]);function u(e){var t=e.details,n=e.hash,r=e.status,o=e.type,a=e.validationResult;c({details:t,hash:n,status:r,type:o,validationResult:a})}function c(e){var t=e.details,n=e.hash,r=e.status,a=e.type,i=e.validationResult;o("MAWBridge").getBridge().fireAndForget("event","updateMediaStatus",{details:t,key:n,status:r,type:a,validationResult:i})}function d(t){switch(t){case"disconnected":case"backoff":case"body-network-error":case"no-host":case"download-throttled":case"max-attempts-exceeded":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":return r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE;case"request-error":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"decryption-error":case"enc-hash-mismatch":case"hash-mismatch":case"ciphertext-hash-mismatch":case"signature-expired":return r("MAWMediaDownloadStatus").NOT_MANUAL_RETRYABLE_FAILURE;default:return s.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["getStatusTypeFromWAAPIDownloadMediaError: Unknown error type ",""])),String(t)),r("MAWMediaDownloadStatus").MANUAL_RETRYABLE_FAILURE}}l.sendMediaDownloadStatusToUI=u,l.getStatusFromWAAPIDownloadMediaError=d}),98);
__d("MAWMediaBackupTxns",["FBLogger","MAWDbMediaTxns","MAWDexieTable","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=1;function m(t,n,a,i,l,p){return p===void 0&&(p=0),i==null?o("MAWDexieTable").dexieResolve():o("MAWDbMediaTxns").maybeGetMediaBackupRowFromObjectId(t,i).then(function(_){if(_==null){var f={mediaId:n,msgId:a,objectId:i};return l!=null&&(f=babelHelpers.extends({},f,{fbid:l})),t.mediaBackup.add(f).then(function(e){return babelHelpers.extends({},f,{mediaBackupId:e})}).catch(function(u){if(u.name==="ConstraintError"){if(p<d)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry. Will attempt a retry. Error: ",""])),u),m(t,n,a,i,l,p+1);throw r("FBLogger")("messenger_web").mustfixThrow("Failed to add mediaBackup entry. Original error: %s, %s",u.name,u.message)}throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to add mediaBackup entry: ",""])),u),u})}else{if(_.mediaId!==n||_.msgId!==a)return o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] mediaId or msgId cannot differ for an objectId in mediaBackup"]))),_;if(_.fbid==null&&l!=null){var g=babelHelpers.extends({},_,{fbid:l});return t.mediaBackup.put(g).then(function(e){return g})}else o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] fbid already exists for objectId"])));return _}})}l.linkMediaBackup=m}),98);
__d("WASortedLists",[],(function(t,n,r,o,a,i){"use strict";function e(){return[]}function l(){return[]}function s(e,t){return e.filter(t)}function u(e,t){return g(e.map(t))}function c(e,t){for(var n=e.length===t.length,r=0;n&&r<e.length;r++)e[r]!==t[r]&&(n=!1);return n}function d(e,t){for(var n=0;n<e.length;n++)if(e[n]===t)return e;return e.concat([t]).sort()}function m(e,t){if(e.length<t.length)return!1;for(var n=!0,r=0,o=0;n&&o<t.length;o++)do n=e[r]===t[o];while(!n&&++r<e.length);return n}function p(e,t){for(var n=[],r=0,o=0;r<e.length;r++){for(var a=e[r];o<t.length&&a>t[o];)o++;(o===t.length||a<t[o])&&n.push(a)}return n}function _(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;){var a=e[r],i=t[o];a<i?r++:(a===i&&(n.push(a),r++),o++)}return n}function f(e,t){for(var n=[],r=0,o=0;r<e.length&&o<t.length;)e[r]<t[o]?n.push(e[r++]):e[r]===t[o]?(n.push(e[r++]),o++):n.push(t[o++]);for(;r<e.length;)n.push(e[r++]);for(;o<t.length;)n.push(t[o++]);return n}function g(e){return h(e.slice().sort())}function h(e){for(var t=!1,n=0;n<e.length-1;n++)e[n]===e[n+1]&&(t=!0);if(!t)return e;for(var r=[],o=0;o<e.length-1;o++)e[o]!==e[o+1]&&r.push(e[o]);return r.push(e[e.length-1]),r}function y(e){return Array.from(e).sort()}function C(e){return e.slice().sort()}function b(e,t,n){for(var r=null,o=0;!r&&o<e.length;o++)e[o]===t&&(r=e.slice(),r[o]=n,r=h(r.sort()));return r||e}function v(e){return[e]}function S(e){return e.length<1}function R(e,t,n){return e.slice(t,n)}i.emptySet=e,i.emptyList=l,i.filter=s,i.map=u,i.areEqual=c,i.addToSet=d,i.contains=m,i.subtract=p,i.intersect=_,i.joinUniq=f,i.sortAndDedupe=g,i.asSortedSet=y,i.sort=C,i.swapIn=b,i.singleElement=v,i.isEmpty=S,i.slice=R}),66);
__d("MAWMediaManagementTxns",["EBLogger","MAWBridgeTypesCreators","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDexieCastToPromise","MAWDexieTable","MAWMediaAfterTxns","MAWMediaBackupTxns","MAWMediaUtils","MAWMsgType","MAWODSProxy","MAWSupportedDocumentTypes","MAWWriteMsgTxns","MWFBLogger","WAErrorMessage","WAHashUtils","WAMediaUtils","WAOdsEnums","WASortedLists","WATimeUtils","emptyFunction","gkx","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g=o("MWFBLogger").MWMediaLogger().tags(["MAWMediaManagementTxns"]),h=r("gkx")("23924");function y(e,t,n,r){var a,i=n==null||t.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE&&(h||!o("MAWSupportedDocumentTypes").isAllowedType((a=n.validatedDocumentFileInfo)==null?void 0:a.filename));return o("MAWWriteMsgTxns").prepareMsgWriteData(e,t,r).then(function(e){return babelHelpers.extends({},e,{shouldDropDocument:i})})}function C(e,t,n,r,a){a===void 0&&(a=!1);var i={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},l=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),s=l.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(l.objectId):null;return R(e,n,r,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,i,s,void 0,a,void 0,t.accessibilitySummaryText)}function b(e,t,n,r,a,i,l){a===void 0&&(a=!1),l===void 0&&(l=!0);var s=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),u=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),c=u.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;return o("MAWDexieTable").dexieAll([L(e,n,r,c,void 0,a),o("MAWDbChunkTxns").hasMediaChunk(e,s)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,i,l,o)})}function v(e,t,n,r,a,i,l,s){a===void 0&&(a=!1),i===void 0&&(i=!1),s===void 0&&(s=!0);var u={validatedAudioInfo:t.validatedAudioInfo,validatedDocumentFileInfo:t.validatedDocumentFileInfo,validatedImageInfo:t.validatedImageInfo,validatedVideoInfo:t.validatedVideoInfo},c=o("MAWMediaUtils").genHMACPlaintextHash(t.plaintextHash),d=o("WAMediaUtils").decodeMediaEntryData(t.mediaEntry),m=d.objectId!=null?o("WAMediaUtils").stringToDeliveryObjectId(d.objectId):null;return o("MAWDexieTable").dexieAll([S(e,n,t.plaintextHash,t.mediaType,t.size,t.mediaEntry,u,m,void 0,a,t.accessibilitySummaryText),o("MAWDbChunkTxns").hasMediaChunk(e,c)]).then(function(t){var r=t[0],o=t[1];return E(e,n,r,a,l,s,o)})}function S(e,t,n,r,o,a,i,l,s,u,c){return u===void 0&&(u=!1),R(e,t.msgId,t.type,n,r,o,a,i,l,s,u,void 0,c).then(function(n){return L(e,t,n,l,void 0,u)})}function R(t,n,r,a,i,l,d,m,p,_,f,h,y){return f===void 0&&(f=!1),h===void 0&&(h=0),y===void 0&&(y=null),o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(t,a).then(function(C){var b=new Map(C==null?void 0:C.mediaEntries),v=x(d,p,_);if(v!=null&&b.set(n,v),C){var S;h>0&&g.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Media found after retry for plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(a)),C.msgIds||g.mustfix("Media missing msgIds: media type=%s",C.mediaType),C.mediaType||g.mustfix("Media missing mediaType: type=%s ; msg type=%s",i,r);var L=babelHelpers.extends({},C,m,{accessibilitySummaryText:y!=null?y:void 0,mediaEntries:b,mediaType:(S=C.mediaType)!=null?S:i,msgIds:o("WASortedLists").addToSet(C.msgIds||o("WASortedLists").emptySet(),n)});return t.media.put(L).then(function(){return L})}else{var E=o("MAWMediaUtils").genHMACPlaintextHash(a),k=babelHelpers.extends({accessibilitySummaryText:y!=null?y:void 0,fbid:_!=null?_:void 0,hashedPlaintextHash:E,mediaEntries:b,mediaType:i,msgIds:o("WASortedLists").singleElement(n),objectId:p!=null?p:void 0,plaintextHash:a,size:l,ts:o("WATimeUtils").unixTime()},m);return t.media.add(k).then(function(e){return babelHelpers.extends({},k,{mediaId:e})}).catch(function(e){var C=o("WAErrorMessage").maybeGetMessageFromError(e);if(h>0)throw g.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry: plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),g.catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link after retry."]))),e;return g.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media failed to link. Possible duplicate? Will attempt a retry. For plaintextHash: ",", hashedPlaintextHash: ",". Error: ",""])),o("WAHashUtils").sanitisePlaintextHash(a),E,C),o("MAWODSProxy").odsBumpEntityKey({amount:1,entity:o("WAOdsEnums").Entity.MAW_MEDIA_DB_DUPLICATE_MEDIA,key:"retry"}),R(t,n,r,a,i,l,d,m,p,_,f,h+1,y)})}})}function L(e,t,n,r,a,i){i===void 0&&(i=!1);var l=i?o("MAWDexieTable").dexieResolve():o("MAWDbMsgTxns").updateMediaId(e,t,n.mediaId,n.plaintextHash);return l.then(function(){return o("MAWMediaBackupTxns").linkMediaBackup(e,n.mediaId,t.msgId,r,a).then(function(){return n})})}function E(e,t,n,r,a,i,l){return r===void 0&&(r=!1),i===void 0&&(i=!0),o("EBLogger").EBLogger().tags(["restore","handleUnstoredDbMedia"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Inserted media with plaintextHash: ",""])),o("WAHashUtils").sanitisePlaintextHash(n.plaintextHash)),t.type!==o("MAWMsgType").MSG_TYPE.REVOKED&&!r&&i?o("MAWMediaAfterTxns").handleNewMediaAfterTxn(t,n,l,e,void 0,a).then(function(){return n}):o("MAWDexieTable").dexieResolve(n)}var k=function(t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n).then(function(e){if(e==null)throw g.mustfixThrow("Do not have the media message in db when attachHashToMediaMsg");return S(t,e,r,l,s,m,u,a,i,c,d)})},I=function(t,n,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=babelHelpers.extends({},e);return a.validatedAudioInfo!=null&&(n.validatedAudioInfo=babelHelpers.extends({},e.validatedAudioInfo,a.validatedAudioInfo)),a.validatedVideoInfo!=null&&(n.validatedVideoInfo=babelHelpers.extends({},e.validatedVideoInfo,a.validatedVideoInfo)),a.validatedImageInfo!=null&&(n.validatedImageInfo=babelHelpers.extends({},e.validatedImageInfo,a.validatedImageInfo)),a.validatedDocumentFileInfo!=null&&(n.validatedDocumentFileInfo=babelHelpers.extends({},e.validatedDocumentFileInfo,a.validatedDocumentFileInfo)),t.media.update(n.mediaId,n).then(r("emptyFunction"))}else g.WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] media entry is missing, can't update media info"])))})},T=function(t,n,r,a){return o("MAWDbMediaTxns").maybeGetMediaFromHashedPlaintextHash(t,n).then(function(e){if(e!=null){var n=a?e.mediaEntries.set(r,a):e.mediaEntries,i=babelHelpers.extends({},e,{mediaEntries:n});return t.media.update(i.mediaId,i)}else return g.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][updateMediaWithEncodedMediaEntryData] media entry is missing, can't upate media with encoded data"]))),o("MAWDexieTable").dexieResolve()})};function D(e,t,n,r,a,i,l,s,u,c,d,m){return c===void 0&&(c=!1),o("MAWDexieTable").dexieAll([k(e,t,r,a,i,l,u.size,s,c,d,m),o("MAWDbChunkTxns").getOrCreateMediaChunkWithPlaintextHash(e,r,n,u.type)]).then(function(e){var t=e[0];return t})}function x(e,t,n){var r,a=e;return a!=null&&t!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedObjectId(r,t)),a!=null&&n!=null&&(r=o("WAMediaUtils").decodeMediaEntryData(a),a=o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(r,n)),a}function $(e,t,n){var r=new Map;return e.mediaEntries.forEach(function(e,a){var i=o("WAMediaUtils").decodeMediaEntryData(e),l=i.objectId===t?o("WAMediaUtils").encodeMediaEntryWithUpdatedFbid(i,n):e;r.set(a,l)}),r}function P(e,t,n,r,a){a===void 0&&(a=!0);var i=new Map;return t.forEach(function(e){var t,n=(t=i.get(e.hashedPlaintextHash))!=null?t:[];n.push(e),i.set(e.hashedPlaintextHash,n)}),o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,[].concat(Array.from(i.keys()))).then(function(l){var s=new Map(l.map(function(e){return[e.hashedPlaintextHash,e]})),u=new Map;t.forEach(function(e){var t=s.get(e.hashedPlaintextHash);if(e!=null){var n=x(e==null?void 0:e.entry,e==null?void 0:e.objectId,e==null?void 0:e.fbId);if(t){var r=n?t.mediaEntries.set(e.msgId,n):t.mediaEntries,a=babelHelpers.extends({},t,{mediaEntries:r,msgIds:o("WASortedLists").addToSet(t.msgIds,e.msgId)});s.set(e.hashedPlaintextHash,a)}else B(u,e,n)}});var c=new Map,d=new Map,m=Array.from(u.values()).filter(function(e){return N(e,c,d)});return o("MAWDexieTable").dexieAll([e.media.bulkAdd(m),e.media.bulkPut(Array.from(s.values()))]).then(function(){return M(e,[].concat(Array.from(i.keys())),i,n,r,a)})})}function N(e,t,n){if(e.objectId!=null){var r=t.get(e.objectId);if(r!=null&&r!==e.hashedPlaintextHash)return g.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same objectId assigned for different mediaIds. objectId: "," shared by  hashedPlaintextHashes: "," ",""])),e.objectId,r,e.hashedPlaintextHash),!1}if(e.fbid!=null){var o=n.get(e.fbid);if(o!=null&&o!==e.hashedPlaintextHash)return g.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Same FBId assigned for different mediaIds. fbId: "," - shared by hashedPlaintextHashes: "," ",""])),e.fbid,o,e.hashedPlaintextHash),!1}return e.objectId!=null&&t.set(e.objectId,e.hashedPlaintextHash),e.fbid!=null&&n.set(e.fbid,e.hashedPlaintextHash),!0}function M(e,t,n,r,a,i){return o("MAWDbMediaTxns").maybeBulkGetMediaFromHashedPlaintextHash(e,t).then(function(t){return o("MAWDexieTable").dexieAll([F(e,t,n)]).then(function(){return i&&w(t,n,r,e,a),t})})}function w(e,t,n,a,i){e.forEach(function(e){var l=t.get(e.hashedPlaintextHash);l!=null&&!A(l)&&r("promiseDone")(o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(a.messages.where("msgId").anyOf(e.msgIds).toArray().then(function(t){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),l=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!1,hdTypes:r,media:e,transportKey:i});return o("MAWMediaAfterTxns").handleNewMediaAfterTxnWithBridgeMedia(a,l)})))})}function A(e){return e.reduce(function(e,t){return e||t.isXMAShare},!1)}function F(e,t,n){var r=t.reduce(function(e,t){var r;return(r=n.get(t.hashedPlaintextHash))==null||r.filter(function(e){return e!=null&&!e.isXMAShare}).forEach(function(n){return e.set(n.msgId,t.mediaId)}),e},new Map);return o("MAWDbMsgTxns").bulkUpdateMediaId(e,r)}function O(e,t){var n,r,a=e?new Map([[t.msgId,e]]):new Map;return babelHelpers.extends({fbid:(n=t.fbId)!=null?n:void 0,hashedPlaintextHash:t.hashedPlaintextHash,mediaEntries:a,mediaType:t.mediaType,msgIds:o("WASortedLists").singleElement(t.msgId),objectId:(r=t.objectId)!=null?r:void 0,plaintextHash:t.plaintextHash,size:t.size,ts:o("WATimeUtils").unixTime()},t.mediaInfo)}function B(e,t,n){var r=e.get(t.hashedPlaintextHash);r==null?e.set(t.hashedPlaintextHash,O(n,t)):(n!=null&&r.mediaEntries.set(t.msgId,n),r.msgIds.push(t.msgId))}l.prepareMediaWriteData=y,l.handleUnstoredDbMediaCreation=C,l.handleUnstoredDbMediaLinking=b,l.handleUnstoredDbMedia=v,l.linkMedia=S,l.createOrUpdateMediaRow=R,l.attachHashToMediaMsg=k,l.updateMediaEntryWithValidatedMediaInfo=I,l.updateMediaWithEncodedMediaEntryData=T,l.attachHashAndSaveMedia=D,l.updateBackupFbidInMediaEntries=$,l.bulkLinkMedia=P,l.linkMessageAndMediaBackupForMediaList=M}),98);
__d("MAWMediaRetryInfo",[],(function(t,n,r,o,a,i){"use strict";var e=new Map;function l(t,n){e.set(t,n)}function s(t){return e.get(t)}function u(t){e.has(t)&&e.delete(t)}i.setRetriedMediaInfo=l,i.getRetriedMediaInfo=s,i.clearRetriedMediaInfo=u}),66);
__d("WAAPI",["cr:21048"],(function(t,n,r,o,a,i,l){"use strict";l.default=n("cr:21048")}),98);
__d("WAGetAgeBucketForMediaKeyTimestamp",["WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e==null)return"Missing";if(o("WATimeUtils").isInFuture(e))switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day in future";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days in future";default:return"> 7 days in future"}switch(!0){case o("WATimeUtils").happenedWithin(e,1*o("WATimeUtils").DAY_SECONDS):return"< 1 day";case o("WATimeUtils").happenedWithin(e,7*o("WATimeUtils").DAY_SECONDS):return"1-7 days";case o("WATimeUtils").happenedWithin(e,14*o("WATimeUtils").DAY_SECONDS):return"7-14 days";case o("WATimeUtils").happenedWithin(e,21*o("WATimeUtils").DAY_SECONDS):return"14-21 days";case o("WATimeUtils").happenedWithin(e,30*o("WATimeUtils").DAY_SECONDS):return"21-30 days";case o("WATimeUtils").happenedWithin(e,40*o("WATimeUtils").DAY_SECONDS):return"30-40 days";case o("WATimeUtils").happenedWithin(e,50*o("WATimeUtils").DAY_SECONDS):return"40-50 days";case o("WATimeUtils").happenedWithin(e,60*o("WATimeUtils").DAY_SECONDS):return"50-60 days";default:return"> 60 days"}}l.getAgeBucketForMediaKeyTimestamp=e}),98);
__d("WAIsMediaExpiredError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){switch(t){case"signature-expired":return!0;case"hash-mismatch":case"ciphertext-hash-mismatch":case"enc-hash-mismatch":case"decryption-error":case"max-attempts-exceeded":case"request-error":case"download-throttled":case"media-not-found":case"media-entry-invalid":case"media-entry-invalid-direct-path":case"media-entry-invalid-file-enc-sha256":case"media-entry-invalid-file-sha256":case"media-entry-invalid-media-key":case"media-entry-invalid-server-media-type":case"no-host":case"backoff":case"body-network-error":case"disconnected":case"runtime-error":case"access-expired":case"http-fetch-exception":case"http-fetch-aborted":case"unspecified-http-error":case"server-timeout":case"missing-expected-hmacs":case"hmac-chiphertext-array-mismatch":return!1;default:return!0}};i.isMediaExpiredError=e}),66);
__d("WAStartMediaDownloadQplFlow",["QPLFlow","WAGetPlatformFromStanzaId","WAGetStorageQplAnnotations","WAJids","WAMediaUtils","WAPREMetrics","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.downloadEntry,n=e.msgType,a=e.triggerUIView,i=e.protocolMsgId,l=e.isPreview,s=e.xmaMediaType,u=o("QPLFlow").startQPLFlow(r("qpl")._(25312150,"83"),{annotations:{bool:{isTransformStreamSupported:o("WAMediaUtils").isTransformStreamSupported()},string:{chat_type:i==null?null:o("WAJids").switchOnMsgrChatJidType(i.chat,{group:function(){return"group"},user:function(){return"user"}}),downloadEntry:l===!0?t+"-preview":t,e2eePlatform:i==null?null:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(i.externalId),msgType:n,trigger_ui_view:a,xmaMediaType:s!=null?s:void 0}},timeoutInMs:o("WAPREMetrics").QPL_MEDIA_DOWNLOAD_TIMEOUT_IN_MS});return o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){u.addAnnotations(e)}),babelHelpers.extends({},u,{downloadEntry:t,triggerUIView:a})}l.startMediaDownloadQplFlow=e}),98);
__d("MAWHandleEchoMediaMsgsRestoreV2",["EBLogger","EchoMessage","EchoMessageMediaFieldUtils","LSMEBTaskCreationSource","MAWBridge","MAWBridgeTypesCreators","MAWCastToMsgrServerMediaType","MAWConfig","MAWDbChunkTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWEncodeMediaTransportProtocol","MAWFrontendMediaUtils","MAWGetMsgForProtocolMsgIdTxn","MAWHandleMediaDownloadApi","MAWIndexedDb","MAWJids","MAWJobDefinitions","MAWJobManager","MAWMediaDownloadStatus","MAWMediaDownloadStatusForUI","MAWMediaManagementTxns","MAWMediaRetryInfo","MAWMediaUtils","MAWSupportedDocumentTypes","MAWTransactionMode","WAAPI","WAArmadilloXMA.pb","WABase64","WAGetAgeBucketForMediaKeyTimestamp","WAGetStorageQplAnnotations","WAHashUtils","WAIsMediaExpiredError","WAJids","WAJobOrchestratorTypes","WAMediaUtils","WAStartMediaDownloadQplFlow","WATimeUtils","cr:10071","getErrorSafe","gkx","vulture"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B,W,q,U,V=o("EBLogger").EBLogger().tags(["restore"]);function H(e){var t=K(e);return t.then(function(t){var n=new Map;return e.forEach(function(e){var r=t.get(e),o=r==null?void 0:r.blobData;n.set(e,o)}),Promise.resolve(n)})}function G(e){return e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG?"image/jpeg":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_PNG?"image/png":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER?"image/webp":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF?"image/gif":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4?"audio/mp4":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV?"audio/wav":e===o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.XMA?"xma":(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}async function z(t,n,a){if(t.length===0)return Promise.resolve();var i=[],l=[],v=new Map,S=new Map;t.map(function(t){var n,a=t.mediaData,h=t.messageTimestamp,y=X(a.plaintextHash),C=a.attachmentObjectId,b=a.attachmentType,R=a.backupEntFbid,L=a.directPath,E=a.filename,k=a.height,I=a.mediaContentType,T=a.mediaKeyTimestamp,D=a.mediaPlayableDuration,x=a.previewContentHeight,$=a.previewContentType,P=a.previewContentWidth,N=a.size,M=a.width,w=o("WAHashUtils").stringToPlaintextHash(y),A=o("MAWMediaUtils").genHMACPlaintextHash(w);l.push(A);var F=I!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(I,t.isXMA):$!=null?o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(G($)):null;if(F==null)return V.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null, msg id: ",""])),t.externalId),V.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - media content type null"]))),Promise.resolve();if(b===o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT&&!o("MAWSupportedDocumentTypes").isAllowedType(E))return V.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot download media - document extension is disallowed, msg id: ",""])),t.externalId),Promise.resolve();var O=t.mediaData.encryptedHash;if(O==null)return V.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null, msg id: ",""])),t.externalId),V.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash cannot be null"]))),Promise.resolve();var B=t.mediaData.mediaKey;if(B==null)return V.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null, msg id: ",""])),t.externalId),V.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Media key cannot be null"]))),Promise.resolve();var W=F.mediaType,q=F.serverMediaType,U=o("WAMediaUtils").stringToDeliveryObjectId(C),H=R!=null?o("WAMediaUtils").stringToBackupEntFbid(R):void 0,z=t.threadJId,j=Y({filename:E,height:k,mediaPlayableDuration:D,mediaType:W,previewContentHeight:x,previewContentWidth:P,width:M});S.set(U,{filename:E,height:k,mediaPlayableDuration:D,mediaType:W,messageTimestamp:h,plaintextHash:w,previewContentHeight:x,previewContentWidth:P,serverMediaType:q,threadJId:z,width:M});var K=null;if(t.previewMediaData!=null)try{K=Z(t.previewMediaData),K!=null&&K.objectId==null&&V.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["downloadableThumbnail was created without metadata, source: echo"])))}catch(e){var Q=r("getErrorSafe")(e);V.catching(Q).DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData, msg id: ",""])),t.externalId),V.catching(Q).MUSTFIX(g||(g=babelHelpers.taggedTemplateLiteralLoose(["Unable to construct downloadableThumbnail from previewMediaData"])))}if(O!=null){var ee=J(y,O,B,L,T,q,E,H,U,K,N);i.push({entry:ee,fbId:H,hashedPlaintextHash:A,isXMAShare:t.isXMA,mediaInfo:j,mediaType:W,msgId:t.msgId,objectId:U,plaintextHash:w,size:N!=null?N:0})}var te=(n=v.get(A))!=null?n:[];te.push(t),v.set(A,te)});var R=a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,L=await j(i,n,R),E=await H(l),k=[];E.forEach(function(e,t){var l=v.get(t);l==null||l.forEach(function(l){if(l!=null){if(e!=null){V.DEBUG(h||(h=babelHelpers.taggedTemplateLiteralLoose(["media for message: "," is already downloaded on the device"])),l.externalId);var s=L.find(function(e){return e.plaintextHash===l.mediaData.plaintextHash});if(s==null){V.DEBUG(y||(y=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message with mediaKey ",""])),l.mediaData.mediaKey);return}return Q(s.msgIds).then(function(e){var t=e.filter(function(e){return o("MAWDbMsg").isMediaMsg(e)});if(t.length>0){var r=o("MAWMediaUtils").createHdTypesForBridgeMedia(t),a=o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:l.threadJId,filteredMsgIds:o("MAWBridgeTypesCreators").getMsgIdsFilteredByJid(t,n),hasMediaForUI:!0,hdTypes:r,media:s,transportKey:"EncryptedBackups"}),i=o("MAWMediaUtils").annotateBridgeMediaForDisplay(a,t);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewMedia",value:i}]})}})}var u=S.get(o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId));if(!(l==null||u==null)){var c=u.filename,d=u.height,m=u.mediaPlayableDuration,p=u.mediaType,_=u.messageTimestamp,f=u.plaintextHash,g=u.previewContentHeight,v=u.previewContentWidth,R=u.serverMediaType,E=u.threadJId,I=u.width,T=o("WAJids").extractUserId(o("MAWJids").toUserJid(l.threadJId)),D=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(R,l.isXMA);if(D!=null){var x={attachmentObjectId:o("WAMediaUtils").stringToDeliveryObjectId(l.mediaData.attachmentObjectId),mediaType:D,messageId:l.externalId,messageTimeStamp:l.messageTimestamp,msgId:l.msgId,plaintextHash:f,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,threadId:T,threadJid:E},$=i.find(function(e){return e.hashedPlaintextHash===t}),P=$==null?void 0:$.entry;if(P==null){V.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message, plaintextHash: ",", msg id: ",""])),o("WAHashUtils").sanitisePlaintextHash(o("WAHashUtils").stringToPlaintextHash(l.mediaData.plaintextHash)),l.externalId),V.MUSTFIX(b||(b=babelHelpers.taggedTemplateLiteralLoose(["Cannot find the media entry for message"])));return}if(a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)return;var N=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:{author:l.author,chat:l.threadJId,externalId:l.externalId},triggerUIView:null});k.push(ee({author:l.author,directPath:l.mediaData.directPath,echoMsg:l.echoMsg,externalId:l.externalId,filename:c,hashedPlaintextHash:t,height:d,isXMA:l.isXMA,mediaPlayableDuration:m,mediaType:p,messageTimestamp:_,plaintextHash:f,previewContentHeight:g,previewContentWidth:v,threadJId:E,width:I},void 0,x,void 0,o("WAMediaUtils").decodeMediaEntryData(P),N))}}}})}),await Promise.all(k)}var j=(q=o("MAWIndexedDb")).makeMsgrTransactor({media:(U=o("MAWTransactionMode")).READWRITE,mediaBackup:U.READWRITE,messages:U.READWRITE},"restoreLinkMedias",function(e){return(function(t,n,r){return o("MAWMediaManagementTxns").bulkLinkMedia(e,t,n,"EncryptedBackups",r)})}),K=q.makeMsgrTransactor({chunk:U.READONLY},"getChunksByHash",function(e){return function(t){return o("MAWDbChunkTxns").maybeBulkGetChunksFromHash(e,t)}}),Q=q.makeMsgrTransactor({messages:U.READONLY},"getMessagesForMsgIds",function(e){return function(t){return e.messages.where("msgId").anyOf(t).toArray()}});function X(e){if(e.endsWith("="))for(var t="",n=0;n<e.length;n++){var r=e.charAt(n);if(r==="=")return t;t+=r}return e}function Y(e){var t=e.height,n=e.mediaType,r=e.width,a=e.previewContentHeight,i=e.previewContentWidth,l=e.mediaPlayableDuration,s=e.filename;return{validatedAudioInfo:n==="Ptt"&&l!=null?{duration:re(l),mimetype:o("MAWEncodeMediaTransportProtocol").AUDIO_WAV_MIME_TYPE,played:!1}:null,validatedDocumentFileInfo:n==="DocumentFile"?{filename:s,mimetype:o("MAWEncodeMediaTransportProtocol").FILE_MIME_TYPE}:null,validatedImageInfo:n==="Image"?{height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,width:r}:n==="Gif"||n==="Sticker"?{height:t,jpegThumbnailHeight:t,jpegThumbnailWidth:r,width:r}:null,validatedVideoInfo:n==="Video"?{duration:l,height:t,jpegThumbnailHeight:a,jpegThumbnailWidth:i,mimetype:o("MAWEncodeMediaTransportProtocol").VIDEO_MIME_TYPE,width:r}:null}}function J(e,t,n,r,a,i,l,s,u,c,d){var m=o("WABase64").decodeB64UrlSafe(e,!0),p=o("WABase64").decodeB64UrlSafe(t,!0),_=o("WABase64").decodeB64UrlSafe(n,!0);return o("WAMediaUtils").rawDataToMediaEntry({directPath:r,downloadableThumbnail:c!=null?c:void 0,fbid:s!=null?s:void 0,fileEncSha256:p,filename:l,fileSha256:m,mediaKey:_,mediaKeyTimestamp:a!=null?o("WATimeUtils").castToUnixTime(a):void 0,objectId:u!=null?u:void 0,serverMediaType:i,size:d!=null?d:void 0})}function Z(e){var t=e.attachmentObjectId,n=e.directPath,r=e.encryptedHash,a=e.mediaKey,i=e.mediaKeyTimestamp,l=e.plaintextHash;if(r==null){V.MUSTFIX(v||(v=babelHelpers.taggedTemplateLiteralLoose(["Encrypted hash is null - unable to download thumbnail"])));return}else{var s=i!=null?o("WATimeUtils").castToUnixTime(i):void 0,u=a!=null?o("WAMediaUtils").castToMediaKey(o("WABase64").decodeB64UrlSafe(a,!0)):void 0,c=o("WABase64").decodeB64UrlSafe(l,!0),d=o("WABase64").decodeB64UrlSafe(r,!0);return{directPath:n,fileEncSha256:d,fileSha256:c,mediaKey:u,mediaKeyTimestamp:s,objectId:t}}}var ee=async function(t,n,a,i,l,s){var e,u,c,d,m,p;V.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["start media download from whatsapp infra. traceId: ",""])),n);var _=t.author,f=t.externalId,g=t.filename,h=t.hashedPlaintextHash,y=t.height,C=t.mediaPlayableDuration,b=t.mediaType,v=t.messageTimestamp,x=t.plaintextHash,$=t.previewContentHeight,P=t.previewContentWidth,N=t.threadJId,M=t.width,w={author:_,chat:N,externalId:f},A=s!=null?s:o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:w,triggerUIView:null});o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore",hash:x,status:r("MAWMediaDownloadStatus").DOWNLOADING,type:"main"});var F=((e=(u=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null?void 0:u.isXMA)!=null?e:!1)||((c=t==null?void 0:t.isXMA)!=null?c:!1),O=((d=o("MAWMediaRetryInfo").getRetriedMediaInfo(f))==null||(d=d.echoMsg)==null?void 0:d.serializationOrigin)||(t==null||(m=t.echoMsg)==null?void 0:m.serializationOrigin)||o("EchoMessage").EchoSerializationOriginType.UNKNOWN,B=r("gkx")("23960");if(A.addPoint("download_media_start",{bool:{isEBDownloadEnforced:a==null&&B,isRetryFromMI:a==null,isXMA:F,pathMismatch:i!==l.directPath},int:{mediaEntrySize:l.size},string:{oldDirectPath:(p=t==null?void 0:t.oldDirectPath)!=null?p:"",origin:O,restorationCdnUrl:i!=null?i:""}}),o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){A.addAnnotations(e)}),a!=null&&B)return V.DEBUG(R||(R=babelHelpers.taggedTemplateLiteralLoose(["downloading media from MI directly. externalId ","."])),w.externalId),ae({decodedMediaEntry:l,isEBDownloadEnforced:B,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});var W=o("WAMediaUtils").validateDecodedMediaEntryForDownload(l);if(!W.success){V.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. externalId ",". traceId: ",". error: ","."])),w.externalId,n,W.error),V.MUSTFIX(E||(E=babelHelpers.taggedTemplateLiteralLoose(["media entry validation failed. error: ","."])),W.error),A.endFail("download_media_fail",{string:{failReason:W.error}});return}var q=await r("WAAPI").cachedDownloadFullMediaOnly({downloadMediaMetric:A,hash:x,mediaEntry:W.value});if(q.success){A.addPoint("download_media_end");var U=q.value,H=U.mimeType,G=U.plaintext;await o("MAWHandleMediaDownloadApi").handleMediaDownload(x,H,G,w),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f);var z=Y({filename:g,height:y,mediaPlayableDuration:C,mediaType:b,previewContentHeight:$,previewContentWidth:P,width:M});await ne(h,z),V.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["media download complete. externalId ",". traceId: ",""])),w.externalId,n),A.endSuccess(),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:"handle_echo_media_msgs_restore_success",hash:x,status:r("MAWMediaDownloadStatus").SUCCESS,type:"main"})}else{var j=q.error;if(o("WAIsMediaExpiredError").isMediaExpiredError(j)&&a)A.addPoint("eb_resign_requested"),A.endSuccess(),V.WARN(I||(I=babelHelpers.taggedTemplateLiteralLoose(["Retry download media as signature has expired and should be renewed. externalId ",". traceId: ",""])),w.externalId,n),await ae({decodedMediaEntry:l,isEBDownloadEnforced:!1,mediaDownloadRequest:t,protocolMsgId:w,retryPayload:a});else{V.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: "," "," when downloading. Message timestamp: ",". traceId: ",""])),f,j,v,n),V.MUSTFIX(D||(D=babelHelpers.taggedTemplateLiteralLoose(["media download failed with error: ",""])),j);var K={string:{directPath:l.directPath,error:"media_download_failure",restorationCdnUrl:i!=null?i:""}};A.endFail(j,K),o("MAWMediaRetryInfo").clearRetriedMediaInfo(f),o("MAWMediaDownloadStatusForUI").sendMediaDownloadStatusToUI({details:j,hash:x,status:o("MAWMediaDownloadStatusForUI").getStatusFromWAAPIDownloadMediaError(j),type:"main"})}}},te=q.makeMsgrTransactor({media:U.READONLY,mediaBackup:U.READONLY,messages:U.READONLY},"invokeRestoreAccessCheckSprocToDownloadAttachment",function(e){return(function(t,n,r){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,n.plaintextHash).then(function(a){if(a){V.DEBUG(x||(x=babelHelpers.taggedTemplateLiteralLoose(["start resign cdn url through sproc"])));var i=ie(a,n.attachmentObjectId);return o("MAWDbMsgTxns").getMsgsByMsgIds(e,i).then(function(e){var i,l=e.find(function(e){return e.externalId===t});r.addPoint("resign_cdn_url_bridge_call",{bool:{isForwarded:(i=l==null?void 0:l.isForwarded)!=null?i:!1},int:{duplicateMsgsCount:e.length,msgXMAType:l==null?void 0:l.xmaMessageType,totalMediaEntries:a.mediaEntries.size},int_array:{duplicateXMATypes:e.map(function(e){var t;return(t=e.xmaMessageType)!=null?t:0})},string:{msgType:l==null?void 0:l.type},string_array:{duplicateMsgs:e.map(function(e){return e.externalId}),duplicateMsgTypes:e.map(function(e){return e.type})}}),o("MAWIndexedDb").afterTransaction({tag:"ResignAttachmentCDNUrl",value:{deliveryObjectId:n.attachmentObjectId,mediaType:n.mediaType,messageId:t,msgId:n.msgId,plaintextHash:n.plaintextHash,productType:o("MAWConfig").getConfig().productTypeForEBAttachments,sortOrder:n.messageTimeStamp,threadId:n.threadId,threadJid:n.threadJid,traceId:r.getQPLAttrs().instanceKey}})})}else V.DEBUG($||($=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ",". traceId: ",""])),t,r.getQPLAttrs().instanceKey),V.MUSTFIX(P||(P=babelHelpers.taggedTemplateLiteralLoose(["media entry is missing from index db. It is required to retry download by resigning cdn url: externalId: ","."])),t),r.endFail("missing-media")})})}),ne=q.makeMsgrTransactor({media:U.READWRITE,messages:U.READWRITE},"updateMediaWithDownloadedChunkBlob",function(e){return(function(t,n){return o("MAWMediaManagementTxns").updateMediaEntryWithValidatedMediaInfo(e,t,n)})});function re(e){var t=Math.floor(e/1e3);return t>0?t:e}function oe(e){return e==null?!1:e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY||e===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION}async function ae(e){var t,a=e.decodedMediaEntry,i=e.isEBDownloadEnforced,l=e.mediaDownloadRequest,s=e.protocolMsgId,u=e.retryPayload,c=await o("MAWGetMsgForProtocolMsgIdTxn").getMsgForProtocolMsgIdTxn(s);if(c.success===!0&&oe(c.value.xmaMessageType))return V.DEBUG(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Skipping media restore for expirable XMA. externalId ",". xmamessageType: ",""])),s.externalId,c.value.xmaMessageType),Promise.resolve();var d=s.externalId;o("MAWMediaRetryInfo").setRetriedMediaInfo(s.externalId,l);var m=((t=a.mediaKeyTimestamp)!=null?t:0)>1725105600,p={bool:{is_after_S441705_fix:m,isEBDownloadEnforced:i},int:{mediaKeyTimestamp:a.mediaKeyTimestamp},string:{externalId:d,mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(a.mediaKeyTimestamp),mediaType:u.mediaType,objectId:u.attachmentObjectId,restoreEntry:"EB",restoreMethod:n("cr:10071")==null?"sproc":"gql"}},_=o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"handleEchoMediaMsgsRestore",msgType:null,protocolMsgId:s,triggerUIView:null});_.addAnnotations(p),V.DEBUG(M||(M=babelHelpers.taggedTemplateLiteralLoose(["start restore media from backup. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey);var f=a.mediaKey;if(f==null){V.WARN(w||(w=babelHelpers.taggedTemplateLiteralLoose(["media key is missing from media entry. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),_.endFail("missing-media-key");return}return n("cr:10071")!=null?(V.DEBUG(A||(A=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [gql]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:s.chat,deliveryObjectId:u.attachmentObjectId,externalId:d,mediaKey:f,mediaType:u.mediaType,sortOrderMs:u.messageTimeStamp}).then(function(e){if(r("vulture")("zP4BquwZMLWLp2xHPcGqA0y9_YQ="),e.success===!1){V.DEBUG(F||(F=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql failed: ",". hash: ",". externalId ",""])),e.error,o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d),_.endFail(e.error);return}V.DEBUG(O||(O=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql success. hash: ",". externalId ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d);var t=o("MAWJobDefinitions").createStartJobInfo("downloadAndRestoreMedia",{deliveryObjectId:u.attachmentObjectId,msgId:u.msgId,plaintextHash:u.plaintextHash,restorationCdnUrl:e.value,scheduleConfig:{priority:o("WAJobOrchestratorTypes").JOB_PRIORITY.LOW},traceId:_.getQPLAttrs().instanceKey});return o("MAWJobManager").getJobManager().fireAndForget(t)}).catch(function(e){var t=r("getErrorSafe")(e);V.catching(t).MUSTFIX(B||(B=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url gql error"]))),_.endFail("runtime-error",{string:{restoreError:t.toString()}})})):(V.DEBUG(W||(W=babelHelpers.taggedTemplateLiteralLoose(["resign cdn url start [sproc]. hash: ",". msgId: ",". traceId: ",""])),o("WAHashUtils").sanitisePlaintextHash(u.plaintextHash),d,_.getQPLAttrs().instanceKey),te(d,u,_))}function ie(e,t){var n,r=[];return(n=e.mediaEntries)==null||n.forEach(function(e,n){var a=o("WAMediaUtils").decodeMediaEntryData(e);a.objectId===t&&r.push(n)}),r}l.downloadMediaAndWriteToMediaStore=z,l.getBase64WithoutPadding=X,l.getMediaInfo=Y,l.constructMediaEntry=J,l.constructRawDownloadableThumbnail=Z,l.handleDownloadMedia=ee,l.invokeRestoreAccessCheckSprocToDownloadAttachment=te}),98);
__d("MAWHandleEchoMsgsRestoreApiUtils",["$InternalEnum","EBLogger","EchoMessage","EchoMessageMediaFieldUtils","MAWAckLevel","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWEBRestoreTrackingUtils","MAWJids","MAWMsgType","MAWRepliesRestoreUtils","WAJids","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("EBLogger").EBLogger().tags(["restore"]),g=n("$InternalEnum")({INITIAL_RESTORE:"initial_restore",POINT_RESTORE:"point_restore",PAGINATED_RESTORE:"paginated_restore"});function h(t,n){var r=n==null?f:f.tags([n]),a=t.contentType;switch(a){case o("EchoMessage").EchoMessageContentType.TEXT:return t.xContentType===o("EchoMessage").EchoXMessageContentType.BUMP?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE):o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.TEXT);case o("EchoMessage").EchoMessageContentType.MEDIA:return t.receiverFetchId!=null&&t.receiverFetchData!=null?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH):t.mediaData==null?o("WAResultOrError").makeError("media_mandatory_fields_missing"):o("WAResultOrError").makeResult(y(t.mediaData));case o("EchoMessage").EchoMessageContentType.PLACEHOLDER:return t.contentSubtype===o("EchoMessage").EchoMessageContentSubtype.UNSEND?o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.REVOKED):(r.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",", xContentType: ",",\n      subcontent type: "," ,\n      origin: ",""])),o("EchoMessage").EchoMessageContentType.getName(a),t.xContentType!=null?o("EchoMessage").EchoXMessageContentType.getName(t.xContentType):"unknown",o("EchoMessage").EchoMessageContentSubtype.getName(t.contentSubtype),t.serializationOrigin!=null?o("EchoMessage").EchoSerializationOriginType.getName(t.serializationOrigin):"unknown"),o("WAResultOrError").makeError("unsupported_message_type"));case o("EchoMessage").EchoMessageContentType.XMA:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.XMA);case o("EchoMessage").EchoMessageContentType.DECRYPTION_FAILURE:return o("WAResultOrError").makeResult(o("MAWMsgType").MSG_TYPE.CIPHERTEXT);default:return r.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Message has unsupported message content type: ",""])),o("EchoMessage").EchoMessageContentType.getName(a)),o("WAResultOrError").makeError("unsupported_message_type")}}function y(e){switch(e.attachmentType){case o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE:return o("MAWMsgType").MSG_TYPE.IMAGE;case o("EchoMessageMediaFieldUtils").AttachmentType.STICKER:return o("MAWMsgType").MSG_TYPE.STICKER;case o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO:return o("MAWMsgType").MSG_TYPE.VIDEO;case o("EchoMessageMediaFieldUtils").AttachmentType.GIF:return o("MAWMsgType").MSG_TYPE.GIF;case o("EchoMessageMediaFieldUtils").AttachmentType.PTT:return o("MAWMsgType").MSG_TYPE.PTT;case o("EchoMessageMediaFieldUtils").AttachmentType.XMA:return o("MAWMsgType").MSG_TYPE.XMA;case o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT:return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}}function C(e,t,n,r,a,i){var l,s=e.from;if(s==null)return f.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Author info is missing from msg: ",""])),r),o("WAResultOrError").makeError("author_missing");var d=h(e,a);if(d.success===!1)return o("WAResultOrError").makeError(d.error);if(d==null)return o("WAResultOrError").makeError("unsupported_message_type");var m=d.value;if((l=e.isTombstoned)!=null&&l)return o("WAResultOrError").makeError("message_tombstoned");switch(m){case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return k(e,t,n,s,m,r,a,i);case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return b(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.XMA:return S(e,t,n,s,m,r);case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("WAResultOrError").makeResult(D(e,t,n,s,m,r));case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return R(e,t,n,s,m,r);default:return f.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Encountered unsupported media type: ",""])),m),o("WAResultOrError").makeError("unsupported_message_type")}}function b(e,t,n,r,o,a){var i=I(e,t,n,r,o,a);return v(o,i)}function v(e,t){switch(e){case o("MAWMsgType").MSG_TYPE.IMAGE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.IMAGE}));case o("MAWMsgType").MSG_TYPE.STICKER:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.STICKER}));case o("MAWMsgType").MSG_TYPE.VIDEO:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.VIDEO}));case o("MAWMsgType").MSG_TYPE.GIF:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.GIF}));case o("MAWMsgType").MSG_TYPE.PTT:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.PTT}));case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("WAResultOrError").makeResult(babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE}));default:return f.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported media message type: ",""])),e),o("WAResultOrError").makeError("unsupported_media_type")}}function S(e,t,n,r,a,i){var l;if(((l=e.xmaData)==null?void 0:l.xmaTargetType)==null)return f.MUSTFIX(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Mandatory XMA Data missing for XMA message: ",""])),i),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var s=e.xmaData.xmaTargetType,u=I(e,t,n,r,a,i),c=babelHelpers.extends({},u,{type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(s)}),d=e.text;return d!=null&&(c.msgContent={content:d}),o("WAResultOrError").makeResult(c)}function R(e,t,n,r,a,i){if(e.receiverFetchData==null)return f.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Mandatory receiver fetch data missing for receiver fetch message: ",""])),i),o("WAResultOrError").makeError("receiver_fetch_mandatory_fields_missing");var l=I(e,t,n,r,a,i);return o("WAResultOrError").makeResult(babelHelpers.extends({},l,{receiverFetchId:e.receiverFetchId,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}))}function L(e){if(e!=null)switch(e){case o("EchoMessage").MessageTextSize.SMALL:return 1;case o("EchoMessage").MessageTextSize.MEDIUM:return 2;case o("EchoMessage").MessageTextSize.LARGE:return 3;default:return}}function E(e){return e.text==null?null:e.editHistory.length===0?e.text:e.editHistory.sort(function(e,t){return e.timestamp-t.timestamp})[0].text}function k(e,t,n,r,a,i,l,s){var u=l==null?f:f.tags([l]),c=s==="first_edit_content"?E(e):e.text;if(c==null)return o("MAWEBRestoreTrackingUtils").addQPLRestorePointWithAnnotationsWorker({annotations:{string:{empty_content_msg_type:a}},pointName:"unstored_text_message_empty",traceId:l}),u.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Message content is empty for the message: ",", type: ",""])),i,a),o("WAResultOrError").makeError("text_message_content_empty");var d=I(e,t,n,r,a,i,l);if(a===o("MAWMsgType").MSG_TYPE.REVOKED)return c!=null&&(d.msgContent={content:c}),e.revokeSentTimestampMs!=null&&(d.originalTs=o("WATimeUtils").castToUnixTime(e.revokeSentTimestampMs)),o("WAResultOrError").makeResult(babelHelpers.extends({},d,{revokedExternalId:o("WAStanzaUtils").toStanzaId("0"),type:o("MAWMsgType").MSG_TYPE.REVOKED,unsendMsgContentDeleteTs:e.revokeUnsentTimestampMS!=null?o("WATimeUtils").castToUnixTime(e.revokeUnsentTimestampMS):d.ts}));if(a===o("MAWMsgType").MSG_TYPE.CIPHERTEXT)return o("WAResultOrError").makeResult(babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT}));var m=babelHelpers.extends({},d,{msgContent:{content:c},specialTextSize:L(e.textSize),type:o("MAWMsgType").MSG_TYPE.TEXT});return o("WAResultOrError").makeResult(babelHelpers.extends({},m,{editCount:Math.max(e.editHistory.length-1,0),groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize}))}function I(e,t,n,r,a,i,l){var s=T(r,n),u={ack:s===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s,externalId:i,groupId:e.groupId,groupIndex:e.groupIndex,groupSize:e.groupSize,isForwarded:e.isForwarded,sortOrderMs:e.sortOrderMs,threadJid:t,ts:o("WATimeUtils").castToUnixTime(e.displayTimestampMs/1e3),type:a};if(e.authoritativeTimestampMs!=null?u.serverTs=o("WATimeUtils").castToUnixTime(e.authoritativeTimestampMs/1e3):u.serverTs=o("WATimeUtils").castToUnixTime(e.sortOrderMs/1e3),e.quoteData!=null){var c=o("MAWRepliesRestoreUtils").getQuoteDataFromEchoMessage(e,n);c!=null&&(u.quote=c,u.quoteExternalId=c.content.externalId)}return u}function T(e,t){var n=o("MAWJids").toUserJid(e.localKey);return n===t?o("WAJids").AUTHOR_ME:n}function D(e,t,n,r,a,i){var l=I(e,t,n,r,a,i);return babelHelpers.extends({},l,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}l.MAWRestoreType=g,l.getDbMsgTypeFromEchoMessage=h,l.getUnstoredDbMessageFromEchoMessage=C,l.resolveAuthorFromEchoAddress=T}),98);
__d("MAWRepliesRestoreUtils",["FBLogger","MAWBridgeMsg","MAWDexieTable","MAWGetMsgQuoteTxn","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWTransactionMode","MAWUpdateQuotedMsgTxns","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["msgId","originalTs","rowId","threadJid","unsendMsgContentDeleteTs"],s,u;function c(e,t){if(t==null||!o("MAWMsgType").isQuotedMsgType(t.type))return e;var n={author:t.author,externalId:t.externalId,ts:t.ts,type:t.type},r={content:n,remoteJid:null};return babelHelpers.extends({},e,{quote:r})}function d(e,t){if(e.quoteData!=null&&e.quoteData.quoteMessageId!=null&&e.quoteData.quoteMessageSender!=null){var n,r={author:o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(e.quoteData.quoteMessageSender,t),externalId:(n=e.quoteData)==null?void 0:n.quoteMessageId,ts:e.displayTimestampMs,type:o("MAWMsgType").MSG_TYPE.TEXT};return{content:r,remoteJid:null}}else o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Quote data is missing for message: ",""])),e.messageId);return null}var m=o("MAWIndexedDb").makeMsgrTransactor({chunk:(u=o("MAWTransactionMode")).READONLY,media:u.READONLY,messages:u.READWRITE,threads:u.READWRITE,xma:u.READONLY},"updateQuoteDataForReplyMessages",function(e){return(function(t,n,r){n==null||n.addPoint("replies_restore_start");var a=t.restoredMsgsData;if(a){var i=a.existingMsgs,l=a.newlyAddedMsgs,s=l.concat(i);return o("MAWDexieTable").dexieAll(s.map(function(t){return o("MAWUpdateQuotedMsgTxns").associateQuotedMessage(e,t.threadJid,t).then(function(e){var n=[];return t.quoteExternalId!=null&&n.push(t),e!=null&&n.push.apply(n,e),n})})).then(function(t){var n=t.flat();return p(e,n,r)}).then(function(e){return n==null||n.addPoint("replies_restore_end",{int:{replies:e}}),e})}return o("MAWDexieTable").dexieResolve(0)})});function p(e,t,n){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=_(t);if(t.threadJid!=null)return o("MAWGetMsgQuoteTxn").enhanceMsgWithQuoteInfo(e,n,t.threadJid).then(function(e){return babelHelpers.extends({},e,{msgId:t.msgId,originalTs:t.originalTs,protocolMsgId:t.protocolMsgId,rowId:t.rowId,threadJid:t.threadJid,unsendMsgContentDeleteTs:t.unsendMsgContentDeleteTs})});r("FBLogger")("labyrinth_web","thread_id_absent").mustfix("Reply restore: threadId cannot be null for a restored msg")})).then(function(e){return e.filter(Boolean).filter(function(e){return e.quote!=null})}).then(function(e){return e.map(function(e){return e.source="eb_restore",e})}).then(function(t){return e.messages.bulkPut(t).then(function(r){return t.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t).then(function(e){n!==!0&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t,e)})})})}).then(function(e){var n;return(n=t==null?void 0:t.length)!=null?n:0})})}function _(t){var n=t.msgId,r=t.originalTs,o=t.rowId,a=t.threadJid,i=t.unsendMsgContentDeleteTs,l=babelHelpers.objectWithoutPropertiesLoose(t,e);return l}l.addQuoteDataToReplyMessage=c,l.getQuoteDataFromEchoMessage=d,l.updateQuoteDataForReplyMessages=m,l.enhanceAndPersistReplyMessagesWithQuoteData=p}),98);
__d("MAWHandleEchoReactionsRestore",["MAWAckLevel","MAWAuthor","MAWBulkWriteReactionsTxns","MAWHandleEchoMsgsRestoreApiUtils","MAWIndexedDb","MAWTransactionMode","Promise","WAJids","WALogger","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(e,t,r){r==null||r.addPoint("reactions_restore_start");var o=e.echoMsgMap,a=e.restoredMsgsData,i=0;if(a){var l=a.existingMsgs,s=a.newlyAddedMsgs,u=s.concat(l),c=a.threadJid,d=u.filter(function(e){var t=o.get(e.externalId);return y(o,e)&&t!=null&&C(t)});if(d.length===0)return(f||(f=n("Promise"))).resolve();var m=d.flatMap(function(e){var n=o.get(e.externalId),r=S(a.threadJid,t,e.externalId,e.msgId,e.author,n);return r.map(function(e){return{chatJid:c,unstoredReaction:e}})});return m.length===0?(f||(f=n("Promise"))).resolve():h(m).then(function(e){i+=m.length,r==null||r.addPoint("reactions_restore_end",{int:{reactions:i}})})}return(f||(f=n("Promise"))).resolve()}var h=o("MAWIndexedDb").makeMsgrTransactor({groupInfo:(_=o("MAWTransactionMode")).READWRITE,messages:_.READWRITE,reactions:_.READWRITE,threads:_.READWRITE},"restoreWriteReactionsToDb",function(e){return(function(t){return o("MAWBulkWriteReactionsTxns").prepareReactionsData(e,t).then(function(t){return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(e,t)})})});function y(t,n){var r=t.get(n.externalId);return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] echo document is absent for a restored msg"]))),!1):o("WAJids").isAuthorSystem(n.author)?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions for system author"]))),!1):o("MAWAuthor").getAuthorUserJid(n.author)==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot have reactions empty author"]))),!1):!0}function C(e){return e.reactions!=null&&e.reactions.length!==0&&e.reactionXOfflineThreadingIds!=null&&e.reactionXOfflineThreadingIds.length!==0&&e.reactionAuthoritativeTimestampMs!=null&&e.reactionAuthoritativeTimestampMs.length!==0}function b(e,t,n){return(e==null?void 0:e.length)===0?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction string is not a single character"]))),!1):t==null?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction external id missing"]))),!1):n==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reactToAuthor field is null"]))),!1):!0}function v(e,t,n){return(e||[]).map(function(e,r){return n==null||t==null||(n==null?void 0:n.length)<=r||(t==null?void 0:t.length)<=r?(o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] reaction fields in backup data uneven in length"]))),[]):[e,t[r],n[r]]})}function S(e,t,n,r,a,i){var l=o("MAWAuthor").getAuthorUserJid(a);if(i==null||l==null)return[];var s=i.reactionAuthoritativeTimestampMs,u=s===void 0?[]:s,c=i.reactionXOfflineThreadingIds,d=c===void 0?[]:c,m=i.reactions;return v(m,d,u).filter(function(e){var t=e[0],n=e[1];return n!=null&&b(t.displayName,n.displayName,o("MAWAuthor").getAuthorUserJid(a))}).map(function(a){var i=a[0],s=a[1],u=a[2],c=i.displayName,d=o("MAWHandleEchoMsgsRestoreApiUtils").resolveAuthorFromEchoAddress(i,t),m={ack:d===o("WAJids").AUTHOR_ME?o("MAWAckLevel").ACK.sent:o("MAWAckLevel").ACK.received,author:d,externalId:o("WAStanzaUtils").toStanzaId(s.displayName||""),groupingKey:c,reaction:c,reactToAuthor:l,reactToExternalId:n,senderTimestampMs:null,threadJid:e,ts:o("WATimeUtils").castToUnixTime(Number(u.displayName)/1e3)};return r!=null?babelHelpers.extends({},m,{reactToMsgId:r}):m})}l.writeEchoReactionsToReactionsStore=g,l.getReactionsForReactionStore=S}),98);
__d("MAWHandleEchoXMARestoreV2",["EchoMessage","MAWBridge","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMediaTxns","MAWDbMsg","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWODSProxy","MAWParseXMAProtocol","MAWTransactionMode","WAArmadilloXMA.pb","WAHashUtils","WALogger","WAMediaUtils","WAOdsEnums","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=function(t,n,r){n==null||n.addPoint("xma_restore_start");var e=t.restoredMsgsData;if(e){var a=e.newlyAddedMsgs,i=a.concat(e.existingMsgs),l=[];return i.map(function(e){var n=e.externalId,r=t.echoMsgMap.get(n);r!=null&&r.contentType===o("EchoMessage").EchoMessageContentType.XMA&&l.push(e)}),l.length===0?Promise.resolve():y(l,t.echoMsgMap,r).then(function(e){return n==null||n.addPoint("xma_restore_end",{int:{xma:e.length}}),Promise.resolve()})}return n==null||n.addPoint("xma_restore_end",{int:{xma:0}}),Promise.resolve()};function y(t,n,r){var a=new Map,i=new Map;t.forEach(function(e){var t,r,l=n.get(e.externalId),s=l==null||(t=l.mediaData)==null?void 0:t.attachmentObjectId;s!=null&&a.set(o("WAMediaUtils").stringToDeliveryObjectId(s),e);var u=l==null||(r=l.mediaData)==null?void 0:r.plaintextHash;if(u!=null){var c=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(u)),d=i.get(c);i.set(c,d!=null?[].concat(d,[e.msgId]):[e.msgId])}});var l=Array.from(a.keys()),u=new Map;return C(i).then(function(i){var c=[];return l.forEach(function(e){var t,n=(t=a.get(e))==null?void 0:t.externalId;n!=null&&u.set(n,e)}),t.filter(function(e){return o("MAWDbMsg").isXMAMsg(e)}).forEach(function(t){var r=n.get(t.externalId);if(r){var a=u.get(t.externalId),l;if(a!=null){var d=i.get(a);d!=null&&(l=d.mediaId)}var m=r.serializationOrigin;m==null&&(m=o("EchoMessage").EchoSerializationOriginType.UNKNOWN);var p=v(t,r,l,m);p==null?o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] dbXMA is null. EchoMessage origin ",""])),m):(p.targetType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE&&t.msgContent==null&&(o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] msgContent is null for external link share XMA on Restore. Echo message origin ",""])),m),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"missing_msg_content_external_link_xma"})),c.push(p))}}),b(c).then(function(e){return e.length>0&&e.map(async function(e){var t=u.get(e.externalId);if(r!==!0){var n;t!=null&&(n=i.get(t));var a=await o("MAWHandleXmaTransactionUtil").checkMediaChunkTransactionAndCreatedBridgeXma(n,e);o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"NewXMA",value:a}]})}}),e})})}var C=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY,mediaBackup:o("MAWTransactionMode").READONLY},"restoreGetMediaForXMAByObjectIds",function(e){return function(t){var n=Array.from(t.keys());return o("MAWDbMediaTxns").maybeBulkGetMediaFromPlaintextHash(e,n).then(function(e){var n=new Map;return e.forEach(function(e){var r=t.get(e.plaintextHash);r==null||r.forEach(function(t){var r=e==null?void 0:e.mediaEntries.get(t);if(e!=null&&r!=null){var a=o("WAMediaUtils").decodeMediaEntryData(r);a.objectId!=null&&n.set(o("WAMediaUtils").stringToDeliveryObjectId(a.objectId),e)}else o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][getMediaForXMAByObjectIds] mediaEntry is null for media restore"])))})}),n})}}),b=o("MAWIndexedDb").makeMsgrTransactor({xma:o("MAWTransactionMode").READWRITE},"restoreWriteXMAsToDb",function(e){return function(t){return e.xma.bulkAdd(t,{allKeys:!0}).then(function(e){return e.map(function(e,n){return babelHelpers.extends({},t[n],{xmaId:e})})})}});function v(e,t,n,r){var a,i,l,s,u,h,y,C,b,v,R,L,E,k,I,T;if(t.xmaData==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaData is missing in the echo doc. Echo message origin ",""])),r),null;var D;if(t.xmaData.xmaDefaultCTA!=null){var x;D=S((x=t.xmaData)==null?void 0:x.xmaDefaultCTA)}else o("WALogger").WARN(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaDefaultCTA field is not present in the echo doc. Echo message origin ",""])),r);var $;if(((a=t.xmaData)==null?void 0:a.xmaTargetType)!=null)$=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(t.xmaData.xmaTargetType);else return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaTargetType field is not present in the echo doc. Echo message origin ",""])),r),null;var P;((i=t.xmaData)==null?void 0:i.xmaGatingType)!=null?P=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(t.xmaData.xmaGatingType):o("WALogger").WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaGatingType field is not present in the echo doc. Echo message origin ",""])),r);var N;((l=t.xmaData)==null?void 0:l.xmaLayoutType)!=null?N=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(t.xmaData.xmaLayoutType):o("WALogger").WARN(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] xmaLayoutType field is not present in the echo doc. Echo message origin ",""])),r);var M;if(e.threadJid!=null)M=e.threadJid;else return o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] threadJid field is not present in the restoredMsg. Echo message origin ",""])),r),null;if(D!=null&&!o("MAWParseXMAProtocol").isValidCTA(D,$,!0))return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] invalid CTA observed while restoring XMA. Echo message origin ",""])),r),null;var w;return((s=t.xmaData)==null?void 0:s.xmaContentRef)!=null&&(w=t.xmaData.xmaContentRef),{author:e.author,contentRef:w,ctas:[],defaultCTA:D,defaultPreviewMediaId:n!=null?n:void 0,externalId:e.externalId,headerTitle:t==null||(u=t.xmaData)==null?void 0:u.xmaHeaderTitle,isTombstoned:t==null||(h=t.xmaData)==null?void 0:h.xmaIsTombstoned,maxSubtitleNumOfLines:t==null||(y=t.xmaData)==null?void 0:y.xmaMaxSubtitleNumLines,maxTitleNumOfLines:t==null||(C=t.xmaData)==null?void 0:C.xmaMaxTitleNumLines,msgId:e.msgId,overlayIconGlyph:P,overlayTitle:t==null||(b=t.xmaData)==null?void 0:b.xmaHeaderSubtitle,previewMediaIds:n!=null?[n]:[],subtitleText:t==null||(v=t.xmaData)==null?void 0:v.xmaSubtitleText,targetExpiringAtSec:((R=t.xmaData)==null?void 0:R.xmaTargetExpiry)!=null?o("WATimeUtils").castToUnixTime(Number((L=t.xmaData)==null?void 0:L.xmaTargetExpiry)):void 0,targetId:t==null||(E=t.xmaData)==null?void 0:E.xmaTargetId,targetType:$,targetUsername:t==null||(k=t.xmaData)==null?void 0:k.xmaTargetUsername,threadJid:M,titleText:(I=t.xmaData)==null?void 0:I.xmaTitleText,xmaDataclass:(T=t.xmaData)==null?void 0:T.xmaDataclass,xmaLayoutType:N}}function S(e){return{actionUrl:e,buttonType:o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_CTA_BUTTON_TYPE.OPEN_NATIVE,nativeUrl:e}}l.writeXMAToXMAStore=h,l.getMediaForXMAByObjectIds=C,l.writeXMAsToDb=b,l.getDefaultCTA=S}),98);
__d("MessageBackupSupplementalKeyGenerator",["$InternalEnum","MAWJids","WAGlobals","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({REACTION:"reaction",EDIT:"edit",RAVEN_ACTION_MESSAGE:"raven_action_message"}),s=":";function u(e,t){return""+e+s+t}function c(e){return e.split(s)[1]}function d(e,t){var n=t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),r=new RegExp("^"+n,"i");return r.test(e)}function m(t){return d(t,e.REACTION)}function p(t){return d(t,e.EDIT)}function _(t){return d(t,e.RAVEN_ACTION_MESSAGE)}function f(t){var n=t.split(s);if(n.length===1)return{rawIdentifierString:t,type:"poll_update"};var r=n[0];if(n.length<2||n.length>3)return{prefix:r,rawIdentifierString:t,type:"unknown"};var a=n[1],i=o("MAWJids").toUserJid(a);if(r===e.REACTION)return{senderJid:i,type:"reaction"};var l=n.length===3?o("WATimeUtils").castToMillisTime(Number(n[2])):null;return r===e.RAVEN_ACTION_MESSAGE?{senderJid:i,type:"raven_action_message"}:l==null?{prefix:r,rawIdentifierString:t,type:"unknown"}:r===e.EDIT?{senderJid:i,ts:l,type:"edit"}:{prefix:r,rawIdentifierString:t,type:"unknown"}}function g(t){switch(t.type){case"edit":return""+e.EDIT+s+o("WAJids").extractUserId(t.senderJid)+s+t.ts.toString();case"reaction":return""+e.REACTION+s+o("WAJids").extractUserId(t.senderJid);case"raven_action_message":return""+e.RAVEN_ACTION_MESSAGE+s+o("WAJids").extractUserId(t.senderJid);case"poll_update":return t.rawIdentifierString}}function h(t){var n;if(o("WAJids").isAuthorMe(t))n=o("WAGlobals").getMyUserJid();else{var r=o("WAJids").interpretAndValidateJid(t);if(r.jidType==="msgrUser")n=r.userJid;else return null}var a=o("WAJids").userIdFromJid(n);return""+e.REACTION+s+a}function y(t,n){var r;if(o("WAJids").isAuthorMe(t))r=o("WAGlobals").getMyUserJid();else{var a=o("WAJids").interpretAndValidateJid(t);if(a.jidType==="msgrUser")r=a.userJid;else return null}var i=o("WAJids").userIdFromJid(r);return""+e.EDIT+s+i+s+n.toString()}l.SupplementalKeyPrefix=e,l.SUPPLEMENTAL_KEY_DELIMITER=s,l.createMessageSupplementalKey_DEPRECATED=u,l.getSupplementalSenderId_DEPRECATED=c,l.isSupplementalProtobufAReaction=m,l.isSupplementalProtobufAnEdit=p,l.isSupplementalProtobufARavenAction=_,l.parseIdentifierString=f,l.toIdentifierString=g,l.createReactionSupplementalKey=h,l.createEditSupplementalKey=y}),98);
__d("PersistedQueuesSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";var e={autoIncrement:!0,indexes:{"[jid+priority+stanzaId]":{fields:["jid","priority","stanzaId"],unique:!1},priority:{fields:["priority"],unique:!1}},nonEncryptedFields:["priority","stanzaId"],primaryKey:"stanzaQueueId",secure:!0},s={autoIncrement:!0,indexes:{},nonEncryptedFields:["uploadStatus","uploadTsSec","backupActionType"],primaryKey:"queueId",secure:!0},u={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},c={autoIncrement:!0,indexes:{},primaryKey:"queueId",secure:!0},d={danglingQueue:u,ebSenderUploadQueueV3:c,ebUploadQueue:s,stanzaQueue:e};function m(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="pqdb",u=new(o("WormEAR")).WormEAR(d,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,d,u,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.makePersistedQueueSchema=m}),98);
__d("PersistedQueueDB",["FBLogger","PersistedQueuesSchema","WAResolvable","WormEAR","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s=new(o("WAResolvable")).Resolvable;async function u(t){var n=t.blockingErrorThreshold,a=t.dbName,i=t.onBlockingError,l=t.qplEvent,u=t.strEncKey;try{var c=o("PersistedQueuesSchema").makePersistedQueueSchema(a,u,n,i,function(t){if(t instanceof o("WormEAR").DecryptionError){var n,a,i=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",i.store),r("promiseDone")((n=(a=e)==null?void 0:a.runInTransaction([i.store],"readwrite",function(e){var t=e.stores[i.store];return i.maybeHashedPk!=null?t.delete(i.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?n:Promise.resolve())}},l);return e=c,await c.init(),s.resolve(c),c}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing PersistedQueue init"),e}}function c(){if(e==null)throw r("err")("PersistedQueue is not initialized");return e}function d(){return s.promise}l.makePersistedQueues=u,l.getPersistedQueues=c,l.getDbPromise=d}),98);
__d("WAThrottle",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){var n=0,r=null,o;function a(){for(var a=Date.now(),i=a-n,l=arguments.length,s=new Array(l),u=0;u<l;u++)s[u]=arguments[u];o=s,i>=t?(clearTimeout(r),r=null,e.apply(void 0,s),n=Date.now()):r==null&&(r=setTimeout(function(){return e.apply(void 0,o)},t-i))}return a}i.throttle=e}),66);
__d("PersistedQueueApi",["PersistedQueueDB","WALogger","WAThrottle"],(function(t,n,r,o,a,i,l){"use strict";var e,s=36e5,u=function(t,n){return"PersistedQueue:"+t+":"+n};function c(){return{ack:p,clear:_,count:b,delete:f,get:d,index:m,keys:h,read:g,write:y}}function d(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){var r=n.stores[e];return r.get(t)},u(e,"get"))}function m(e,t){return{equals:function(r){return{read:function(a){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexRange(t,{only:r},a)},u(e,"index-equal"))}}},keys:function(){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndexKeys(t)},"index-keys")},read:async function(r){var n=await o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readIndex(t,void 0,r)},u(e,"index-read"));return n}}}function p(e,t){return f(e,t)}function _(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(t){return t.stores[e].clear()},u(e,"clear"))}function f(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(n){var r=n.stores[e];await r.bulkDelete(t),v(e)},u(e,"delete"))}function g(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(n){return n.stores[e].readAll(t)},u(e,"read"))}function h(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].readKeys()},u(e,"keys"))}function y(e,t){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",function(n){return n.stores[e].bulkAdd(t)},u(e,"write"))}function C(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readwrite",async function(t){var n=t.stores[e],r=await n.readAll({limit:1});r.length===0&&await n.clear()},u(e,"ClearIfEmpty"))}function b(e){return o("PersistedQueueDB").getPersistedQueues().runInTransaction([e],"readonly",function(t){return t.stores[e].count()},u(e,"count"))}var v=o("WAThrottle").throttle(function(t){C(t).catch(function(n){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueueV2] Error during PQ clear operation of ",": ",""])),t,n)})},s);l.persistedQueueApi=c,l.persistedQueueGet=d,l.persistedQueueIndex=m,l.persistedQueueAck=p,l.persistedQueueClear=_,l.persistedQueueDelete=f,l.persistedQueueRead=g,l.persistedQueueKeys=h,l.persistedQueueWrite=y,l.clearIfEmpty=C,l.persistedQueueCount=b}),98);
__d("WAMapContentTypeToFbType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"text":return"text";case"media":return"media";case"reaction":return"reaction";case"live_location":case"pay":case"product_list":case"poll_creation":case"poll_vote":case"scheduled_call":return"text";default:return"text"}}i.mapContentTypeToFbType=e}),66);
__d("WAPersistedQueueCache",["WAResolvable","WAShiftTimer","WATagsLogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("WATagsLogger").TAGS(["PersistedQueue",t,"cache"]),i=[],l=new(o("WAResolvable")).Resolvable,s=r!=null?r:{},u=new(o("WAShiftTimer")).ShiftTimer(function(){m()});return{commit:function(){return m()},add:function(t){i.push(t);var e=l;return c(),d(),e.promise},config:function(t){s=t}};function c(){s.cacheSize!=null&&i.length>=s.cacheSize&&m()}function d(){if(s.maxDelay!=null){var e=s.maxDelay;u.cancel(),u.onOrAfter(e)}}async function m(){if(i.length!==0){u.cancel();var t=i;i=[];var r=l;l=new(o("WAResolvable")).Resolvable;try{await n(t),r.resolve()}catch(t){throw a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during flush: ",""])),t),r.reject(t),t}}}}l.makePersistedQueueCache=s}),98);
__d("WAPersistedQueue",["WALogger","WAPersistedQueueCache","WAPubSub"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=(function(){function t(t,n,r){var a=this;this.$1=o("WAPubSub").simplePubSub(),this.$3=t,this.$4=n,this.$2=o("WAPersistedQueueCache").makePersistedQueueCache(t,function(r){return n.write(t,r).then(function(t){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),r.length),a.$1.publish({type:"flush"})})},r)}var n=t.prototype;return n.subscribe=function(t){return this.$1.subscribe(t)},n.index=function(e){return this.$4.index(this.$3,e)},n.keys=function(){return this.$4.keys(this.$3)},n.get=function(t){return this.$4.get(this.$3,t)},n.read=function(t){return this.$4.read(this.$3,t)},n.addAndCommit=function(t){var e=this;return o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] new entry & commit"]))),this.$1.publish({type:"new_entity"}),this.$4.write(this.$3,t).then(function(n){return o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[PersistedQueue] flush: ","}"])),t.length),e.$1.publish({type:"flush"}),n})},n.commit=function(){return this.$2.commit()},n.ack=function(t){return this.$4.ack(this.$3,t)},n.delete=function(t){return this.$4.delete(this.$3,t)},n.clear=function(){return this.$4.clear(this.$3)},n.count=function(){return this.$4.count(this.$3)},t})();function d(e,t,n){return new c(e,t,n)}l.PersistedQueue=c,l.initPersistedQueue=d}),98);
__d("WAProtocolQueue",["PersistedQueueApi","WAGlobals","WAJids","WALogger","WAMapContentTypeToFbType","WAPersistedQueue"],(function(t,n,r,o,a,i,l){"use strict";var e,s=5e3,u=null;function c(t){if(u!=null)return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Protocol Queue is already initialized"]))),u;var n=o("WAPersistedQueue").initPersistedQueue("stanzaQueue",t,{cacheSize:null,maxDelay:s});return u=n,u}function d(){return u||c(o("PersistedQueueApi").persistedQueueApi())}var m=(function(){function e(){this.$1=[],this.$2=[],this.$3=[]}var t=e.prototype;return t.enqueue=function(t,n,r){this.$1.push(t),n&&this.$2.push(n),r&&this.$3.push(r)},t.flush=function(t,n,r,o,a){var e=this.$1,i=this.$2,l=this.$3;return this.$1=[],this.$2=[],this.$3=[],d().addAndCommit(e).then(function(){return i.forEach(function(e){return e()})}).catch(function(e){return l.forEach(function(t){return t(e)})})},e})(),p=new m;function _(e){return e.map(function(e){return e.type==="message"?f(e):babelHelpers.extends({},e)})}function f(e){switch(e.subtype){case"unavailable":{var t=e,n=o("WAJids").extractUserJid(t.from),r={id:{author:o("WAGlobals").getMyUserJid()===n?"@me":n,chat:t.jid,externalId:t.stanzaId},ts:t.serverTs,type:"UnavailableMsg"};return{incomingType:"wa-incoming",jid:t.jid,message:{decrypted:r,details:{count:null,externalId:t.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(n){return{author:t.from,chat:n,groupJid:n,type:"group"}},user:function(n){return{author:t.from,chat:n,deviceJid:t.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:t.offline,recipient:t.recipient,reportingMeta:t.reportingMeta,retryCount:t.retryCount,ts:t.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(t.contentType)}},priority:t.priority,stanzaId:t.stanzaId,stanzaQueueId:e.stanzaQueueId,type:t.type}}case"armadillo":{var a=e,i=o("WAJids").extractUserJid(a.from),l={folder:a.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===i?"@me":i,chat:a.jid,externalId:a.stanzaId},msg:a.message,recipientsCount:null,reportingMeta:a.reportingMeta,ts:a.serverTs,type:"IncomingMsg"};return{incomingType:e.incomingType,jid:a.jid,message:{decrypted:l,details:{count:null,externalId:a.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(a.jid,{group:function(t){return{author:a.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:a.from,chat:t,deviceJid:a.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:a.offline,recipient:a.recipient,reportingMeta:a.reportingMeta,retryCount:a.retryCount,ts:a.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(a.contentType)}},priority:a.priority,stanzaId:a.stanzaId,stanzaQueueId:e.stanzaQueueId,type:a.type,ebTimestampMs:a.ebTimestampMs}}case"instamadillo":{var s=e,u=o("WAJids").extractUserJid(s.from),c={folder:s.fbFolderId,id:{author:o("WAGlobals").getMyUserJid()===u?"@me":u,chat:s.jid,externalId:s.stanzaId},msg:s.message,recipientsCount:null,reportingMeta:s.reportingMeta,ts:s.serverTs,type:"InstamadilloMsg"};return{incomingType:"wa-incoming",jid:s.jid,message:{decrypted:c,details:{count:null,externalId:s.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(s.jid,{group:function(t){return{author:s.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:s.from,chat:t,deviceJid:s.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!0,offline:s.offline,recipient:s.recipient,reportingMeta:s.reportingMeta,retryCount:s.retryCount,ts:s.serverTs,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(s.contentType)}},priority:s.priority,stanzaId:s.stanzaId,stanzaQueueId:e.stanzaQueueId,type:s.type}}case"ciphertext":{var d=function(){return!(m.contentType==="reaction"||m.hideDecryptionFailure===!0)},m=e,p=o("WAJids").extractUserJid(m.from),_={createPlaceholder:d(),id:{author:o("WAGlobals").getMyUserJid()===p?"@me":p,chat:m.jid,externalId:m.stanzaId},ts:m.serverTs,type:"IncomingCiphertextMsg"};return{incomingType:"wa-incoming",jid:m.jid,message:{decrypted:_,details:{count:null,type:o("WAMapContentTypeToFbType").mapContentTypeToFbType(m.contentType),externalId:m.stanzaId,from:o("WAJids").switchOnMsgrChatJidType(m.jid,{group:function(t){return{author:m.from,chat:t,groupJid:t,type:"group"}},user:function(t){return{author:m.from,chat:t,deviceJid:m.from,type:"device"}}}),hideDecryptionFailure:!1,isInstamadillo:!1,offline:m.offline,recipient:m.recipient,reportingMeta:m.reportingMeta,retryCount:m.retryCount,ts:m.serverTs}},priority:m.priority,stanzaId:m.stanzaId,stanzaQueueId:e.stanzaQueueId,type:m.type}}default:return babelHelpers.extends({},e)}}var g=9,h=7,y=5,C=2;function b(e){return e}function v(e){return e}function S(e){return e}l.initProtocolQueue=c,l.protocolQueue=d,l.PQFlushable=m,l.pqFlushable=p,l.mapProtocolEntriesV2toV1=_,l.mapProcolQueueMessageV2toV1=f,l.WAProtocolQueuePriorityHigh=g,l.WAProtocolQueuePriorityMid=h,l.WAProtocolQueuePriorityLow=y,l.WAProtocolQueuePriorityBackground=C,l.appdataApplicationProtocol=b,l.extractSubProtocolFromAppdataProtocol=v,l.numberToStanzaQueueId=S}),98);
__d("MAWHandleEBRestoreWithHIM",["EBAPIWorkerCheck","EchoMessage","EncryptedBackupsUploadEntity","FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWBulkEditMsgsTxns","MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph","MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType","MAWConvertXMATargetTypeToExtendedContentTargetType","MAWDbMsg","MAWEchoToProtobufConversionLoggingUtils","MAWFrontendMediaUtils","MAWHandleEchoMediaMsgsRestoreV2","MAWHandleEchoMsgsRestoreApiUtils","MAWHandleEchoReactionsRestore","MAWHandleEchoXMARestoreV2","MAWJids","MAWMsgType","MAWODSProxy","MAWParseXMAProtocol","MAWUnsafeCoerce","MAWUserJidWrapper","MessageBackupSupplementalKeyGenerator","MpsTags","Random","WAGlobals","WAHashUtils","WAJids","WALogger","WALongInt","WAOdsEnums","WAProtocolQueue","WAResultOrError","WASortedLists","WAStanzaUtils","WATimeUtils","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e=["originalTs","threadJid","unsendMsgContentDeleteTs"],s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k;function I(e,t){return e==="@me"||e==="@system"?t:e}function T(e,t,n,r,a){var i=[];if(e.reactionXOfflineThreadingIds!=null)for(var l=0;l<e.reactionXOfflineThreadingIds.length;++l){var s=o("MAWHandleEchoReactionsRestore").getReactionsForReactionStore(t,n,r,null,a,e),u=s.map(function(e){return{decodedMsg:{unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:e,unstoredDbReceiverFetchInfo:void 0},stanza:P(e.externalId,e.ts,I(e.author,n),t,"reaction")}});i.push.apply(i,u)}return i}function D(e,t,n,r,a){return r.map(function(r){if(r.messageId==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] messageId is null in edit, original externalId: ",""])),e),a!=null&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(a,"getUnstoredDbEditsFromEcho_messageId_missing"),null;var i=r.messageId;return{decodedMsg:{unstoredDbEditActionMsg:{ack:o("MAWAckLevel").ACK.sent,author:n,editMsgContent:{content:r.text},externalId:o("WAStanzaUtils").toStanzaId(i),originalMsgExternalId:e,serverTs:o("WATimeUtils").castToUnixTime(r.timestamp),ts:o("WATimeUtils").castToUnixTime(r.timestamp),type:o("MAWMsgType").MSG_TYPE.EDIT_ACTION},unstoredDbMedia:void 0,unstoredDbMsg:void 0,unstoredDbReaction:void 0},stanza:P(o("WAStanzaUtils").toStanzaId(i),o("WATimeUtils").castToUnixTime(r.timestamp),n,t,"text")}}).filter(Boolean)}function x(e,t){return e.map(F).filter(Boolean).map(function(e){return $(e,t)})}function $(e,t){var n,a=o("MAWUserJidWrapper").getMyUserJid(),i=e.from,l=o("MAWHandleEchoMsgsRestoreApiUtils").getDbMsgTypeFromEchoMessage(e);if(i==null||l==null)return[];var s=e.xOfflineThreadingId;if(s==null)return r("FBLogger")("wmi_eb").warn("xOfflineThreadingId is null for Echo message"),[];var u=o("WAStanzaUtils").toStanzaId(s),c=o("WATimeUtils").castToUnixTime(((n=e.authoritativeTimestampMs)!=null?n:e.sortOrderMs)/1e3),d=o("MAWJids").toUserJid(i.localKey),m=A(e,t,a,u,"echo_content");if(m.success===!1)return[];var p=m.value,_=T(e,t,a,u,d),f=e.contentType===o("EchoMessage").EchoMessageContentType.TEXT||e.contentType===o("EchoMessage").EchoMessageContentType.PLACEHOLDER?"text":"media",g=D(u,t,d,e.editHistory);return[{decodedMsg:p,stanza:P(u,c,d,t,f)}].concat(_,g)}function P(e,t,n,r,a){var i={applicationPayload:new Uint8Array(0).buffer,backupDirective:null,icdc:null,metadata:null,protobuf:new Uint8Array(0),subprotocol:new Uint8Array(0),subprotocolType:"consumerMessage",type:"subprotocol",version:"v3"},l={folder:null,id:{author:n,chat:r,externalId:e},msg:i,recipientsCount:null,reportingMeta:null,ts:t,type:"IncomingMsg"};return{incomingType:"ebrestore",jid:r,message:{decrypted:l,details:{count:0,externalId:e,from:o("WAJids").switchOnMsgrChatJidType(r,{group:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,groupJid:t,type:"group"}},user:function(t){return{author:o("WAJids").defaultDeviceJidForUser(n),chat:t,deviceJid:o("WAJids").defaultDeviceJidForUser(n),type:"device"}}}),hideDecryptionFailure:!0,isInstamadillo:!1,offline:null,recipient:null,reportingMeta:null,retryCount:0,ts:t,type:a}},priority:o("WAProtocolQueue").WAProtocolQueuePriorityLow,stanzaId:e,stanzaQueueId:o("MAWUnsafeCoerce").unsafeCoerce(-1),type:"message"}}function N(e){if(e.mediaData==null)return o("WAResultOrError").makeResult(null);var t=e.previewMediaData,n=e.sortOrderMs,r=e.xOfflineThreadingId,a=e.mediaData,i=a.attachmentObjectId,l=a.backupEntFbid,s=a.directPath,d=a.encryptedHash,m=a.filename,p=a.height,_=a.mediaContentType,f=a.mediaKey,g=a.mediaKeyTimestamp,h=a.mediaPlayableDuration,y=a.plaintextHash,C=a.previewContentHeight,b=a.previewContentWidth,v=a.size,S=a.width,R=e.contentType===o("EchoMessage").EchoMessageContentType.XMA,L=o("MAWFrontendMediaUtils").getMediaTypeAndServerMediaTypeFromBlob(_||"",R),E=L.mediaType,k=L.serverMediaType,I=o("WAHashUtils").stringToPlaintextHash(o("MAWHandleEchoMediaMsgsRestoreV2").getBase64WithoutPadding(y)),T=null;if(t!=null)try{T=o("MAWHandleEchoMediaMsgsRestoreV2").constructRawDownloadableThumbnail(t),T!=null&&T.objectId==null&&o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] downloadableThumbnail was created without metadata, source: protobuf"])))}catch(t){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unable to construct downloadableThumbnail from previewMediaData: ",", msg id: ",". Echo message origin ",""])),t,r,e.serializationOrigin)}if(f==null)return o("WAResultOrError").makeError("missing_media_key");if(d==null)return o("WAResultOrError").makeError("missing_encrypted_hash");var D=o("MAWHandleEchoMediaMsgsRestoreV2").constructMediaEntry(I,d,f,s,g,k,m,l,i,T,v),x=o("MAWHandleEchoMediaMsgsRestoreV2").getMediaInfo({filename:m,height:p,mediaPlayableDuration:h,mediaType:E,previewContentHeight:C,previewContentWidth:b,width:S}),$=x.validatedAudioInfo,P=x.validatedDocumentFileInfo,N=x.validatedImageInfo,M=x.validatedVideoInfo;return o("WAResultOrError").makeResult({mediaEntry:D,mediaType:E,msgIds:o("WASortedLists").asSortedSet(new Set),plaintextHash:o("WAHashUtils").stringToPlaintextHash(y),size:v||0,ts:g!=null?o("WATimeUtils").castToUnixTime(g):o("WATimeUtils").castMilliSecondsToUnixTime(n),validatedAudioInfo:$,validatedDocumentFileInfo:P,validatedImageInfo:N,validatedVideoInfo:M})}function M(e,t){if(e.xmaData==null||e.from==null||e.xOfflineThreadingId==null)return o("WAResultOrError").makeResult(null);var n=e.from,r=e.serializationOrigin,a=e.xmaData,i=e.xOfflineThreadingId,l=a.xmaContentRef,s=a.xmaDataclass,u=a.xmaDefaultCTA,c=a.xmaGatingType,p=a.xmaHeaderSubtitle,_=a.xmaHeaderTitle,f=a.xmaIsTombstoned,g=a.xmaLayoutType,h=a.xmaMaxSubtitleNumLines,y=a.xmaMaxTitleNumLines,C=a.xmaSubtitleText,b=a.xmaTargetExpiry,v=a.xmaTargetId,S=a.xmaTargetType,R=a.xmaTargetUsername,L=a.xmaTitleText;if(S==null)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Mandatory XMA Data missing for XMA message. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_mandatory_fields_missing");var E=o("MAWConvertXMATargetTypeToExtendedContentTargetType").convertXMATargetTypeToExtendedContentTargetType(S),k;if(u!=null&&(k=o("MAWHandleEchoXMARestoreV2").getDefaultCTA(u)),k!=null&&!o("MAWParseXMAProtocol").isValidCTA(k,E,!0))return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] defautlCTA failed validation check. Echo message origin ",""])),r),o("WAResultOrError").makeError("xma_cta_validation_failure");var I;c!=null&&(I=o("MAWConvertXMAGatingTypeToExtendedContentOverlayIconGlyph").convertXMAGatingTypeToExtendedContentOverlayIconGlyph(c));var T;b!=null&&(T=o("WATimeUtils").castToUnixTime(b));var D;return g!=null&&(D=o("MAWConvertXMALayoutTypeToExtendedContentXMLLayoutType").convertXMALayoutTypeToExtendedContentXMLLayoutType(g)),o("WAResultOrError").makeResult({unstoredDbXMA:{author:o("MAWJids").toUserJid(n.localKey),contentRef:l,ctas:[],defaultCTA:k,externalId:o("WAStanzaUtils").toStanzaId(i),headerTitle:_,isTombstoned:f,maxSubtitleNumOfLines:h,maxTitleNumOfLines:y,overlayDescription:p,overlayIconGlyph:I,overlayTitle:_,subtitleText:C,targetExpiringAtSec:T,targetId:v,targetType:E,targetUsername:R,threadJid:t,titleText:L,xmaDataclass:s,xmaLayoutType:D}})}function w(e){if(e.receiverFetchId==null||e.receiverFetchData==null)return o("WAResultOrError").makeResult(null);var t=e.receiverFetchData,n=e.receiverFetchId;return t.type!=="sticker"?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Unsupported receiver fetch message type: ",". Echo message origin ",""])),t.type,e.serializationOrigin),o("WAResultOrError").makeError("unsupported_message_type")):o("WAResultOrError").makeResult({mimetype:t.mimetype,previewHeight:t.previewHeight,previewWidth:t.previewWidth,receiverFetchId:n,type:t.type})}function A(t,n,r,a,i){var l=o("MAWHandleEchoMsgsRestoreApiUtils").getUnstoredDbMessageFromEchoMessage(t,n,r,a,void 0,i);if(l.success===!1)return o("WAResultOrError").makeError(l.error);var s=l.value,u=s.originalTs,c=s.threadJid,d=s.unsendMsgContentDeleteTs,m=babelHelpers.objectWithoutPropertiesLoose(s,e);m.sortOrderMs=t.sortOrderMs;var p=N(t);if(p.success===!1)return p;var _=M(t,n);if(_.success===!1)return o("WAResultOrError").makeError(_.error);var f=_.value,g=w(t);if(g.success===!1)return o("WAResultOrError").makeError(g.error);var h=g.value;return o("WAResultOrError").makeResult({unstoredDbMedia:p.value,unstoredDbMsg:m,unstoredDbReaction:void 0,unstoredDbReceiverFetchInfo:h!=null?h:void 0,unstoredXMA:f!=null?f:void 0})}function F(e){try{return o("EchoMessage").decodeEchoMessage(e)}catch(e){return o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decode echo message: ",""])),e),null}}function O(e,t){if(!o("EBAPIWorkerCheck").runningInWorker())throw r("FBLogger")("messenger_web").mustfixThrow("convertEchoMessagesToEBProtobufs should be called from the worker thread");var n=e.map(function(e){return B(e,t)}).filter(Boolean);return o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.success"}),n.length!==e.length&&(o("WALogger").WARN(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to convert all echo messages to protobuf. Chat: ",", echo messages count: ",", converted echo messages count: ",""])),t,e.length,n.length),o("MAWODSProxy").odsBumpEntityKey({amount:e.length-n.length,entity:o("WAOdsEnums").Entity.EB_RESTORE,key:"echo2protobuf.fail"})),n}function B(e,t){var n=r("Random").uint32();o("MAWEchoToProtobufConversionLoggingUtils").startQplUserFlow(n);var a=F(e);if(a==null)return o("WALogger").ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to decode echo message"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_decode_failure"),null;var i=o("WAGlobals").getMyUserJid(),l=a.from,s=a.sortOrderMs,u=a.xOfflineThreadingId,c=o("WATimeUtils").castToMillisTime(s);if(u==null||l==null)return o("WALogger").ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] One of the mandatory fields is null for Echo message. Echo message origin ",""])),a.serializationOrigin),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"mandatory_fields_missing"),null;var d=o("MAWJids").toUserJid(l.localKey),m=o("WAStanzaUtils").toStanzaId(u),p=A(a,t,i,m,"first_edit_content");if(p.success===!1)return o("WALogger").ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: ",""])),p.error),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"echo_message_parsing_failure_"+p.error),null;if(p.value.unstoredDbMsg==null)return o("WALogger").ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to extract UnstoredDbMsg from EchoMessage: unstoredDbMsg missing in UnstoredDbContent"]))),o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"unstoredDbMsg_conversion_failure_unstoredDbMsg_missing"),null;var _=p.value,f=_.unstoredDbMedia,I=_.unstoredDbMsg,x=_.unstoredDbReceiverFetchInfo,$=_.unstoredXMA,P={author:d,chat:t,externalId:m};I!=null&&(I.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),($==null?void 0:$.unstoredDbXMA)!=null&&($.unstoredDbXMA.msgId=o("MAWDbMsg").stanzaIdToMsgId(m)),f!=null&&(f.msgIds=o("WASortedLists").asSortedSet(new Set([o("MAWDbMsg").stanzaIdToMsgId(m)])));var N;($==null?void 0:$.unstoredDbXMA)!=null&&(N={associatedMessage:null,defaultPreview:f!=null?f:null,favicon:null,header:f!=null?f:null,previews:f!=null?[f]:null,xma:$.unstoredDbXMA});var M={frankingKey:null,frankingTag:null,frankingVersion:null,reportingContent:null,reportingTag:null},w;try{w={decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeMessageApplication(I,f,null,N,t,r("justknobx")._("3632")?x:null),msgId:P,reportingMeta:M,sortOrderMs:c})),protobufTimestampMS:c}}catch(e){return o("MAWEchoToProtobufConversionLoggingUtils").endFailure(n,"top_level_protobuf_encoding_failure"),o("WALogger").ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Exception when trying to encode top-level protobuf: ",""])),e),null}var O=new Map,B=D(m,t,d,a.editHistory).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbEditActionMsg}).filter(Boolean).filter(function(e){return e.externalId!==e.originalMsgExternalId}).map(function(e){return o("MAWBulkEditMsgsTxns").getMessageHistory(e,t)});B.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_edits"),B.forEach(function(e){var r=e.author,a=e.editTs,i=o("MessageBackupSupplementalKeyGenerator").createEditSupplementalKey(r,o("WATimeUtils").castUnixTimeToMillisTime(a));if(i==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create edit supplemental key"])));return}if(e.editExternalId==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_key_generation_failure"),o("WALogger").ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to fetch edit external id"])));return}var l=e.editExternalId;try{O.set(i,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeEditMessageApplication(e),msgId:{author:d,chat:t,externalId:l},reportingMeta:M,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(e.editTs)})),protobufTimestampMS:o("WATimeUtils").castUnixTimeToMillisTime(a)})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"edit_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode edit supplemental protobuf: ",""])),e)}});var W=T(a,t,i,m,d).map(function(e){var t;return(t=e.decodedMsg)==null?void 0:t.unstoredDbReaction}).filter(Boolean);W.length>0&&o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"convert_reactions"),W.forEach(function(e){var r=e.author,a=e.senderTimestampMs,i=e.ts,l=a!=null?o("WATimeUtils").castToMillisTime(o("WALongInt").numberOrThrowIfTooLarge(a)):o("WATimeUtils").castUnixTimeToMillisTime(i),s=o("MessageBackupSupplementalKeyGenerator").createReactionSupplementalKey(r);if(s==null){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_key_generation_failure"),o("WALogger").ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web][echo2protobuf] Failed to create reaction supplemental key"])));return}try{O.set(s,{decryptedProtobuf:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(o("EncryptedBackupsUploadEntity").encodeBackupMessage({messageApplication:o("MAWAsMessageApplication").encodeReactionMessageApplication(e),msgId:{author:d,chat:t,externalId:e.externalId},reportingMeta:M,sortOrderMs:l})),protobufTimestampMS:l})}catch(e){o("MAWEchoToProtobufConversionLoggingUtils").addPoint(n,"reaction_supplemental_protobuf_encoding_failure"),o("WALogger").ERROR(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Exception when trying to encode reaction supplemental protobuf: ",""])),e)}}),o("MAWEchoToProtobufConversionLoggingUtils").endSuccess(n);var q;try{q=o("MpsTags").getTagFromProto(w.decryptedProtobuf)}catch(e){o("WALogger").ERROR(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to get tag from proto: ",""])),e)}return{otid:m,supplementalProtobufs:O,tags:q!=null?[q]:[],toplevelProtobuf:w}}l.convertEchoMessages=x,l.convertEchoMessagesToEBProtobufs=O}),98);
__d("MAWMediaPreviewDownloadManager",["WAResolvable"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=[],u=new Map;function c(e){if(!u.has(e)){_();var t=new(o("WAResolvable")).Resolvable;u.set(e,t),s.push(e)}}function d(e,t){var n=u.get(e);n!=null&&(n.reject(t),p(e))}function m(e){return u.get(e)}function p(e){u.delete(e)}function _(){if(s.length>=e){var t=s.shift();t!=null&&u.delete(t)}}function f(){s=[],u.clear()}l.markMediaPreviewAsDownloading=c,l.markMediaPreviewAsFailed=d,l.getMediaPreviewDownloadingResolvable=m,l.removeMediaPreviewDownloadingResolvable=p,l.clear=f}),98);
__d("MAWUnstoredQuotedMsgUtils",["FBLogger","MAWMsgType","WAJids","WAMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){if(e!=null){var t=e.content,n=e.remoteJid,a;switch(t.type){case o("MAWMsgType").MSG_TYPE.TEXT:a=u(t);break;case o("MAWMsgType").MSG_TYPE.IMAGE:a=c(t);break;case o("MAWMsgType").MSG_TYPE.VIDEO:a=d(t);break;case o("MAWMsgType").MSG_TYPE.PTT:a=m(t);break;case o("MAWMsgType").MSG_TYPE.GIF:a=p(t);break;case o("MAWMsgType").MSG_TYPE.STICKER:a=_(t);break;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:a=g(t);break;case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:a=h(t);break;case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:a=y(t);break;case o("WAMsgType").NOTE_REPLY:a=f(t);break;case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:a=C(t);break;default:throw t.type,r("FBLogger")("messenger_web").mustfixThrow("For flow")}return{content:a,remoteJid:n}}}function s(e){if(o("WAJids").isAuthorSystem(e.author))throw r("FBLogger")("messenger_web").mustfixThrow("A system message cannot be quoted");return{author:e.author,externalId:e.externalId,ts:e.ts}}function u(e){return babelHelpers.extends({},s(e),{msgContent:e.msgContent,type:o("MAWMsgType").MSG_TYPE.TEXT})}function c(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.IMAGE})}function d(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.VIDEO})}function m(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.PTT})}function p(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.GIF})}function _(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.STICKER})}function f(e){return babelHelpers.extends({},s(e),{expirationTs:e.expirationTs,msgContent:e.msgContent,type:o("WAMsgType").NOTE_REPLY})}function g(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function h(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE})}function y(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL})}function C(e){return babelHelpers.extends({},s(e),{type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}function b(t){return{quote:e(t.quote)}}l.getWithQuoteMsg=b}),98);
__d("MAWUnstoredTypedMsgUtils",["MAWAdminMsgType","MAWDbMsg","MAWMsgType","MAWRavenUtils","MAWUnstoredQuotedMsgUtils","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return{ack:e.ack,author:e.id.author,ebTimestampMs:e.ebTimestampMs,externalId:e.id.externalId,reportingMeta:e.reportingMeta,serverTs:e.serverTs,ts:e.ts}}function s(e){return{forwardingScore:e.forwardingScore,isForwarded:e.isForwarded}}function u(e){return{ephemeralSetting:c(e.ephemeralSetting),messageDeleteTs:e.deleteTs,messageExpirationTs:e.expirationTs}}function c(e){if(e!=null)return{ephemeralExpirationInSec:e.expirationTs,ephemeralLastUpdatedOrSetTimestamp:e.updatedTs}}function d(t,n){var r;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,collapsibleId:t.collapsibleId,isCollapsed:t.isCollapsed,msgContent:{commands:n.commands,content:(r=n.sentWithMessage)!=null?r:"",mentionedJids:n.mentionedJids},type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:n.targetType})}function m(t){return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,editCount:0,msgContent:t.msgContent,specialTextSize:t.specialTextSize,type:o("MAWMsgType").MSG_TYPE.TEXT})}function p(t){var n;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,plaintextHash:(n=t.mediaId)!=null?n:void 0,type:o("MAWMsgType").MSG_TYPE.IMAGE})}function _(t){return babelHelpers.extends({},e(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,ravenEphemeralMediaState:o("MAWRavenUtils").getEphemeralMediaState(t.ravenEphemeralMediaState),ravenEphemeralType:t.ravenEphemeralType,ravenMediaType:t.ravenMediaType,type:o("MAWMsgType").MSG_TYPE.RAVEN})}function f(t){var n;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,plaintextHash:(n=t.mediaId)!=null?n:void 0,type:o("MAWMsgType").MSG_TYPE.VIDEO})}function g(t){return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,type:o("MAWMsgType").MSG_TYPE.PTT})}function h(e){return{adminMsgContent:e.adminMsgContent,adminType:e.adminType}}function y(t){return babelHelpers.extends({},e(t),{altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,msgContent:h(t.msgContent),type:o("MAWMsgType").MSG_TYPE.ADMIN})}function C(t){var n;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,plaintextHash:(n=t.mediaId)!=null?n:void 0,type:o("MAWMsgType").MSG_TYPE.GIF})}function b(t){var n;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,plaintextHash:(n=t.mediaId)!=null?n:void 0,type:o("MAWMsgType").MSG_TYPE.STICKER})}function v(t){return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE})}function S(t){return babelHelpers.extends({},e(t),{altIndex:o("MAWDbMsg").FUTUREPROOF_ALT_INDEX,msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.FUTUREPROOF})}function R(t){return babelHelpers.extends({},e(t),{altIndex:void 0,ebTimestampMs:t.ebTimestampMs,revokedExternalId:t.revokedExternalId,type:o("MAWMsgType").MSG_TYPE.REVOKED})}function L(e){return{adminMsgContent:e.adminMsgContent,adminType:e.adminType}}function E(t){return babelHelpers.extends({},e(t),{altIndex:void 0,msgContent:L(t.msgContent),type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN})}function k(e){return{adminMsgContent:e.adminMsgContent,adminType:e.adminType,screenshotActionType:e.screenshotActionType,version:e.version}}function I(t){return babelHelpers.extends({},e(t),{altIndex:void 0,msgContent:k(t.msgContent),type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION})}function T(e){return{adminType:e.adminType,authorName:e.authorName}}function D(t){return babelHelpers.extends({},e(t),{altIndex:void 0,msgContent:T(t.msgContent),type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT})}function x(t){return babelHelpers.extends({},e(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE})}function $(t,n){var r=n.receiverFetchId;return babelHelpers.extends({},e(t),s(t),o("MAWUnstoredQuotedMsgUtils").getWithQuoteMsg(t),u(t),{altIndex:void 0,receiverFetchId:r,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH})}function P(t,n){var r=t.id.author===o("WAJids").AUTHOR_ME,a=[n.name];r||a.unshift(t.id.author!==o("WAJids").AUTHOR_ME&&t.id.author!==o("WAJids").AUTHOR_SYSTEM?o("WAJids").userIdFromJid(t.id.author):t.id.author);var i=r?o("MAWAdminMsgType").CURRENT_USER_CREATED_POLL:o("MAWAdminMsgType").PARTICIPANT_CREATED_POLL;return babelHelpers.extends({},e(t),{altIndex:void 0,msgContent:{adminMsgContent:a,adminType:i,version:1},type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE})}function N(t){return babelHelpers.extends({},e(t),{altIndex:void 0,type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE})}l.getXMAMsg=d,l.getTextMsg=m,l.getImageMsg=p,l.getRavenMsg=_,l.getVideoMsg=f,l.getPttMsg=g,l.getAdminMsg=y,l.getGifMsg=C,l.getStickerMsg=b,l.getDocumentFileMsg=v,l.getFutureproofMsg=S,l.getRevokedMsg=R,l.getEphemeralSettingAdminMsg=E,l.getEphemeralScreenshotActionMsg=I,l.getICDCAlertMsg=D,l.getBumpExistingMessageMsg=x,l.getReceiverFetchMsg=$,l.getGroupPollCreateMsg=P,l.getGroupPollUpdateMsg=N}),98);
__d("MAWUnstoredMsgUtils",["FBLogger","MAWMsgType","MAWUnstoredTypedMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.unstoredMsg,n=e.unstoredReceiverFetchInfo,a=e.unstoredXMA;if(t==null)return null;switch(t.type){case o("MAWMsgType").MSG_TYPE.TEXT:return o("MAWUnstoredTypedMsgUtils").getTextMsg(t);case o("MAWMsgType").MSG_TYPE.IMAGE:return o("MAWUnstoredTypedMsgUtils").getImageMsg(t);case o("MAWMsgType").MSG_TYPE.VIDEO:return o("MAWUnstoredTypedMsgUtils").getVideoMsg(t);case o("MAWMsgType").MSG_TYPE.PTT:return o("MAWUnstoredTypedMsgUtils").getPttMsg(t);case o("MAWMsgType").MSG_TYPE.ADMIN:return o("MAWUnstoredTypedMsgUtils").getAdminMsg(t);case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return o("MAWUnstoredTypedMsgUtils").getFutureproofMsg(t);case o("MAWMsgType").MSG_TYPE.REVOKED:return o("MAWUnstoredTypedMsgUtils").getRevokedMsg(t);case o("MAWMsgType").MSG_TYPE.GIF:return o("MAWUnstoredTypedMsgUtils").getGifMsg(t);case o("MAWMsgType").MSG_TYPE.STICKER:return o("MAWUnstoredTypedMsgUtils").getStickerMsg(t);case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return o("MAWUnstoredTypedMsgUtils").getDocumentFileMsg(t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("MAWUnstoredTypedMsgUtils").getEphemeralSettingAdminMsg(t);case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("MAWUnstoredTypedMsgUtils").getEphemeralScreenshotActionMsg(t);case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("MAWUnstoredTypedMsgUtils").getICDCAlertMsg(t);case o("MAWMsgType").MSG_TYPE.XMA:{if((a==null?void 0:a.xma)==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA content cannot be parsed without XMA payload");return o("MAWUnstoredTypedMsgUtils").getXMAMsg(t,a==null?void 0:a.xma)}case o("MAWMsgType").MSG_TYPE.RAVEN:return o("MAWUnstoredTypedMsgUtils").getRavenMsg(t);case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:case o("MAWMsgType").MSG_TYPE.REACTION:case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:return null;case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return o("MAWUnstoredTypedMsgUtils").getBumpExistingMessageMsg(t);case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:{if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("Receiver Fetch Info cannot be null for Receiver Fetch Msg");return o("MAWUnstoredTypedMsgUtils").getReceiverFetchMsg(t,n)}case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:throw r("FBLogger")("messenger_web").mustfixThrow("Group polls are not yet supported");case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:throw r("FBLogger")("messenger_web").mustfixThrow("Group polls are not yet supported");default:return t.type,null}}function s(e){if(e==null)return null;switch(e.type){case o("MAWMsgType").MSG_TYPE.TEXT:return o("MAWUnstoredTypedMsgUtils").getTextMsg(e);case o("MAWMsgType").MSG_TYPE.GIF:return o("MAWUnstoredTypedMsgUtils").getGifMsg(e);case o("MAWMsgType").MSG_TYPE.STICKER:return o("MAWUnstoredTypedMsgUtils").getStickerMsg(e);default:return null}}function u(e){var t=e.unstoredMsg;if(!t||t.type!==o("MAWMsgType").MSG_TYPE.REACTION)return null;var n=t;return{ack:n.ack,author:n.id.author,externalId:n.id.externalId,groupingKey:n.groupingKey,reaction:n.reaction,reactToAuthor:n.reactToAuthor,reactToExternalId:n.reactToExternalId,senderTimestampMs:n.senderTimestampMs,threadJid:n.id.chat,ts:n.ts}}function c(e){var t=e.unstoredMsg;if(!t||t.type!==o("MAWMsgType").MSG_TYPE.RAVEN_ACTION)return null;var n=t;return{ack:n.ack,actionTimestamp:n.actionTimestamp,actionType:n.actionType,author:n.id.author,externalId:n.id.externalId,ravenActionToMsgExternalId:n.ravenActionToMsgExternalId,ts:n.ts,type:n.type}}function d(e){var t=e.unstoredIncomingGroupInvite;return t?babelHelpers.extends({},t):null}function m(e){return e==null?null:{ack:e.ack,author:e.id.author,editMsgContent:e.editMsgContent,externalId:e.id.externalId,originalMsgExternalId:e.originalMsgExternalId,reportingMeta:e.reportingMeta,serverTs:e.serverTs,specialTextSize:e.specialTextSize,ts:e.ts,type:e.type}}function p(e){var t=e.unstoredReceiverFetchInfo;return t==null?null:babelHelpers.extends({},t,{type:"sticker"})}function _(e){var t=e.unstoredGroupPollCreateInfo;return t==null?null:babelHelpers.extends({},t,{latestSenderTimestampsMs:new Map})}function f(e){var t=e.unstoredGroupPollUpdateInfo;return t==null?null:{encryptedMessage:t.pollUpdateMessage}}l.getUnstoredMsg=e,l.getUnstoredAssociatedMsg=s,l.getUnstoredReaction=u,l.getUnstoredRavenActionMsg=c,l.getGroupInvite=d,l.getUnstoredEditActionMsg=m,l.getUnstoredReceiverFetchInfo=p,l.getUnstoredGroupPollCreateInfo=_,l.getUnstoredDbGroupPollUpdateInfo=f}),98);
__d("MAWUnstoredMediaUtils",["MAWUnstoredMsgUtils","WASortedLists"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e==null?null:{accessibilitySummaryText:e.accessibilitySummaryText,mediaEntry:e.mediaEntry,mediaType:e.mediaType,msgIds:o("WASortedLists").emptySet(),plaintextHash:e.plaintextHash,size:e.size,ts:e.ts,validatedAudioInfo:e.validatedAudioInfo,validatedDocumentFileInfo:e.validatedDocumentFileInfo,validatedImageInfo:e.validatedImageInfo,validatedVideoInfo:e.validatedVideoInfo}}function s(t){var n,r,a,i,l=t.unstoredXMA;if(l!=null){var s=l.unstoredAssociatedMedia,u=l.unstoredAssociatedMsg,c=l.unstoredFavicon,d=l.unstoredHeaderMedia,m=l.unstoredPreviews,p=l.xma;return{unstoredAssociatedMedia:(n=e(s))!=null?n:void 0,unstoredAssociatedMsg:(r=o("MAWUnstoredMsgUtils").getUnstoredAssociatedMsg(u))!=null?r:void 0,unstoredDbXMA:{author:p.author,contentRef:p.contentRef,ctas:p.ctas,defaultCTA:p.defaultCTA,externalId:p.externalId,headerTitle:p.headerTitle,isTombstoned:p.isTombstoned,maxSubtitleNumOfLines:p.maxSubtitleNumOfLines,maxTitleNumOfLines:p.maxTitleNumOfLines,overlayDescription:p.overlayDescription,overlayIconGlyph:p.overlayIconGlyph,overlayTitle:p.overlayTitle,subtitleText:p.subtitleText,targetExpiringAtSec:p.targetExpiringAtSec,targetId:p.targetId,targetType:p.targetType,targetUsername:p.targetUsername,threadJid:p.threadJid,titleText:p.titleText,xmaDataclass:p.xmaDataclass,xmaLayoutType:p.xmaLayoutType},unstoredFavicon:(a=e(c))!=null?a:void 0,unstoredHeaderMedia:(i=e(d))!=null?i:void 0,unstoredPreviews:m?m.map(function(t){return e(t)}).filter(Boolean):void 0}}}l.getUnstoredMedia=e,l.getUnstoredXMA=s}),98);
__d("MAWUnstoredContentToUnstoredDbContentUtils",["MAWUnstoredMediaUtils","MAWUnstoredMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t,n=(t=o("MAWUnstoredMsgUtils")).getUnstoredMsg(e),r=o("MAWUnstoredMediaUtils").getUnstoredMedia(e.unstoredMedia),a=t.getUnstoredReaction(e),i=t.getUnstoredRavenActionMsg(e),l=o("MAWUnstoredMediaUtils").getUnstoredXMA(e),s=t.getGroupInvite(e),u=t.getUnstoredEditActionMsg(e.unstoredEditMsg),c=t.getUnstoredReceiverFetchInfo(e),d=t.getUnstoredGroupPollCreateInfo(e),m=t.getUnstoredDbGroupPollUpdateInfo(e);return s==null?{contentTypeForLogging:e.contentTypeForLogging,unstoredDbEditActionMsg:u,unstoredDbGroupPollCreateInfo:d,unstoredDbGroupPollUpdateInfo:m,unstoredDbMedia:r,unstoredDbMsg:n,unstoredDbRavenActionMsg:i,unstoredDbReaction:a,unstoredDbReceiverFetchInfo:c,unstoredXMA:l,xmaTargetTypeForLogging:e.xmaTargetTypeForLogging}:{contentTypeForLogging:e.contentTypeForLogging,unstoredDbEditActionMsg:u,unstoredDbGroupPollCreateInfo:d,unstoredDbGroupPollUpdateInfo:m,unstoredDbMedia:r,unstoredDbMsg:n,unstoredDbRavenActionMsg:i,unstoredDbReaction:a,unstoredDbReceiverFetchInfo:c,unstoredIncomingDbGroupInvite:s,unstoredXMA:l,xmaTargetTypeForLogging:e.xmaTargetTypeForLogging}}l.unstoredContentToUnstoredDbContent=e}),98);